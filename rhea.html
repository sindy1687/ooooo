<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>填空挑戰 - 英打小英雄</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
<style>
  :root{--gold:#ffd700;--cyan:#00ffff;--panel:rgba(30,30,40,.97);--glass:rgba(30,30,40,.92)}
  *{box-sizing:border-box} html,body{margin:0;padding:0;overflow-x:hidden}
  body{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;
       font-family:'Segoe UI',Arial,sans-serif,'Orbitron',sans-serif;color:#fff;
       background:linear-gradient(135deg,#232526 0%,#414345 100%)}
  h1{margin:60px 0 20px;color:var(--gold);text-shadow:0 0 8px var(--gold);letter-spacing:2px;font:700 2.2rem Orbitron,Arial,sans-serif}
  .top-btns{position:fixed;top:20px;right:20px;display:flex;gap:8px;z-index:11}
  .top-btns button,button{cursor:pointer;border:0;border-radius:12px;box-shadow:0 2px 8px #0003;transition:.2s;background:var(--gold);color:#000}
  .top-btns button{padding:6px 12px;font:1rem Orbitron,Arial,sans-serif}
  button{padding:10px 26px;font:1rem Orbitron,Arial,sans-serif}
  #submit-btn{background:var(--gold);color:#111} #skip-btn{background:#bbb;color:#222} #next-btn{background:#4caf50;color:#fff}
  #speak-btn{background:#0ff;color:#111;margin-top:10px}
  #submit-btn:disabled,#speak-btn:disabled{background:#555;color:#888;cursor:not-allowed}
  #skip-btn:hover{background:#ccc} #next-btn:hover{background:#6fdc7f} .top-btns button:hover{background:#ffe54f}
  #bgMusicControl{position:fixed;right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;font-size:1.5rem;
                  display:flex;align-items:center;justify-content:center;background:rgba(255,215,0,.9);box-shadow:0 0 12px rgba(255,215,0,.4);z-index:12}
  #bgMusicControl:hover{transform:scale(1.1);box-shadow:0 0 20px rgba(255,215,0,.6)} #bgMusicControl.paused{background:rgba(255,255,255,.3);color:#fff}
  #starsDisplay{position:fixed;top:20px;left:20px;background:rgba(10,20,40,.85);border:2px solid var(--cyan);box-shadow:0 0 12px var(--gold),0 0 32px var(--cyan);
                color:var(--gold);padding:8px 14px;border-radius:10px;font-weight:bold;z-index:10}
  #star-counter{display:flex;gap:18px;align-items:center;justify-content:center;background:var(--glass);border:1.5px solid #ffd70044;border-radius:18px;
                padding:14px 32px;margin:0 0 18px;color:var(--gold);min-width:260px;font:1.18rem Orbitron,Arial,sans-serif}
  #timer{font-size:1.1rem;margin-bottom:16px} .hidden{display:none}
  #question-container{background:var(--panel);border:1.5px solid #ffd70044;border-radius:22px;box-shadow:0 8px 32px rgba(31,38,135,.37);
                      padding:38px 30px 30px;max-width:440px;width:100%;margin:auto;display:flex;flex-direction:column;align-items:center}
  .question-title{font-size:1.1rem;margin-bottom:8px;letter-spacing:1px}
  .question-sentence{font-size:1.6rem;font-weight:700;margin:10px 0 20px;line-height:1.5;word-break:break-word}
  .blank{color:#0ff;background:#fff2;border-radius:8px;padding:2px 16px;box-shadow:0 1px 4px #0ff2}
  .question-zh{color:var(--gold);margin-bottom:16px;font-size:1.05rem}
  input{width:92%;padding:14px;font-size:1.1rem;border:2px solid var(--gold);border-radius:14px;background:#222;color:#fff;margin-bottom:18px;outline:0}
  input:focus{border-color:var(--cyan)} .btn-row{display:flex;gap:20px;justify-content:center;margin-bottom:10px;width:100%}
  #feedback{min-height:28px;margin-top:10px;font-size:1.05rem}
  .feedback-box{display:inline-block;padding:10px 22px;border-radius:16px;font-weight:700;box-shadow:0 2px 16px #0004;margin-top:8px;animation:pf .7s cubic-bezier(.68,-.55,.27,1.55)}
  .feedback-correct{background:linear-gradient(90deg,#2ecc40,#bfff00);color:#222} .feedback-wrong{background:linear-gradient(90deg,#ff4f4f,#ffbaba);color:#fff}
  .feedback-bonus{color:var(--gold);animation:bflash 1s infinite alternate;font-size:1.15em}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)}
  .modal-content{background:rgba(30,30,40,.95);border:2px solid var(--gold);border-radius:20px;padding:32px;text-align:center;max-width:500px;width:90%;
                 box-shadow:0 0 32px #ffd70044,0 0 80px #00ffff22 inset;animation:mp .5s cubic-bezier(.68,-.55,.27,1.55)}
  .end-icon{font-size:3.2rem;margin-bottom:14px;animation:tada 1.2s infinite}
  .end-buttons{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
  @keyframes pf{0%{transform:scale(.7);opacity:0}60%{transform:scale(1.12);opacity:1}100%{transform:scale(1)}}
  @keyframes mp{0%{transform:scale(.7);opacity:0}60%{transform:scale(1.1);opacity:1}100%{transform:scale(1)}}
  @keyframes bflash{0%{text-shadow:0 0 8px var(--gold)}100%{text-shadow:0 0 24px #fff700}}
  @keyframes tada{0%{transform:scale(1)}10%,20%{transform:scale(.9) rotate(-3deg)}30%,50%,70%,90%{transform:scale(1.1) rotate(3deg)}40%,60%,80%{transform:scale(1.1) rotate(-3deg)}100%{transform:scale(1)}}
  @media (max-width:768px){.top-btns{top:10px;right:10px;flex-wrap:wrap}.top-btns button{font-size:.9rem;padding:4px 8px}
    #starsDisplay{top:10px;left:10px;font-size:1rem;padding:6px 10px} h1{font-size:1.8rem;margin-top:60px}
    #question-container{max-width:95vw;padding:20px 15px;margin:10px auto}.question-sentence{font-size:1.3rem}
    .modal-content{max-width:95vw;padding:20px}}
  @media (max-width:480px){h1{font-size:1.5rem;margin-top:10px}.btn-row{flex-direction:column}.btn-row button{width:100%}}
</style>
</head>
<body>
  <button id="bgMusicControl" title="背景音樂控制">🎵</button>

  <div id="starsDisplay">⭐<span id="totalStarsCount">0</span></div>

  <div class="top-btns">
    <button onclick="location.href='atlas.html?tab=greek'">🏠 回首頁</button>
    <button onclick="resetProgress()">🔄 重新開始</button>
    <button onclick="showReviewModal()">📚 複習單字</button>
  </div>

  <h1>瑞亞 Rhea - 填空挑戰</h1>

  <div id="sessionStarsDisplay" style="margin-bottom:10px;color:#ffd700;font-weight:bold;font-size:1.02rem;">本次已獲得 0 顆星星</div>

  <div id="star-counter">第 <span id="current-index">0</span> / <span id="total-questions">0</span> 題</div>

  <div id="timer" class="hidden">⏳ 倒數：<span id="time-left">0</span> 秒</div>

  <div id="question-container"></div>

  <!-- 遊戲結束 -->
  <div id="gameEndModal" class="modal" style="display:none">
    <div class="modal-content">
      <div class="end-icon">🎉</div>
      <h2 style="color:#ffd700;text-shadow:0 0 12px #ffd700">遊戲完成！</h2>
      <div class="end-stats">
        <p>⭐ 本次獲得星星：<b id="endSessionStars">0</b></p>
        <p>✅ 答對題數：<b id="endCorrectCount">0</b></p>
        <p>❌ 答錯題數：<b id="endWrongCount">0</b></p>
        <p>⭐ 累積總星星：<b id="endTotalStars">0</b></p>
      </div>
      <div class="end-buttons">
        <button onclick="restartGame()">🔄 重新開始</button>
        <button onclick="location.href='atlas.html?tab=greek'">🏠 返回首頁</button>
      </div>
    </div>
  </div>

  <!-- 複習單字 -->
  <div id="reviewModal" class="modal" style="display:none">
    <div class="modal-content">
      <div class="end-icon">📚</div>
      <h2 style="color:#ffd700">單字複習</h2>
      <div style="margin-bottom:12px">
        <label for="categoryFilter" style="color:#ffd700;font-weight:700;margin-right:8px">選擇分類：</label>
        <select id="categoryFilter" style="background:#222;color:#fff;border:2px solid #ffd700;border-radius:8px;padding:6px 10px">
          <option value="all">全部單字</option>
        </select>
      </div>
      <div id="vocabStats" style="background:rgba(255,215,0,.1);border:1px solid #ffd700;border-radius:8px;padding:8px;color:#ffd700;font-size:.9rem">
        總共 <span id="totalVocabCount">0</span> 個單字
        <button onclick="showVocabStats()" style="background:#0ff;color:#000;border:none;border-radius:6px;padding:4px 8px;font-size:.8rem;margin-left:8px">📊 詳細統計</button>
        <button onclick="exportVocabData()" style="background:#4caf50;color:#fff;border:none;border-radius:6px;padding:4px 8px;font-size:.8rem;margin-left:4px">📥 匯出字庫</button>
      </div>
      <div id="reviewWordsContainer" style="max-height:400px;overflow-y:auto;margin:14px 0"></div>
      <div class="end-buttons"><button onclick="closeReviewModal()">關閉</button></div>
    </div>
  </div>

  <audio id="backgroundMusic" loop>
    <source src="sound/午後放鬆時光（純音樂）.mp3" type="audio/mpeg">
  </audio>

<script>
/* ===================== 設定 & 小工具 ===================== */
const $ = s => document.querySelector(s);
const GAME = { QUESTIONS_COUNT: 20, TIME_LIMIT: 30, MAX_ATTEMPTS: 3 };
const SOUNDS = { correct:new Audio('sound/correct.mp3'), wrong:new Audio('sound/wrong.mp3'), type:new Audio('sound/type.mp3') };
const speakSys = { voice:null };
const state = { data:[], i:0, tries:0, answered:false, timer:null, log:[], sessionStars:0 };
const esc = s => s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
const safeBlank = (sent, ans) => { try{ return sent.replace(new RegExp(esc(ans),'i'),'___'); }catch{ const L=sent.toLowerCase(),t=ans.toLowerCase(),i=L.indexOf(t); return i>=0?sent.slice(0,i)+'___'+sent.slice(i+ans.length):sent; } };
const say = (t,rate=1,cb)=>{ if(!speechSynthesis) return; const u=new SpeechSynthesisUtterance(t); u.lang='en-US'; u.rate=rate; u.pitch=1.12; if(speakSys.voice) u.voice=speakSys.voice; if(cb) u.onend=cb; speechSynthesis.cancel(); speechSynthesis.speak(u); };

/* ===================== 題庫（示例 60 筆，可自行再加） ===================== */
const VOCAB_DATA = [
  {"word":"second","zh":"第二；秒","en_sentence":"This is the second time I've met him.","zh_sentence":"這是我第二次見到他。","category":"序數/時間"},
  {"word":"third","zh":"第三","en_sentence":"She won the third prize in the race.","zh_sentence":"她在比賽中贏得了第三名。","category":"序數"},
  {"word":"money","zh":"金錢","en_sentence":"I need some money to buy a new book.","zh_sentence":"我需要一些錢買一本新書。","category":"名詞/金錢"},
  {"word":"Mother's Day","zh":"母親節","en_sentence":"We always give Mom flowers on Mother's Day.","zh_sentence":"我們總是在母親節送花給媽媽。","category":"節日/活動"},
  {"word":"idea","zh":"主意；想法","en_sentence":"That's a great idea for a party theme.","zh_sentence":"那是一個很棒的派對主題點子。","category":"抽象名詞"},
  {"word":"because","zh":"因為","en_sentence":"I'm happy because it's Friday.","zh_sentence":"我很開心，因為今天是星期五。","category":"連接詞"},
  {"word":"drawer","zh":"抽屜","en_sentence":"Keep your socks in the bottom drawer.","zh_sentence":"把你的襪子放在最下面的抽屜裡。","category":"家居/物品"},
  {"word":"bath","zh":"洗澡","en_sentence":"I like to take a warm bath before bed.","zh_sentence":"我喜歡在睡前洗個熱水澡。","category":"活動/名詞"},
  {"word":"cow","zh":"母牛","en_sentence":"The cow is grazing in the field.","zh_sentence":"母牛正在田野裡吃草。","category":"動物/名詞"},
  {"word":"market","zh":"市場","en_sentence":"She buys fresh vegetables at the morning market.","zh_sentence":"她在早市買新鮮的蔬菜。","category":"地點/場所"},
  {"word":"expensive","zh":"昂貴的","en_sentence":"That watch is too expensive for me.","zh_sentence":"那隻手錶對我來說太貴了。","category":"形容詞"},
  {"word":"cheap","zh":"便宜的","en_sentence":"We found a cheap hotel near the beach.","zh_sentence":"我們在海灘附近找到了一家便宜的旅館。","category":"形容詞"},
  {"word":"enough","zh":"足夠的","en_sentence":"Do we have enough food for all the guests?","zh_sentence":"我們有足夠的食物給所有客人嗎？","category":"量詞/形容詞"},
  {"word":"all","zh":"全部","en_sentence":"I ate all the cookies by myself.","zh_sentence":"我自己吃掉了所有餅乾。","category":"限定詞/代名詞"},
  {"word":"poor","zh":"貧窮的；可憐的","en_sentence":"The poor man lost his job yesterday.","zh_sentence":"那個窮人昨天失業了。","category":"形容詞"},
  {"word":"early","zh":"早的；提早","en_sentence":"We need to get up early tomorrow.","zh_sentence":"我們明天需要早起。","category":"形容詞/副詞"},
  {"word":"dirty","zh":"髒的","en_sentence":"My shoes are dirty from walking in the mud.","zh_sentence":"我的鞋子在泥濘中行走弄髒了。","category":"形容詞"},
  {"word":"easy","zh":"容易的","en_sentence":"The test was surprisingly easy.","zh_sentence":"這次考試出乎意料地容易。","category":"形容詞"},
  {"word":"hard","zh":"困難的；努力地","en_sentence":"She works very hard to save money.","zh_sentence":"她非常努力地工作來存錢。","category":"形容詞/副詞"},
  {"word":"busy","zh":"忙碌的","en_sentence":"He is always busy with work and study.","zh_sentence":"他總是忙於工作和學習。","category":"形容詞"},
  {"word":"free","zh":"有空的；免費的","en_sentence":"Are you free this afternoon to meet up?","zh_sentence":"你今天下午有空見面嗎？","category":"形容詞"},
  {"word":"need","zh":"需要","en_sentence":"I need your help with this heavy box.","zh_sentence":"我需要你幫忙搬這個重箱子。","category":"動詞/名詞"},
  {"word":"end","zh":"結束；末端","en_sentence":"The movie will end in five minutes.","zh_sentence":"電影將在五分鐘內結束。","category":"名詞/動詞"},
  {"word":"cost","zh":"花費","en_sentence":"How much does it cost to fix the car?","zh_sentence":"修理汽車需要多少錢？","category":"動詞/名詞"},
  {"word":"buy","zh":"購買","en_sentence":"I want to buy a new pair of glasses.","zh_sentence":"我想買一副新眼鏡。","category":"動詞"},
  {"word":"put","zh":"放置","en_sentence":"Put the plate on the dining table.","zh_sentence":"把盤子放在餐桌上。","category":"動詞"},
  {"word":"feed","zh":"餵食","en_sentence":"Don't forget to feed the cat this evening.","zh_sentence":"今晚別忘了餵貓。","category":"動詞"},
  {"word":"sell","zh":"販賣","en_sentence":"They sell fresh bread at the bakery.","zh_sentence":"他們在麵包店販賣新鮮的麵包。","category":"動詞"},
  {"word":"also","zh":"也","en_sentence":"She is a singer and also an actress.","zh_sentence":"她是歌手，也是演員。","category":"副詞"},
  {"word":"once","zh":"一次","en_sentence":"I have only been to Taipei once.","zh_sentence":"我只去過台北一次。","category":"副詞"},
  {"word":"twice","zh":"兩次","en_sentence":"He visits his grandmother twice a week.","zh_sentence":"他每週探望他的祖母兩次。","category":"副詞"},
  {"word":"place","zh":"地方；放置","en_sentence":"This is a lovely place for a picnic.","zh_sentence":"這是一個適合野餐的可愛地方。","category":"名詞/動詞"},
  {"word":"road","zh":"道路","en_sentence":"The road to the mountain is narrow.","zh_sentence":"通往山上的路很狹窄。","category":"地點"},
  {"word":"temple","zh":"寺廟","en_sentence":"We visited an ancient temple in the town.","zh_sentence":"我們參觀了鎮上的一座古老寺廟。","category":"地點"},
  {"word":"museum","zh":"博物館","en_sentence":"The new art museum opened last week.","zh_sentence":"新的藝術博物館上週開放了。","category":"地點"},
  {"word":"hotel","zh":"旅館","en_sentence":"We stayed at a fancy hotel near the beach.","zh_sentence":"我們住在海灘附近的一家高級旅館。","category":"地點"},
  {"word":"season","zh":"季節","en_sentence":"Spring is my favorite season of the year.","zh_sentence":"春天是我一年中最喜歡的季節。","category":"時間"},
  {"word":"autumn","zh":"秋天","en_sentence":"The leaves turn red and yellow in autumn.","zh_sentence":"樹葉在秋天會變紅變黃。","category":"時間"},
  {"word":"snow","zh":"雪；下雪","en_sentence":"It is starting to snow outside.","zh_sentence":"外面開始下雪了。","category":"自然"},
  {"word":"snowman","zh":"雪人","en_sentence":"The children built a big snowman in the yard.","zh_sentence":"孩子們在院子裡堆了一個大雪人。","category":"名詞"},
  {"word":"plan","zh":"計畫","en_sentence":"Do you have a plan for the weekend?","zh_sentence":"你週末有什麼計畫嗎？","category":"抽象/動詞"},
  {"word":"date","zh":"日期；約會","en_sentence":"What is the date today?","zh_sentence":"今天的日期是什麼？","category":"時間"},
  {"word":"USA","zh":"美國","en_sentence":"She plans to visit the USA next summer.","zh_sentence":"她計畫明年夏天去美國。","category":"國家"},
  {"word":"photo","zh":"照片","en_sentence":"I keep my favorite photos in an album.","zh_sentence":"我把最喜歡的照片放在相簿裡。","category":"名詞"},
  {"word":"mind","zh":"介意；頭腦","en_sentence":"Do you mind closing the window?","zh_sentence":"你介意關窗戶嗎？","category":"動詞/名詞"},
  {"word":"exercise","zh":"運動；練習","en_sentence":"We should exercise every day to stay healthy.","zh_sentence":"我們應該每天運動以保持健康。","category":"動詞/名詞"},
  {"word":"practice","zh":"練習","en_sentence":"She needs to practice the piano daily.","zh_sentence":"她需要每天練習鋼琴。","category":"動詞/名詞"},
  {"word":"team","zh":"隊伍","en_sentence":"Our school baseball team won the championship.","zh_sentence":"我們學校的棒球隊贏了冠軍。","category":"團體"},
  {"word":"problem","zh":"問題","en_sentence":"She needs help solving a math problem.","zh_sentence":"她需要幫助解決數學問題。","category":"抽象"},
  {"word":"toe","zh":"腳趾","en_sentence":"He stubbed his toe on the table edge.","zh_sentence":"他的腳趾撞到桌邊。","category":"身體"},
  {"word":"violin","zh":"小提琴","en_sentence":"He practices the violin every evening.","zh_sentence":"他每天晚上練小提琴。","category":"樂器"},
  {"word":"flute","zh":"長笛","en_sentence":"The sound of the flute is sweet.","zh_sentence":"長笛的聲音很甜美。","category":"樂器"},
  {"word":"special","zh":"特別的","en_sentence":"Today is special because it's my birthday.","zh_sentence":"今天很特別，因為是我生日。","category":"形容詞"},
  {"word":"afraid","zh":"害怕的","en_sentence":"I am afraid of spiders.","zh_sentence":"我害怕蜘蛛。","category":"情緒"},
  {"word":"same","zh":"相同的","en_sentence":"We chose the same color.","zh_sentence":"我們選了相同的顏色。","category":"形容詞"},
  {"word":"different","zh":"不同的","en_sentence":"They have different ideas.","zh_sentence":"他們有不同的想法。","category":"形容詞"},
  {"word":"dry","zh":"乾燥的","en_sentence":"Please keep the dishes dry.","zh_sentence":"請確保盤子乾燥。","category":"形容詞"},
  {"word":"wet","zh":"濕的","en_sentence":"The floor is wet; be careful.","zh_sentence":"地板是濕的，小心。","category":"形容詞"},
  {"word":"popular","zh":"受歡迎的","en_sentence":"That coffee shop is popular.","zh_sentence":"那家咖啡店很受歡迎。","category":"形容詞"},
  {"word":"dark","zh":"黑暗的","en_sentence":"It gets dark early in winter.","zh_sentence":"冬天很早就天黑了。","category":"形容詞"},
  {"word":"know","zh":"知道","en_sentence":"Do you know the way to the post office?","zh_sentence":"你知道去郵局的路嗎？","category":"心理"},
  {"word":"keep","zh":"保持","en_sentence":"Please keep quiet during the meeting.","zh_sentence":"開會時請保持安靜。","category":"動作"},
  {"word":"join","zh":"加入","en_sentence":"Would you like to join us for lunch?","zh_sentence":"要一起吃午餐嗎？","category":"動作"},
  {"word":"throw","zh":"丟","en_sentence":"Please throw the trash into the bin.","zh_sentence":"請把垃圾丟進垃圾桶。","category":"動作"},
  {"word":"hit","zh":"擊中","en_sentence":"He hit the ball hard.","zh_sentence":"他用力擊球。","category":"動作"},
  {"word":"enjoy","zh":"享受","en_sentence":"We enjoy spending time in nature.","zh_sentence":"我們喜歡待在大自然。","category":"情緒"}
];

/* ===================== 初始化資料 ===================== */
const pick = (arr,n)=>arr.slice().sort(()=>Math.random()-.5).slice(0,Math.min(n,arr.length));
function initData(){
  const list = pick(VOCAB_DATA,GAME.QUESTIONS_COUNT);
  state.data = list.map(v=>({answer:v.word, zh:v.zh, sentence:safeBlank(v.en_sentence,v.word),
                             original:v.en_sentence, zh_sentence:v.zh_sentence, category:v.category}));
  $('#total-questions').textContent = state.data.length;
}

/* ===================== 本地儲存 & 星星 ===================== */
const loadStars = ()=> parseInt(localStorage.getItem('totalStars')||'0',10);
const saveStars = n => { localStorage.setItem('totalStars',n); updateStars(); };
const addStars = n => saveStars(loadStars()+n);
const updateStars = ()=> { $('#totalStarsCount').textContent = loadStars(); };
function resetProgress(){ localStorage.removeItem('fillIndex'); location.reload(); }

/* ===================== 背景音樂 ===================== */
let music = null, playing=false;
function initMusic(){
  music = $('#backgroundMusic'); music.volume = .3;
  if(localStorage.getItem('bgMusicState')==='playing') playMusic();
  $('#bgMusicControl').onclick = toggleMusic; updateMusicBtn();
}
function playMusic(){ if(!music) return; music.play().then(()=>{playing=true;localStorage.setItem('bgMusicState','playing');updateMusicBtn();}).catch(()=>{}); }
function pauseMusic(){ if(!music) return; music.pause(); playing=false; localStorage.setItem('bgMusicState','paused'); updateMusicBtn(); }
function toggleMusic(){ playing?pauseMusic():playMusic(); }
function updateMusicBtn(){ const b=$('#bgMusicControl'); b.textContent = playing?'🔊':'🔇'; b.classList.toggle('paused',!playing); }

/* ===================== 語音 ===================== */
function pickVoice(){
  const vs = speechSynthesis.getVoices();
  const prefer = ['Google US English','Microsoft Aria Online','Microsoft Jenny Online','Samantha','Jenny','Aria','en-US'];
  speakSys.voice = vs.find(v=>prefer.some(p=>v.name.includes(p))) || vs.find(v=>v.lang==='en-US') || vs[0];
}
if(typeof speechSynthesis!=='undefined'){ speechSynthesis.onvoiceschanged=pickVoice; pickVoice(); }

/* ===================== 題目流程 ===================== */
function timerStart(){
  clearInterval(state.timer); let t=GAME.TIME_LIMIT;
  $('#time-left').textContent=t; $('#timer').classList.remove('hidden');
  state.timer=setInterval(()=>{ t--; $('#time-left').textContent=t; if(t<=0){ clearInterval(state.timer); revealAnswer(true); } },1000);
}
function timerStop(){ clearInterval(state.timer); }

function showQ(){
  if(!state.data.length){ $('#question-container').innerHTML='<div style="color:#f66;font-size:1.2rem">⚠️ 題庫沒有題目</div>'; return; }
  if(state.i>=state.data.length){ endGame(); return; }

  state.answered=false; state.tries=0;
  const q = state.data[state.i];
  $('#question-container').innerHTML =
    `<div class="question-title">英文句子：</div>
     <div class="question-sentence">${q.sentence.replace('___','<span class="blank">___</span>')}</div>
     <div class="question-zh">中文提示：${q.zh_sentence||q.zh}</div>
     <input id="user-input" placeholder="輸入答案…" autocomplete="off" />
     <div class="btn-row">
       <button id="submit-btn" onclick="checkAnswer()">送出</button>
       <button id="skip-btn" onclick="skipQ()">跳過</button>
       <button id="next-btn" onclick="nextQ()">下一題</button>
     </div>
     <div id="feedback"></div>
     <button id="speak-btn">🔊 朗讀</button>`;

  $('#speak-btn').onclick = ()=> { say(q.original,.97,()=> setTimeout(()=>{ say(safeBlank(q.original,q.answer).replace('___','...'),1.02,()=>setTimeout(()=>say(q.answer,1.08),350)); },350)); };
  const input = $('#user-input'); input.focus();
  input.onkeydown = e => { if(e.key==='Enter') checkAnswer(); else if(e.key.length===1){ try{ SOUNDS.type.currentTime=0; SOUNDS.type.play(); }catch(_){} } };
  $('#current-index').textContent = state.i+1; timerStart(); setTimeout(()=>say(q.original,.97),400);
  window.answerStartTime = Date.now();
}

function revealAnswer(autoNext=false){
  state.tries = 999;
  $('#feedback').innerHTML = `<span style="color:#f66">⏰ 時間到！正確答案：<b>${state.data[state.i].answer}</b></span>`;
  $('#submit-btn').disabled = true; $('#user-input').disabled = true;
  log(false);
  if(autoNext) setTimeout(()=>{ state.i++; showQ(); }, 500);
}

function log(correct,user=''){
  const q = state.data[state.i];
  state.log[state.i] = { word:q.answer, zh:q.zh_sentence||q.zh, en:q.original, user, correct, stars:0, category:q.category };
}

function checkAnswer(){
  if(state.answered) return;
  state.tries++;
  const ans = state.data[state.i].answer.toLowerCase();
  const val = $('#user-input').value.trim().toLowerCase();

  if(val===ans){
    state.answered=true; timerStop();
    const sec = (Date.now()-(window.answerStartTime||Date.now()))/1000;
    let bonus = sec<10 ? 2 : 0;
    $('#feedback').innerHTML = `<div class="feedback-box feedback-correct">✅ 答對了！太棒了！ ${bonus?'<span class="feedback-bonus">BONUS! ⏱️ +2</span>':''}</div>`;
    $('#user-input').disabled=true; $('#submit-btn').disabled=true; say(ans,1.1);
    log(true,$('#user-input').value.trim());
    const add = 1+bonus; addStars(add); state.sessionStars+=add; $('#sessionStarsDisplay').textContent=`本次已獲得 ${state.sessionStars} 顆星星`;
    try{ SOUNDS.correct.currentTime=0; SOUNDS.correct.play(); }catch(_){}
    setTimeout(()=>{ state.i++; showQ(); },1300);
  }else{
    if(state.tries<GAME.MAX_ATTEMPTS){
      $('#feedback').innerHTML = `<div class="feedback-box feedback-wrong">❌ 再試一次！你可以的！</div>`;
      try{ SOUNDS.wrong.currentTime=0; SOUNDS.wrong.play(); }catch(_){}
    }else{
      $('#feedback').innerHTML = `<div class="feedback-box feedback-wrong">❌ 正確答案：<b>${state.data[state.i].answer}</b><br>別氣餒，再接再厲！</div>`;
      $('#user-input').disabled=true; $('#submit-btn').disabled=true;
      log(false,$('#user-input').value.trim());
      try{ SOUNDS.wrong.currentTime=0; SOUNDS.wrong.play(); }catch(_){}
      setTimeout(()=>{ state.i++; showQ(); },1300);
    }
  }
}

function skipQ(){ timerStop(); log(null,''); $('#feedback').innerHTML='<span style="color:#bbb">已跳過本題</span>'; setTimeout(()=>{ state.i++; showQ(); },400); }
function nextQ(){ timerStop(); if(!state.log[state.i]){ log(false,$('#user-input')?.value||''); $('#feedback').innerHTML='<span style="color:#bbb">未作答</span>'; } setTimeout(()=>{ state.i++; showQ(); },400); }

/* ===================== 結束畫面 ===================== */
function endGame(){
  const correct = state.log.filter(x=>x && x.correct===true).length;
  const wrong   = state.log.filter(x=>x && x.correct===false).length;
  $('#endSessionStars').textContent = state.sessionStars;
  $('#endCorrectCount').textContent = correct;
  $('#endWrongCount').textContent = wrong;
  $('#endTotalStars').textContent = loadStars();
  $('#gameEndModal').style.display='flex';
  timerStop();
  try{ SOUNDS.correct.currentTime=0; SOUNDS.correct.play(); }catch(_){}
}
function restartGame(){
  $('#gameEndModal').style.display='none';
  state.i=0; state.sessionStars=0; state.log=[];
  initData(); $('#current-index').textContent=1; $('#sessionStarsDisplay').textContent='本次已獲得 0 顆星星';
  showQ();
}

/* ===================== 複習/統計/匯出 ===================== */
function showReviewModal(){ timerStop(); fillCategories(); showList('all'); $('#totalVocabCount').textContent=VOCAB_DATA.length; $('#reviewModal').style.display='flex'; }
function closeReviewModal(){ $('#reviewModal').style.display='none'; if(state.i<state.data.length && !state.answered) timerStart(); }
function speakWord(w){ say(w,.9); }

function fillCategories(){
  const sel = $('#categoryFilter'); sel.innerHTML = '<option value="all">全部單字</option>';
  [...new Set(VOCAB_DATA.map(v=>v.category))].forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
  sel.onchange = e=> showList(e.target.value);
}

function showList(cat){
  const box=$('#reviewWordsContainer'); box.innerHTML='';
  const list = cat==='all'? VOCAB_DATA : VOCAB_DATA.filter(v=>v.category===cat);
  $('#totalVocabCount').textContent=list.length;
  if(cat!=='all'){
    const t=document.createElement('div'); t.style.cssText='color:#0ff;font-size:1.1rem;font-weight:700;margin:8px 0;padding:8px;background:rgba(0,255,255,.1);border-radius:8px;text-align:center';
    t.textContent=`📂 ${cat} (${list.length}個單字)`; box.appendChild(t);
  }
  list.forEach((v,i)=>{
    const d=document.createElement('div');
    d.style.cssText='background:rgba(255,255,255,.1);border:1px solid #ffd700;border-radius:10px;padding:12px;margin:8px 0;text-align:left;cursor:pointer;transition:.2s';
    d.innerHTML = `
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="flex:1;min-width:0">
          <div style="color:#ffd700;font-weight:700;margin-bottom:6px;word-break:break-word">${i+1}. ${v.word}${cat==='all'?` <span style="color:#0ff;font-size:.8rem;background:rgba(0,255,255,.2);padding:2px 6px;border-radius:4px">${v.category}</span>`:''}</div>
          <div style="color:#fff;margin-bottom:6px">${v.zh}</div>
          <div style="color:#0ff;font-size:.95rem;font-style:italic">${v.en_sentence}</div>
        </div>
        <button onclick="event.stopPropagation();speakWord('${v.word.replace(/'/g,"\\'")}')" style="background:#0ff;color:#000;border:none;border-radius:50%;width:42px;height:42px;font-size:1.2rem;box-shadow:0 2px 8px rgba(0,255,255,.3)">🔊</button>
      </div>`;
    d.onmouseenter=()=>{ d.style.background='rgba(255,215,0,.2)'; d.style.transform='scale(1.02)'; };
    d.onmouseleave=()=>{ d.style.background='rgba(255,255,255,.1)'; d.style.transform='scale(1)'; };
    d.onclick=()=>speakWord(v.word);
    box.appendChild(d);
  });
  if(!list.length){ const n=document.createElement('div'); n.style.cssText='text-align:center;color:#888;padding:30px;font-style:italic'; n.textContent='此分類暫無單字'; box.appendChild(n); }
}

function showVocabStats(){
  const stats = {}; VOCAB_DATA.forEach(v=> stats[v.category]=(stats[v.category]||0)+1 );
  const modal=document.createElement('div'); modal.className='modal'; modal.style.display='flex';
  modal.innerHTML = `<div class="modal-content" style="max-width:600px">
    <div class="end-icon">📊</div><h2 style="color:#ffd700">字庫統計</h2>
    <div style="text-align:left;margin:12px 0">${Object.entries(stats).map(([c,n])=>`
      <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,215,0,.3)">
        <span style="color:#fff">${c}</span><span style="color:#0ff;font-weight:700">${n} 個單字</span>
      </div>`).join('')}
      <div style="display:flex;justify-content:space-between;padding:10px 0;border-top:2px solid #ffd700;margin-top:8px;font-weight:700">
        <span style="color:#ffd700">總計</span><span style="color:#ffd700">${VOCAB_DATA.length} 個單字</span>
      </div>
    </div>
    <div class="end-buttons"><button onclick="this.closest('.modal').remove()">關閉</button></div></div>`;
  modal.onclick=e=>{ if(e.target===modal) modal.remove(); };
  document.body.appendChild(modal);
}

function exportVocabData(){
  const csv = [
    ['單字','中文','英文例句','中文例句','分類'],
    ...VOCAB_DATA.map(v=>[v.word,v.zh,v.en_sentence,v.zh_sentence||'',v.category])
  ].map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download=`zeus_vocabulary_${new Date().toISOString().slice(0,10)}.csv`; a.click();
}

/* ===================== 事件 & 啟動 ===================== */
function updateIndex(){ $('#current-index').textContent = state.i+1; }
function addNotice(msg,type='info'){
  const n=document.createElement('div'); n.style.cssText=`position:fixed;top:20px;left:50%;transform:translateX(-50%);
    background:${type==='success'?'#4caf50':'#2196f3'};color:#fff;padding:10px 18px;border-radius:8px;font-weight:700;z-index:2000`;
  n.textContent=msg; document.body.appendChild(n); setTimeout(()=>n.remove(),2200);
}
function addStarsAndToast(n){ addStars(n); addNotice('✅ 字庫已成功匯出！','success'); }

document.addEventListener('DOMContentLoaded',()=>{
  updateStars(); $('#sessionStarsDisplay').textContent='本次已獲得 0 顆星星';
  initData(); state.i=0; updateIndex(); showQ(); localStorage.removeItem('fillIndex');
  initMusic();
  // 點彈窗外關閉
  ['reviewModal','gameEndModal'].forEach(id=>{
    const m=$('#'+id); if(m) m.addEventListener('click',e=>{ if(e.target===m) m.style.display='none'; });
  });
});

</script>
</body>
</html>
