<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è‹±æ‰“å°è‹±é›„ - æ˜Ÿåº§æŒ‘æˆ°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="responsive_enhanced.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* é˜²æ­¢æ°´å¹³æ»¾å‹• */
    html {
      overflow-x: hidden;
    }
    
    /* ç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½åœ¨è¦–çª—ç¯„åœå…§ */
    * {
      box-sizing: border-box;
      max-width: 100%;
    }
    
    /* === èƒŒæ™¯ï¼šæ˜Ÿç©ºèˆ‡æ¼¸å±¤ === */
    body {
      margin: 0;
      padding: 0;
      overflow: auto;
      font-family: 'Orbitron', sans-serif;
      color: #fff;
      background: linear-gradient(to bottom, #020111 0%, #000010 100%);
      width: 100%;
      overflow-x: hidden;
    }
    /* æ˜Ÿæ˜Ÿç²’å­ */
    #starfield {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
    }
    /* ä¸»è¦å®¹å™¨ï¼šåŠé€æ˜èƒŒæ™¯å’Œæ¨¡ç³Šæ•ˆæœ */
    #container {
      position: relative;
      z-index: 1;
      max-width: 500px;
      margin: 40px auto;
      padding: 20px;
      background: rgba(10, 20, 40, 0.7);
      border-radius: 16px;
      box-shadow: 0 0 32px #00ffff44, 0 0 80px #a259ff22 inset;
      backdrop-filter: blur(8px);
    }
    /* è¿”å›é¦–é æŒ‰éˆ• */
    .home-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      color: #000;
      font-weight: bold;
      padding: 8px 16px;
      border-radius: 8px;
      box-shadow: 0 0 16px #00ffff;
      text-decoration: none;
      z-index: 2;
      transition: transform 0.2s, box-shadow 0.2s;
      font-family: 'Orbitron', sans-serif;
    }
    .home-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 0 32px #00ffff;
    }
    /* ç¸½æ˜Ÿæ˜Ÿé¡¯ç¤º */
    #totalStars {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(10, 20, 40, 0.85);
      padding: 8px 14px;
      border-radius: 10px;
      box-shadow: 0 0 12px #ffd700, 0 0 32px #00ffff;
      border: 2px solid #00ffff;
      color: #ffd700;
      font-size: 1.2rem;
      font-weight: bold;
      z-index: 2;
      font-family: 'Orbitron', sans-serif;
    }
    /* ç”Ÿå‘½å€¼é¡¯ç¤º */
    #lives {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(10, 20, 40, 0.85);
      padding: 8px 14px;
      border-radius: 10px;
      box-shadow: 0 0 12px #ffd700, 0 0 32px #00ffff;
      border: 2px solid #00ffff;
      color: #ffd700;
      font-size: 1.2rem;
      font-weight: bold;
      z-index: 2;
      font-family: 'Orbitron', sans-serif;
    }
    
    /* éŸ³æ¨‚æ§åˆ¶æŒ‰éˆ• */
    #audioControls {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1001;
      display: flex;
      gap: 10px;
    }
    
    #toggleMusic {
      background: rgba(10, 20, 40, 0.85);
      border: 2px solid #00ffff;
      color: #00ffff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 16px #00ffff;
    }
    
    #toggleMusic:hover {
      background: rgba(0, 255, 255, 0.2);
      transform: scale(1.1);
      box-shadow: 0 0 24px #00ffff;
    }
    
    #toggleMusic.playing {
      background: rgba(0, 255, 255, 0.2);
      border-color: #00ffff;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    

    /* æ¨™é¡Œ */
    h1 {
      margin-top: 60px;
      font-size: 2rem;
      letter-spacing: 1px;
      color: #00ffff;
      text-shadow: 0 0 12px #00ffff, 0 0 32px #a259ff;
      z-index: 2;
      font-family: 'Orbitron', sans-serif;
      text-align: center;
    }
    /* é¡Œæ•¸é¡¯ç¤º */
    #questionCount {
      margin: 10px auto;
      font-size: 1.2rem;
      color: #a0a0ff;
      text-align: center;
      z-index: 2;
      font-family: 'Orbitron', sans-serif;
      text-shadow: 0 0 6px #00ffff;
    }
    /* å–®å­—é¡¯ç¤º */
    #wordDisplay {
      margin: 20px auto;
      font-size: 2.8rem;
      font-weight: bold;
      color: #ffd700;
      text-shadow: 0 0 8px #ffd700;
      animation: glow 2s ease-in-out infinite alternate;
      z-index: 2;
      font-family: 'Orbitron', sans-serif;
      text-align: center;
    }
    @keyframes glow {
      from { text-shadow: 0 0 8px #ffd700; }
      to { text-shadow: 0 0 16px #ffd700, 0 0 32px #00ffff; }
    }
    /* è¨ˆæ™‚å™¨ */
    #timerDisplay {
      font-size: 1.1rem;
      color: #00ffff;
      margin-bottom: 15px;
      z-index: 2;
      font-family: 'Orbitron', sans-serif;
      text-align: center;
      text-shadow: 0 0 6px #00ffff;
    }
    #timerDisplay.danger { animation: flash 1s infinite; }
    @keyframes flash { 0%,100% { color: #00ffff; } 50% { color: #ff4444; } }
    /* è¼¸å…¥æ¡† */
    #answerInput {
      font-family: 'Roboto Mono', monospace;
      font-size: 1.1rem;
      padding: 12px 16px;
      border-radius: 12px;
      border: 2px solid #00ffff;
      width: 80%;
      max-width: 400px;
      background: rgba(10, 20, 40, 0.7);
      color: #fff;
      box-shadow: 0 0 16px #00ffff80;
      text-align: center;
      outline: none;
      margin-bottom: 15px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    #answerInput:focus {
      border-color: #00ffff;
      box-shadow: 0 0 32px #00ffff;
    }
    /* å›é¥‹è¨Šæ¯ */
    #feedback {
      height: 30px;
      font-size: 1.1rem;
      font-weight: bold;
      margin: 12px 0;
      z-index: 2;
      font-family: 'Orbitron', sans-serif;
      text-align: center;
      color: #ffd700;
      text-shadow: 0 0 6px #00ffff;
    }
    /* æŒ‰éˆ•åˆ— */
    .btn-row {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 20px;
      margin-bottom: 80px;
      z-index: 2;
    }
    .btn-row button {
      font-family: 'Orbitron', sans-serif;
      font-size: 1rem;
      padding: 12px 20px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      color: #000;
      font-weight: bold;
      box-shadow: 0 0 16px #00ffff, 0 0 24px #a259ff99;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-row button:hover {
      transform: scale(1.08);
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
    }
    #speakBtn { 
      background: linear-gradient(90deg, #ffd700 0%, #ffaa00 100%);
      color: #000;
    }
    /* æ¨¡æ…‹è¦–çª— - ç¾åŒ–ç‰ˆæœ¬ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      align-items: center;
      justify-content: center;
      overflow-y: auto;
      backdrop-filter: blur(8px);
      animation: modalFadeIn 0.3s ease-out;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .modal-content {
      background: linear-gradient(135deg, rgba(10, 20, 40, 0.98), rgba(20, 40, 80, 0.95));
      padding: 35px;
      border-radius: 20px;
      color: #fff;
      max-width: 600px;
      width: 90%;
      text-align: center;
      box-shadow: 
        0 0 40px #00ffff88, 
        0 0 80px #a259ff44 inset,
        0 20px 40px rgba(0, 0, 0, 0.5);
      font-family: 'Orbitron', sans-serif;
      margin: 20px;
      border: 3px solid #00ffff;
      position: relative;
      overflow: hidden;
      animation: modalSlideIn 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    
    @keyframes modalSlideIn {
      from { transform: translateY(-50px) scale(0.9); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }
    
    .modal-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #00ffff, #a259ff, #ffd700, #00ffff);
      animation: borderGlow 2s linear infinite;
    }
    
    @keyframes borderGlow {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }
    
    .modal-content h2 {
      margin-bottom: 20px;
      color: #00ffff;
      text-shadow: 0 0 15px #00ffff, 0 0 35px #a259ff;
      font-size: 1.8rem;
      font-family: 'Orbitron', sans-serif;
      font-weight: bold;
      letter-spacing: 1px;
      position: relative;
    }
    
    .modal-content h2::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, #00ffff, #a259ff);
      border-radius: 2px;
    }
    
    .modal-content p {
      margin: 12px 0;
      font-size: 1rem;
      font-family: 'Orbitron', sans-serif;
      color: #a0a0ff;
      line-height: 1.5;
    }
    
    .modal-content ul {
      list-style: none;
      padding: 0;
      max-height: 200px;
      overflow-y: auto;
      margin: 20px 0;
      text-align: left;
      font-size: 0.95rem;
      font-family: 'Roboto Mono', monospace;
      color: #fff;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 15px;
      border: 1px solid rgba(0, 255, 255, 0.2);
    }
    
    .modal-content ul li { 
      margin: 8px 0;
      padding: 8px 12px;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(162, 89, 255, 0.1));
      border-radius: 8px;
      border-left: 3px solid #00ffff;
      transition: all 0.3s ease;
    }
    
    .modal-content ul li:hover {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(162, 89, 255, 0.2));
      transform: translateX(5px);
      box-shadow: 0 2px 8px rgba(0, 255, 255, 0.3);
    }
    
    /* æ’è¡Œæ¦œè¡¨æ ¼ç¾åŒ– */
    .modal-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .modal-content th {
      background: linear-gradient(135deg, #00ffff22, #a259ff22);
      color: #00ffff;
      padding: 12px 8px;
      font-weight: bold;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 2px solid #00ffff;
    }
    
    .modal-content td {
      padding: 10px 8px;
      border-bottom: 1px solid rgba(0, 255, 255, 0.1);
      transition: background 0.3s ease;
    }
    
    .modal-content tr:hover td {
      background: rgba(0, 255, 255, 0.1);
    }
    
    /* æŒ‰éˆ•ç¾åŒ– */
    .modal-content button {
      background: linear-gradient(135deg, #00ffff 0%, #a259ff 100%);
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      color: #000;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      margin: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 255, 255, 0.3);
      font-family: 'Orbitron', sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .modal-content button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 255, 255, 0.5);
      background: linear-gradient(135deg, #00ffff 0%, #ffd700 100%);
    }
    
    .modal-content button:active {
      transform: translateY(0);
    }
    
    /* æ’è¡Œæ¦œè¼‰å…¥ç‹€æ…‹ */
    .loading {
      text-align: center;
      padding: 20px;
      color: #00ffff;
      font-family: 'Orbitron', sans-serif;
      font-size: 1.1rem;
    }
    
    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #00ffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
    /* ç¿»ç‰Œå¡ç‰‡å‹•ç•« */
    .flip-card-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 28px 18px;
      justify-content: center;
      margin: 32px auto 0 auto;
      max-width: 600px;
    }
    .flip-card {
      background: transparent;
      width: 260px;
      height: 160px;
      perspective: 1000px;
      cursor: pointer;
      margin: 0 auto;
    }
    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.7s cubic-bezier(.4,2,.6,1);
      transform-style: preserve-3d;
    }
    .flip-card.flipped .flip-card-inner {
      transform: rotateY(180deg);
    }
    .flip-card-front, .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 2rem;
      font-family: 'Orbitron', sans-serif;
      border-radius: 18px;
      box-shadow: 0 0 24px #00ffff44, 0 0 48px #a259ff22 inset;
      background: linear-gradient(135deg, #181818 60%, #00ffff22 100%);
      color: #00ffff;
      border: 2px solid #00ffff;
      user-select: none;
    }
    .flip-card-back {
      background: linear-gradient(135deg, #ffd700 60%, #a259ff22 100%);
      color: #a259ff;
      transform: rotateY(180deg);
      font-size: 2.2rem;
      font-weight: bold;
      text-shadow: 0 0 12px #ffd700, 0 0 32px #a259ff;
    }
    .practice-next-btn {
      display: block;
      margin: 28px auto 0 auto;
      font-size: 1.1rem;
      padding: 10px 32px;
      border-radius: 10px;
      background: linear-gradient(90deg,#00ffff 0%,#a259ff 100%);
      color: #000;
      font-weight: bold;
      box-shadow: 0 0 12px #00ffff;
      border: none;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .practice-next-btn:hover {
      transform: scale(1.08);
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
    }
  </style>
</head>
<body>
  <!-- éŸ³æ¨‚æ§åˆ¶ -->
  <div id="audioControls">
    <button id="toggleMusic" title="èƒŒæ™¯éŸ³æ¨‚">
      <span class="material-icons">music_note</span>
    </button>

  </div>

  <!-- èƒŒæ™¯éŸ³æ¨‚éŸ³é »å…ƒç´  -->
  <audio id="backgroundMusic" loop>
    <source src="sound/åˆå¾Œæ”¾é¬†æ™‚å…‰ï¼ˆç´”éŸ³æ¨‚ï¼‰.mp3" type="audio/mpeg">
  </audio>

  <canvas id="starfield"></canvas>
  <div id="container">
    <a href="atlas.html" class="home-btn">â† è¿”å›é¦–é </a>
    <div id="totalStars">ç¸½æ˜Ÿæ˜Ÿï¼š<span id="totalStarCount">0</span> â­</div>
    <div id="lives">â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</div>
    <h1>ğŸ§  æ˜Ÿåº§æŒ‘æˆ°ï¼š<span id="categoryName"></span></h1>
    <div id="questionCount">ç¬¬ <span id="currentQuestion">0</span> é¡Œ / 20 é¡Œ</div>
    <div id="wordDisplay">æº–å‚™ä¸­...</div>
    <div id="timerDisplay">â± æ™‚é–“ï¼š<span id="timeLeft">30</span> ç§’</div>
    <input type="text" id="answerInput" placeholder="è«‹è¼¸å…¥è‹±æ–‡..." autocomplete="off" />
    <div id="feedback"></div>
    <div class="btn-row">
      <button onclick="checkAnswer()">é€å‡º</button>
      <button onclick="nextWord()">è·³é</button>
      <button id="speakBtn" onclick="speakCurrentWord()">ğŸ”ˆ ç™¼éŸ³</button>
      <button onclick="restartGame()">ğŸ” é‡ç©</button>
    </div>

    <!-- çµç®—é¢æ¿ -->
    <div id="resultModal" class="modal">
      <div class="modal-content">
        <h2>é—œå¡çµç®—</h2>
        <p>â­ æœ¬æ¬¡åŠ æ˜Ÿæ˜Ÿï¼š<span id="sessionStars">0</span></p>
        <p>âœ… ç­”å°é¡Œæ•¸ï¼š<span id="sessionCorrect">0</span></p>
        <p>âŒ ç­”éŒ¯é¡Œæ•¸ï¼š<span id="sessionWrong">0</span></p>
        <button id="wrongBtn" onclick="showWrongModal()">éŒ¯é¡Œè¤‡ç¿’</button>
        <button onclick="showLeaderboard()">ğŸ† æ’è¡Œæ¦œ</button>
        <button onclick="restartGame()">é‡æ–°é–‹å§‹</button>
        <button onclick="goHome()">è¿”å›é¦–é </button>
      </div>
    </div>
    
    <!-- æ’è¡Œæ¦œé¢æ¿ -->
    <div id="leaderboardModal" class="modal">
      <div class="modal-content">
        <h2>ğŸ† æ˜Ÿåº§æŒ‘æˆ°æ’è¡Œæ¦œ</h2>
        <div id="leaderboardContent">
          <div class="loading">æ­£åœ¨è¼‰å…¥æ’è¡Œæ¦œ...</div>
        </div>
        <button onclick="closeLeaderboard()">é—œé–‰</button>
      </div>
    </div>
    
    <!-- éŒ¯é¡Œè¤‡ç¿’é¢æ¿ -->
    <div id="wrongModal" class="modal">
      <div class="modal-content">
        <h2>éŒ¯é¡Œè¤‡ç¿’</h2>
        <ul id="wrongItems"></ul>
        <button onclick="closeWrongModal()">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- å¤–éƒ¨å­—åº«æª”æ¡ˆ -->
  <script src="js/userData.js"></script>
  <script src="js/sound.js"></script>
  <script src="js/starRewardSystem.js"></script>
  <script src="js/vocabData.js"></script>
  <!-- æ–°å¢ï¼šå¼•å…¥å¡ç‰‡è³‡æ–™ -->
  <script src="js/cards.js"></script>
  <script src="js/achievementSystem.js"></script>
  <script>
    /***** èƒŒæ™¯éŸ³æ¨‚é€£å‹•ç³»çµ± *****/
    function initBackgroundMusic() {
      if (typeof SoundSystem !== 'undefined') {
        SoundSystem.bgm.initGlobalAudio();
        SoundSystem.bgm.updateAllControls();
      }
    }

    function playBackgroundMusic() {
      if (typeof SoundSystem !== 'undefined') {
        SoundSystem.bgm.play();
      }
    }

    function pauseBackgroundMusic() {
      if (typeof SoundSystem !== 'undefined') {
        SoundSystem.bgm.pause();
      }
    }

    function toggleBackgroundMusic() {
      if (typeof SoundSystem !== 'undefined') {
        SoundSystem.bgm.toggle();
      }
    }
    
    // === æ˜Ÿç©ºèƒŒæ™¯ç”Ÿæˆ ===
    const starCanvas = document.getElementById('starfield');
    const ctx = starCanvas.getContext('2d');
    let width = window.innerWidth, height = window.innerHeight;
    starCanvas.width = width;
    starCanvas.height = height;
    const starsBg = [];
    function initStars() {
      starsBg.length = 0;
      for (let i = 0; i < 100; i++) {
        starsBg.push({
          x: Math.random() * width,
          y: Math.random() * height,
          r: Math.random() * 1.2 + 0.3,
          alpha: Math.random(),
          twinkle: Math.random() * 5
        });
      }
    }
    function drawStars() {
      ctx.clearRect(0, 0, width, height);
      starsBg.forEach(s => {
        s.twinkle += 0.02;
        s.alpha = Math.abs(Math.sin(s.twinkle));
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255, 255, 255, ${s.alpha})`;
        ctx.fill();
      });
      requestAnimationFrame(drawStars);
    }
    window.addEventListener('resize', () => {
      width = window.innerWidth;
      height = window.innerHeight;
      starCanvas.width = width;
      starCanvas.height = height;
      initStars();
    });
    initStars();
    drawStars();

    // === TTS voices è¼‰å…¥ ===
    // ä½¿ç”¨æ–°çš„ç™¼éŸ³ç³»çµ±ï¼Œç§»é™¤èˆŠçš„èªéŸ³è¼‰å…¥é‚è¼¯

    function speak(text) {
      if (!text) return;
      isSpeaking = true;
      document.getElementById('answerInput').disabled = true;
      SoundSystem.speech.speakWord(text, function() {
        isSpeaking = false;
        document.getElementById('answerInput').disabled = false;
        document.getElementById('answerInput').focus();
      });
    }
    
    function speakCurrentWord() {
      if (!current) return;
      isSpeaking = true;
      document.getElementById('answerInput').disabled = true;
      SoundSystem.speech.speakWord(current.en, function() {
        isSpeaking = false;
        document.getElementById('answerInput').disabled = false;
        document.getElementById('answerInput').focus();
      });
    }

    // === ä½¿ç”¨å¤–éƒ¨è¼‰å…¥çš„ vocabData ===
    // å‡è¨­ js/vocabData.js æœƒå®šç¾©å…¨åŸŸè®Šæ•¸ vocabData

    // ====== åˆªé™¤ç·´ç¿’æ¨¡å¼ç‹€æ…‹èˆ‡æµç¨‹ ======
    // éŠæˆ²è®Šæ•¸
    const params = new URLSearchParams(location.search);
    const categoryKey = params.get('category') || 'aries';
    document.getElementById('categoryName').textContent = categoryKey;
    let words = vocabData[categoryKey] || [];
    words = words.slice(0, 20); // æ¯é—œæœ€å¤š 20 é¡Œ

    let current = null;
    let used = [];
    let wrongList = [];
    let correctCount = 0;
    let timer = null;
    let timeLeft = 30;
    let lives = 5;
    
    // ===== æ–°å¢ï¼šéŠæˆ²ç‹€æ…‹è¿½è¹¤ =====
    let gameStats = {
      correctCount: 0,
      totalAnswered: 0,
      consecutiveCorrect: 0, // é€£çºŒç­”å°æ¬¡æ•¸
      fastestAnswer: Infinity, // æœ€å¿«ç­”é¡Œæ™‚é–“
      slowestAnswer: 0, // æœ€æ…¢ç­”é¡Œæ™‚é–“
      totalTimeUsed: 0, // ç¸½ç”¨æ™‚
      perfectAnswers: 0, // å®Œç¾ç­”é¡Œæ¬¡æ•¸ï¼ˆ15ç§’å…§ç­”å°ï¼‰
      startTime: Date.now()
    };
    
    // ===== æ–°å¢ï¼šç­”é¡Œè™•ç†ç‹€æ…‹ =====
    let isProcessingAnswer = false; // æ˜¯å¦æ­£åœ¨è™•ç†ç­”é¡Œ
    // ===== æ–°å¢ï¼šç™¼éŸ³é–å®šç‹€æ…‹ =====
    let isSpeaking = false; // æ˜¯å¦æ­£åœ¨ç™¼éŸ³

    // å¾ localStorage å–ç¸½æ˜Ÿæ˜Ÿï¼Œè‹¥ç„¡å‰‡ç‚º 0
    let totalStarCount = parseInt(localStorage.getItem('totalStars') || '0', 10);
    function updateTotal() {
      // ä½¿ç”¨é€£å‹•ç³»çµ±ç²å–æœ€æ–°çš„æ˜Ÿæ˜Ÿæ•¸é‡
      if (typeof LinkageSystem !== 'undefined') {
        totalStarCount = LinkageSystem.stars.get();
      } else if (typeof StarRewardSystem !== 'undefined') {
        // å¦‚æœä½¿ç”¨ StarRewardSystemï¼Œå¾å®ƒç²å–æ˜Ÿæ˜Ÿæ•¸é‡
        totalStarCount = StarRewardSystem.getTotalStars ? StarRewardSystem.getTotalStars() : totalStarCount;
      }
      document.getElementById('totalStarCount').textContent = totalStarCount;
    }

    function updateLives() {
      const livesDiv = document.getElementById('lives');
      livesDiv.innerHTML = 'â¤ï¸'.repeat(lives) + 'ğŸ¤'.repeat(5 - lives);
    }

    function updateQuestionCount() {
      document.getElementById('currentQuestion').textContent = used.length;
    }
    
    // ===== æ–°å¢ï¼šæ˜Ÿæ˜Ÿçå‹µè¨ˆç®—å‡½æ•¸ =====
    function calculateStarReward(isCorrect, answerTime, consecutiveCount, wordLength) {
      if (!isCorrect) return 0;
      
      let baseReward = 1; // åŸºç¤çå‹µ
      let comboReward = 0; // é€£æ“Šçå‹µ
      
      // é€£æ“Šçå‹µï¼šé€£çºŒç­”å°è¶Šå¤šçå‹µè¶Šå¤š
      if (consecutiveCount >= 5) {
        comboReward = 2; // 5é€£æ“Š +2æ˜Ÿ
      } else if (consecutiveCount >= 3) {
        comboReward = 1; // 3é€£æ“Š +1æ˜Ÿ
      } else if (consecutiveCount >= 2) {
        comboReward = 1; // 2é€£æ“Š +1æ˜Ÿ
      }
      
      // è¨ˆç®—ç¸½çå‹µï¼šåŸºç¤1æ˜Ÿ + é€£æ“Šçå‹µ
      let totalReward = baseReward + comboReward;
      
      return totalReward;
    }
    
    // ===== æ–°å¢ï¼šé¡¯ç¤ºçå‹µå‹•ç•« =====
    function showRewardAnimation(starsEarned, reason = '') {
      const rewardDiv = document.createElement('div');
      rewardDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.95), rgba(255, 170, 0, 0.95));
        color: #000;
        padding: 20px 30px;
        border-radius: 15px;
        font-size: 1.5rem;
        font-weight: bold;
        z-index: 1000;
        box-shadow: 0 0 30px #ffd700;
        animation: rewardPop 1.2s ease-out forwards;
        font-family: 'Orbitron', sans-serif;
        text-align: center;
        min-width: 300px;
      `;
      
      let reasonText = '';
      if (reason) {
        reasonText = `<div style="font-size: 1rem; margin-top: 8px; color: #666;">${reason}</div>`;
      }
      
      rewardDiv.innerHTML = `
        <div style="font-size: 3rem; margin-bottom: 10px;">â­</div>
        <div style="font-size: 1.8rem; margin-bottom: 5px;">+${starsEarned} æ˜Ÿæ˜Ÿ</div>
        ${reasonText}
      `;
      
      // æ·»åŠ å‹•ç•«æ¨£å¼
      const style = document.createElement('style');
      style.textContent = `
        @keyframes rewardPop {
          0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
          50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
          100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(rewardDiv);
      
      // æ’­æ”¾æ˜Ÿæ˜ŸéŸ³æ•ˆ
      if (typeof StarRewardSystem !== 'undefined') {
        StarRewardSystem.playStarSound();
      }
      
      // 3.5ç§’å¾Œç§»é™¤
      setTimeout(() => {
        if (document.body.contains(rewardDiv)) {
          document.body.removeChild(rewardDiv);
        }
        if (document.head.contains(style)) {
          document.head.removeChild(style);
        }
      }, 3500);
    }
    
    // ===== æ–°å¢ï¼šé¡¯ç¤ºé€£æ“Šé€šçŸ¥ =====
    function showComboNotification(comboCount) {
      if (comboCount < 2) return;
      
      const comboDiv = document.createElement('div');
      comboDiv.style.cssText = `
        position: fixed;
        top: 20%;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, rgba(255, 69, 0, 0.9), rgba(255, 140, 0, 0.9));
        color: #fff;
        padding: 15px 25px;
        border-radius: 25px;
        font-size: 1.2rem;
        font-weight: bold;
        z-index: 1000;
        box-shadow: 0 0 20px #ff4500;
        animation: comboSlide 0.8s ease-out forwards;
        font-family: 'Orbitron', sans-serif;
      `;
      
      let comboText = '';
      let comboIcon = '';
      
      if (comboCount >= 5) {
        comboText = `${comboCount} é€£æ“Šï¼ğŸ”¥ ç„¡æ•µé€£æ“Šï¼`;
        comboIcon = 'ğŸ”¥';
      } else if (comboCount >= 3) {
        comboText = `${comboCount} é€£æ“Šï¼âš¡ è¶…å¼·é€£æ“Šï¼`;
        comboIcon = 'âš¡';
      } else {
        comboText = `${comboCount} é€£æ“Šï¼âœ¨ é€£æ“Šé–‹å§‹ï¼`;
        comboIcon = 'âœ¨';
      }
      
      comboDiv.innerHTML = `${comboIcon} ${comboText} ${comboIcon}`;
      
      // æ·»åŠ å‹•ç•«æ¨£å¼
      const style = document.createElement('style');
      style.textContent = `
        @keyframes comboSlide {
          0% { transform: translateX(-50%) translateY(-100%); opacity: 0; }
          50% { transform: translateX(-50%) translateY(0); opacity: 1; }
          100% { transform: translateX(-50%) translateY(0); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(comboDiv);
      
      // 4ç§’å¾Œç§»é™¤
      setTimeout(() => {
        if (document.body.contains(comboDiv)) {
          document.body.removeChild(comboDiv);
        }
        if (document.head.contains(style)) {
          document.head.removeChild(style);
        }
      }, 4000);
    }

    function showResultPanel() {
      // æœ¬æ¬¡æ˜Ÿæ˜Ÿå·²åœ¨checkAnswerç´¯åŠ ï¼Œä¸éœ€è¦å†æ¬¡è¨­ç½®
      document.getElementById('sessionStars').textContent = correctCount * 2;
      document.getElementById('sessionCorrect').textContent = correctCount;
      document.getElementById('sessionWrong').textContent = wrongList.length;
      document.getElementById('wrongBtn').style.display = wrongList.length ? 'inline-block' : 'none';
      document.getElementById('resultModal').style.display = 'flex';
      disablePlay();
      
      // åªåœ¨æ²’æœ‰ä½¿ç”¨å¤–éƒ¨æ˜Ÿæ˜Ÿç³»çµ±æ™‚æ›´æ–°ç¸½æ˜Ÿæ˜Ÿé¡¯ç¤º
      if (typeof StarRewardSystem === 'undefined' && typeof LinkageSystem === 'undefined') {
        updateTotal();
      }

      // è©•åˆ†èˆ‡åˆ†æ•¸
      const score = correctCount * 2;
      let rating = '';
      if (correctCount === 20) rating = 'ğŸŒŸ æ»¿åˆ†é«˜æ‰‹ï¼';
      else if (correctCount >= 16) rating = 'ğŸ‰ å¾ˆæ£’ï¼Œç¹¼çºŒåŠ æ²¹ï¼';
      else if (correctCount >= 10) rating = 'ğŸ‘ é‚„ä¸éŒ¯ï¼Œå†åŠªåŠ›ï¼';
      else if (correctCount >= 5) rating = 'ğŸ’¡ å¤šå¤šç·´ç¿’æœƒæ›´å¥½ï¼';
      else rating = 'ğŸ“ å»ºè­°å¤šè¤‡ç¿’å–®å­—ï¼';

      // ====== æ–°å¢ï¼šé€šé—œåˆ¤æ–·èˆ‡å„²å­˜ ======
      if (correctCount === 20 || correctCount >= 16) {
        let passed = JSON.parse(localStorage.getItem('passed_atlas')||'[]');
        if (!passed.includes(categoryKey)) {
          passed.push(categoryKey);
          localStorage.setItem('passed_atlas', JSON.stringify(passed));
        }
      }

      // å–å¾—ä¸Šæ¬¡åˆ†æ•¸
      let lastScore = parseInt(localStorage.getItem('lastScore') || '0', 10);
      let compare = '';
      if (lastScore === 0) compare = 'ï¼ˆé¦–æ¬¡éŠç©ï¼‰';
      else if (score > lastScore) compare = 'â¬†ï¸ æœ‰é€²æ­¥ï¼';
      else if (score < lastScore) compare = 'â¬‡ï¸ æœ‰é€€æ­¥';
      else compare = 'â¡ï¸ æŒå¹³';
      localStorage.setItem('lastScore', score);

      // é¡¯ç¤ºæ‰€æœ‰éŒ¯é¡Œåˆ—è¡¨
      let wrongListHtml = '';
      if (wrongList.length > 0) {
        wrongListHtml = '<ul style="max-height:120px;overflow-y:auto;text-align:left;font-size:1rem;margin:10px 0 0 0;padding:0 10px 0 20px;">';
        wrongList.forEach(item => {
          wrongListHtml += `<li>âŒ <b>${item.zh}</b> â†’ <span style='color:#ffd700;'>${item.en}</span></li>`;
        });
        wrongListHtml += '</ul>';
      } else {
        wrongListHtml = '<div style="color:#0f0;margin-top:10px;">æœ¬æ¬¡ç„¡éŒ¯é¡Œï¼</div>';
      }
      // æ’å…¥åˆ°çµç®—é¢æ¿ï¼ˆsessionWrongä¸‹æ–¹ï¼‰
      const resultModal = document.getElementById('resultModal').querySelector('.modal-content');
      let wrongListDiv = document.getElementById('wrongListAll');
      if (!wrongListDiv) {
        wrongListDiv = document.createElement('div');
        wrongListDiv.id = 'wrongListAll';
        resultModal.appendChild(wrongListDiv);
      }
      wrongListDiv.innerHTML = wrongListHtml;

      // æ’å…¥åˆ†æ•¸ã€è©•åƒ¹ã€é€²æ­¥
      let scoreDiv = document.getElementById('scoreInfo');
      if (!scoreDiv) {
        scoreDiv = document.createElement('div');
        scoreDiv.id = 'scoreInfo';
        resultModal.insertBefore(scoreDiv, wrongListDiv);
      }
      scoreDiv.innerHTML = `<div style='margin:10px 0 0 0;font-size:1.2rem;'>æœ¬æ¬¡åˆ†æ•¸ï¼š<b style='color:#ffd700;'>${score}</b> åˆ†<br>${rating} <span style='font-size:1rem;color:#00ffff;'>${compare}</span></div>`;

      // ====== æ–°å¢ï¼šæˆå°±ç³»çµ±é€£å‹• ======
      updateQuizAchievements();
      
      // ====== æ–°å¢ï¼šè‡ªå‹•æäº¤åˆ†æ•¸åˆ°æ’è¡Œæ¦œ ======
      submitScoreToLeaderboard();
    }

    // ====== æ–°å¢ï¼šæˆå°±ç³»çµ±å‡½æ•¸ =====
    function updateQuizAchievements() {
      // æ›´æ–°æ˜Ÿåº§æŒ‘æˆ°å®Œæˆæ¬¡æ•¸
      const quizGames = parseInt(localStorage.getItem('quizGamesCompleted') || '0');
      localStorage.setItem('quizGamesCompleted', quizGames + 1);
      
      // æª¢æŸ¥ä¸¦æ›´æ–°ç›¸é—œæˆå°±
      checkAndUpdateQuizAchievements();
    }
    
    // ===== æ–°å¢ï¼šGoogle Sheets æ’è¡Œæ¦œç³»çµ± =====
    const GOOGLE_SHEETS_API = "https://script.google.com/macros/s/AKfycbxg_xEZZd94RUsLXWvMokPN1LWQ288llpraGLSDRHYZAsYfMds3lS3vB999jS6z6ks9/exec";
    const LEADERBOARD_SHEET_ID = "11kMAXtBxLICMUYysPLP1noZzTsjbfXmbRcZSKK8_6cw";
    
    // é¡¯ç¤ºæ’è¡Œæ¦œ
    function showLeaderboard() {
      document.getElementById('leaderboardModal').style.display = 'flex';
      loadLeaderboard();
    }
    
    // é—œé–‰æ’è¡Œæ¦œ
    function closeLeaderboard() {
      document.getElementById('leaderboardModal').style.display = 'none';
    }
    
    // è¼‰å…¥æ’è¡Œæ¦œæ•¸æ“š
    async function loadLeaderboard() {
      const content = document.getElementById('leaderboardContent');
      content.innerHTML = '<div class="loading">æ­£åœ¨è¼‰å…¥æ’è¡Œæ¦œ...</div>';
      
      try {
        // æ–¹æ³•1ï¼šå˜—è©¦å¾ Google Apps Script API ç²å–æ•¸æ“š
        const formData = new URLSearchParams();
        formData.append('action', 'getLeaderboard');
        
        const response = await fetch(GOOGLE_SHEETS_API, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: formData.toString()
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.leaderboard) {
            displayLeaderboard(data.leaderboard);
            return;
          }
        }
        
        // æ–¹æ³•2ï¼šå¦‚æœ API å¤±æ•—ï¼Œé¡¯ç¤ºæ¸¬è©¦æ•¸æ“š
        console.log('API èª¿ç”¨å¤±æ•—ï¼Œé¡¯ç¤ºæ¸¬è©¦æ•¸æ“š');
        const testData = [
          { rank: 1, playerName: 'æ¸¬è©¦ç©å®¶1', score: 40, correctCount: 20, category: 'aries', date: '2024/1/15' },
          { rank: 2, playerName: 'æ¸¬è©¦ç©å®¶2', score: 36, correctCount: 18, category: 'taurus', date: '2024/1/15' },
          { rank: 3, playerName: 'æ¸¬è©¦ç©å®¶3', score: 32, correctCount: 16, category: 'gemini', date: '2024/1/14' }
        ];
        displayLeaderboard(testData);
        
      } catch (error) {
        console.error('è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', error);
        content.innerHTML = `
          <div style="color: #ff6b6b; text-align: center; padding: 30px; background: rgba(255, 107, 107, 0.1); border-radius: 15px; border: 2px solid #ff6b6b;">
            <div style="font-size: 3rem; margin-bottom: 15px; animation: pulse 2s infinite;">âš ï¸</div>
            <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—</div>
            <div style="font-size: 0.9rem; margin-top: 15px; color: #ff9999; background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 8px;">
              <strong>éŒ¯èª¤ï¼š</strong>${error.message}
            </div>
            <div style="font-size: 0.9rem; margin-top: 10px; color: #ccc;">
              è«‹æª¢æŸ¥ Google Apps Script è¨­ç½®
            </div>
          </div>
        `;
      }
    }
    
    // é¡¯ç¤ºæ’è¡Œæ¦œ
    function displayLeaderboard(data) {
      const content = document.getElementById('leaderboardContent');
      
      if (data.length === 0) {
        content.innerHTML = `
          <div style="text-align: center; padding: 30px; color: #666; background: rgba(0, 255, 255, 0.1); border-radius: 15px; border: 2px solid rgba(0, 255, 255, 0.3);">
            <div style="font-size: 3rem; margin-bottom: 15px; animation: bounce 2s infinite;">ğŸ“Š</div>
            <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #00ffff;">ç›®å‰é‚„æ²’æœ‰æ’è¡Œæ¦œæ•¸æ“š</div>
            <div style="font-size: 1rem; margin-top: 15px; color: #a0a0ff;">
              ğŸ¯ æˆç‚ºç¬¬ä¸€å€‹ä¸Šæ¦œçš„ç©å®¶å§ï¼
            </div>
          </div>
        `;
        return;
      }
      
      let html = `
        <div style="max-height: 350px; overflow-y: auto; margin-bottom: 20px; border-radius: 12px; background: rgba(0, 0, 0, 0.2); padding: 10px;">
          <table style="width: 100%; border-collapse: collapse; font-family: 'Orbitron', sans-serif;">
            <thead>
              <tr>
                <th style="padding: 12px 8px; text-align: center; color: #00ffff; border-bottom: 2px solid #00ffff; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">æ’å</th>
                <th style="padding: 12px 8px; text-align: left; color: #00ffff; border-bottom: 2px solid #00ffff; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">ç©å®¶</th>
                <th style="padding: 12px 8px; text-align: center; color: #00ffff; border-bottom: 2px solid #00ffff; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">åˆ†æ•¸</th>
                <th style="padding: 12px 8px; text-align: center; color: #00ffff; border-bottom: 2px solid #00ffff; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">ç­”å°</th>
                <th style="padding: 12px 8px; text-align: center; color: #00ffff; border-bottom: 2px solid #00ffff; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">æ˜Ÿåº§</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      data.slice(0, 20).forEach((item, index) => {
        const isTop3 = index < 3;
        const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${item.rank}`;
        const rowStyle = isTop3 ? 
          `background: linear-gradient(90deg, ${index === 0 ? '#ffd70022' : index === 1 ? '#c0c0c022' : '#cd7f3222'}, transparent);` : '';
        
        html += `
          <tr style="${rowStyle}; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(0, 255, 255, 0.1)'" onmouseout="this.style.background='${rowStyle}'">
            <td style="padding: 10px 8px; text-align: center; font-weight: bold; color: ${isTop3 ? '#ffd700' : '#fff'}; font-size: 1.1rem;">
              ${rankIcon}
            </td>
            <td style="padding: 10px 8px; text-align: left; color: #fff; font-weight: 500;">
              ${item.playerName}
            </td>
            <td style="padding: 10px 8px; text-align: center; color: #ffd700; font-weight: bold; font-size: 1.1rem;">
              ${item.score}
            </td>
            <td style="padding: 10px 8px; text-align: center; color: #0f0; font-weight: 500;">
              ${item.correctCount}/20
            </td>
            <td style="padding: 10px 8px; text-align: center; color: #a0a0ff; font-size: 0.9rem; font-style: italic;">
              ${item.category}
            </td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
        <div style="text-align: center; font-size: 0.9rem; color: #666; margin-top: 15px; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
          <span style="color: #00ffff;">ğŸ“Š</span> é¡¯ç¤ºå‰ 20 åç©å®¶
        </div>
      `;
      
      content.innerHTML = html;
    }
    
    // æäº¤åˆ†æ•¸åˆ°æ’è¡Œæ¦œ
    async function submitScoreToLeaderboard() {
      const playerName = localStorage.getItem('playerName') || 'åŒ¿åç©å®¶';
      const score = correctCount * 2;
      const category = categoryKey;
      const date = new Date().toLocaleDateString('zh-TW');
      
      try {
        const formData = new URLSearchParams();
        formData.append('action', 'addQuizScore');
        formData.append('playerName', playerName);
        formData.append('score', score.toString());
        formData.append('correctCount', correctCount.toString());
        formData.append('category', category);
        formData.append('date', date);
        
        const response = await fetch(GOOGLE_SHEETS_API, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: formData.toString()
        });
        
        if (response.ok) {
          console.log('åˆ†æ•¸å·²æˆåŠŸæäº¤åˆ°æ’è¡Œæ¦œ');
        } else {
          console.error('æäº¤åˆ†æ•¸å¤±æ•—');
        }
      } catch (error) {
        console.error('æäº¤åˆ†æ•¸æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      }
    }
    
    function checkAndUpdateQuizAchievements() {
      // æª¢æŸ¥æ˜¯å¦æœ‰æ–°æˆå°±é”æˆ
      const achievements = [
        { id: 'speed_learner', name: 'å¿«é€Ÿå­¸ç¿’è€…', requirement: 10 },
        { id: 'accuracy_master', name: 'æº–ç¢ºå¤§å¸«', requirement: 20 },
        { id: 'combo_king', name: 'é€£æ“Šä¹‹ç‹', requirement: 15 }
      ];
      
      const claimed = JSON.parse(localStorage.getItem('claimedAchievements') || '[]');
      
      achievements.forEach(ach => {
        if (claimed.includes(ach.id)) return; // å·²ç¶“é ˜å–éäº†
        
        // è¨ˆç®—é€šéçš„é—œå¡æ•¸é‡
        const fillGames = parseInt(localStorage.getItem('fillGamesCompleted') || '0');
        const cardGames = parseInt(localStorage.getItem('cardGamesCompleted') || '0');
        const quizGames = parseInt(localStorage.getItem('quizGamesCompleted') || '0');
        const spellingGames = parseInt(localStorage.getItem('spellingGamesCompleted') || '0');
        const matchingGames = parseInt(localStorage.getItem('matchingGamesCompleted') || '0');
        const totalGames = fillGames + cardGames + quizGames + spellingGames + matchingGames;
        
        if (totalGames >= ach.requirement) {
          // é¡¯ç¤ºæˆå°±é”æˆé€šçŸ¥
          showAchievementNotification(ach.name, ach.id);
        }
      });
    }
    
    function showAchievementNotification(achievementName, achievementId) {
      // å‰µå»ºæˆå°±é€šçŸ¥
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #ffd700, #ffed4e);
        color: #000;
        padding: 20px 30px;
        border-radius: 15px;
        font-weight: bold;
        font-size: 1.2rem;
        z-index: 10000;
        box-shadow: 0 0 30px #ffd700;
        animation: achievementPop 0.8s cubic-bezier(.68, -0.55, .27, 1.55);
        text-align: center;
        min-width: 300px;
      `;
      
      notification.innerHTML = `
        <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ†</div>
        <div style="margin-bottom: 5px;">ğŸ‰ æˆå°±é”æˆï¼</div>
        <div style="font-size: 1.1rem;">${achievementName}</div>
        <div style="font-size: 0.9rem; margin-top: 10px; color: #666;">
          å‰å¾€æˆå°±é é¢é ˜å–çå‹µ
        </div>
      `;
      
      // æ·»åŠ å‹•ç•«æ¨£å¼
      const style = document.createElement('style');
      style.textContent = `
        @keyframes achievementPop {
          0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
          50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
          100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(notification);
      
      // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
      setTimeout(() => {
        notification.remove();
        style.remove();
      }, 3000);
    }

    function disablePlay() {
      document.getElementById('answerInput').disabled = true;
      document.querySelectorAll('.btn-row button').forEach(btn => btn.disabled = true);
    }
    function enablePlay() {
      document.getElementById('answerInput').disabled = false;
      document.querySelectorAll('.btn-row button').forEach(btn => btn.disabled = false);
    }

    function showWrongModal() {
      if (!wrongList.length) return;
      // å•Ÿå‹•è¤‡ç¿’æ¨¡å¼
      startReviewMode();
    }
    
    // ===== è¤‡ç¿’æ¨¡å¼ =====
    let reviewList = [];
    let reviewIndex = 0;
    let inReviewMode = false;

    function startReviewMode() {
      reviewList = wrongList.slice();
      reviewIndex = 0;
      inReviewMode = true;
      // ä¸è¦æ¨¡ç³Šä¸»ç•«é¢
      // document.getElementById('container').style.filter = 'blur(2px)';
      document.getElementById('wrongModal').style.display = 'flex';
      showReviewQuestion();
    }

    function showReviewQuestion() {
      const list = document.getElementById('wrongItems');
      list.innerHTML = '';
      if (reviewIndex >= reviewList.length) {
        // è¤‡ç¿’çµæŸ
        const li = document.createElement('li');
        li.textContent = 'ğŸ‰ è¤‡ç¿’å®Œæˆï¼';
        list.appendChild(li);
        document.getElementById('answerInput').disabled = true;
        return;
      }
      const item = reviewList[reviewIndex];
      const li = document.createElement('li');
      li.innerHTML = `<span style='color:#ffd700;font-weight:bold;'>${item.zh}</span> <input id='reviewInput' type='text' style='font-size:1rem;padding:4px 8px;border-radius:6px;border:1px solid #00ffff;width:120px;margin-left:8px;' autocomplete='off' /> <span id='reviewFeedback'></span>`;
      list.appendChild(li);
      document.getElementById('reviewInput').focus();
      document.getElementById('reviewInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') checkReviewAnswer();
      });
    }

    function checkReviewAnswer() {
      const item = reviewList[reviewIndex];
      const input = document.getElementById('reviewInput');
      const feedback = document.getElementById('reviewFeedback');
      if (!input) return;
      if (input.value.trim().toLowerCase() === item.en.toLowerCase()) {
        feedback.textContent = 'âœ… æ­£ç¢º';
        feedback.style.color = '#0f0';
        setTimeout(() => {
          reviewIndex++;
          showReviewQuestion();
        }, 600);
      } else {
        feedback.textContent = `âŒ æ­£è§£ï¼š${item.en}`;
        feedback.style.color = '#f66';
        setTimeout(() => {
          reviewIndex++;
          showReviewQuestion();
        }, 1200);
      }
    }

    function closeWrongModal() {
      document.getElementById('wrongModal').style.display = 'none';
      // document.getElementById('container').style.filter = '';
      inReviewMode = false;
      document.getElementById('answerInput').disabled = false;
    }

    function goHome() {
      location.href = 'atlas.html';
    }

    // ===== æ–°å¢ï¼šè¨ˆæ™‚å™¨å‡½æ•¸ =====
    function startTimer() {
      timeLeft = 30;
      document.getElementById('timeLeft').textContent = timeLeft;
      document.getElementById('timerDisplay').classList.remove('danger');
      
      if (timer) {
        clearInterval(timer);
      }
      
      timer = setInterval(() => {
        timeLeft--;
        document.getElementById('timeLeft').textContent = timeLeft;
        
        // æ™‚é–“ä¸è¶³æ™‚é¡¯ç¤ºè­¦å‘Š
        if (timeLeft <= 10) {
          document.getElementById('timerDisplay').classList.add('danger');
        }
        
        // æ™‚é–“åˆ°
        if (timeLeft <= 0) {
          clearInterval(timer);
          // æ™‚é–“åˆ°ç®—ç­”éŒ¯
          document.getElementById('feedback').textContent = `â° æ™‚é–“åˆ°ï¼æ­£è§£æ˜¯ï¼š${current.en}`;
          document.getElementById('feedback').style.color = '#f66';
          SoundSystem.play('wrong');
          wrongList.push(current);
          lives--;
          gameStats.consecutiveCorrect = 0; // é‡ç½®é€£æ“Š
          
          updateLives();
          if (lives <= 0) {
            setTimeout(() => {
              showResultPanel();
              isProcessingAnswer = false; // é‡ç½®è™•ç†ç‹€æ…‹
            }, 800);
          } else {
            setTimeout(() => {
              nextWord();
              isProcessingAnswer = false; // é‡ç½®è™•ç†ç‹€æ…‹
            }, 800);
          }
        }
      }, 1000);
    }

    function nextWord() {
      isProcessingAnswer = false; // é‡ç½®è™•ç†ç‹€æ…‹
      if (used.length >= words.length) {
        document.getElementById('wordDisplay').textContent = 'âœ… æŒ‘æˆ°å®Œæˆ';
        clearInterval(timer);
        showResultPanel();
        return;
      }
      // è·³éä¹Ÿè¦æ‰£æ„›å¿ƒä¸¦ç®—éŒ¯é¡Œ
      if (used.length > 0 && document.getElementById('answerInput').value === '') { // åªæœ‰è·³éæ‰æ‰£æ„›å¿ƒ
        lives--;
        updateLives();
        wrongList.push(current);
        gameStats.consecutiveCorrect = 0; // è·³éä¹Ÿé‡ç½®é€£æ“Š
        if (lives <= 0) {
          clearInterval(timer);
          showResultPanel();
          return;
        }
      }
      const available = words.filter(w => !used.includes(w.en));
      current = available[Math.floor(Math.random() * available.length)];
      used.push(current.en);
      updateQuestionCount();
      document.getElementById('wordDisplay').textContent = current.zh;
      document.getElementById('answerInput').value = '';
      document.getElementById('feedback').textContent = '';
      isSpeaking = true;
      document.getElementById('answerInput').disabled = true;
      SoundSystem.speech.speakWord(current.en, function() {
        isSpeaking = false;
        document.getElementById('answerInput').disabled = false;
        document.getElementById('answerInput').focus();
      });
      startTimer();
      document.getElementById('resultModal').style.display = 'none';
      document.getElementById('wrongModal').style.display = 'none';
      enablePlay();
      updateLives();
    }

    function checkAnswer() {
      if (!current || isProcessingAnswer) return; // å¦‚æœæ­£åœ¨è™•ç†ç­”é¡Œï¼Œç›´æ¥è¿”å›
      isProcessingAnswer = true; // è¨­ç½®æ­£åœ¨è™•ç†ç­”é¡Œç‹€æ…‹
      const ans = document.getElementById('answerInput').value.trim().toLowerCase();
      
      // ===== æ–°å¢ï¼šè¨ˆç®—ç­”é¡Œæ™‚é–“ =====
      const answerTime = (30 - timeLeft); // 30ç§’å€’è¨ˆæ™‚ï¼Œæ‰€ä»¥ç”¨30æ¸›å»å‰©é¤˜æ™‚é–“
      gameStats.totalAnswered++;
      gameStats.totalTimeUsed += answerTime;
      
      if (ans === current.en.toLowerCase()) {
        document.getElementById('feedback').textContent = 'âœ… æ­£ç¢º';
        document.getElementById('feedback').style.color = '#0f0';
        SoundSystem.play('correct');
        correctCount++;
        
        // ===== æ–°å¢ï¼šç­”å°é‚è¼¯ =====
        gameStats.correctCount++;
        gameStats.consecutiveCorrect++;
        
        // æ›´æ–°æœ€å¿«/æœ€æ…¢ç­”é¡Œæ™‚é–“
        if (answerTime < gameStats.fastestAnswer) {
          gameStats.fastestAnswer = answerTime;
        }
        if (answerTime > gameStats.slowestAnswer) {
          gameStats.slowestAnswer = answerTime;
        }
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºå®Œç¾ç­”é¡Œï¼ˆ15ç§’å…§ç­”å°ï¼‰
        if (answerTime <= 15) {
          gameStats.perfectAnswers++;
        }
        
        // è¨ˆç®—æ˜Ÿæ˜Ÿçå‹µ
        const starsEarned = calculateStarReward(true, answerTime, gameStats.consecutiveCorrect, current.en.length);
        
        // åªä½¿ç”¨ä¸€å€‹æ˜Ÿæ˜Ÿç³»çµ±ï¼Œé¿å…é‡è¤‡åŠ æ˜Ÿæ˜Ÿ
        if (typeof StarRewardSystem !== 'undefined') {
          StarRewardSystem.addStars(starsEarned);
        } else if (typeof LinkageSystem !== 'undefined') {
          LinkageSystem.stars.add(starsEarned);
        } else {
          totalStarCount += starsEarned;
          localStorage.setItem('totalStars', totalStarCount);
        }
        
        // æ›´æ–°é¡¯ç¤ºï¼ˆåªåœ¨æ²’æœ‰ä½¿ç”¨å¤–éƒ¨ç³»çµ±æ™‚æ›´æ–°ï¼‰
        if (typeof StarRewardSystem === 'undefined' && typeof LinkageSystem === 'undefined') {
          updateTotal();
        }
        
        // é¡¯ç¤ºçå‹µå‹•ç•«
        let reasonText = '';
        if (gameStats.consecutiveCorrect >= 3) {
          reasonText = 'ğŸ”¥ é€£æ“Šçå‹µï¼';
        }
        
        // showRewardAnimation(starsEarned, reasonText); // ç§»é™¤é€™ä¸€è¡Œï¼Œçµ±ä¸€ç”± StarRewardSystem è™•ç†å½ˆçª—å‹•ç•«
        
        // é¡¯ç¤ºé€£æ“Šé€šçŸ¥
        showComboNotification(gameStats.consecutiveCorrect);
        
        // ===== æ–°å¢ï¼šè¨˜éŒ„ç­”å°çš„å–®å­— =====
        if (typeof VocabularyAchievementSystem !== 'undefined') {
          VocabularyAchievementSystem.recordCorrectWord(current.en, categoryKey);
        }
        
        clearInterval(timer);
        setTimeout(() => {
          nextWord();
          isProcessingAnswer = false; // é‡ç½®è™•ç†ç‹€æ…‹
        }, 800);
      } else {
        document.getElementById('feedback').textContent = `âŒ æ­£è§£æ˜¯ï¼š${current.en}`;
        document.getElementById('feedback').style.color = '#f66';
        SoundSystem.play('wrong');
        wrongList.push(current);
        lives--;
        
        // ===== æ–°å¢ï¼šç­”éŒ¯é‚è¼¯ =====
        gameStats.consecutiveCorrect = 0; // é‡ç½®é€£æ“Š
        
        updateLives();
        clearInterval(timer);
        if (lives <= 0) {
          setTimeout(() => {
            showResultPanel();
            isProcessingAnswer = false; // é‡ç½®è™•ç†ç‹€æ…‹
          }, 800);
        } else {
          setTimeout(() => {
            nextWord();
            isProcessingAnswer = false; // é‡ç½®è™•ç†ç‹€æ…‹
          }, 800);
        }
      }
    }

    function restartGame() {
      used = [];
      wrongList = [];
      correctCount = 0;
      lives = 5;
      isProcessingAnswer = false; // é‡ç½®è™•ç†ç‹€æ…‹
      gameStats = {
        correctCount: 0,
        totalAnswered: 0,
        consecutiveCorrect: 0,
        fastestAnswer: Infinity,
        slowestAnswer: 0,
        totalTimeUsed: 0,
        perfectAnswers: 0,
        startTime: Date.now()
      };
      document.getElementById('currentQuestion').textContent = '0';
      document.getElementById('resultModal').style.display = 'none';
      document.getElementById('wrongModal').style.display = 'none';
      updateLives();
      nextWord();
    }

    // ===== é é¢åˆå§‹åŒ– =====
    document.addEventListener('DOMContentLoaded', function() {
      // åˆå§‹åŒ–éŸ³æ•ˆç³»çµ±
      if (typeof SoundSystem !== 'undefined') {
        SoundSystem.init();
      }
      
      // åˆå§‹åŒ–éŸ³æ¨‚ç³»çµ±
      setTimeout(() => {
        initBackgroundMusic();
        
        // ç¶å®šéŸ³æ¨‚æ§åˆ¶æŒ‰éˆ•äº‹ä»¶
        const musicBtn = document.getElementById('toggleMusic');
        if (musicBtn) {
          musicBtn.addEventListener('click', toggleBackgroundMusic);
          console.log('ğŸµ éŸ³æ¨‚æ§åˆ¶æŒ‰éˆ•äº‹ä»¶å·²ç¶å®š');
        }
        
        // æ·»åŠ ç”¨æˆ¶äº’å‹•è§¸ç™¼éŸ³æ¨‚æ’­æ”¾
        let hasUserInteracted = false;
        
        function handleUserInteraction() {
          if (!hasUserInteracted) {
            hasUserInteracted = true;
            console.log('ğŸ‘† ç”¨æˆ¶äº’å‹•è§¸ç™¼ï¼ŒéŸ³æ¨‚ç³»çµ±å·²å•Ÿç”¨');
            
            // å¦‚æœæ‡‰è©²æ’­æ”¾ä½†é‚„æ²’æ’­æ”¾ï¼Œå˜—è©¦æ’­æ”¾
            if (isMusicPlaying && backgroundMusic && backgroundMusic.paused) {
              playBackgroundMusic();
            }
          }
        }
        
        // ç›£è½å„ç¨®ç”¨æˆ¶äº’å‹•äº‹ä»¶
        ['click', 'touchstart', 'keydown'].forEach(eventType => {
          document.addEventListener(eventType, handleUserInteraction, { once: true });
        });
      }, 500);
      
      // ç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–ï¼Œè™•ç†éŸ³æ¨‚æš«åœ/æ¢å¾©
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          // é é¢éš±è—æ™‚æš«åœéŸ³æ¨‚
          if (isMusicPlaying && backgroundMusic) {
            backgroundMusic.pause();
          }
        } else {
          // é é¢é¡¯ç¤ºæ™‚æ¢å¾©éŸ³æ¨‚
          if (isMusicPlaying && backgroundMusic && backgroundMusic.paused) {
            backgroundMusic.play().catch(err => {
              console.log('é é¢æ¢å¾©æ™‚éŸ³æ¨‚æ’­æ”¾å¤±æ•—:', err);
            });
          }
        }
      });
      
      // åˆå§‹åŒ–éŠæˆ²
      updateTotal();
      updateQuestionCount();
      lives = 5;
      updateLives();
      
      // è¨­ç½® Enter éµäº‹ä»¶ç›£è½å™¨
      const answerInput = document.getElementById('answerInput');
      if (answerInput) {
        answerInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault(); // é˜²æ­¢è¡¨å–®æäº¤
            if (isSpeaking || isProcessingAnswer) return; // ç™¼éŸ³æˆ–è™•ç†ä¸­ç¦æ­¢é€å‡º
            checkAnswer();
          }
        });
      }
      
      // æ·»åŠ éµç›¤å¿«æ·éµ
      document.addEventListener('keydown', (e) => {
        // éŸ³æ¨‚æ§åˆ¶å¿«æ·éµ
        if (e.key === 'm' || e.key === 'M') {
          toggleBackgroundMusic();
        }
      });
      
      // é–‹å§‹éŠæˆ²
      nextWord();
    });
  </script>
</body>
</html>
