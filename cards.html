<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>卡片倉庫 - Typing Hero</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="card-style.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* ====== 全域樣式 ====== */
    :root {
      --glow-cyan: #00ffff;
      --glow-magenta: #a259ff;
      --glow-gold: #ffd700;
      --glow-red: #ff6b6b;
      --bg-dark: rgba(10, 20, 40, 0.85);
      --gradient-primary: linear-gradient(135deg, #00ffff 0%, #a259ff 100%);
      --gradient-secondary: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
      --gradient-accent: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
      --shadow-primary: 0 0 20px rgba(0, 255, 255, 0.4);
      --shadow-secondary: 0 0 30px rgba(162, 89, 255, 0.3);
      --shadow-gold: 0 0 25px rgba(255, 215, 0, 0.5);
    }
    html {
      /* scroll-behavior: smooth; */
      overflow-x: hidden;
      width: 100%;
      box-sizing: border-box;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body > * {
      max-width: 100vw;
      overflow-x: hidden;
    }
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0;
      font-family: 'Orbitron', sans-serif;
      background: url('https://wallpaperaccess.com/full/192936.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      text-align: center;
      overflow-y: auto;
      overflow-x: hidden;
      width: 100%;
      box-sizing: border-box;
    }

    /* ====== 全域捲軸樣式 ====== */
    body::-webkit-scrollbar {
      width: 12px;
    }
    body::-webkit-scrollbar-track {
      background: #0a1428; /* 深藍色背景，配合主題 */
    }
    body::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, var(--glow-cyan), var(--glow-magenta));
      border-radius: 6px;
      border: 2px solid #0a1428; /* 創造懸浮感 */
    }
    body::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, var(--glow-gold), var(--glow-red)); /* 懸停時變色 */
    }

    header {
      background: linear-gradient(135deg, rgba(10, 20, 40, 0.95) 0%, rgba(20, 40, 80, 0.9) 100%);
      padding: 20px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-primary), var(--shadow-secondary), 0 4px 20px rgba(0, 0, 0, 0.3);
      border-bottom: 3px solid transparent;
      border-image: var(--gradient-primary);
      border-image-slice: 1;
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
      position: relative;
    }
    
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(0, 255, 255, 0.1) 50%, transparent 70%);
      animation: headerShine 3s ease-in-out infinite;
      pointer-events: none;
    }
    
    @keyframes headerShine {
      0%, 100% { transform: translateX(-100%); }
      50% { transform: translateX(100%); }
    }
    header h1 {
      margin: 0;
      font-size: 2.3rem;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 3px;
      text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      font-weight: 700;
      position: relative;
      z-index: 1;
    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .btn {
      background: var(--gradient-primary);
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 15px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: var(--shadow-primary), var(--shadow-secondary);
      font-size: 1.1rem;
      letter-spacing: 1px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }
    
    .btn:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: var(--shadow-primary), var(--shadow-secondary), 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    .btn:hover::before {
      left: 100%;
    }

    .stars-display {
      display: inline-flex;
      align-items: center;
      padding: 12px 20px;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 140, 0, 0.1) 100%);
      border: 2px solid transparent;
      border-image: var(--gradient-secondary);
      border-image-slice: 1;
      border-radius: 15px;
      font-size: 1.3rem;
      color: var(--glow-gold);
      font-weight: bold;
      text-shadow: 0 0 10px var(--glow-gold);
      box-shadow: var(--shadow-gold);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .stars-display::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255, 215, 0, 0.1) 50%, transparent 70%);
      animation: starShine 2s ease-in-out infinite;
      pointer-events: none;
    }
    
    @keyframes starShine {
      0%, 100% { transform: translateX(-100%); }
      50% { transform: translateX(100%); }
    }
    
    .stars-display:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: var(--shadow-gold), 0 8px 25px rgba(255, 215, 0, 0.3);
    }

    /* ====== 控制列（搜尋、稀有度、類別） ====== */
    #controls {
      margin: 25px auto;
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
      max-width: 100%;
      padding: 20px 25px;
      background: linear-gradient(135deg, rgba(10, 20, 40, 0.9) 0%, rgba(20, 40, 80, 0.8) 100%);
      border-radius: 20px;
      box-shadow: var(--shadow-primary), var(--shadow-secondary), 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 2px solid transparent;
      border-image: var(--gradient-primary);
      border-image-slice: 1;
      backdrop-filter: blur(15px);
      position: relative;
      overflow: hidden;
    }
    
    #controls::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(0, 255, 255, 0.05) 50%, transparent 70%);
      animation: controlsShine 4s ease-in-out infinite;
      pointer-events: none;
    }
    
    @keyframes controlsShine {
      0%, 100% { transform: translateX(-100%); }
      50% { transform: translateX(100%); }
    }
    #controls input,
    #controls select {
      padding: 10px 16px;
      border-radius: 12px;
      border: 2px solid rgba(0, 255, 255, 0.4);
      background: linear-gradient(135deg, rgba(10, 20, 40, 0.9) 0%, rgba(20, 40, 80, 0.8) 100%);
      color: #00ffff;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 8px;
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(5px);
      position: relative;
      z-index: 1;
      text-shadow: 0 0 4px rgba(0, 255, 255, 0.5);
    }
    
    #controls input::placeholder {
      color: rgba(0, 255, 255, 0.6);
      text-shadow: 0 0 4px rgba(0, 255, 255, 0.3);
    }
    
    #controls select option {
      background: rgba(10, 20, 40, 0.95);
      color: #ffffff;
      font-weight: 500;
    }
    
    #controls input:focus,
    #controls select:focus {
      outline: none;
      border-color: var(--glow-gold);
      box-shadow: var(--shadow-gold), 0 0 20px rgba(255, 215, 0, 0.3);
      transform: translateY(-1px);
    }
    #controls button {
      padding: 10px 16px;
      border-radius: 12px;
      border: 2px solid rgba(0, 255, 255, 0.4);
      background: linear-gradient(135deg, rgba(10, 20, 40, 0.8) 0%, rgba(20, 40, 80, 0.6) 100%);
      color: #00ffff;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 8px;
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.2);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(5px);
      position: relative;
      z-index: 1;
      text-shadow: 0 0 4px rgba(0, 255, 255, 0.5);
    }
    
    #controls button:hover {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.2) 0%, rgba(162, 89, 255, 0.2) 100%);
      box-shadow: var(--shadow-primary), 0 0 20px rgba(0, 255, 255, 0.4);
      transform: translateY(-1px);
    }
    
    #controls button.active {
      background: var(--gradient-primary);
      color: #000;
      font-weight: bold;
      box-shadow: var(--shadow-primary), var(--shadow-secondary);
      transform: translateY(-1px);
    }

    /* ====== 頁籤按鈕 ====== */
    .tab-container {
      display: flex;
      gap: 12px;
    }
    
    .tab-btn {
      padding: 10px 18px;
      border-radius: 15px;
      border: 2px solid rgba(0, 255, 255, 0.4);
      background: linear-gradient(135deg, rgba(10, 20, 40, 0.8) 0%, rgba(20, 40, 80, 0.6) 100%);
      color: #00ffff;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 8px;
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.2);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: 'Orbitron', sans-serif;
      backdrop-filter: blur(5px);
      position: relative;
      z-index: 1;
      text-shadow: 0 0 4px rgba(0, 255, 255, 0.5);
    }
    
    .tab-btn:hover {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.2) 0%, rgba(162, 89, 255, 0.2) 100%);
      box-shadow: var(--shadow-primary), 0 0 20px rgba(0, 255, 255, 0.4);
      transform: translateY(-1px);
    }
    
    .tab-btn.active {
      background: var(--gradient-primary);
      color: #000;
      font-weight: bold;
      box-shadow: var(--shadow-primary), var(--shadow-secondary);
      transform: translateY(-1px);
    }

    /* ====== 收集進度 ====== */
    #progress {
      margin: 15px 0;
      font-size: 1.2rem;
      color: var(--glow-gold);
      text-shadow: 0 0 10px var(--glow-gold), 0 0 20px rgba(0, 255, 255, 0.5);
      font-weight: bold;
      padding: 10px 20px;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 140, 0, 0.1) 100%);
      border-radius: 15px;
      border: 2px solid transparent;
      border-image: var(--gradient-secondary);
      border-image-slice: 1;
      box-shadow: var(--shadow-gold);
      backdrop-filter: blur(5px);
      display: inline-block;
    }
    
    /* ====== 音樂控制按鈕樣式 ====== */
    #toggleMusic.playing {
      background: rgba(0, 255, 255, 0.2) !important;
      border-color: #00ffff !important;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    #toggleMusic:hover {
      background: rgba(0, 255, 255, 0.2) !important;
      transform: scale(1.1);
      box-shadow: 0 0 24px #00ffff !important;
    }

    /* ====== 卡片格子（正方形 120x120px） ====== */
    #cardGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 20px;
      padding: 30px 25px 15px 25px;
      justify-content: center;
      overflow-x: hidden;
      box-sizing: border-box;
      background: linear-gradient(135deg, rgba(10, 20, 40, 0.9) 0%, rgba(20, 40, 80, 0.8) 100%);
      border-radius: 20px;
      box-shadow: var(--shadow-primary), var(--shadow-secondary), 0 8px 40px rgba(0, 0, 0, 0.3);
      position: relative;
      max-width: 100%;
      margin: 0 auto;
      border: 2px solid transparent;
      border-image: var(--gradient-primary);
      border-image-slice: 1;
      backdrop-filter: blur(15px);
      height: 80vh; /* 新增：固定高度 */
      overflow-y: auto; /* 新增：可垂直捲動 */
    }
    #cardGrid:before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('https://png.pngtree.com/thumb_back/fw800/background/20230613/pngtree-cosmic-starry-sky-background-image_2890957.jpg') repeat center center,
                  linear-gradient(to bottom, rgba(10, 20, 40, 0.3) 0%, rgba(10, 20, 40, 0.7) 100%);
      background-blend-mode: overlay;
      opacity: 0.15;
      border-radius: 20px;
      pointer-events: none;
      z-index: 0;
    }
    #cardGrid > * { position: relative; z-index: 1; }
    .card {
      width: 120px;
      height: 120px;
      position: relative;
      background: transparent;
      border-radius: 0;
      padding: 0;
      margin: 0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      animation: float 3s ease-in-out infinite;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      box-shadow: none;
      border: none;
      backdrop-filter: none;
      overflow: hidden;
      z-index: 1;
    }
    
    .card:hover {
      transform: translateY(-12px) scale(1.08) rotate(-3deg);
      box-shadow: var(--shadow-primary), var(--shadow-secondary), 0 20px 40px rgba(0,0,0,0.4);
    }
    .card.locked {
      cursor: not-allowed;
      opacity: 0.5;
      pointer-events: none;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    .card img,
    .card .card-media {
      width: 100%;
      height: 100%;
      border-radius: 0;
      object-fit: cover;
      object-position: center top;
      background: transparent;
      margin: 0;
      padding: 0;
      display: block;
      box-shadow: none;
      border: none;
      pointer-events: none;
    }
    .card .card-media {
      width: 100%;
      height: 100%;
      border-radius: 0;
      filter: none;
      object-fit: cover;
      background: transparent;
      pointer-events: none;
    }
    .card video.card-media {
      border: 2px solid rgba(0, 255, 255, 0.3);
      transition: border-color 0.3s ease;
      /* 移除自動播放，改為手動控制 */
      autoplay: false;
      loop: true;
      muted: true;
      playsinline: true;
      /* 隱藏影片控制條 */
      -webkit-media-controls: none;
      -webkit-media-controls-panel: none;
      -webkit-media-controls-play-button: none;
      -webkit-media-controls-start-playback-button: none;
    }
    .card video.card-media::-webkit-media-controls {
      display: none !important;
    }
    .card video.card-media::-webkit-media-controls-panel {
      display: none !important;
    }
    .card video.card-media::-webkit-media-controls-play-button {
      display: none !important;
    }
    .card video.card-media::-webkit-media-controls-start-playback-button {
      display: none !important;
    }
    .card:hover video.card-media {
      border-color: rgba(0, 255, 255, 0.8);
    }
    .card.locked img {
      filter: grayscale(1) brightness(0.3);
    }
    .card.locked video {
      filter: grayscale(1) brightness(0.3);
    }
    
    /* 未解鎖卡片鎖定遮罩樣式 */
    .lock-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20;
      backdrop-filter: blur(2px);
    }
    
    .lock-overlay .lock-icon {
      font-size: 2rem;
      color: #ffd700;
      text-shadow: 0 0 8px #ffd700;
      margin-bottom: 8px;
      animation: lockPulse 2s ease-in-out infinite;
    }
    
    .lock-overlay .lock-text {
      font-size: 0.9rem;
      color: #fff;
      text-shadow: 0 0 4px #000;
      font-weight: bold;
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    @keyframes lockPulse {
      0%, 100% { 
        transform: scale(1);
        opacity: 0.8;
      }
      50% { 
        transform: scale(1.1);
        opacity: 1;
      }
    }
    .stars {
      margin-top: 4px;
      font-size: 1.1rem;
      color: #ffd700;
      line-height: 1;
      letter-spacing: 2px;
      text-shadow: 0 0 8px #fff, 0 0 16px #00ffff;
    }
    .card .label {
      margin-top: 6px;
      font-size: 0.9rem;
      color: #00ffff;
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
      width: 100%;
      text-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
      line-height: 1.2;
      word-wrap: break-word;
      hyphens: auto;
      min-height: 2.4em;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .card .label .chinese-text {
      font-size: 0.9rem;
      color: #00ffff;
      margin-bottom: 2px;
      text-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
      font-weight: bold;
    }
    
    .card .label .english-text {
      font-size: 0.8rem;
      color: #ffd700;
      text-shadow: 0 0 6px #ffd700, 0 0 12px #ffaa00;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    .card .category-tag {
      margin-top: 4px;
      font-size: 0.85rem;
      color: #ffd700;
      text-shadow: 0 0 6px #fff, 0 0 12px #00ffff;
    }
    
    /* 新增：卡片描述樣式 */
    .card .description-tag {
      margin-top: 2px;
      font-size: 0.7rem;
      color: #ccc;
      text-shadow: 0 0 4px #ccc;
      line-height: 1.1;
      max-height: 2.2em;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      word-wrap: break-word;
      hyphens: auto;
      padding: 0 2px;
    }
    

    .common { border: 2.5px solid #00ffff; }
    .rare   { border: 2.5px solid #a259ff; }
    .epic   { border: 2.5px solid #ffd700; box-shadow: 0 0 16px #ffd700; }
    .rank-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      font-size: 0.95rem;
      font-weight: bold;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      z-index: 10;
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      color: #000;
      box-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
    }
    .card.common .rank-badge {
      background: #00ffff;
      border: 2px solid #00ffff;
      color: #000;
    }
    .card.rare .rank-badge {
      background: #a259ff;
      border: 2px solid #a259ff;
      color: #fff;
    }
    .card.epic .rank-badge {
      background: #ffd700;
      border: 2px solid #ffd700;
      color: #000;
    }

    /* ====== 遮罩 & Modal ====== */
    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      z-index: 900;
    }
    /* Modal 外框套用與卡片相同設定 */
    #modal .card {
      width: 260px;
      height: 430px;
      margin: 0 auto;
      background: rgba(10, 20, 40, 0.95);
      border-radius: 16px;
      padding: 14px;
      border: 2.5px solid #00ffff;
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
    }
    #modal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: transparent;
      padding: 0;
      border: none;
      z-index: 1000;
      transition: transform 0.3s;
      color: #fff;
      box-sizing: border-box;
    }
    #modal.show {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      pointer-events: auto;
    }
    
    /* Modal 卡片樣式 */
    .modal-card {
      width: 240px;
      max-width: 90vw;
      height: 380px;
      background: rgba(10, 20, 40, 0.95);
      border-radius: 20px;
      padding: 16px;
      border: 2.5px solid #00ffff;
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
      color: #fff;
      position: relative;
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    /* Modal 稀有度顏色 */
    .modal-card.common {
      border: 2.5px solid #00ffff;
      box-shadow: 0 0 32px #00ffff, 0 0 48px #00ffffcc;
    }
    
    .modal-card.rare {
      border: 2.5px solid #a259ff;
      box-shadow: 0 0 32px #a259ff, 0 0 48px #a259ffcc;
    }
    
    .modal-card.epic {
      border: 2.5px solid #ffd700;
      box-shadow: 0 0 32px #ffd700, 0 0 48px #ffd700cc;
    }
    
    .modal-title {
      width: 100%;
      text-align: center;
      margin-bottom: 12px;
      order: -1;
    }
    
    .modal-title .chinese-text {
      font-size: 1.2rem;
      color: #00ffff;
      margin-bottom: 4px;
      text-shadow: 0 0 8px #00ffff;
      font-weight: bold;
      text-align: center;
    }
    
    .modal-title .english-text {
      font-size: 1rem;
      color: #ffd700;
      text-shadow: 0 0 6px #ffd700;
      font-weight: 500;
      text-align: center;
    }
    
    .modal-media {
      width: 100%;
      height: 60%;
      margin-bottom: 12px;
      border-radius: 16px;
      overflow: hidden;
      background: transparent;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      border-radius: 16px;
      background: transparent;
    }
    
    .modal-video {
      width: 100%;
      height: 100%;
      border-radius: 16px;
      background: transparent;
      object-fit: contain;
      object-position: center;
    }
    
    .modal-youtube {
      width: 100%;
      height: 100%;
      border-radius: 16px;
      background: transparent;
      border: none;
    }
    
    .modal-no-media {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 16px;
      color: #ccc;
    }
    
    .modal-no-media .material-icons {
      font-size: 3rem;
      margin-bottom: 8px;
      opacity: 0.5;
    }
    
    .modal-no-media p {
      font-size: 0.9rem;
      margin: 0;
      opacity: 0.7;
    }
    
    .modal-image-container {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 16px;
      overflow: hidden;
    }
    
    .youtube-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .modal-image-container:hover .youtube-overlay {
      opacity: 1;
    }
    
    .youtube-search-btn {
      background: linear-gradient(45deg, #ff0000, #cc0000);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
      transition: all 0.3s ease;
    }
    
    .youtube-search-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(255, 0, 0, 0.6);
    }
    
    .youtube-search-btn .material-icons {
      font-size: 1.2rem;
    }
    
    .modal-info {
      text-align: center;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      width: 100%;
    }
    
    .modal-category {
      font-size: 0.9rem;
      color: #ffd700;
      margin-bottom: 8px;
      text-shadow: 0 0 6px #ffd700;
      text-align: center;
    }
    
    .modal-description {
      font-size: 0.85rem;
      color: #ccc;
      line-height: 1.4;
      text-shadow: 0 0 4px #ccc;
      text-align: center;
      overflow-y: auto;
      max-height: 80px;
      padding: 0 4px;
    }
    
    .modal-card .rarity-stars {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 1.1rem;
      color: #ffd700;
      text-shadow: 0 0 8px #ffd700;
      background: rgba(0, 0, 0, 0.6);
      padding: 6px 10px;
      border-radius: 16px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      backdrop-filter: blur(4px);
    }
    
    .modal-card .rarity-label {
      position: absolute;
      top: 12px;
      left: 12px;
      font-size: 0.8rem;
      color: #00ffff;
      text-shadow: 0 0 6px #00ffff;
      background: rgba(0, 0, 0, 0.8);
      padding: 4px 8px;
      border-radius: 12px;
      border: 1px solid rgba(0, 255, 255, 0.5);
      backdrop-filter: blur(4px);
      font-weight: bold;
      letter-spacing: 1px;
      z-index: 10;
    }
    #modal .card img {
      width: 100%;
      height: 50%;
      border-radius: 10px;
      filter: drop-shadow(0 0 12px #00ffffcc);
      object-fit: cover;
      background: #000;
    }
    #modal .card .card-media {
      width: 100%;
      height: 50%;
      border-radius: 10px;
      filter: drop-shadow(0 0 12px #00ffffcc);
      object-fit: cover;
      background: #000;
    }
    #modal .card video.card-media {
      border: 2px solid rgba(0, 255, 255, 0.5);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
      /* Modal 中的影片設定 */
      autoplay: false;
      loop: true;
      muted: true;
      playsinline: true;
      /* 隱藏影片控制條 */
      -webkit-media-controls: none;
      -webkit-media-controls-panel: none;
      -webkit-media-controls-play-button: none;
      -webkit-media-controls-start-playback-button: none;
    }
    #modal .card video.card-media::-webkit-media-controls {
      display: none !important;
    }
    #modal .card video.card-media::-webkit-media-controls-panel {
      display: none !important;
    }
    #modal .card video.card-media::-webkit-media-controls-play-button {
      display: none !important;
    }
    #modal .card video.card-media::-webkit-media-controls-start-playback-button {
      display: none !important;
    }
    #modal .card .stars {
      margin-top: 6px;
      font-size: 1.1rem;
      color: #ffd700;
      line-height: 1;
      letter-spacing: 2px;
      text-shadow: 0 0 8px #fff, 0 0 16px #00ffff;
    }
    #modal .card .label {
      margin-top: 6px;
      font-size: 1rem;
      color: #00ffff;
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
      width: 100%;
      text-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
      text-align: center;
      line-height: 1.3;
      word-wrap: break-word;
      hyphens: auto;
      min-height: 2.6em;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #modal .card .label .chinese-text {
      font-size: 1rem;
      color: #00ffff;
      margin-bottom: 3px;
      text-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
      font-weight: bold;
    }
    #modal .card .label .english-text {
      font-size: 0.9rem;
      color: #ffd700;
      text-shadow: 0 0 6px #ffd700, 0 0 12px #ffaa00;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    #modal .card .category-tag {
      margin-top: 4px;
      font-size: 0.95rem;
      color: #ffd700;
      text-shadow: 0 0 6px #fff, 0 0 12px #00ffff;
      text-align: center;
    }
    #modal .card .rank-badge {
      top: 8px;
      right: 8px;
      width: 36px;
      height: 36px;
      font-size: 1.1rem;
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      color: #000;
      box-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
    }

    #modal .description {
      margin-top: 14px;
      text-align: left;
      line-height: 1.6;
      font-size: 1.05rem;
      max-height: 160px;
      overflow-y: auto;
      width: 260px;
      background: rgba(10, 20, 40, 0.95);
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 0 16px #00ffff99, 0 0 40px #a259ff44 inset;
      color: #fff;
      text-shadow: 0 0 8px #000a;
    }
    #modal .description::-webkit-scrollbar {
      width: 8px;
    }
    #modal .description::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.3);
      border-radius: 4px;
    }
    #modal .description::-webkit-scrollbar-thumb {
      background: var(--glow-cyan);
      border-radius: 4px;
    }
    #modal .description::-webkit-scrollbar-thumb:hover {
      background: var(--glow-gold);
    }
    
    /* 卡牌效果資訊樣式 */
    #modal .card-effect {
      margin-top: 12px;
      padding: 10px;
      background: rgba(0, 255, 255, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(0, 255, 255, 0.3);
    }
    
    #modal .card-effect h4 {
      color: #00ffff;
      margin: 0 0 8px 0;
      font-size: 1rem;
      text-align: center;
    }
    
    #modal .card-effect .effect-desc {
      color: #ffd700;
      font-size: 0.9rem;
      text-align: center;
      margin: 0;
      font-weight: 500;
    }
    
    #modal .card-effect .effect-type {
      color: #a259ff;
      font-size: 0.8rem;
      text-align: center;
      margin-top: 5px;
      opacity: 0.8;
    }
    .sound-btn-modal {
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      color: #000;
      border: none;
      padding: 10px 22px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1.1rem;
      margin-top: 12px;
      box-shadow: 0 0 16px #00ffff, 0 0 24px #a259ff99;
      font-weight: bold;
      letter-spacing: 1px;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .sound-btn-modal:hover {
      transform: scale(1.07);
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
    }
    .modal-actions {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 12px;
    }
    .disenchant-btn-modal {
      background: linear-gradient(90deg, #ff8a00 0%, #e52e71 100%);
      color: #fff;
      border: none;
      padding: 10px 22px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 16px #ff8a00, 0 0 24px #e52e7199;
      font-size: 1.1rem;
      letter-spacing: 1px;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .disenchant-btn-modal:hover {
      transform: scale(1.07);
      box-shadow: 0 0 32px #ff8a00, 0 0 48px #e52e71cc;
    }
    .disenchant-btn-modal:disabled {
      background: #555;
      color: #999;
      cursor: not-allowed;
      box-shadow: none;
    }
    .disenchant-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .quantity-selector {
      display: flex;
      align-items: center;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      border: 1px solid #ff8a00;
    }
    .quantity-btn {
      background: transparent;
      border: none;
      color: #ff8a00;
      font-size: 1.5rem;
      font-weight: bold;
      cursor: pointer;
      padding: 0 12px;
    }
    .quantity-btn:hover {
      color: #fff;
    }
    #disenchant-quantity {
      width: 40px;
      text-align: center;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 1.2rem;
      font-weight: bold;
      -moz-appearance: textfield;
    }
    #disenchant-quantity::-webkit-outer-spin-button,
    #disenchant-quantity::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .close-btn {
      position: absolute;
      top: -16px; left: -16px;
      background: red;
      color: white;
      width: 32px; height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 6px #f00;
    }

    /* ====== 新卡片圖標 ====== */
    .new-card-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: var(--gradient-accent);
      background-size: 200% 200%;
      color: #fff;
      padding: 8px 14px;
      font-size: 0.85rem;
      font-weight: bold;
      border-radius: 18px;
      z-index: 15;
      box-shadow: 0 0 20px rgba(255, 107, 107, 0.6), 0 0 30px rgba(255, 217, 61, 0.5), 0 0 40px rgba(255, 107, 107, 0.4);
      text-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
      border: 2px solid rgba(255, 255, 255, 0.9);
      transform-origin: center;
      backdrop-filter: blur(4px);
    }
    
    @keyframes newCardPulse {
      0%, 100% { 
        transform: scale(1) rotate(0deg);
        box-shadow: 
          0 0 15px #ff6b6b, 
          0 0 25px #ffd93d,
          0 0 35px #ff6b6b;
      }
      25% {
        transform: scale(1.15) rotate(-2deg);
        box-shadow: 
          0 0 25px #ff6b6b, 
          0 0 35px #ffd93d,
          0 0 45px #ff6b6b;
      }
      50% { 
        transform: scale(1.25) rotate(0deg);
        box-shadow: 
          0 0 30px #ff6b6b, 
          0 0 40px #ffd93d,
          0 0 50px #ff6b6b;
      }
      75% {
        transform: scale(1.15) rotate(2deg);
        box-shadow: 
          0 0 25px #ff6b6b, 
          0 0 35px #ffd93d,
          0 0 45px #ff6b6b;
      }
    }
    
    @keyframes newCardGradient {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    @keyframes fadeInScale {
      0% { 
        opacity: 0;
        transform: scale(0.9) translateY(10px);
      }
      100% { 
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    @keyframes slideInFromTop {
      0% {
        opacity: 0;
        transform: translateY(-20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes glowPulse {
      0%, 100% {
        box-shadow: var(--shadow-primary), var(--shadow-secondary);
      }
      50% {
        box-shadow: var(--shadow-primary), var(--shadow-secondary), 0 0 30px rgba(0, 255, 255, 0.6);
      }
    }
    
    .new-card-glow {
      animation: newCardGlow 2s ease-in-out infinite;
      position: relative;
    }
    
    .new-card-glow::before {
      content: '';
      position: absolute;
      top: -5px;
      left: -5px;
      right: -5px;
      bottom: -5px;
      background: linear-gradient(45deg, #ff6b6b, #ffd93d, #ff6b6b);
      border-radius: 20px;
      z-index: -1;
      opacity: 0.6;
      animation: newCardGlowRing 2s ease-in-out infinite;
    }
    
    @keyframes newCardGlow {
      0%, 100% { 
        box-shadow: 
          0 0 20px #00ffff55, 
          0 0 40px #a259ff33,
          0 0 15px #ff6b6b88;
      }
      25% {
        box-shadow: 
          0 0 25px #00ffff66, 
          0 0 45px #a259ff44,
          0 0 25px #ff6b6b99,
          0 0 35px #ffd93d66;
      }
      50% { 
        box-shadow: 
          0 0 30px #00ffff77, 
          0 0 50px #a259ff55,
          0 0 35px #ff6b6baa,
          0 0 45px #ffd93d77;
      }
      75% {
        box-shadow: 
          0 0 25px #00ffff66, 
          0 0 45px #a259ff44,
          0 0 25px #ff6b6b99,
          0 0 35px #ffd93d66;
      }
    }
    
    @keyframes newCardGlowRing {
      0%, 100% { 
        transform: scale(1);
        opacity: 0.6;
      }
      50% { 
        transform: scale(1.1);
        opacity: 0.8;
      }
    }

    .video-indicator {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 0.8rem;
      z-index: 10;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      animation: videoIndicatorPulse 2s ease-in-out infinite;
    }
    
    @keyframes videoIndicatorPulse {
      0%, 100% { 
        transform: scale(1);
        opacity: 0.8;
      }
      50% { 
        transform: scale(1.1);
        opacity: 1;
      }
    }

    /* ====== YouTube 影片相關樣式 ====== */
    .card iframe.card-media {
      border: 2px solid rgba(0, 255, 255, 0.3);
      transition: border-color 0.3s ease;
      pointer-events: none; /* 防止在卡片上直接操作 iframe */
    }
    .card:hover iframe.card-media {
      border-color: rgba(0, 255, 255, 0.8);
    }
    .card .youtube-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s ease;
      z-index: 5;
    }
    .card .youtube-overlay:hover {
      background: rgba(0, 0, 0, 0.1);
    }
    .card .youtube-overlay .play-button {
      width: 40px;
      height: 40px;
      background: rgba(255, 0, 0, 0.8);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      transition: all 0.3s ease;
    }
    .card .youtube-overlay:hover .play-button {
      transform: scale(1.2);
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
    }
    .card .video-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #00ffff;
      font-size: 12px;
      z-index: 6;
    }
    .card .video-error {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #ff6b6b;
      font-size: 12px;
      z-index: 6;
      text-align: center;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px;
      border-radius: 6px;
    }

    /* Modal 中的 YouTube 影片樣式 */
    #modal .card iframe.card-media {
      border: 2px solid rgba(0, 255, 255, 0.5);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
      pointer-events: auto; /* Modal 中可以操作 */
    }
    #modal .card iframe.card-media::-webkit-media-controls {
      background: rgba(0, 0, 0, 0.7);
      border-radius: 8px;
    }

    /* ====== 影片按鈕樣式 ====== */
    .video-button {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      background: rgba(255, 0, 0, 0.8);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 15;
      transition: all 0.3s ease;
      box-shadow: 0 0 8px rgba(255, 0, 0, 0.5);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .video-button:hover {
      transform: scale(1.1);
      background: rgba(255, 0, 0, 1);
      box-shadow: 0 0 16px rgba(255, 0, 0, 0.8);
      border-color: rgba(255, 255, 255, 0.8);
    }
    
    .video-icon {
      color: white;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
    }

    /* 新增：媒體容器樣式 */
    .media-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border-radius: 0;
      overflow: hidden;
      padding: 0;
      margin: 0;
    }
    
    .media-container .card-media {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 0;
      display: block;
      background: transparent;
      padding: 0;
      margin: 0;
    }
    
    /* 新增：影片播放指示器 */
    .video-play-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.7);
      color: #00ffff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: bold;
      z-index: 10;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(0, 255, 255, 0.3);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .card:hover .video-play-indicator {
      opacity: 1;
    }
    
    /* 觸控設備優化 */
    @media (hover: none) and (pointer: coarse) {
      .card:hover .video-play-indicator {
        opacity: 0; /* 觸控設備不顯示懸停提示 */
      }
    }
    
    /* 響應式設計 - 防止橫向滑桿 */
    @media (max-width: 768px) {
      body {
        overflow-x: hidden;
      }
      
      #controls {
        margin: 15px 10px;
        padding: 15px 20px;
        gap: 10px;
        max-width: calc(100vw - 20px);
      }
      
      #controls input,
      #controls select,
      #controls button {
        padding: 8px 12px;
        font-size: 0.9rem;
      }
      
      .tab-container {
        gap: 8px;
      }
      
      .tab-btn {
        padding: 8px 14px;
        font-size: 0.9rem;
      }
      
      #cardGrid {
        gap: 15px;
        padding: 20px 15px 10px 15px;
        margin: 0 10px;
      }
      
      #featureMenu {
        margin: 10px;
        padding: 15px;
      }
      
      header {
        padding: 15px 20px;
      }
      
      header h1 {
        font-size: 1.8rem;
      }
      
      .stars-display {
        padding: 8px 15px;
        font-size: 1.1rem;
      }
    }
    
    @media (max-width: 480px) {
      body {
        overflow-x: hidden;
      }
      
      #controls {
        margin: 10px 5px;
        padding: 12px 15px;
        max-width: calc(100vw - 10px);
      }
      
      #cardGrid {
        gap: 12px;
        padding: 15px 10px 8px 10px;
        margin: 0 5px;
      }
      
      header h1 {
        font-size: 1.5rem;
      }
      
      .header-actions {
        gap: 10px;
      }
      
      .btn {
        padding: 8px 16px;
        font-size: 0.9rem;
      }
    }

    /* 新增：影片播放控制樣式 */
    .video-controls {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 0.8rem;
      color: #00ffff;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(0, 255, 255, 0.3);
    }
    
    .video-controls:hover {
      background: rgba(0, 0, 0, 0.9);
      border-color: rgba(0, 255, 255, 0.8);
      box-shadow: 0 0 8px rgba(0, 255, 255, 0.5);
    }

    /* ====== 影片 Modal 樣式 ====== */
    .video-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(8px);
    }
    
    .video-modal-content {
      background: rgba(10, 20, 40, 0.95);
      border: 2px solid #00ffff;
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
    }
    
    .video-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: rgba(0, 255, 255, 0.1);
      border-bottom: 1px solid rgba(0, 255, 255, 0.3);
    }
    
    .video-modal-header h3 {
      color: #00ffff;
      margin: 0;
      font-size: 1.2rem;
      text-shadow: 0 0 8px #00ffff;
    }
    
    .video-modal-close {
      background: rgba(255, 0, 0, 0.8);
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .video-modal-close:hover {
      background: rgba(255, 0, 0, 1);
      transform: scale(1.1);
      box-shadow: 0 0 12px rgba(255, 0, 0, 0.8);
    }
    
    .video-modal-body {
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
    }
    
    .video-modal-body iframe,
    .video-modal-body video {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      border: 2px solid rgba(0, 255, 255, 0.3);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
    }
    
    .video-modal-body iframe {
      background: #000;
    }
    
    .video-modal-body video {
      background: #000;
    }
    
    /* ====== 成就系統樣式 ====== */
    .badge {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid;
      position: relative;
    }
    
    .badge.locked {
      background: rgba(128, 128, 128, 0.3);
      border-color: #666;
      color: #666;
      cursor: default;
      filter: grayscale(1);
    }
    
    .badge.unlocked {
      cursor: pointer;
      animation: badgeGlow 2s ease-in-out infinite alternate;
    }
    
    .badge.unlocked:hover {
      transform: scale(1.2);
      box-shadow: 0 0 20px currentColor;
    }
    
    .badge-bronze.unlocked {
      background: linear-gradient(45deg, #cd7f32, #daa520);
      border-color: #cd7f32;
      color: #fff;
      box-shadow: 0 0 12px #cd7f32;
    }
    
    .badge-silver.unlocked {
      background: linear-gradient(45deg, #c0c0c0, #e5e4e2);
      border-color: #c0c0c0;
      color: #333;
      box-shadow: 0 0 12px #c0c0c0;
    }
    
    .badge-gold.unlocked {
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      border-color: #ffd700;
      color: #333;
      box-shadow: 0 0 12px #ffd700;
    }
    
    .badge-platinum.unlocked {
      background: linear-gradient(45deg, #e5e4e2, #b4b4b4);
      border-color: #e5e4e2;
      color: #333;
      box-shadow: 0 0 12px #e5e4e2;
    }
    
    .badge-diamond.unlocked {
      background: linear-gradient(45deg, #b9f2ff, #00ffff);
      border-color: #b9f2ff;
      color: #333;
      box-shadow: 0 0 12px #b9f2ff;
    }
    
    @keyframes badgeGlow {
      0% { box-shadow: 0 0 12px currentColor; }
      100% { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor; }
    }
    
    .reward-stars {
      color: #ffd700;
      font-weight: bold;
      text-shadow: 0 0 8px #ffd700;
    }

    /* ====== 已擁有標記 ====== */
    .owned-stamp {
      position: absolute;
      bottom: 6px;
      right: 6px;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.7), rgba(162, 89, 255, 0.7));
      color: #fff;
      padding: 3px 7px;
      font-size: 0.75rem;
      border-radius: 6px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      z-index: 10;
      backdrop-filter: blur(2px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .avatar-head {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      border-radius: 50%;
      display: block;
      transition: transform 0.3s;
    }

    /* ====== 稀有度圖標樣式 ====== */
    .rarity-icon {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-weight: bold;
      font-size: 1.1rem;
      z-index: 15;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(255, 255, 255, 0.8);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }
    
    .rarity-icon.common {
      background: linear-gradient(135deg, #00ffff, #00cccc);
      color: #000;
      box-shadow: 0 0 8px #00ffff, 0 0 16px #00ffff88;
    }
    
    .rarity-icon.rare {
      background: linear-gradient(135deg, #a259ff, #8a2be2);
      color: #fff;
      box-shadow: 0 0 8px #a259ff, 0 0 16px #a259ff88;
    }
    
    .rarity-icon.epic {
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      color: #000;
      box-shadow: 0 0 8px #ffd700, 0 0 16px #ffd70088;
    }
  </style>
</head>
<body>
  <!-- 背景音樂音頻元素 -->
  <audio id="backgroundMusic" loop>
    <source src="sound/午後放鬆時光（純音樂）.mp3" type="audio/mpeg">
  </audio>

  <div style="
    width: 100%;
    max-width: 100vw;
    overflow-x: hidden;
    box-sizing: border-box;
  ">
    <header>
      <h1>📁 卡片收藏</h1>
      <div class="header-actions">
        <span id="totalStarsCount" class="stars-display">⭐ 0</span>
        
        <button class="btn" onclick="location.href='index.html'">🏠 首頁</button>
      </div>
    </header>

  <!-- 新增：功能選單區域 -->
  <div id="featureMenu" style="
    background: linear-gradient(135deg, rgba(10, 20, 40, 0.9) 0%, rgba(20, 40, 80, 0.8) 100%);
    border: 2px solid transparent;
    border-image: var(--gradient-primary);
    border-image-slice: 1;
    border-radius: 20px;
    padding: 20px;
    margin: 15px auto;
    max-width: 100%;
    text-align: center;
    box-sizing: border-box;
    box-shadow: var(--shadow-primary), var(--shadow-secondary), 0 8px 32px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(15px);
  ">
          <h3 style="
        color: #00ffff; 
        margin: 0 0 20px 0; 
        font-size: 1.4rem;
        font-weight: bold;
        text-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      ">🚀 快速功能</h3>
          <div style="
        display: flex; 
        gap: 16px; 
        justify-content: center; 
        flex-wrap: wrap; 
        align-items: center;
        min-height: 44px;
        width: 100%;
        box-sizing: border-box;
      ">
      <button class="btn" onclick="location.href='autoSaveManager.html'">🔄 自動儲存</button>
      <button class="btn" onclick="location.href='gacha.html'">🎴 抽卡</button>
      <button id="toggleMusic" class="btn" title="背景音樂" style="
        width: 55px;
        height: 55px;
        border-radius: 50%;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(10, 20, 40, 0.9) 0%, rgba(20, 40, 80, 0.8) 100%);
        border: 2px solid transparent;
        border-image: var(--gradient-primary);
        border-image-slice: 1;
        color: #00ffff;
        backdrop-filter: blur(15px);
        box-shadow: var(--shadow-primary);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      ">
        <span class="material-icons">music_note</span>
      </button>
    </div>
  </div>

  <!-- 搜尋、稀有度、類別 -->
  <div id="controls">
    <input type="text" id="searchInput" placeholder="搜尋單字或中文" oninput="renderCards(); updateCategoryStats()">
    <select id="rarityFilter" onchange="renderCards(); updateCategoryStats()">
      <option value="all">全部稀有度</option>
      <option value="普通">普通</option>
      <option value="稀有">稀有</option>
      <option value="超稀有">超稀有</option>
    </select>
    <select id="categoryFilter" onchange="renderCards(); updateCategoryStats()">
      <option value="all">全部類別</option>
      <!-- JS 會動態把 cards.js 的 category 填進去 -->
    </select>
    <div id="categoryStats" style="
      margin-top: 12px;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.1) 0%, rgba(162, 89, 255, 0.1) 100%);
      border: 2px solid transparent;
      border-image: var(--gradient-primary);
      border-image-slice: 1;
      border-radius: 16px;
      color: #00ffff;
      font-size: 0.95rem;
      text-align: center;
      display: none;
      box-shadow: var(--shadow-primary), var(--shadow-secondary), 0 8px 25px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(8px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    "></div>
    <div class="tab-container">
      <button class="tab-btn active" data-filter="all">全部卡片</button>
      <button class="tab-btn" data-filter="owned">📦 我的收藏</button>
    </div>
  </div>

  <div id="progress">已解鎖：0 / 0</div>
  

  
  <div id="cardGrid"></div>

  <div id="overlay"></div>
  <div id="modal">
    <div id="modalCardContainer"></div>
    <div class="close-btn" onclick="closeModal()">✕</div>
  </div>

  </div>

  <!-- 先載入 cards.js（必須放在頁面相同資料夾，或自行修改路徑） -->
  <script src="js/sound.js"></script>
  <script src="js/userData.js"></script>
  <script src="js/starRewardSystem.js"></script>
  <script src="js/cardUtils.js"></script> <!-- 引入共享的卡牌工具函式 -->
  <script src="js/cards.js"></script> <!-- 載入主卡片資料，包含影片屬性 -->
  <script src="js/achievementSystem.js"></script>
  <script>
    /***** 背景音樂連動系統 *****/
    let backgroundMusic = null;
    let toggleMusicBtn = null;
    let isMusicPlaying = false;
    
    // 初始化背景音樂系統
    function initBackgroundMusic() {
      console.log('🎵 初始化背景音樂系統...');
      
      backgroundMusic = document.getElementById('backgroundMusic');
      toggleMusicBtn = document.getElementById('toggleMusic');
      
      if (!backgroundMusic) {
        console.error('❌ 找不到背景音樂元素');
        return;
      }
      
      if (!toggleMusicBtn) {
        console.error('❌ 找不到音樂控制按鈕');
        return;
      }
      
      // 設定音樂屬性
      backgroundMusic.volume = 0.3;
      backgroundMusic.loop = true;
      
      // 檢查 LinkageSystem 是否可用
      if (typeof LinkageSystem !== 'undefined' && LinkageSystem.music) {
        isMusicPlaying = LinkageSystem.music.isPlaying();
        console.log('🔗 LinkageSystem 音樂狀態:', isMusicPlaying);
      } else {
        // 備用方案：直接從 localStorage 讀取
        const musicState = localStorage.getItem('bgMusicState');
        isMusicPlaying = musicState === 'playing';
        console.log('📦 localStorage 音樂狀態:', isMusicPlaying);
      }
      
      // 根據狀態設定按鈕外觀
      updateMusicButtonState();
      
      // 如果應該播放，嘗試播放
      if (isMusicPlaying) {
        playBackgroundMusic();
      }
      
      console.log('✅ 背景音樂系統初始化完成');
    }
    
    // 更新音樂按鈕狀態
    function updateMusicButtonState() {
      if (!toggleMusicBtn) return;
      
      if (isMusicPlaying) {
        toggleMusicBtn.classList.add('playing');
        toggleMusicBtn.style.background = 'rgba(0, 255, 255, 0.2)';
      } else {
        toggleMusicBtn.classList.remove('playing');
        toggleMusicBtn.style.background = 'rgba(10, 20, 40, 0.85)';
      }
    }
    
    // 播放背景音樂
    function playBackgroundMusic() {
      if (!backgroundMusic) return;
      
      // 優先使用 SoundSystem
      if (typeof SoundSystem !== 'undefined' && SoundSystem.bgm) {
        SoundSystem.bgm.play();
        isMusicPlaying = true;
        updateMusicButtonState();
        console.log('🎵 透過 SoundSystem 播放背景音樂');
        return;
      }
      
      // 備用方案：直接播放本地音樂元素
      backgroundMusic.play().then(() => {
        isMusicPlaying = true;
        updateMusicButtonState();
        
        // 同步到 LinkageSystem
        if (typeof LinkageSystem !== 'undefined' && LinkageSystem.music) {
          LinkageSystem.music.setPlaying(true);
        } else {
          localStorage.setItem('bgMusicState', 'playing');
        }
        
        console.log('🎵 背景音樂開始播放');
      }).catch(err => {
        console.error('❌ 背景音樂播放失敗:', err);
        isMusicPlaying = false;
        updateMusicButtonState();
      });
    }
    
    // 暫停背景音樂
    function pauseBackgroundMusic() {
      if (!backgroundMusic) return;
      
      // 優先使用 SoundSystem
      if (typeof SoundSystem !== 'undefined' && SoundSystem.bgm) {
        SoundSystem.bgm.pause();
        isMusicPlaying = false;
        updateMusicButtonState();
        console.log('🔇 透過 SoundSystem 暫停背景音樂');
        return;
      }
      
      // 備用方案：直接暫停本地音樂元素
      backgroundMusic.pause();
      isMusicPlaying = false;
      updateMusicButtonState();
      
      // 同步到 LinkageSystem
      if (typeof LinkageSystem !== 'undefined' && LinkageSystem.music) {
        LinkageSystem.music.setPlaying(false);
      } else {
        localStorage.setItem('bgMusicState', 'paused');
      }
      
      console.log('🔇 背景音樂已暫停');
    }
    
    // 切換背景音樂播放狀態
    function toggleBackgroundMusic() {
      if (isMusicPlaying) {
        pauseBackgroundMusic();
      } else {
        playBackgroundMusic();
      }
    }
    
    // 音樂系統診斷函數
    function diagnoseMusicSystem() {
      console.log('🔍 === 音樂系統診斷 ===');
      console.log('背景音樂元素:', backgroundMusic);
      console.log('音樂控制按鈕:', toggleMusicBtn);
      console.log('當前播放狀態:', isMusicPlaying);
      console.log('LinkageSystem 可用:', typeof LinkageSystem !== 'undefined');
      console.log('SoundSystem 可用:', typeof SoundSystem !== 'undefined');
      
      if (backgroundMusic) {
        console.log('音樂檔案路徑:', backgroundMusic.src);
        console.log('音樂音量:', backgroundMusic.volume);
        console.log('音樂是否循環:', backgroundMusic.loop);
        console.log('音樂是否暫停:', backgroundMusic.paused);
        console.log('音樂當前時間:', backgroundMusic.currentTime);
      }
      
      if (typeof LinkageSystem !== 'undefined' && LinkageSystem.music) {
        console.log('LinkageSystem 音樂狀態:', LinkageSystem.music.isPlaying());
        console.log('LinkageSystem 音樂音量:', LinkageSystem.music.getVolume());
      }
      
      if (typeof SoundSystem !== 'undefined' && SoundSystem.bgm) {
        console.log('SoundSystem 背景音樂:', SoundSystem.bgm);
        console.log('SoundSystem 背景音樂狀態:', !SoundSystem.bgm.paused);
      }
      
      alert('音樂系統診斷完成，請查看控制台');
    }
    
    // -------- 0. 從 cards.js 取得 allCards 資料 --------
    console.log('正在載入 allCards...');
    console.log('window.allCards:', window.allCards);
    
    // 等待 cards.js 完全載入
    function waitForAllCards() {
      if (window.allCards && window.allCards.length > 0) {
        console.log('allCards 載入成功，長度:', window.allCards.length);
        initializePage();
      } else {
        console.log('等待 allCards 載入...');
        setTimeout(waitForAllCards, 100);
      }
    }
    
    // -------- 1. 從 localStorage 拿 ownedCards --------
    let ownedCards = LinkageSystem.cards.getOwnedCards();
    let recentlyObtainedCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
    
    // 開始等待 allCards 載入
    console.log('🚀 頁面開始載入...');
    waitForAllCards();

    // -------- 3. 初始化「類別選單」 --------
    function initCategoryOptions() {
      const categorySet = new Set();
      window.allCards.forEach(card => {
        if (card.category) categorySet.add(card.category);
      });
      const categoryFilter = document.getElementById("categoryFilter");
      // 清掉除了「全部」以外的選項
      Array.from(categoryFilter.querySelectorAll("option")).forEach(opt => {
        if (opt.value !== "all") opt.remove();
      });
      Array.from(categorySet).sort().forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        categoryFilter.appendChild(option);
      });
    }

    // -------- 3.5. 更新分類統計資訊 --------
    function updateCategoryStats() {
      const categoryFilter = document.getElementById("categoryFilter");
      const categoryStats = document.getElementById("categoryStats");
      const selectedCategory = categoryFilter.value;
      
      if (selectedCategory === "all") {
        categoryStats.style.display = "none";
        return;
      }
      
      // 計算該分類的總卡片數和已收集數
      const categoryCards = window.allCards.filter(card => card.category === selectedCategory);
      const totalCards = categoryCards.length;
      const ownedCards = LinkageSystem.cards.getOwnedCards();
      const collectedCards = categoryCards.filter(card => LinkageSystem.cards.isCardOwned(card.word)).length;
      
      // 計算收集百分比
      const percentage = totalCards > 0 ? Math.round((collectedCards / totalCards) * 100) : 0;
      
      // 根據完成度決定表情符號和顏色
      let emoji, progressColor, bgColor, borderColor;
      if (percentage === 100) {
        emoji = "🎉";
        progressColor = "#ffd700";
        bgColor = "rgba(255, 215, 0, 0.15)";
        borderColor = "rgba(255, 215, 0, 0.6)";
      } else if (percentage >= 80) {
        emoji = "🌟";
        progressColor = "#ffd700";
        bgColor = "rgba(255, 215, 0, 0.1)";
        borderColor = "rgba(255, 215, 0, 0.4)";
      } else if (percentage >= 50) {
        emoji = "⭐";
        progressColor = "#a259ff";
        bgColor = "rgba(162, 89, 255, 0.15)";
        borderColor = "rgba(162, 89, 255, 0.5)";
      } else if (percentage >= 25) {
        emoji = "📈";
        progressColor = "#00ffff";
        bgColor = "rgba(0, 255, 255, 0.1)";
        borderColor = "rgba(0, 255, 255, 0.4)";
      } else {
        emoji = "📝";
        progressColor = "#00ffff";
        bgColor = "rgba(0, 255, 255, 0.08)";
        borderColor = "rgba(0, 255, 255, 0.3)";
      }
      
      // 更新統計顯示
      categoryStats.innerHTML = `
        <div style="margin-bottom: 8px;">
          <strong style="font-size: 1.1rem;">${emoji} ${selectedCategory} 分類統計</strong>
        </div>
        <div style="margin-bottom: 6px;">
          <span style="color: ${progressColor}; font-weight: bold; font-size: 1rem;">
            已收集：${collectedCards} / ${totalCards}
          </span>
        </div>
        <div style="
          background: rgba(0, 0, 0, 0.3);
          border-radius: 10px;
          height: 8px;
          margin: 8px 0;
          overflow: hidden;
        ">
          <div style="
            background: linear-gradient(90deg, ${progressColor}, ${progressColor}88);
            height: 100%;
            width: ${percentage}%;
            transition: width 0.5s ease;
            border-radius: 10px;
            box-shadow: 0 0 8px ${progressColor}66;
          "></div>
        </div>
        <div style="color: ${progressColor}; font-weight: bold;">
          完成度：${percentage}%
        </div>
      `;
      
      // 更新樣式
      categoryStats.style.background = bgColor;
      categoryStats.style.borderColor = borderColor;
      categoryStats.style.color = progressColor;
      categoryStats.style.display = "block";
      
      // 添加動畫效果
      categoryStats.style.animation = "none";
      setTimeout(() => {
        categoryStats.style.animation = "fadeInScale 0.3s ease";
      }, 10);
    }

    // -------- 4. 渲染卡片倉庫(搜尋+篩選+解鎖狀態) --------
    function renderCards() {
      // 重新拿 localStorage，確保與抽卡頁同步
      try {
        ownedCards = LinkageSystem.cards.getOwnedCards();
        recentlyObtainedCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
        
        // 添加調試資訊
        console.log('🔍 renderCards 調試資訊:');
        console.log('- ownedCards 數量:', Object.keys(ownedCards).length);
        console.log('- recentlyObtainedCards 數量:', recentlyObtainedCards.length);
        console.log('- window.allCards 數量:', window.allCards ? window.allCards.length : 'undefined');
      } catch (error) {
        console.error('獲取卡片資料時發生錯誤:', error);
        ownedCards = {};
        recentlyObtainedCards = [];
      }

      const search = document.getElementById("searchInput").value.trim().toLowerCase();
      const filterRarity = document.getElementById("rarityFilter").value;
      const filterCategory = document.getElementById("categoryFilter").value;
      const ownedFilter = document.querySelector('.tab-btn.active').dataset.filter;
      const showOwnedOnly = (ownedFilter === 'owned');
      const grid = document.getElementById("cardGrid");
      grid.innerHTML = "";

      // 簡化後的排序邏輯
      const sortedCards = [...window.allCards].sort((a, b) => {
        const aIsUnlocked = LinkageSystem.cards.isCardOwned(a.word);
        const bIsUnlocked = LinkageSystem.cards.isCardOwned(b.word);

        // 1. 已解鎖的卡片優先
        if (aIsUnlocked !== bIsUnlocked) {
          return aIsUnlocked ? -1 : 1;
        }

        // 2. 稀有度高的優先
        const rarityOrder = { '超稀有': 3, '稀有': 2, '普通': 1 };
        const aRarity = rarityOrder[a.rarity] || 0;
        const bRarity = rarityOrder[b.rarity] || 0;
        if (aRarity !== bRarity) {
          return bRarity - aRarity;
        }
        
        // 3. 最後依照 ID 排序
        return (a.id || 0) - (b.id || 0);
      });

      let unlockedCount = 0;
      sortedCards.forEach(card => {
        // 搜尋單字或中文
        const combinedText = (card.word + card.zh).toLowerCase();
        const matchSearch = combinedText.includes(search);
        // 篩稀有度
        const matchRarity = (filterRarity === 'all' || card.rarity === filterRarity);
        // 篩類別
        const matchCategory = (filterCategory === 'all' || card.category === filterCategory);

        const isUnlocked = LinkageSystem.cards.isCardOwned(card.word);
        const isNewCardFlag = recentlyObtainedCards.includes(card.word);

        let shardDisplayHtml = '';
        if (isUnlocked) {
          shardDisplayHtml = `<div class="shard-count shard-unlocked">✔</div>`;
        } else {
          shardDisplayHtml = `<div class="shard-count">未解鎖</div>`;
        }

        // 篩選已有卡片 (此功能已移除，改為標記)
        const matchOwned = !showOwnedOnly || isUnlocked;

        if (!(matchSearch && matchRarity && matchCategory && matchOwned)) return;

        // CSS class
        const rarityClass = card.rarity === '普通' ? 'common'
                             : card.rarity === '稀有' ? 'rare' : 'epic';

        const div = document.createElement("div");
        div.className = `card ${rarityClass}${isUnlocked ? ' unlocked' : ' locked'}`;
        div.setAttribute('data-word', card.word); // 添加data-word屬性用於定位
        
        // 根據稀有度決定邊框底圖
        if (card.rarity === '普通') {
          div.style.backgroundImage = "url('img/border/common.jpg')";
        } else if (card.rarity === '稀有') {
          div.style.backgroundImage = "url('img/border/rare.png')";
        } else if (card.rarity === '超稀有') {
          div.style.backgroundImage = "url('img/border/epic.png')";
        }

        // 星星圖示
        let starIcons = '';
        if (card.rarity === '普通') starIcons = '★';
        else if (card.rarity === '稀有') starIcons = '★★';
        else if (card.rarity === '超稀有') starIcons = '★★★';

        // 準備卡片內容
        let mediaContent = '';
        // 判斷圖片型態，產生正方形縮圖（mp4 擷取第一幀）
        let imgSrc = card.image;
        if (imgSrc && imgSrc.endsWith('.mp4')) {
          // mp4 檔案：用 video 標籤擷取第一幀作為縮圖
          mediaContent = `
            <video class="card-media" preload="metadata" muted playsinline>
              <source src="${imgSrc}" type="video/mp4">
            </video>
          `;
        } else {
          // 一般圖片
          mediaContent = `
            <img class="card-media" src="${imgSrc}" alt="${card.word}" onerror="this.onerror=null;this.src='img/cards/placeholder.jpg'">
          `;
        }
        let cardContent = `
          ${mediaContent}
        `;
        
        // 如果是新卡片且已解鎖，添加NEW標籤
        if (recentlyObtainedCards.includes(card.word) && isUnlocked) {
          cardContent = `
            <div class="new-card-badge">NEW!</div>
            ${cardContent}
          `;
        }

        div.innerHTML = cardContent;

        // 只有已解鎖卡片才綁定點擊事件
        if (isUnlocked) {
          div.onclick = (event) => {
            // 檢查是否點擊的是影片按鈕，如果是則不處理（讓影片按鈕自己處理）
            if (event.target.closest('.video-button')) {
              return;
            }
            
            // 打開 Modal
            openModal(card);
          };
          
          // 只有已解鎖卡片的影片才添加點擊事件和懸停事件
          const videoElement = div.querySelector('video');
          if (videoElement) {
            // 點擊播放/暫停
            videoElement.addEventListener('click', (e) => {
              e.stopPropagation();
              if (videoElement.paused) {
                videoElement.play();
              } else {
                videoElement.pause();
              }
            });
            
            // 滑鼠懸停時播放，離開時暫停
            div.addEventListener('mouseenter', () => {
              if (videoElement.paused) {
                videoElement.play().catch(err => {
                  console.log('影片播放失敗:', err);
                });
              }
            });
            
            div.addEventListener('mouseleave', () => {
              if (!videoElement.paused) {
                videoElement.pause();
              }
            });
          }
          
          unlockedCount++;
        } else {
          // 未解鎖卡片：禁用所有點擊事件
          div.style.pointerEvents = 'none';
          div.style.cursor = 'not-allowed';
          
          // 禁用未解鎖卡片的影片播放
          const videoElements = div.querySelectorAll('video');
          videoElements.forEach(video => {
            video.style.pointerEvents = 'none';
            video.controls = false;
            video.autoplay = false;
            video.muted = true;
            video.pause();
          });
          
          // 為未解鎖卡片添加鎖定遮罩
          const lockOverlay = document.createElement('div');
          lockOverlay.className = 'lock-overlay';
          lockOverlay.innerHTML = `
            <div class="lock-icon">🔒</div>
            <div class="lock-text">未解鎖</div>
          `;
          div.appendChild(lockOverlay);
        }

        grid.appendChild(div);
      });

      document.getElementById("progress").textContent = `已解鎖：${unlockedCount} / ${window.allCards.length}`;
      
      // 更新卡片統計（移除重複呼叫，避免效能問題）
      // updateCardStats();

      // 為每張卡片添加右鍵選單
      document.querySelectorAll('.card').forEach(cardElement => {
        cardElement.addEventListener('contextmenu', function(e) {
          e.preventDefault();
          
          const cardWord = this.getAttribute('data-word');
          const card = window.allCards.find(c => c.word === cardWord);
          
          if (!card) return;
          
          // 如果是生日蛋糕卡片且未設定生日，顯示生日設定選項
          if (card.word === 'Birthday Cake' && !BirthdaySystem.hasBirthdaySet()) {
            showBirthdayContextMenu(e, card);
          }
        });
      });
    }

    // -------- 4.5. 切換已有卡片篩選 --------
    function toggleOwnedFilter() {
      const button = document.getElementById("ownedFilter");
      button.classList.toggle("active");
      renderCards();
    }

    // -------- 5. Modal 的開啟/關閉 邏輯 --------
    
    // YouTube URL 轉換函數
    function getYouTubeEmbedUrl(url) {
      if (!url) return null;
      
      // 支援多種YouTube URL格式
      const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
        /youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/
      ];
      
      for (let pattern of patterns) {
        const match = url.match(pattern);
        if (match) {
          return `https://www.youtube.com/embed/${match[1]}?rel=0&modestbranding=1`;
        }
      }
      
      return null;
    }
    
    // 根據卡片內容自動生成YouTube搜尋URL
    function getYouTubeSearchUrl(card) {
      // 使用卡片的中英文名稱作為搜尋關鍵字
      const searchTerm = encodeURIComponent(`${card.word} ${card.zh}`);
      // 使用YouTube搜尋頁面，讓用戶可以手動搜尋相關影片
      return `https://www.youtube.com/results?search_query=${searchTerm}`;
    }
    
    // 檢測是否應該顯示YouTube影片
    function shouldShowYouTube(card) {
      // 如果卡片沒有影片但有圖片，則顯示YouTube
      return card.image && !card.image.endsWith('.mp4') && 
             !card.image.includes('youtube.com') && 
             !card.image.includes('youtu.be');
    }
    
    function openModal(card) {
      // 移除該卡片的 NEW 標記
      removeNewCardMarker(card.word);

      // 準備稀有度星星
      let starIcons = '';
      if (card.rarity === '普通') starIcons = '★';
      else if (card.rarity === '稀有') starIcons = '★★';
      else if (card.rarity === '超稀有') starIcons = '★★★';
      
      // 準備稀有度標籤
      let rarityLabel = '';
      if (card.rarity === '普通') rarityLabel = 'A';
      else if (card.rarity === '稀有') rarityLabel = 'R';
      else if (card.rarity === '超稀有') rarityLabel = 'SSR';
      
      console.log('稀有度標籤:', rarityLabel, '星星:', starIcons);
      
      let rarityIconHtml = `
        <div class="rarity-stars">${starIcons}</div>
        <div class="rarity-label">${rarityLabel}</div>
      `;

      // 準備稀有度CSS類別
      let rarityClass = '';
      if (card.rarity === '普通') rarityClass = 'common';
      else if (card.rarity === '稀有') rarityClass = 'rare';
      else if (card.rarity === '超稀有') rarityClass = 'epic';

      // 準備媒體內容
      let mediaContent = '';
      if (card.image) {
        if (card.image.endsWith('.mp4')) {
          // MP4 影片
          mediaContent = `<video class="modal-video" controls>
            <source src="${card.image}" type="video/mp4">
          </video>`;
        } else if (card.image.includes('youtube.com') || card.image.includes('youtu.be')) {
          // YouTube 影片
          const embedUrl = getYouTubeEmbedUrl(card.image);
          if (embedUrl) {
            mediaContent = `<iframe class="modal-youtube" 
              src="${embedUrl}" 
              frameborder="0" 
              allowfullscreen>
            </iframe>`;
          } else {
            // 如果無法解析YouTube URL，顯示預設圖片
            mediaContent = `<img class="modal-image" src="${card.image}" alt="${card.word}">`;
          }
        } else {
          // 一般圖片 - 提供YouTube搜尋選項
          const youtubeUrl = getYouTubeSearchUrl(card);
          mediaContent = `
            <div class="modal-image-container">
              <img class="modal-image" src="${card.image}" alt="${card.word}">
              <div class="youtube-overlay">
                <button class="youtube-search-btn" onclick="window.open('${youtubeUrl}', '_blank')">
                  <span class="material-icons">play_circle</span>
                  <span>搜尋YouTube影片</span>
                </button>
              </div>
            </div>
          `;
        }
      } else {
        // 沒有圖片時的預設內容
        mediaContent = `<div class="modal-no-media">
          <span class="material-icons">image</span>
          <p>無媒體內容</p>
        </div>`;
      }

      // 準備完整卡片內容
      let modalContent = `
        <div class="modal-card ${rarityClass}">
          ${rarityIconHtml}
          <div class="modal-title">
            <div class="chinese-text">${card.zh}</div>
            <div class="english-text">${card.word}</div>
          </div>
          <div class="modal-media">
            ${mediaContent}
          </div>
          <div class="modal-info">
            <div class="modal-category">類別：${card.category}</div>
            <div class="modal-description">${card.description}</div>
          </div>
        </div>
      `;

      // 清空 modalCardContainer，放入完整內容
      const container = document.getElementById('modalCardContainer');
      container.innerHTML = modalContent;

      document.getElementById("overlay").style.display = "block";
      document.getElementById("modal").classList.add("show");
    }



    function closeModal() {
      // 停止Modal中的影片播放
      const modalVideo = document.querySelector('#modal video');
      if (modalVideo) {
        modalVideo.pause();
        modalVideo.currentTime = 0;
      }
      
      // 移除YouTube iframe以停止播放
      const modalYouTube = document.querySelector('#modal iframe');
      if (modalYouTube) {
        modalYouTube.remove();
      }
      
      document.getElementById("modal").classList.remove("show");
      document.getElementById("overlay").style.display = "none";
      // 使用新的發音系統停止發音
      if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
      }
    }

    function playModalAudio() {
      const audioElem = document.getElementById("modalAudio");
      if (audioElem && audioElem.src) {
        audioElem.play();
      }
    }

    // -------- 6. 頁面載入時先初始化 「類別選單」 並 renderCards() --------
    // 移除重複的 window.addEventListener("load")，統一在下方處理

    // 設置 Modal 事件
    function setupModalEvents() {
      const overlay = document.getElementById('overlay');
      const modal = document.getElementById('modal');
      
      if (overlay) {
        // 點擊背景遮罩關閉 Modal
        overlay.addEventListener('click', function(e) {
          if (e.target === overlay) {
            closeModal();
          }
        });
      }
      
      if (modal) {
        // 點擊 Modal 內容區域不關閉
        modal.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      }
      
      // ESC 鍵關閉 Modal
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeModal();
        }
      });
    }

    // -------- 7. 碎片系統相關函數 --------
    // 已刪除 toggleShardInfo 函數，因為不再需要切換說明顯示

    // -------- 8. 新卡片系統相關函數 --------
    function clearNewCardMarkers() {
      // 清除最近獲得的卡片標記
      localStorage.removeItem('recentlyObtainedCards');
      localStorage.removeItem('newCardTimestamps');
      recentlyObtainedCards = [];
      renderCards();
    }

    function addNewCard(cardWord) {
      // 添加新卡片到最近獲得列表
      let recentCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
      let cardTimestamps = JSON.parse(localStorage.getItem('newCardTimestamps') || '{}');
      
      if (!recentCards.includes(cardWord)) {
        recentCards.push(cardWord);
        // 記錄獲得時間戳
        cardTimestamps[cardWord] = Date.now();
        
        // 只保留最近20張新卡片
        if (recentCards.length > 20) {
          const oldestCard = recentCards.shift();
          delete cardTimestamps[oldestCard];
        }
        
        localStorage.setItem('recentlyObtainedCards', JSON.stringify(recentCards));
        localStorage.setItem('newCardTimestamps', JSON.stringify(cardTimestamps));
      }
    }

    // 移除單張卡片的 NEW 標記
    function removeNewCardMarker(cardWord) {
      let recentCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
      let cardTimestamps = JSON.parse(localStorage.getItem('newCardTimestamps') || '{}');
      
      // 如果卡片在新卡片列表中，則移除它
      if (recentCards.includes(cardWord)) {
        recentCards = recentCards.filter(card => card !== cardWord);
        delete cardTimestamps[cardWord];
        
        localStorage.setItem('recentlyObtainedCards', JSON.stringify(recentCards));
        localStorage.setItem('newCardTimestamps', JSON.stringify(cardTimestamps));
        
        // 更新頁面變數
        recentlyObtainedCards = recentCards;
        
        // 重新渲染卡片以移除 NEW 標記
        renderCards();
        
        console.log(`✅ 已移除「${cardWord}」的 NEW 標記`);
      }
    }

    // 自動清除新卡片標記（10分鐘後）
    function autoClearNewCards() {
      const cardTimestamps = JSON.parse(localStorage.getItem('newCardTimestamps') || '{}');
      const now = Date.now();
      const tenMinutes = 10 * 60 * 1000; // 10分鐘
      
      let hasExpiredCards = false;
      const expiredCards = [];
      
      // 檢查是否有過期的卡片
      Object.keys(cardTimestamps).forEach(cardWord => {
        const timestamp = cardTimestamps[cardWord];
        if (now - timestamp > tenMinutes) {
          expiredCards.push(cardWord);
          delete cardTimestamps[cardWord];
          hasExpiredCards = true;
        }
      });
      
      // 如果有過期卡片，更新 localStorage
      if (hasExpiredCards) {
        let recentCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
        recentCards = recentCards.filter(card => !expiredCards.includes(card));
        
        localStorage.setItem('recentlyObtainedCards', JSON.stringify(recentCards));
        localStorage.setItem('newCardTimestamps', JSON.stringify(cardTimestamps));
        
        // 更新頁面變數
        recentlyObtainedCards = recentCards;
        
        // 只在有過期卡片時才重新渲染，避免不必要的重複渲染
        if (expiredCards.length > 0) {
          renderCards();
          console.log(`⏰ 已移除 ${expiredCards.length} 張過期的新卡片標記：`, expiredCards);
        }
      }
      
      // 移除頻繁的 console.log，避免效能問題
      // console.log('⏰ 檢查新卡片標記完成');
    }

    // 檢查卡片是否為新卡片（10分鐘內）
    function isNewCard(cardWord) {
      const cardTimestamps = JSON.parse(localStorage.getItem('newCardTimestamps') || '{}');
      const timestamp = cardTimestamps[cardWord];
      
      if (!timestamp) return false;
      
      const now = Date.now();
      const tenMinutes = 10 * 60 * 1000; // 10分鐘
      
      return (now - timestamp) <= tenMinutes;
    }

    // 獲取效果類型的中文名稱
    function getEffectTypeName(effectType) {
      const typeNames = {
        'time_extend': '時間延長',
        'time_freeze': '時間暫停',
        'hint': '提示輔助',
        'shield': '護盾保護',
        'energy_restore': '能量恢復',
        'combo_protect': '連擊保護',
        'score_multiply': '分數加倍',
        'skip_level': '跳過關卡'
      };
      return typeNames[effectType] || '未知效果';
    }

    // 調試信息
    function debugNewCardInfo() {
      console.log('🔍 調試信息：');
      console.log('recentlyObtainedCards:', recentlyObtainedCards);
      console.log('ownedCards keys:', Object.keys(ownedCards));
      console.log('localStorage recentlyObtainedCards:', localStorage.getItem('recentlyObtainedCards'));
      console.log('ownedCards 完整內容:', ownedCards);
      
      // 測試卡片檢查已移除
      
      // 顯示時間戳信息
      const cardTimestamps = JSON.parse(localStorage.getItem('newCardTimestamps') || '{}');
      console.log('newCardTimestamps:', cardTimestamps);
      
      // 顯示每張新卡片的剩餘時間
      const now = Date.now();
      const tenMinutes = 10 * 60 * 1000;
      Object.keys(cardTimestamps).forEach(cardWord => {
        const timestamp = cardTimestamps[cardWord];
        const elapsed = now - timestamp;
        const remaining = tenMinutes - elapsed;
        const remainingMinutes = Math.max(0, Math.floor(remaining / 60000));
        const remainingSeconds = Math.max(0, Math.floor((remaining % 60000) / 1000));
        console.log(`⏰ ${cardWord}: 剩餘 ${remainingMinutes}分${remainingSeconds}秒`);
      });
    }

    // 更新卡片統計
    function updateCardStats() {
      const totalCards = window.allCards.length;
      const ownedCards = LinkageSystem.cards.getOwnedCards();
      const unlockedCards = Object.keys(ownedCards).length;
      
      // 更新頁面頂部的星星顯示
      const totalStars = parseInt(localStorage.getItem('totalStars') || '0');
      const starsDisplay = document.getElementById('totalStarsCount');
      if (starsDisplay) {
        starsDisplay.textContent = `⭐ ${totalStars}`;
      }
      
      // 更新進度顯示
      const progressText = `已解鎖：${unlockedCards} / ${totalCards}`;
      document.getElementById("progress").textContent = progressText;
    }

    // -------- 9. YouTube 影片相關函數 --------
    
    // 播放影片函數
    function playVideo(videoUrl, cardWord) {
      if (!videoUrl) {
        alert('沒有影片連結');
        return;
      }
      
      // 檢查是否為 YouTube 連結
      if (/youtu(be\.com|\.be)/.test(videoUrl)) {
        const youtubeId = extractYouTubeId(videoUrl);
        if (youtubeId) {
          // 開啟 YouTube 影片 Modal
          openVideoModal(youtubeId, cardWord, 'youtube');
        } else {
          alert('YouTube 連結格式錯誤');
        }
      } else {
        // 本地 MP4 影片
        openVideoModal(videoUrl, cardWord, 'mp4');
      }
    }
    
    // 開啟影片 Modal
    function openVideoModal(videoSource, cardWord, type) {
      // 創建影片 Modal
      const modal = document.createElement('div');
      modal.className = 'video-modal';
      modal.innerHTML = `
        <div class="video-modal-content">
          <div class="video-modal-header">
            <h3>${cardWord}</h3>
            <button class="video-modal-close" onclick="closeVideoModal()">×</button>
          </div>
          <div class="video-modal-body">
            ${type === 'youtube' 
              ? `<iframe src="https://www.youtube.com/embed/${videoSource}?controls=1&showinfo=1&rel=0&modestbranding=1" 
                   frameborder="0" allow="encrypted-media" allowfullscreen></iframe>`
              : `<video controls>
                   <source src="${videoSource}" type="video/mp4">
                   您的瀏覽器不支援影片播放
                 </video>`
            }
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // 點擊背景關閉 Modal
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeVideoModal();
        }
      });
      
      // ESC 鍵關閉 Modal
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeVideoModal();
        }
      });
    }
    
    // 關閉影片 Modal
    function closeVideoModal() {
      const modal = document.querySelector('.video-modal');
      if (modal) {
        modal.remove();
      }
    }
    
    // 新增：切換影片播放/暫停
    function toggleVideoPlayback(controlElement) {
      const video = controlElement.parentElement.querySelector('video');
      if (!video) return;
      
      if (video.paused) {
        video.play();
        controlElement.textContent = '⏸️ 暫停';
      } else {
        video.pause();
        controlElement.textContent = '▶️ 播放';
      }
    }
    
    function extractYouTubeId(url) {
      const patterns = [
        /(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([\w-]{11})/,
        /youtube\.com\/embed\/([\w-]{11})/,
        /youtu\.be\/([\w-]{11})/
      ];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
          return match[1];
        }
      }
      return null;
    }



    // =================== 測試者整合程式碼 ===================
    // 如果要用測試者指令（例如：加星、解鎖所有），可以在 localStorage 裡放 testerInstructions
    // { "addStars": true, "unlockAllCards": true, "testerMode": true }
    let stars = parseInt(localStorage.getItem("totalStars") || "0");

    function updateStars() {
      // 如果有 #stars 或 #totalStarsCount 元素，就更新它
      const el = document.getElementById("stars") || document.getElementById("totalStarsCount");
      if (el) {
        // 為 totalStarsCount 元素加上星星符號
        if (el.id === 'totalStarsCount') {
          el.textContent = `⭐ ${stars}`;
        } else {
          el.textContent = stars;
        }
      }
      localStorage.setItem("totalStars", stars);
    }

    window.addEventListener("load", () => {
      updateStars();
      
      // 移除重複的初始化邏輯，讓 waitForAllCards() 統一處理
      // if (!window.allCards || window.allCards.length === 0) {
      //   console.error('警告：allCards 為空陣列，可能是 cards.js 載入失敗');
      //   waitForAllCards();
      // } else {
      //   initializePage();
      // }
    });



    console.log('allCards 長度:', window.allCards.length);

    // 移除重複的初始化邏輯，避免多次呼叫 initializePage()
    // if (!window.allCards || window.allCards.length === 0) {
    //   console.error('警告：allCards 為空陣列，可能是 cards.js 載入失敗');
    //   waitForAllCards();
    // } else {
    //   initializePage();
    // }

    function initializePage() {
      // 初始化音效系統
      if (typeof SoundSystem !== 'undefined') {
        SoundSystem.speech.init();
      }
      
      // 初始化音樂系統
      setTimeout(() => {
        initBackgroundMusic();
        
        // 綁定音樂控制按鈕事件
        const musicBtn = document.getElementById('toggleMusic');
        if (musicBtn) {
          musicBtn.addEventListener('click', toggleBackgroundMusic);
          console.log('🎵 音樂控制按鈕事件已綁定');
        }
        
        // 添加用戶互動觸發音樂播放
        let hasUserInteracted = false;
        
        function handleUserInteraction() {
          if (!hasUserInteracted) {
            hasUserInteracted = true;
            console.log('👆 用戶互動觸發，音樂系統已啟用');
            
            // 如果應該播放但還沒播放，嘗試播放
            if (isMusicPlaying && backgroundMusic && backgroundMusic.paused) {
              playBackgroundMusic();
            }
          }
        }
        
        // 監聽各種用戶互動事件
        ['click', 'touchstart', 'keydown'].forEach(eventType => {
          document.addEventListener(eventType, handleUserInteraction, { once: true });
        });
      }, 500);
      
      // 監聽頁面可見性變化，處理音樂暫停/恢復
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          // 頁面隱藏時暫停音樂
          if (isMusicPlaying && backgroundMusic) {
            backgroundMusic.pause();
          }
        } else {
          // 頁面顯示時恢復音樂
          if (isMusicPlaying && backgroundMusic && backgroundMusic.paused) {
            backgroundMusic.play().catch(err => {
              console.log('頁面恢復時音樂播放失敗:', err);
            });
          }
        }
      });
      
      // 初始化頁籤按鈕
      document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const clickedButton = e.currentTarget;
          if (clickedButton.classList.contains('active')) {
            return; // 如果點擊的已經是啟用狀態，則不重複執行
          }
          document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
          clickedButton.classList.add('active');
          renderCards();
          updateCategoryStats();
        });
      });
      
      // 初始化新卡片系統
      autoClearNewCards();
      
      // 設置定時器，每分鐘檢查一次過期的新卡片標記
      setInterval(autoClearNewCards, 60 * 1000); // 每分鐘檢查一次
      
      // 初始化頁面
      initCategoryOptions();
      renderCards();
      updateCardStats(); // 確保星星數同步
      updateCategoryStats(); // 初始化分類統計
      // updateShardStats(); // 已移除碎片系統
      
      // 設置 Modal 事件
      setupModalEvents();
      
      // 設置觸控設備優化
      setupTouchOptimization();
      
      // 檢查並突出顯示新解鎖的卡片
      setTimeout(() => {
        highlightNewCards();
      }, 500); // 延遲500ms確保卡片已渲染完成
      
      // 設置影片效能優化定時器
      setInterval(optimizeVideoPerformance, 2000); // 每2秒檢查一次影片效能
      
      // 調試信息
      debugNewCardInfo();
      
      // 如果有新卡片，顯示提示
      if (recentlyObtainedCards.length > 0) {
        console.log(`🎉 發現 ${recentlyObtainedCards.length} 張新卡片！`);
      } else {
        console.log('📝 目前沒有新卡片標記');
      }
      
      // 添加鍵盤快捷鍵
      document.addEventListener('keydown', (e) => {
        // 音樂控制快捷鍵
        if (e.key === 'm' || e.key === 'M') {
          toggleBackgroundMusic();
        }
      });
      
      setupVirtualScroll();
      renderCardsVirtual();
    }

    // -------- 9. YouTube 影片相關函數 --------
    
    // 新增：觸控設備優化
    function setupTouchOptimization() {
      // 檢測是否為觸控設備
      const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      
      if (isTouchDevice) {
        console.log('📱 檢測到觸控設備，啟用觸控優化');
        
        // 為觸控設備添加特殊的影片控制
        document.addEventListener('click', (e) => {
          const video = e.target.closest('.card')?.querySelector('video.card-media');
          if (video) {
            e.preventDefault();
            e.stopPropagation();
            
            if (video.paused) {
              video.play().catch(err => {
                console.log('觸控設備影片播放失敗:', err);
              });
            } else {
              video.pause();
            }
          }
        });
      }
    }
    
    // 新增：新卡片高亮動畫
    const style = document.createElement('style');
    style.textContent = `
      @keyframes newCardHighlight {
        0%, 100% { 
          transform: scale(1);
          box-shadow: 0 0 16px #00ffff55, 0 0 32px #a259ff33;
        }
        50% { 
          transform: scale(1.1);
          box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc, 0 0 20px #ffd700;
        }
      }
    `;
    document.head.appendChild(style);

    // 輔助函數：判斷是否為SSR
    function isSSR(card) {
      return card.rarity === '超稀有' || card.rarity === '節日限定';
    }

    // 碎片轉換星星功能已移除（碎片系統已移除）



    // 顯示生日設定右鍵選單
    function showBirthdayContextMenu(e, card) {
      // 移除現有的右鍵選單
      const existingMenu = document.querySelector('.context-menu');
      if (existingMenu) {
        existingMenu.remove();
      }
      
      const menu = document.createElement('div');
      menu.className = 'context-menu';
      menu.style.cssText = `
        position: fixed;
        top: ${e.clientY}px;
        left: ${e.clientX}px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        padding: 8px 0;
        min-width: 200px;
      `;
      
      menu.innerHTML = `
        <div style="padding: 8px 16px; border-bottom: 1px solid #eee; font-weight: bold; color: #333;">
          🎂 生日蛋糕卡片
        </div>
        <div style="padding: 8px 16px; cursor: pointer; transition: background 0.2s;" 
             onmouseover="this.style.background='#f5f5f5'" 
             onmouseout="this.style.background='transparent'"
             onclick="BirthdaySystem.showBirthdaySetupDialog(); this.parentElement.remove();">
          📅 設定生日日期
        </div>
        <div style="padding: 8px 16px; color: #666; font-size: 12px;">
          設定後在生日當天會自動獲得此卡片
        </div>
      `;
      
      document.body.appendChild(menu);
      
      // 點擊其他地方關閉選單
      setTimeout(() => {
        document.addEventListener('click', function closeMenu() {
          menu.remove();
          document.removeEventListener('click', closeMenu);
        });
      }, 100);
    }

    // 在頁面載入時初始化生日系統
    document.addEventListener('DOMContentLoaded', function() {
      // 檢查並顯示生日祝福
      if (typeof BirthdaySystem !== 'undefined') {
        BirthdaySystem.checkAndGiveBirthdayCard();
      }
    });

    console.log('allCards 長度:', window.allCards.length);

    // 移除重複的初始化邏輯
    // if (!window.allCards || window.allCards.length === 0) {
    //   console.error('警告：allCards 為空陣列，可能是 cards.js 載入失敗');
    //   waitForAllCards();
    // } else {
    //   initializePage();
    // }

    // 清理無效的 ownedCards 資料
    function cleanOwnedCards() {
        const ownedCards = JSON.parse(localStorage.getItem('ownedCards') || '{}');
        const allCardWords = window.allCards.map(card => card.word);
        
        // 只保留在 allCards 中存在的卡片
        const cleanedOwnedCards = {};
        Object.keys(ownedCards).forEach(word => {
            if (allCardWords.includes(word)) {
                cleanedOwnedCards[word] = ownedCards[word];
            } else {
                console.log('移除無效卡片:', word);
            }
        });
        
        localStorage.setItem('ownedCards', JSON.stringify(cleanedOwnedCards));
        console.log('清理完成，有效卡片數量:', Object.keys(cleanedOwnedCards).length);
        
        // 重新渲染頁面
        if (typeof renderCards === 'function') {
            renderCards();
        }
    }

    // 移除自動執行清理，避免在頁面載入時就清空卡片資料
    // cleanOwnedCards();

    // 測試卡片已清理完成

    // ====== 進階虛擬捲動優化 ======
    const CARD_HEIGHT = 160;
    const BUFFER_ROWS = 1;
    let cardsPerRow = 0;
    let visibleRows = 0;
    let lastStartIdx = -1;
    let cardDomPool = [];
    let cardDomInUse = [];
    let debounceTimers = {};

    function getCardsPerRow() {
      const grid = document.getElementById('cardGrid');
      const gridWidth = grid.offsetWidth;
      const cardWidth = 120 + 20;
      return Math.max(1, Math.floor(gridWidth / cardWidth));
    }

    function getVisibleRows() {
      const grid = document.getElementById('cardGrid');
      const gridHeight = grid.offsetHeight;
      return Math.ceil(gridHeight / CARD_HEIGHT);
    }

    function preloadImage(src) {
      if (!src) return;
      const img = new window.Image();
      img.src = src;
    }

    // ====== 進階虛擬捲動優化（行動裝置專屬） ======
    function isTouchDevice() {
      return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    }

    function renderCardsVirtual() {
      window.requestAnimationFrame(() => {
        try {
          ownedCards = LinkageSystem.cards.getOwnedCards();
          recentlyObtainedCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
        } catch (error) {
          ownedCards = {};
          recentlyObtainedCards = [];
        }
        const search = document.getElementById("searchInput").value.trim().toLowerCase();
        const filterRarity = document.getElementById("rarityFilter").value;
        const filterCategory = document.getElementById("categoryFilter").value;
        const ownedFilter = document.querySelector('.tab-btn.active').dataset.filter;
        const showOwnedOnly = (ownedFilter === 'owned');
        const grid = document.getElementById("cardGrid");

        // 排序與篩選
        const sortedCards = [...window.allCards].sort((a, b) => {
          const aIsUnlocked = LinkageSystem.cards.isCardOwned(a.word);
          const bIsUnlocked = LinkageSystem.cards.isCardOwned(b.word);
          if (aIsUnlocked !== bIsUnlocked) return aIsUnlocked ? -1 : 1;
          const rarityOrder = { '超稀有': 3, '稀有': 2, '普通': 1 };
          const aRarity = rarityOrder[a.rarity] || 0;
          const bRarity = rarityOrder[b.rarity] || 0;
          if (aRarity !== bRarity) return bRarity - aRarity;
          return (a.id || 0) - (b.id || 0);
        });
        const filteredCards = sortedCards.filter(card => {
          const combinedText = (card.word + card.zh).toLowerCase();
          const matchSearch = combinedText.includes(search);
          const matchRarity = (filterRarity === 'all' || card.rarity === filterRarity);
          const matchCategory = (filterCategory === 'all' || card.category === filterCategory);
          const isUnlocked = LinkageSystem.cards.isCardOwned(card.word);
          const matchOwned = !showOwnedOnly || isUnlocked;
          return matchSearch && matchRarity && matchCategory && matchOwned;
        });

        // 虛擬捲動計算
        cardsPerRow = getCardsPerRow();
        visibleRows = getVisibleRows();
        const totalRows = Math.ceil(filteredCards.length / cardsPerRow);
        const scrollTop = grid.scrollTop;
        const startRow = Math.max(0, Math.floor(scrollTop / CARD_HEIGHT) - BUFFER_ROWS);
        const endRow = Math.min(totalRows, Math.ceil((scrollTop + grid.offsetHeight) / CARD_HEIGHT) + BUFFER_ROWS);
        const startIdx = startRow * cardsPerRow;
        const endIdx = Math.min(filteredCards.length, endRow * cardsPerRow);

        if (lastStartIdx === startIdx && grid.childElementCount > 0) return;
        lastStartIdx = startIdx;

        // 預載圖片（可見區域前後 2 行）
        for (let i = Math.max(0, startIdx - 2 * cardsPerRow); i < Math.min(filteredCards.length, endIdx + 2 * cardsPerRow); i++) {
          const card = filteredCards[i];
          if (card.image && !card.image.endsWith('.mp4')) preloadImage(card.image);
        }

        // DOM 池重用
        if (!cardDomPool.length || cardDomPool.length < (endIdx - startIdx)) {
          for (let i = cardDomPool.length; i < (endIdx - startIdx); i++) {
            const div = document.createElement('div');
            cardDomPool.push(div);
          }
        }
        cardDomInUse = [];

        // 產生佔位高度
        const topSpace = document.createElement('div');
        topSpace.style.height = `${startRow * CARD_HEIGHT}px`;
        const bottomSpace = document.createElement('div');
        bottomSpace.style.height = `${(totalRows - endRow) * CARD_HEIGHT}px`;

        // 渲染可見卡片
        for (let i = startIdx, poolIdx = 0; i < endIdx; i++, poolIdx++) {
          const card = filteredCards[i];
          const isUnlocked = LinkageSystem.cards.isCardOwned(card.word);
          const rarityClass = card.rarity === '普通' ? 'common' : card.rarity === '稀有' ? 'rare' : 'epic';
          const div = cardDomPool[poolIdx];
          div.className = `card ${rarityClass}${isUnlocked ? ' unlocked' : ' locked'}`;
          div.setAttribute('data-word', card.word);
          let imgSrc = card.image;
          // 行動裝置只顯示圖片，桌機才支援 hover 載入影片
          let cardContent = `<img class="card-media" src="${imgSrc}" alt="${card.word}" onerror="this.onerror=null;this.src='img/cards/placeholder.jpg'">`;
          if (recentlyObtainedCards.includes(card.word) && isUnlocked) {
            cardContent = `<div class="new-card-badge">NEW!</div>` + cardContent;
          }
          div.innerHTML = cardContent;
          if (isUnlocked) {
            div.onclick = (event) => {
              if (event.target.closest('.video-button')) return;
              openModal(card);
            };
            // 桌機才支援 hover 載入影片
            if (!isTouchDevice() && imgSrc && imgSrc.endsWith('.mp4')) {
              div.onmouseenter = function() {
                clearTimeout(debounceTimers[card.word]);
                debounceTimers[card.word] = setTimeout(() => {
                  if (!div.querySelector('video')) {
                    const video = document.createElement('video');
                    video.className = 'card-media';
                    video.preload = 'none';
                    video.muted = true;
                    video.playsInline = true;
                    video.loop = true;
                    video.style.width = '100%';
                    video.style.height = '100%';
                    const source = document.createElement('source');
                    source.src = imgSrc;
                    source.type = 'video/mp4';
                    video.appendChild(source);
                    video.addEventListener('canplay', () => video.play());
                    video.addEventListener('click', (e) => {
                      e.stopPropagation();
                      if (video.paused) video.play();
                      else video.pause();
                    });
                    const img = div.querySelector('img');
                    if (img) img.remove();
                    div.appendChild(video);
                  }
                }, 100);
              };
              div.onmouseleave = function() {
                clearTimeout(debounceTimers[card.word]);
                debounceTimers[card.word] = setTimeout(() => {
                  const video = div.querySelector('video');
                  if (video) video.remove();
                  if (!div.querySelector('img')) {
                    const img = document.createElement('img');
                    img.className = 'card-media';
                    img.src = imgSrc;
                    img.alt = card.word;
                    img.onerror = function() { this.onerror=null; this.src='img/cards/placeholder.jpg'; };
                    div.appendChild(img);
                  }
                }, 100);
              };
            } else {
              div.onmouseenter = null;
              div.onmouseleave = null;
            }
          } else {
            div.style.pointerEvents = 'none';
            div.style.cursor = 'not-allowed';
            const lockOverlay = document.createElement('div');
            lockOverlay.className = 'lock-overlay';
            lockOverlay.innerHTML = `<div class="lock-icon">🔒</div><div class="lock-text">未解鎖</div>`;
            div.appendChild(lockOverlay);
          }
          cardDomInUse.push(div);
        }
        grid.innerHTML = '';
        grid.appendChild(topSpace);
        cardDomInUse.forEach(div => grid.appendChild(div));
        grid.appendChild(bottomSpace);
        document.getElementById("progress").textContent = `已解鎖：${Object.keys(ownedCards).length} / ${window.allCards.length}`;
      });
    }

    function setupVirtualScroll() {
      const grid = document.getElementById('cardGrid');
      grid.addEventListener('scroll', () => {
        renderCardsVirtual();
      });
      window.addEventListener('resize', () => {
        lastStartIdx = -1;
        renderCardsVirtual();
      });
    }

    // ====== 分類分頁功能 ======
    function renderCategoryTabs() {
      if (!Array.isArray(allCards)) return;
      const categories = Array.from(new Set(allCards.map(card => card.category))).filter(Boolean);
      const tabDiv = document.getElementById('categoryTabs');
      tabDiv.innerHTML = '';
      // "全部"分頁
      const allBtn = document.createElement('button');
      allBtn.textContent = '全部';
      allBtn.className = 'filter-btn active';
      allBtn.onclick = () => filterCardsByCategory('全部');
      tabDiv.appendChild(allBtn);
      // 其他分類
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.textContent = cat;
        btn.className = 'filter-btn';
        btn.onclick = () => filterCardsByCategory(cat);
        tabDiv.appendChild(btn);
      });
    }
    function filterCardsByCategory(category) {
      // 切換按鈕高亮
      document.querySelectorAll('#categoryTabs .filter-btn').forEach(btn => {
        if (btn.textContent === category || (category === '全部' && btn.textContent === '全部')) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      // 過濾卡片顯示
      const grid = document.getElementById('cardGrid');
      if (!Array.isArray(allCards)) return;
      let showCards = (category === '全部') ? allCards : allCards.filter(card => card.category === category);
      // 這裡直接複用現有的卡片渲染邏輯
      grid.innerHTML = '';
      showCards.forEach(card => {
        // 你可以根據現有的卡片渲染方式生成卡片
        // 這裡簡化為只顯示卡片標題
        // 實際應用時請複用原本的卡片 HTML 結構
        // ...
      });
      // 你可以在這裡呼叫原本的卡片渲染函數，或直接複製原本的渲染邏輯
    }
    // 頁面載入時自動渲染分頁
    window.addEventListener('load', () => {
      renderCategoryTabs();
      filterCardsByCategory('全部');
    });
  </script>
</body>
</html>
