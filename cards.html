<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Âç°ÁâáÂÄâÂ∫´ - Typing Hero</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="card-style.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* ====== ÂÖ®ÂüüÊ®£Âºè ====== */
    :root {
      --glow-cyan: #00ffff;
      --glow-magenta: #a259ff;
      --glow-gold: #ffd700;
      --glow-red: #ff6b6b;
      --bg-dark: rgba(10, 20, 40, 0.85);
      --gradient-primary: linear-gradient(135deg, #00ffff 0%, #a259ff 100%);
      --gradient-secondary: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
      --gradient-accent: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
      --shadow-primary: 0 0 20px rgba(0, 255, 255, 0.4);
      --shadow-secondary: 0 0 30px rgba(162, 89, 255, 0.3);
      --shadow-gold: 0 0 25px rgba(255, 215, 0, 0.5);
    }
    html {
      /* scroll-behavior: smooth; */
      overflow-x: hidden;
      width: 100%;
      box-sizing: border-box;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body > * {
      max-width: 100vw;
      overflow-x: hidden;
    }
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0;
      font-family: 'Orbitron', sans-serif;
      background: url('https://wallpaperaccess.com/full/192936.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      text-align: center;
      overflow-y: auto;
      overflow-x: hidden;
      width: 100%;
      box-sizing: border-box;
    }

    /* ====== ÂÖ®ÂüüÊç≤Ëª∏Ê®£Âºè ====== */
    body::-webkit-scrollbar {
      width: 12px;
    }
    body::-webkit-scrollbar-track {
      background: #0a1428; /* Ê∑±ËóçËâ≤ËÉåÊôØÔºåÈÖçÂêà‰∏ªÈ°å */
    }
    body::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, var(--glow-cyan), var(--glow-magenta));
      border-radius: 6px;
      border: 2px solid #0a1428; /* ÂâµÈÄ†Êá∏ÊµÆÊÑü */
    }
    body::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, var(--glow-gold), var(--glow-red)); /* Êá∏ÂÅúÊôÇËÆäËâ≤ */
    }

    header {
      background: linear-gradient(135deg, rgba(10, 20, 40, 0.95) 0%, rgba(20, 40, 80, 0.9) 100%);
      padding: 20px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-primary), var(--shadow-secondary), 0 4px 20px rgba(0, 0, 0, 0.3);
      border-bottom: 3px solid transparent;
      border-image: var(--gradient-primary);
      border-image-slice: 1;
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
      position: relative;
    }
    
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(0, 255, 255, 0.1) 50%, transparent 70%);
      animation: headerShine 3s ease-in-out infinite;
      pointer-events: none;
    }
    
    @keyframes headerShine {
      0%, 100% { transform: translateX(-100%); }
      50% { transform: translateX(100%); }
    }
    header h1 {
      margin: 0;
      font-size: 2.3rem;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 3px;
      text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      font-weight: 700;
      position: relative;
      z-index: 1;
    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .btn {
      background: var(--gradient-primary);
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 15px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: var(--shadow-primary), var(--shadow-secondary);
      font-size: 1.1rem;
      letter-spacing: 1px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }
    
    .btn:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: var(--shadow-primary), var(--shadow-secondary), 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    .btn:hover::before {
      left: 100%;
    }

    .stars-display {
      display: inline-flex;
      align-items: center;
      padding: 12px 20px;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 140, 0, 0.1) 100%);
      border: 2px solid transparent;
      border-image: var(--gradient-secondary);
      border-image-slice: 1;
      border-radius: 15px;
      font-size: 1.3rem;
      color: var(--glow-gold);
      font-weight: bold;
      text-shadow: 0 0 10px var(--glow-gold);
      box-shadow: var(--shadow-gold);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .stars-display::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255, 215, 0, 0.1) 50%, transparent 70%);
      animation: starShine 2s ease-in-out infinite;
      pointer-events: none;
    }
    
    @keyframes starShine {
      0%, 100% { transform: translateX(-100%); }
      50% { transform: translateX(100%); }
    }
    
    .stars-display:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: var(--shadow-gold), 0 8px 25px rgba(255, 215, 0, 0.3);
    }

    /* ====== ÊéßÂà∂ÂàóÔºàÊêúÂ∞ã„ÄÅÁ®ÄÊúâÂ∫¶„ÄÅÈ°ûÂà•Ôºâ ====== */
    #controls {
      margin: 25px auto;
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
      max-width: 100%;
      padding: 20px 25px;
      background: linear-gradient(135deg, rgba(10, 20, 40, 0.9) 0%, rgba(20, 40, 80, 0.8) 100%);
      border-radius: 20px;
      box-shadow: var(--shadow-primary), var(--shadow-secondary), 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 2px solid transparent;
      border-image: var(--gradient-primary);
      border-image-slice: 1;
      backdrop-filter: blur(15px);
      position: relative;
      overflow: hidden;
    }
    
    #controls::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(0, 255, 255, 0.05) 50%, transparent 70%);
      animation: controlsShine 4s ease-in-out infinite;
      pointer-events: none;
    }
    
    @keyframes controlsShine {
      0%, 100% { transform: translateX(-100%); }
      50% { transform: translateX(100%); }
    }
    #controls input,
    #controls select {
      padding: 10px 16px;
      border-radius: 12px;
      border: 2px solid rgba(0, 255, 255, 0.4);
      background: linear-gradient(135deg, rgba(10, 20, 40, 0.9) 0%, rgba(20, 40, 80, 0.8) 100%);
      color: #00ffff;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 8px;
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(5px);
      position: relative;
      z-index: 1;
      text-shadow: 0 0 4px rgba(0, 255, 255, 0.5);
    }
    
    #controls input::placeholder {
      color: rgba(0, 255, 255, 0.6);
      text-shadow: 0 0 4px rgba(0, 255, 255, 0.3);
    }
    
    #controls select option {
      background: rgba(10, 20, 40, 0.95);
      color: #ffffff;
      font-weight: 500;
    }
    
    #controls input:focus,
    #controls select:focus {
      outline: none;
      border-color: var(--glow-gold);
      box-shadow: var(--shadow-gold), 0 0 20px rgba(255, 215, 0, 0.3);
      transform: translateY(-1px);
    }
    #controls button {
      padding: 10px 16px;
      border-radius: 12px;
      border: 2px solid rgba(0, 255, 255, 0.4);
      background: linear-gradient(135deg, rgba(10, 20, 40, 0.8) 0%, rgba(20, 40, 80, 0.6) 100%);
      color: #00ffff;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 8px;
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.2);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(5px);
      position: relative;
      z-index: 1;
      text-shadow: 0 0 4px rgba(0, 255, 255, 0.5);
    }
    
    #controls button:hover {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.2) 0%, rgba(162, 89, 255, 0.2) 100%);
      box-shadow: var(--shadow-primary), 0 0 20px rgba(0, 255, 255, 0.4);
      transform: translateY(-1px);
    }
    
    #controls button.active {
      background: var(--gradient-primary);
      color: #000;
      font-weight: bold;
      box-shadow: var(--shadow-primary), var(--shadow-secondary);
      transform: translateY(-1px);
    }

    /* ====== È†ÅÁ±§ÊåâÈàï ====== */
    .tab-container {
      display: flex;
      gap: 12px;
    }
    
    .tab-btn {
      padding: 10px 18px;
      border-radius: 15px;
      border: 2px solid rgba(0, 255, 255, 0.4);
      background: linear-gradient(135deg, rgba(10, 20, 40, 0.8) 0%, rgba(20, 40, 80, 0.6) 100%);
      color: #00ffff;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 8px;
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.2);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: 'Orbitron', sans-serif;
      backdrop-filter: blur(5px);
      position: relative;
      z-index: 1;
      text-shadow: 0 0 4px rgba(0, 255, 255, 0.5);
    }
    
    .tab-btn:hover {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.2) 0%, rgba(162, 89, 255, 0.2) 100%);
      box-shadow: var(--shadow-primary), 0 0 20px rgba(0, 255, 255, 0.4);
      transform: translateY(-1px);
    }
    
    .tab-btn.active {
      background: var(--gradient-primary);
      color: #000;
      font-weight: bold;
      box-shadow: var(--shadow-primary), var(--shadow-secondary);
      transform: translateY(-1px);
    }

    /* ====== Êî∂ÈõÜÈÄ≤Â∫¶ ====== */
    #progress {
      margin: 15px 0;
      font-size: 1.2rem;
      color: var(--glow-gold);
      text-shadow: 0 0 10px var(--glow-gold), 0 0 20px rgba(0, 255, 255, 0.5);
      font-weight: bold;
      padding: 10px 20px;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 140, 0, 0.1) 100%);
      border-radius: 15px;
      border: 2px solid transparent;
      border-image: var(--gradient-secondary);
      border-image-slice: 1;
      box-shadow: var(--shadow-gold);
      backdrop-filter: blur(5px);
      display: inline-block;
    }
    
    /* ====== Èü≥Ê®ÇÊéßÂà∂ÊåâÈàïÊ®£Âºè ====== */
    #toggleMusic.playing {
      background: rgba(0, 255, 255, 0.2) !important;
      border-color: #00ffff !important;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    #toggleMusic:hover {
      background: rgba(0, 255, 255, 0.2) !important;
      transform: scale(1.1);
      box-shadow: 0 0 24px #00ffff !important;
    }

    /* ====== Âç°ÁâáÊ†ºÂ≠êÔºàÂç°ÁâáÂΩ¢ÁãÄ 120x160pxÔºâ ====== */
    #cardGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 20px;
      padding: 30px 25px 15px 25px;
      justify-content: center;
      overflow-x: hidden;
      box-sizing: border-box;
      background: linear-gradient(135deg, rgba(10, 20, 40, 0.9) 0%, rgba(20, 40, 80, 0.8) 100%);
      border-radius: 20px;
      box-shadow: var(--shadow-primary), var(--shadow-secondary), 0 8px 40px rgba(0, 0, 0, 0.3);
      position: relative;
      max-width: 100%;
      margin: 0 auto;
      border: 2px solid transparent;
      border-image: var(--gradient-primary);
      border-image-slice: 1;
      backdrop-filter: blur(15px);
      height: 80vh; /* Êñ∞Â¢ûÔºöÂõ∫ÂÆöÈ´òÂ∫¶ */
      overflow-y: auto; /* Êñ∞Â¢ûÔºöÂèØÂûÇÁõ¥Êç≤Âãï */
    }
    #cardGrid:before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('https://png.pngtree.com/thumb_back/fw800/background/20230613/pngtree-cosmic-starry-sky-background-image_2890957.jpg') repeat center center,
                  linear-gradient(to bottom, rgba(10, 20, 40, 0.3) 0%, rgba(10, 20, 40, 0.7) 100%);
      background-blend-mode: overlay;
      opacity: 0.15;
      border-radius: 20px;
      pointer-events: none;
      z-index: 0;
    }
    #cardGrid > * { position: relative; z-index: 1; }
    .card {
      width: 120px;
      height: 160px;
      position: relative;
      background: transparent;
      border-radius: 12px;
      padding: 0;
      margin: 0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      animation: float 3s ease-in-out infinite;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      box-shadow: none;
      border: none;
      backdrop-filter: none;
      overflow: hidden;
      z-index: 1;
    }
    
    .card:hover {
      transform: translateY(-12px) scale(1.08) rotate(-3deg);
      box-shadow: var(--shadow-primary), var(--shadow-secondary), 0 20px 40px rgba(0,0,0,0.4);
    }
    .card.locked {
      cursor: not-allowed;
      opacity: 0.5;
      pointer-events: none;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    .card img,
    .card .card-media {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      object-fit: cover;
      object-position: center top;
      background: transparent;
      margin: 0;
      padding: 0;
      display: block;
      box-shadow: none;
      border: none;
      pointer-events: none;
    }
    .card .card-media {
      width: 100%;
      height: 100%;
      border-radius: 0;
      filter: none;
      object-fit: cover;
      background: transparent;
      pointer-events: none;
    }
    .card video.card-media {
      border: 2px solid rgba(0, 255, 255, 0.3);
      transition: border-color 0.3s ease;
      /* ÁßªÈô§Ëá™ÂãïÊí≠ÊîæÔºåÊîπÁÇ∫ÊâãÂãïÊéßÂà∂ */
      autoplay: false;
      loop: true;
      muted: true;
      playsinline: true;
      /* Èö±ËóèÂΩ±ÁâáÊéßÂà∂Ê¢ù */
      -webkit-media-controls: none;
      -webkit-media-controls-panel: none;
      -webkit-media-controls-play-button: none;
      -webkit-media-controls-start-playback-button: none;
    }
    .card video.card-media::-webkit-media-controls {
      display: none !important;
    }
    .card video.card-media::-webkit-media-controls-panel {
      display: none !important;
    }
    .card video.card-media::-webkit-media-controls-play-button {
      display: none !important;
    }
    .card video.card-media::-webkit-media-controls-start-playback-button {
      display: none !important;
    }
    .card:hover video.card-media {
      border-color: rgba(0, 255, 255, 0.8);
    }
    .card.locked img {
      filter: grayscale(1) brightness(0.3);
    }
    .card.locked video {
      filter: grayscale(1) brightness(0.3);
    }
    
    /* Êú™Ëß£ÈéñÂç°ÁâáÈéñÂÆöÈÅÆÁΩ©Ê®£Âºè */
    .lock-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20;
      backdrop-filter: blur(2px);
    }
    
    .lock-overlay .lock-icon {
      font-size: 1.5rem;
      color: #ffd700;
      text-shadow: 0 0 8px #ffd700;
      margin-bottom: 6px;
      animation: lockPulse 2s ease-in-out infinite;
    }
    
    .lock-overlay .lock-text {
      font-size: 0.8rem;
      color: #fff;
      text-shadow: 0 0 4px #000;
      font-weight: bold;
      background: rgba(0, 0, 0, 0.6);
      padding: 3px 6px;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    @keyframes lockPulse {
      0%, 100% { 
        transform: scale(1);
        opacity: 0.8;
      }
      50% { 
        transform: scale(1.1);
        opacity: 1;
      }
    }
    .stars {
      margin-top: 2px;
      font-size: 0.9rem;
      color: #ffd700;
      line-height: 1;
      letter-spacing: 1px;
      text-shadow: 0 0 8px #fff, 0 0 16px #00ffff;
    }
    .card .label {
      margin-top: 4px;
      font-size: 0.8rem;
      color: #00ffff;
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
      width: 100%;
      text-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
      line-height: 1.1;
      word-wrap: break-word;
      hyphens: auto;
      min-height: 2em;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }
    
    .card .label .chinese-text {
      font-size: 0.8rem;
      color: #00ffff;
      margin-bottom: 1px;
      text-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
      font-weight: bold;
    }
    
    .card .label .english-text {
      font-size: 0.7rem;
      color: #ffd700;
      text-shadow: 0 0 6px #ffd700, 0 0 12px #ffaa00;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    .card .category-tag {
      margin-top: 2px;
      font-size: 0.75rem;
      color: #ffd700;
      text-shadow: 0 0 6px #fff, 0 0 12px #00ffff;
    }
    
    /* Êñ∞Â¢ûÔºöÂç°ÁâáÊèèËø∞Ê®£Âºè */
    .card .description-tag {
      margin-top: 1px;
      font-size: 0.6rem;
      color: #ccc;
      text-shadow: 0 0 4px #ccc;
      line-height: 1.1;
      max-height: 1.8em;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      word-wrap: break-word;
      hyphens: auto;
      padding: 0 2px;
    }
    
    /* Âç°ÁâáÂêçÁ®±Ê®£Âºè */
    .card-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 100%);
      padding: 8px 6px;
      border-radius: 0 0 12px 12px;
      backdrop-filter: blur(4px);
      z-index: 5;
    }
    
    .card-name-chinese {
      font-size: 0.8rem;
      color: #00ffff;
      text-shadow: 0 0 6px #00ffff;
      font-weight: bold;
      text-align: center;
      margin-bottom: 2px;
      line-height: 1.1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .card-name-english {
      font-size: 0.7rem;
      color: #ffd700;
      text-shadow: 0 0 4px #ffd700;
      font-weight: 500;
      text-align: center;
      line-height: 1.1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    

    .common { border: 2.5px solid #00ffff; }
    .rare   { border: 2.5px solid #a259ff; }
    .epic   { border: 2.5px solid #ffd700; box-shadow: 0 0 16px #ffd700; }
    .rank-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 0.8rem;
      font-weight: bold;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      z-index: 10;
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      color: #000;
      box-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
    }
    .card.common .rank-badge {
      background: #00ffff;
      border: 2px solid #00ffff;
      color: #000;
    }
    .card.rare .rank-badge {
      background: #a259ff;
      border: 2px solid #a259ff;
      color: #fff;
    }
    .card.epic .rank-badge {
      background: #ffd700;
      border: 2px solid #ffd700;
      color: #000;
    }

    /* ====== ÈÅÆÁΩ© & Modal ====== */
    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      z-index: 900;
    }
    /* Modal Â§ñÊ°ÜÂ•óÁî®ËàáÂç°ÁâáÁõ∏ÂêåË®≠ÂÆö */
    #modal .card {
      width: 260px;
      height: 430px;
      margin: 0 auto;
      background: rgba(10, 20, 40, 0.95);
      border-radius: 16px;
      padding: 14px;
      border: 2.5px solid #00ffff;
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
    }
    #modal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: transparent;
      padding: 0;
      border: none;
      z-index: 1000;
      transition: transform 0.3s;
      color: #fff;
      box-sizing: border-box;
    }
    #modal.show {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      pointer-events: auto;
    }
    
    /* Modal Âç°ÁâáÊ®£Âºè */
    .modal-card {
      width: 240px;
      max-width: 90vw;
      height: 380px;
      background: rgba(10, 20, 40, 0.95);
      border-radius: 20px;
      padding: 16px;
      border: 2.5px solid #00ffff;
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
      color: #fff;
      position: relative;
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    /* Modal Á®ÄÊúâÂ∫¶È°èËâ≤ */
    .modal-card.common {
      border: 2.5px solid #00ffff;
      box-shadow: 0 0 32px #00ffff, 0 0 48px #00ffffcc;
    }
    
    .modal-card.rare {
      border: 2.5px solid #a259ff;
      box-shadow: 0 0 32px #a259ff, 0 0 48px #a259ffcc;
    }
    
    .modal-card.epic {
      border: 2.5px solid #ffd700;
      box-shadow: 0 0 32px #ffd700, 0 0 48px #ffd700cc;
    }
    
    .modal-title {
      width: 100%;
      text-align: center;
      margin-bottom: 12px;
      order: -1;
    }
    
    .modal-title .chinese-text {
      font-size: 1.2rem;
      color: #00ffff;
      margin-bottom: 4px;
      text-shadow: 0 0 8px #00ffff;
      font-weight: bold;
      text-align: center;
    }
    
    .modal-title .english-text {
      font-size: 1rem;
      color: #ffd700;
      text-shadow: 0 0 6px #ffd700;
      font-weight: 500;
      text-align: center;
    }
    
    .modal-media {
      width: 100%;
      height: 60%;
      margin-bottom: 12px;
      border-radius: 16px;
      overflow: hidden;
      background: transparent;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      border-radius: 16px;
      background: transparent;
    }
    
    .modal-video {
      width: 100%;
      height: 100%;
      border-radius: 16px;
      background: transparent;
      object-fit: contain;
      object-position: center;
    }
    
    .modal-youtube {
      width: 100%;
      height: 100%;
      border-radius: 16px;
      background: transparent;
      border: none;
    }
    
    .modal-no-media {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 16px;
      color: #ccc;
    }
    
    .modal-no-media .material-icons {
      font-size: 3rem;
      margin-bottom: 8px;
      opacity: 0.5;
    }
    
    .modal-no-media p {
      font-size: 0.9rem;
      margin: 0;
      opacity: 0.7;
    }
    
    .modal-image-container {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 16px;
      overflow: hidden;
    }
    
    .youtube-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .modal-image-container:hover .youtube-overlay {
      opacity: 1;
    }
    
    .youtube-search-btn {
      background: linear-gradient(45deg, #ff0000, #cc0000);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
      transition: all 0.3s ease;
    }
    
    .youtube-search-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(255, 0, 0, 0.6);
    }
    
    .youtube-search-btn .material-icons {
      font-size: 1.2rem;
    }
    
    .modal-info {
      text-align: center;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      width: 100%;
    }
    
    .modal-category {
      font-size: 0.9rem;
      color: #ffd700;
      margin-bottom: 8px;
      text-shadow: 0 0 6px #ffd700;
      text-align: center;
    }
    
    .modal-description {
      font-size: 0.85rem;
      color: #ccc;
      line-height: 1.4;
      text-shadow: 0 0 4px #ccc;
      text-align: center;
      overflow-y: auto;
      max-height: 80px;
      padding: 0 4px;
    }
    
    .modal-card .rarity-stars {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 1.1rem;
      color: #ffd700;
      text-shadow: 0 0 8px #ffd700;
      background: rgba(0, 0, 0, 0.6);
      padding: 6px 10px;
      border-radius: 16px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      backdrop-filter: blur(4px);
    }
    
    .modal-card .rarity-label {
      position: absolute;
      top: 12px;
      left: 12px;
      font-size: 0.8rem;
      color: #00ffff;
      text-shadow: 0 0 6px #00ffff;
      background: rgba(0, 0, 0, 0.8);
      padding: 4px 8px;
      border-radius: 12px;
      border: 1px solid rgba(0, 255, 255, 0.5);
      backdrop-filter: blur(4px);
      font-weight: bold;
      letter-spacing: 1px;
      z-index: 10;
    }
    #modal .card img {
      width: 100%;
      height: 50%;
      border-radius: 10px;
      filter: drop-shadow(0 0 12px #00ffffcc);
      object-fit: cover;
      background: #000;
    }
    #modal .card .card-media {
      width: 100%;
      height: 50%;
      border-radius: 10px;
      filter: drop-shadow(0 0 12px #00ffffcc);
      object-fit: cover;
      background: #000;
    }
    #modal .card video.card-media {
      border: 2px solid rgba(0, 255, 255, 0.5);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
      /* Modal ‰∏≠ÁöÑÂΩ±ÁâáË®≠ÂÆö */
      autoplay: false;
      loop: true;
      muted: true;
      playsinline: true;
      /* Èö±ËóèÂΩ±ÁâáÊéßÂà∂Ê¢ù */
      -webkit-media-controls: none;
      -webkit-media-controls-panel: none;
      -webkit-media-controls-play-button: none;
      -webkit-media-controls-start-playback-button: none;
    }
    #modal .card video.card-media::-webkit-media-controls {
      display: none !important;
    }
    #modal .card video.card-media::-webkit-media-controls-panel {
      display: none !important;
    }
    #modal .card video.card-media::-webkit-media-controls-play-button {
      display: none !important;
    }
    #modal .card video.card-media::-webkit-media-controls-start-playback-button {
      display: none !important;
    }
    #modal .card .stars {
      margin-top: 6px;
      font-size: 1.1rem;
      color: #ffd700;
      line-height: 1;
      letter-spacing: 2px;
      text-shadow: 0 0 8px #fff, 0 0 16px #00ffff;
    }
    #modal .card .label {
      margin-top: 6px;
      font-size: 1rem;
      color: #00ffff;
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
      width: 100%;
      text-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
      text-align: center;
      line-height: 1.3;
      word-wrap: break-word;
      hyphens: auto;
      min-height: 2.6em;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #modal .card .label .chinese-text {
      font-size: 1rem;
      color: #00ffff;
      margin-bottom: 3px;
      text-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
      font-weight: bold;
    }
    #modal .card .label .english-text {
      font-size: 0.9rem;
      color: #ffd700;
      text-shadow: 0 0 6px #ffd700, 0 0 12px #ffaa00;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    #modal .card .category-tag {
      margin-top: 4px;
      font-size: 0.95rem;
      color: #ffd700;
      text-shadow: 0 0 6px #fff, 0 0 12px #00ffff;
      text-align: center;
    }
    #modal .card .rank-badge {
      top: 8px;
      right: 8px;
      width: 36px;
      height: 36px;
      font-size: 1.1rem;
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      color: #000;
      box-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
    }

    #modal .description {
      margin-top: 14px;
      text-align: left;
      line-height: 1.6;
      font-size: 1.05rem;
      max-height: 160px;
      overflow-y: auto;
      width: 260px;
      background: rgba(10, 20, 40, 0.95);
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 0 16px #00ffff99, 0 0 40px #a259ff44 inset;
      color: #fff;
      text-shadow: 0 0 8px #000a;
    }
    #modal .description::-webkit-scrollbar {
      width: 8px;
    }
    #modal .description::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.3);
      border-radius: 4px;
    }
    #modal .description::-webkit-scrollbar-thumb {
      background: var(--glow-cyan);
      border-radius: 4px;
    }
    #modal .description::-webkit-scrollbar-thumb:hover {
      background: var(--glow-gold);
    }
    
    /* Âç°ÁâåÊïàÊûúË≥áË®äÊ®£Âºè */
    #modal .card-effect {
      margin-top: 12px;
      padding: 10px;
      background: rgba(0, 255, 255, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(0, 255, 255, 0.3);
    }
    
    #modal .card-effect h4 {
      color: #00ffff;
      margin: 0 0 8px 0;
      font-size: 1rem;
      text-align: center;
    }
    
    #modal .card-effect .effect-desc {
      color: #ffd700;
      font-size: 0.9rem;
      text-align: center;
      margin: 0;
      font-weight: 500;
    }
    
    #modal .card-effect .effect-type {
      color: #a259ff;
      font-size: 0.8rem;
      text-align: center;
      margin-top: 5px;
      opacity: 0.8;
    }
    .sound-btn-modal {
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      color: #000;
      border: none;
      padding: 10px 22px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1.1rem;
      margin-top: 12px;
      box-shadow: 0 0 16px #00ffff, 0 0 24px #a259ff99;
      font-weight: bold;
      letter-spacing: 1px;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .sound-btn-modal:hover {
      transform: scale(1.07);
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
    }
    .modal-actions {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 12px;
    }
    .disenchant-btn-modal {
      background: linear-gradient(90deg, #ff8a00 0%, #e52e71 100%);
      color: #fff;
      border: none;
      padding: 10px 22px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 16px #ff8a00, 0 0 24px #e52e7199;
      font-size: 1.1rem;
      letter-spacing: 1px;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .disenchant-btn-modal:hover {
      transform: scale(1.07);
      box-shadow: 0 0 32px #ff8a00, 0 0 48px #e52e71cc;
    }
    .disenchant-btn-modal:disabled {
      background: #555;
      color: #999;
      cursor: not-allowed;
      box-shadow: none;
    }
    .disenchant-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .quantity-selector {
      display: flex;
      align-items: center;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      border: 1px solid #ff8a00;
    }
    .quantity-btn {
      background: transparent;
      border: none;
      color: #ff8a00;
      font-size: 1.5rem;
      font-weight: bold;
      cursor: pointer;
      padding: 0 12px;
    }
    .quantity-btn:hover {
      color: #fff;
    }
    #disenchant-quantity {
      width: 40px;
      text-align: center;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 1.2rem;
      font-weight: bold;
      -moz-appearance: textfield;
    }
    #disenchant-quantity::-webkit-outer-spin-button,
    #disenchant-quantity::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .close-btn {
      position: absolute;
      top: -16px; left: -16px;
      background: red;
      color: white;
      width: 32px; height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 6px #f00;
    }

    /* ====== Êñ∞Âç°ÁâáÂúñÊ®ô ====== */
    .new-card-badge {
      position: absolute;
      top: 6px;
      left: 6px;
      background: var(--gradient-accent);
      background-size: 200% 200%;
      color: #fff;
      padding: 6px 10px;
      font-size: 0.75rem;
      font-weight: bold;
      border-radius: 14px;
      z-index: 15;
      box-shadow: 0 0 20px rgba(255, 107, 107, 0.6), 0 0 30px rgba(255, 217, 61, 0.5), 0 0 40px rgba(255, 107, 107, 0.4);
      text-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
      border: 2px solid rgba(255, 255, 255, 0.9);
      transform-origin: center;
      backdrop-filter: blur(4px);
    }
    
    @keyframes newCardPulse {
      0%, 100% { 
        transform: scale(1) rotate(0deg);
        box-shadow: 
          0 0 15px #ff6b6b, 
          0 0 25px #ffd93d,
          0 0 35px #ff6b6b;
      }
      25% {
        transform: scale(1.15) rotate(-2deg);
        box-shadow: 
          0 0 25px #ff6b6b, 
          0 0 35px #ffd93d,
          0 0 45px #ff6b6b;
      }
      50% { 
        transform: scale(1.25) rotate(0deg);
        box-shadow: 
          0 0 30px #ff6b6b, 
          0 0 40px #ffd93d,
          0 0 50px #ff6b6b;
      }
      75% {
        transform: scale(1.15) rotate(2deg);
        box-shadow: 
          0 0 25px #ff6b6b, 
          0 0 35px #ffd93d,
          0 0 45px #ff6b6b;
      }
    }
    
    @keyframes newCardGradient {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    @keyframes fadeInScale {
      0% { 
        opacity: 0;
        transform: scale(0.9) translateY(10px);
      }
      100% { 
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    @keyframes slideInFromTop {
      0% {
        opacity: 0;
        transform: translateY(-20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes glowPulse {
      0%, 100% {
        box-shadow: var(--shadow-primary), var(--shadow-secondary);
      }
      50% {
        box-shadow: var(--shadow-primary), var(--shadow-secondary), 0 0 30px rgba(0, 255, 255, 0.6);
      }
    }
    
    .new-card-glow {
      animation: newCardGlow 2s ease-in-out infinite;
      position: relative;
    }
    
    .new-card-glow::before {
      content: '';
      position: absolute;
      top: -5px;
      left: -5px;
      right: -5px;
      bottom: -5px;
      background: linear-gradient(45deg, #ff6b6b, #ffd93d, #ff6b6b);
      border-radius: 20px;
      z-index: -1;
      opacity: 0.6;
      animation: newCardGlowRing 2s ease-in-out infinite;
    }
    
    @keyframes newCardGlow {
      0%, 100% { 
        box-shadow: 
          0 0 20px #00ffff55, 
          0 0 40px #a259ff33,
          0 0 15px #ff6b6b88;
      }
      25% {
        box-shadow: 
          0 0 25px #00ffff66, 
          0 0 45px #a259ff44,
          0 0 25px #ff6b6b99,
          0 0 35px #ffd93d66;
      }
      50% { 
        box-shadow: 
          0 0 30px #00ffff77, 
          0 0 50px #a259ff55,
          0 0 35px #ff6b6baa,
          0 0 45px #ffd93d77;
      }
      75% {
        box-shadow: 
          0 0 25px #00ffff66, 
          0 0 45px #a259ff44,
          0 0 25px #ff6b6b99,
          0 0 35px #ffd93d66;
      }
    }
    
    @keyframes newCardGlowRing {
      0%, 100% { 
        transform: scale(1);
        opacity: 0.6;
      }
      50% { 
        transform: scale(1.1);
        opacity: 0.8;
      }
    }

    .video-indicator {
      position: absolute;
      top: 6px;
      left: 6px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 3px 5px;
      border-radius: 4px;
      font-size: 0.7rem;
      z-index: 10;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      animation: videoIndicatorPulse 2s ease-in-out infinite;
    }
    
    @keyframes videoIndicatorPulse {
      0%, 100% { 
        transform: scale(1);
        opacity: 0.8;
      }
      50% { 
        transform: scale(1.1);
        opacity: 1;
      }
    }

    /* ====== YouTube ÂΩ±ÁâáÁõ∏ÈóúÊ®£Âºè ====== */
    .card iframe.card-media {
      border: 2px solid rgba(0, 255, 255, 0.3);
      transition: border-color 0.3s ease;
      pointer-events: none; /* Èò≤Ê≠¢Âú®Âç°Áâá‰∏äÁõ¥Êé•Êìç‰Ωú iframe */
    }
    .card:hover iframe.card-media {
      border-color: rgba(0, 255, 255, 0.8);
    }
    .card .youtube-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s ease;
      z-index: 5;
    }
    .card .youtube-overlay:hover {
      background: rgba(0, 0, 0, 0.1);
    }
    .card .youtube-overlay .play-button {
      width: 40px;
      height: 40px;
      background: rgba(255, 0, 0, 0.8);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      transition: all 0.3s ease;
    }
    .card .youtube-overlay:hover .play-button {
      transform: scale(1.2);
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
    }
    .card .video-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #00ffff;
      font-size: 12px;
      z-index: 6;
    }
    .card .video-error {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #ff6b6b;
      font-size: 12px;
      z-index: 6;
      text-align: center;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px;
      border-radius: 6px;
    }

    /* Modal ‰∏≠ÁöÑ YouTube ÂΩ±ÁâáÊ®£Âºè */
    #modal .card iframe.card-media {
      border: 2px solid rgba(0, 255, 255, 0.5);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
      pointer-events: auto; /* Modal ‰∏≠ÂèØ‰ª•Êìç‰Ωú */
    }
    #modal .card iframe.card-media::-webkit-media-controls {
      background: rgba(0, 0, 0, 0.7);
      border-radius: 8px;
    }

    /* ====== ÂΩ±ÁâáÊåâÈàïÊ®£Âºè ====== */
    .video-button {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      background: rgba(255, 0, 0, 0.8);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 15;
      transition: all 0.3s ease;
      box-shadow: 0 0 8px rgba(255, 0, 0, 0.5);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .video-button:hover {
      transform: scale(1.1);
      background: rgba(255, 0, 0, 1);
      box-shadow: 0 0 16px rgba(255, 0, 0, 0.8);
      border-color: rgba(255, 255, 255, 0.8);
    }
    
    .video-icon {
      color: white;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
    }

    /* Êñ∞Â¢ûÔºöÂ™íÈ´îÂÆπÂô®Ê®£Âºè */
    .media-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border-radius: 0;
      overflow: hidden;
      padding: 0;
      margin: 0;
    }
    
    .media-container .card-media {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 0;
      display: block;
      background: transparent;
      padding: 0;
      margin: 0;
    }
    
    /* Êñ∞Â¢ûÔºöÂΩ±ÁâáÊí≠ÊîæÊåáÁ§∫Âô® */
    .video-play-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.7);
      color: #00ffff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: bold;
      z-index: 10;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(0, 255, 255, 0.3);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .card:hover .video-play-indicator {
      opacity: 1;
    }
    
    /* Ëß∏ÊéßË®≠ÂÇôÂÑ™Âåñ */
    @media (hover: none) and (pointer: coarse) {
      .card:hover .video-play-indicator {
        opacity: 0; /* Ëß∏ÊéßË®≠ÂÇô‰∏çÈ°ØÁ§∫Êá∏ÂÅúÊèêÁ§∫ */
      }
    }
    
    /* ÈüøÊáâÂºèË®≠Ë®à - Èò≤Ê≠¢Ê©´ÂêëÊªëÊ°ø */
    @media (max-width: 768px) {
      body {
        overflow-x: hidden;
      }
      
      #controls {
        margin: 15px 10px;
        padding: 15px 20px;
        gap: 10px;
        max-width: calc(100vw - 20px);
      }
      
      #controls input,
      #controls select,
      #controls button {
        padding: 8px 12px;
        font-size: 0.9rem;
      }
      
      .tab-container {
        gap: 8px;
      }
      
      .tab-btn {
        padding: 8px 14px;
        font-size: 0.9rem;
      }
      
      #cardGrid {
        gap: 15px;
        padding: 20px 15px 10px 15px;
        margin: 0 10px;
      }
      
      #featureMenu {
        margin: 10px;
        padding: 15px;
      }
      
      header {
        padding: 15px 20px;
      }
      
      header h1 {
        font-size: 1.8rem;
      }
      
      .stars-display {
        padding: 8px 15px;
        font-size: 1.1rem;
      }
    }
    
    @media (max-width: 480px) {
      body {
        overflow-x: hidden;
      }
      
      #controls {
        margin: 10px 5px;
        padding: 12px 15px;
        max-width: calc(100vw - 10px);
      }
      
      #cardGrid {
        gap: 12px;
        padding: 15px 10px 8px 10px;
        margin: 0 5px;
      }
      
      header h1 {
        font-size: 1.5rem;
      }
      
      .header-actions {
        gap: 10px;
      }
      
      .btn {
        padding: 8px 16px;
        font-size: 0.9rem;
      }
    }

    /* Êñ∞Â¢ûÔºöÂΩ±ÁâáÊí≠ÊîæÊéßÂà∂Ê®£Âºè */
    .video-controls {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 0.8rem;
      color: #00ffff;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(0, 255, 255, 0.3);
    }
    
    .video-controls:hover {
      background: rgba(0, 0, 0, 0.9);
      border-color: rgba(0, 255, 255, 0.8);
      box-shadow: 0 0 8px rgba(0, 255, 255, 0.5);
    }

    /* ====== ÂΩ±Áâá Modal Ê®£Âºè ====== */
    .video-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(8px);
    }
    
    .video-modal-content {
      background: rgba(10, 20, 40, 0.95);
      border: 2px solid #00ffff;
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
    }
    
    .video-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: rgba(0, 255, 255, 0.1);
      border-bottom: 1px solid rgba(0, 255, 255, 0.3);
    }
    
    .video-modal-header h3 {
      color: #00ffff;
      margin: 0;
      font-size: 1.2rem;
      text-shadow: 0 0 8px #00ffff;
    }
    
    .video-modal-close {
      background: rgba(255, 0, 0, 0.8);
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .video-modal-close:hover {
      background: rgba(255, 0, 0, 1);
      transform: scale(1.1);
      box-shadow: 0 0 12px rgba(255, 0, 0, 0.8);
    }
    
    .video-modal-body {
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
    }
    
    .video-modal-body iframe,
    .video-modal-body video {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      border: 2px solid rgba(0, 255, 255, 0.3);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
    }
    
    .video-modal-body iframe {
      background: #000;
    }
    
    .video-modal-body video {
      background: #000;
    }
    
    /* ====== ÊàêÂ∞±Á≥ªÁµ±Ê®£Âºè ====== */
    .badge {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid;
      position: relative;
    }
    
    .badge.locked {
      background: rgba(128, 128, 128, 0.3);
      border-color: #666;
      color: #666;
      cursor: default;
      filter: grayscale(1);
    }
    
    .badge.unlocked {
      cursor: pointer;
      animation: badgeGlow 2s ease-in-out infinite alternate;
    }
    
    .badge.unlocked:hover {
      transform: scale(1.2);
      box-shadow: 0 0 20px currentColor;
    }
    
    .badge-bronze.unlocked {
      background: linear-gradient(45deg, #cd7f32, #daa520);
      border-color: #cd7f32;
      color: #fff;
      box-shadow: 0 0 12px #cd7f32;
    }
    
    .badge-silver.unlocked {
      background: linear-gradient(45deg, #c0c0c0, #e5e4e2);
      border-color: #c0c0c0;
      color: #333;
      box-shadow: 0 0 12px #c0c0c0;
    }
    
    .badge-gold.unlocked {
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      border-color: #ffd700;
      color: #333;
      box-shadow: 0 0 12px #ffd700;
    }
    
    .badge-platinum.unlocked {
      background: linear-gradient(45deg, #e5e4e2, #b4b4b4);
      border-color: #e5e4e2;
      color: #333;
      box-shadow: 0 0 12px #e5e4e2;
    }
    
    .badge-diamond.unlocked {
      background: linear-gradient(45deg, #b9f2ff, #00ffff);
      border-color: #b9f2ff;
      color: #333;
      box-shadow: 0 0 12px #b9f2ff;
    }
    
    @keyframes badgeGlow {
      0% { box-shadow: 0 0 12px currentColor; }
      100% { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor; }
    }
    
    .reward-stars {
      color: #ffd700;
      font-weight: bold;
      text-shadow: 0 0 8px #ffd700;
    }

    /* ====== Â∑≤ÊìÅÊúâÊ®ôË®ò ====== */
    .owned-stamp {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.7), rgba(162, 89, 255, 0.7));
      color: #fff;
      padding: 2px 5px;
      font-size: 0.65rem;
      border-radius: 4px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      z-index: 10;
      backdrop-filter: blur(2px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .avatar-head {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      border-radius: 50%;
      display: block;
      transition: transform 0.3s;
    }

    /* ====== Á®ÄÊúâÂ∫¶ÂúñÊ®ôÊ®£Âºè ====== */
    .rarity-icon {
      position: absolute;
      top: 6px;
      left: 6px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-weight: bold;
      font-size: 0.9rem;
      z-index: 15;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(255, 255, 255, 0.8);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }
    
    .rarity-icon.common {
      background: linear-gradient(135deg, #00ffff, #00cccc);
      color: #000;
      box-shadow: 0 0 8px #00ffff, 0 0 16px #00ffff88;
    }
    
    .rarity-icon.rare {
      background: linear-gradient(135deg, #a259ff, #8a2be2);
      color: #fff;
      box-shadow: 0 0 8px #a259ff, 0 0 16px #a259ff88;
    }
    
    .rarity-icon.epic {
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      color: #000;
      box-shadow: 0 0 8px #ffd700, 0 0 16px #ffd70088;
    }
  </style>
</head>
<body>
  <!-- ËÉåÊôØÈü≥Ê®ÇÈü≥È†ªÂÖÉÁ¥† -->
  <audio id="backgroundMusic" loop>
    <source src="sound/ÂçàÂæåÊîæÈ¨ÜÊôÇÂÖâÔºàÁ¥îÈü≥Ê®ÇÔºâ.mp3" type="audio/mpeg">
  </audio>

  <div style="
    width: 100%;
    max-width: 100vw;
    overflow-x: hidden;
    box-sizing: border-box;
  ">
    <header>
      <h1>üìÅ Âç°ÁâáÊî∂Ëóè</h1>
      <div class="header-actions">
        <span id="totalStarsCount" class="stars-display">‚≠ê 0</span>
        
        <button class="btn" onclick="location.href='index.html'">üè† È¶ñÈ†Å</button>
      </div>
    </header>

  <!-- Êñ∞Â¢ûÔºöÂäüËÉΩÈÅ∏ÂñÆÂçÄÂüü -->
  <div id="featureMenu" style="
    background: linear-gradient(135deg, rgba(10, 20, 40, 0.9) 0%, rgba(20, 40, 80, 0.8) 100%);
    border: 2px solid transparent;
    border-image: var(--gradient-primary);
    border-image-slice: 1;
    border-radius: 20px;
    padding: 20px;
    margin: 15px auto;
    max-width: 100%;
    text-align: center;
    box-sizing: border-box;
    box-shadow: var(--shadow-primary), var(--shadow-secondary), 0 8px 32px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(15px);
  ">
          <h3 style="
        color: #00ffff; 
        margin: 0 0 20px 0; 
        font-size: 1.4rem;
        font-weight: bold;
        text-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      ">üöÄ Âø´ÈÄüÂäüËÉΩ</h3>
          <div style="
        display: flex; 
        gap: 16px; 
        justify-content: center; 
        flex-wrap: wrap; 
        align-items: center;
        min-height: 44px;
        width: 100%;
        box-sizing: border-box;
      ">
      <button class="btn" onclick="location.href='autoSaveManager.html'">üîÑ Ëá™ÂãïÂÑ≤Â≠ò</button>
      <button class="btn" onclick="location.href='gacha.html'">üé¥ ÊäΩÂç°</button>
      <button id="toggleMusic" class="btn" title="ËÉåÊôØÈü≥Ê®Ç" style="
        width: 55px;
        height: 55px;
        border-radius: 50%;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(10, 20, 40, 0.9) 0%, rgba(20, 40, 80, 0.8) 100%);
        border: 2px solid transparent;
        border-image: var(--gradient-primary);
        border-image-slice: 1;
        color: #00ffff;
        backdrop-filter: blur(15px);
        box-shadow: var(--shadow-primary);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      ">
        <span class="material-icons">music_note</span>
      </button>
    </div>
  </div>

  <!-- ÊêúÂ∞ã„ÄÅÁ®ÄÊúâÂ∫¶„ÄÅÈ°ûÂà• -->
  <div id="controls">
    <input type="text" id="searchInput" placeholder="ÊêúÂ∞ãÂñÆÂ≠óÊàñ‰∏≠Êñá" oninput="renderCards(); updateCategoryStats()">
    <select id="rarityFilter" onchange="renderCards(); updateCategoryStats()">
      <option value="all">ÂÖ®ÈÉ®Á®ÄÊúâÂ∫¶</option>
      <option value="ÊôÆÈÄö">ÊôÆÈÄö</option>
      <option value="Á®ÄÊúâ">Á®ÄÊúâ</option>
      <option value="Ë∂ÖÁ®ÄÊúâ">Ë∂ÖÁ®ÄÊúâ</option>
    </select>
    <select id="categoryFilter" onchange="renderCards(); updateCategoryStats()">
      <option value="all">ÂÖ®ÈÉ®È°ûÂà•</option>
      <!-- JS ÊúÉÂãïÊÖãÊää cards.js ÁöÑ category Â°´ÈÄ≤Âéª -->
    </select>
    <div id="categoryStats" style="
      margin-top: 12px;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.1) 0%, rgba(162, 89, 255, 0.1) 100%);
      border: 2px solid transparent;
      border-image: var(--gradient-primary);
      border-image-slice: 1;
      border-radius: 16px;
      color: #00ffff;
      font-size: 0.95rem;
      text-align: center;
      display: none;
      box-shadow: var(--shadow-primary), var(--shadow-secondary), 0 8px 25px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(8px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    "></div>
    <div class="tab-container">
      <button class="tab-btn active" data-filter="all">ÂÖ®ÈÉ®Âç°Áâá</button>
      <button class="tab-btn" data-filter="owned">üì¶ ÊàëÁöÑÊî∂Ëóè</button>
    </div>
  </div>

  <div id="progress">Â∑≤Ëß£ÈéñÔºö0 / 0</div>
  

  
  <div id="cardGrid"></div>

  <div id="overlay"></div>
  <div id="modal">
    <div id="modalCardContainer"></div>
    <div class="close-btn" onclick="closeModal()">‚úï</div>
  </div>

  </div>

  <!-- ÂÖàËºâÂÖ• cards.jsÔºàÂøÖÈ†àÊîæÂú®È†ÅÈù¢Áõ∏ÂêåË≥áÊñôÂ§æÔºåÊàñËá™Ë°å‰øÆÊîπË∑ØÂæëÔºâ -->
  <script src="js/sound.js"></script>
  <script src="js/userData.js"></script>
  <script src="js/starRewardSystem.js"></script>
  <script src="js/cardUtils.js"></script> <!-- ÂºïÂÖ•ÂÖ±‰∫´ÁöÑÂç°ÁâåÂ∑•ÂÖ∑ÂáΩÂºè -->
  <script src="js/cards.js"></script> <!-- ËºâÂÖ•‰∏ªÂç°ÁâáË≥áÊñôÔºåÂåÖÂê´ÂΩ±ÁâáÂ±¨ÊÄß -->
  <script src="js/achievementSystem.js"></script>
  <script>
    /***** ËÉåÊôØÈü≥Ê®ÇÈÄ£ÂãïÁ≥ªÁµ± *****/
    let backgroundMusic = null;
    let toggleMusicBtn = null;
    let isMusicPlaying = false;
    
    // ÂàùÂßãÂåñËÉåÊôØÈü≥Ê®ÇÁ≥ªÁµ±
    function initBackgroundMusic() {
      console.log('üéµ ÂàùÂßãÂåñËÉåÊôØÈü≥Ê®ÇÁ≥ªÁµ±...');
      
      backgroundMusic = document.getElementById('backgroundMusic');
      toggleMusicBtn = document.getElementById('toggleMusic');
      
      if (!backgroundMusic) {
        console.error('‚ùå Êâæ‰∏çÂà∞ËÉåÊôØÈü≥Ê®ÇÂÖÉÁ¥†');
        return;
      }
      
      if (!toggleMusicBtn) {
        console.error('‚ùå Êâæ‰∏çÂà∞Èü≥Ê®ÇÊéßÂà∂ÊåâÈàï');
        return;
      }
      
      // Ë®≠ÂÆöÈü≥Ê®ÇÂ±¨ÊÄß
      backgroundMusic.volume = 0.3;
      backgroundMusic.loop = true;
      
      // Ê™¢Êü• LinkageSystem ÊòØÂê¶ÂèØÁî®
      if (typeof LinkageSystem !== 'undefined' && LinkageSystem.music) {
        isMusicPlaying = LinkageSystem.music.isPlaying();
        console.log('üîó LinkageSystem Èü≥Ê®ÇÁãÄÊÖã:', isMusicPlaying);
      } else {
        // ÂÇôÁî®ÊñπÊ°àÔºöÁõ¥Êé•Âæû localStorage ËÆÄÂèñ
        const musicState = localStorage.getItem('bgMusicState');
        isMusicPlaying = musicState === 'playing';
        console.log('üì¶ localStorage Èü≥Ê®ÇÁãÄÊÖã:', isMusicPlaying);
      }
      
      // Ê†πÊìöÁãÄÊÖãË®≠ÂÆöÊåâÈàïÂ§ñËßÄ
      updateMusicButtonState();
      
      // Â¶ÇÊûúÊáâË©≤Êí≠ÊîæÔºåÂòóË©¶Êí≠Êîæ
      if (isMusicPlaying) {
        playBackgroundMusic();
      }
      
      console.log('‚úÖ ËÉåÊôØÈü≥Ê®ÇÁ≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàê');
    }
    
    // Êõ¥Êñ∞Èü≥Ê®ÇÊåâÈàïÁãÄÊÖã
    function updateMusicButtonState() {
      if (!toggleMusicBtn) return;
      
      if (isMusicPlaying) {
        toggleMusicBtn.classList.add('playing');
        toggleMusicBtn.style.background = 'rgba(0, 255, 255, 0.2)';
      } else {
        toggleMusicBtn.classList.remove('playing');
        toggleMusicBtn.style.background = 'rgba(10, 20, 40, 0.85)';
      }
    }
    
    // Êí≠ÊîæËÉåÊôØÈü≥Ê®Ç
    function playBackgroundMusic() {
      if (!backgroundMusic) return;
      
      // ÂÑ™ÂÖà‰ΩøÁî® SoundSystem
      if (typeof SoundSystem !== 'undefined' && SoundSystem.bgm) {
        SoundSystem.bgm.play();
        isMusicPlaying = true;
        updateMusicButtonState();
        console.log('üéµ ÈÄèÈÅé SoundSystem Êí≠ÊîæËÉåÊôØÈü≥Ê®Ç');
        return;
      }
      
      // ÂÇôÁî®ÊñπÊ°àÔºöÁõ¥Êé•Êí≠ÊîæÊú¨Âú∞Èü≥Ê®ÇÂÖÉÁ¥†
      backgroundMusic.play().then(() => {
        isMusicPlaying = true;
        updateMusicButtonState();
        
        // ÂêåÊ≠•Âà∞ LinkageSystem
        if (typeof LinkageSystem !== 'undefined' && LinkageSystem.music) {
          LinkageSystem.music.setPlaying(true);
        } else {
          localStorage.setItem('bgMusicState', 'playing');
        }
        
        console.log('üéµ ËÉåÊôØÈü≥Ê®ÇÈñãÂßãÊí≠Êîæ');
      }).catch(err => {
        console.error('‚ùå ËÉåÊôØÈü≥Ê®ÇÊí≠ÊîæÂ§±Êïó:', err);
        isMusicPlaying = false;
        updateMusicButtonState();
      });
    }
    
    // Êö´ÂÅúËÉåÊôØÈü≥Ê®Ç
    function pauseBackgroundMusic() {
      if (!backgroundMusic) return;
      
      // ÂÑ™ÂÖà‰ΩøÁî® SoundSystem
      if (typeof SoundSystem !== 'undefined' && SoundSystem.bgm) {
        SoundSystem.bgm.pause();
        isMusicPlaying = false;
        updateMusicButtonState();
        console.log('üîá ÈÄèÈÅé SoundSystem Êö´ÂÅúËÉåÊôØÈü≥Ê®Ç');
        return;
      }
      
      // ÂÇôÁî®ÊñπÊ°àÔºöÁõ¥Êé•Êö´ÂÅúÊú¨Âú∞Èü≥Ê®ÇÂÖÉÁ¥†
      backgroundMusic.pause();
      isMusicPlaying = false;
      updateMusicButtonState();
      
      // ÂêåÊ≠•Âà∞ LinkageSystem
      if (typeof LinkageSystem !== 'undefined' && LinkageSystem.music) {
        LinkageSystem.music.setPlaying(false);
      } else {
        localStorage.setItem('bgMusicState', 'paused');
      }
      
      console.log('üîá ËÉåÊôØÈü≥Ê®ÇÂ∑≤Êö´ÂÅú');
    }
    
    // ÂàáÊèõËÉåÊôØÈü≥Ê®ÇÊí≠ÊîæÁãÄÊÖã
    function toggleBackgroundMusic() {
      if (isMusicPlaying) {
        pauseBackgroundMusic();
      } else {
        playBackgroundMusic();
      }
    }
    
    // Èü≥Ê®ÇÁ≥ªÁµ±Ë®∫Êñ∑ÂáΩÊï∏
    function diagnoseMusicSystem() {
      console.log('üîç === Èü≥Ê®ÇÁ≥ªÁµ±Ë®∫Êñ∑ ===');
      console.log('ËÉåÊôØÈü≥Ê®ÇÂÖÉÁ¥†:', backgroundMusic);
      console.log('Èü≥Ê®ÇÊéßÂà∂ÊåâÈàï:', toggleMusicBtn);
      console.log('Áï∂ÂâçÊí≠ÊîæÁãÄÊÖã:', isMusicPlaying);
      console.log('LinkageSystem ÂèØÁî®:', typeof LinkageSystem !== 'undefined');
      console.log('SoundSystem ÂèØÁî®:', typeof SoundSystem !== 'undefined');
      
      if (backgroundMusic) {
        console.log('Èü≥Ê®ÇÊ™îÊ°àË∑ØÂæë:', backgroundMusic.src);
        console.log('Èü≥Ê®ÇÈü≥Èáè:', backgroundMusic.volume);
        console.log('Èü≥Ê®ÇÊòØÂê¶Âæ™Áí∞:', backgroundMusic.loop);
        console.log('Èü≥Ê®ÇÊòØÂê¶Êö´ÂÅú:', backgroundMusic.paused);
        console.log('Èü≥Ê®ÇÁï∂ÂâçÊôÇÈñì:', backgroundMusic.currentTime);
      }
      
      if (typeof LinkageSystem !== 'undefined' && LinkageSystem.music) {
        console.log('LinkageSystem Èü≥Ê®ÇÁãÄÊÖã:', LinkageSystem.music.isPlaying());
        console.log('LinkageSystem Èü≥Ê®ÇÈü≥Èáè:', LinkageSystem.music.getVolume());
      }
      
      if (typeof SoundSystem !== 'undefined' && SoundSystem.bgm) {
        console.log('SoundSystem ËÉåÊôØÈü≥Ê®Ç:', SoundSystem.bgm);
        console.log('SoundSystem ËÉåÊôØÈü≥Ê®ÇÁãÄÊÖã:', !SoundSystem.bgm.paused);
      }
      
      alert('Èü≥Ê®ÇÁ≥ªÁµ±Ë®∫Êñ∑ÂÆåÊàêÔºåË´ãÊü•ÁúãÊéßÂà∂Âè∞');
    }
    
    // -------- 0. Âæû cards.js ÂèñÂæó allCards Ë≥áÊñô --------
    console.log('Ê≠£Âú®ËºâÂÖ• allCards...');
    console.log('window.allCards:', window.allCards);
    
    // Á≠âÂæÖ cards.js ÂÆåÂÖ®ËºâÂÖ•
    function waitForAllCards() {
      if (window.allCards && window.allCards.length > 0) {
        console.log('allCards ËºâÂÖ•ÊàêÂäüÔºåÈï∑Â∫¶:', window.allCards.length);
        initializePage();
      } else {
        console.log('Á≠âÂæÖ allCards ËºâÂÖ•...');
        setTimeout(waitForAllCards, 100);
      }
    }
    
    // -------- 1. Âæû localStorage Êãø ownedCards --------
    let ownedCards = LinkageSystem.cards.getOwnedCards();
    let recentlyObtainedCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
    
    // ÈñãÂßãÁ≠âÂæÖ allCards ËºâÂÖ•
    console.log('üöÄ È†ÅÈù¢ÈñãÂßãËºâÂÖ•...');
    waitForAllCards();

    // -------- 3. ÂàùÂßãÂåñ„ÄåÈ°ûÂà•ÈÅ∏ÂñÆ„Äç --------
    function initCategoryOptions() {
      const categorySet = new Set();
      window.allCards.forEach(card => {
        if (card.category) categorySet.add(card.category);
      });
      const categoryFilter = document.getElementById("categoryFilter");
      // Ê∏ÖÊéâÈô§‰∫Ü„ÄåÂÖ®ÈÉ®„Äç‰ª•Â§ñÁöÑÈÅ∏È†Ö
      Array.from(categoryFilter.querySelectorAll("option")).forEach(opt => {
        if (opt.value !== "all") opt.remove();
      });
      Array.from(categorySet).sort().forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        categoryFilter.appendChild(option);
      });
    }

    // -------- 3.5. Êõ¥Êñ∞ÂàÜÈ°ûÁµ±Ë®àË≥áË®ä --------
    function updateCategoryStats() {
      const categoryFilter = document.getElementById("categoryFilter");
      const categoryStats = document.getElementById("categoryStats");
      const selectedCategory = categoryFilter.value;
      
      if (selectedCategory === "all") {
        categoryStats.style.display = "none";
        return;
      }
      
      // Ë®àÁÆóË©≤ÂàÜÈ°ûÁöÑÁ∏ΩÂç°ÁâáÊï∏ÂíåÂ∑≤Êî∂ÈõÜÊï∏
      const categoryCards = window.allCards.filter(card => card.category === selectedCategory);
      const totalCards = categoryCards.length;
      const ownedCards = LinkageSystem.cards.getOwnedCards();
      const collectedCards = categoryCards.filter(card => LinkageSystem.cards.isCardOwned(card.word)).length;
      
      // Ë®àÁÆóÊî∂ÈõÜÁôæÂàÜÊØî
      const percentage = totalCards > 0 ? Math.round((collectedCards / totalCards) * 100) : 0;
      
      // Ê†πÊìöÂÆåÊàêÂ∫¶Ê±∫ÂÆöË°®ÊÉÖÁ¨¶ËôüÂíåÈ°èËâ≤
      let emoji, progressColor, bgColor, borderColor;
      if (percentage === 100) {
        emoji = "üéâ";
        progressColor = "#ffd700";
        bgColor = "rgba(255, 215, 0, 0.15)";
        borderColor = "rgba(255, 215, 0, 0.6)";
      } else if (percentage >= 80) {
        emoji = "üåü";
        progressColor = "#ffd700";
        bgColor = "rgba(255, 215, 0, 0.1)";
        borderColor = "rgba(255, 215, 0, 0.4)";
      } else if (percentage >= 50) {
        emoji = "‚≠ê";
        progressColor = "#a259ff";
        bgColor = "rgba(162, 89, 255, 0.15)";
        borderColor = "rgba(162, 89, 255, 0.5)";
      } else if (percentage >= 25) {
        emoji = "üìà";
        progressColor = "#00ffff";
        bgColor = "rgba(0, 255, 255, 0.1)";
        borderColor = "rgba(0, 255, 255, 0.4)";
      } else {
        emoji = "üìù";
        progressColor = "#00ffff";
        bgColor = "rgba(0, 255, 255, 0.08)";
        borderColor = "rgba(0, 255, 255, 0.3)";
      }
      
      // Êõ¥Êñ∞Áµ±Ë®àÈ°ØÁ§∫
      categoryStats.innerHTML = `
        <div style="margin-bottom: 8px;">
          <strong style="font-size: 1.1rem;">${emoji} ${selectedCategory} ÂàÜÈ°ûÁµ±Ë®à</strong>
        </div>
        <div style="margin-bottom: 6px;">
          <span style="color: ${progressColor}; font-weight: bold; font-size: 1rem;">
            Â∑≤Êî∂ÈõÜÔºö${collectedCards} / ${totalCards}
          </span>
        </div>
        <div style="
          background: rgba(0, 0, 0, 0.3);
          border-radius: 10px;
          height: 8px;
          margin: 8px 0;
          overflow: hidden;
        ">
          <div style="
            background: linear-gradient(90deg, ${progressColor}, ${progressColor}88);
            height: 100%;
            width: ${percentage}%;
            transition: width 0.5s ease;
            border-radius: 10px;
            box-shadow: 0 0 8px ${progressColor}66;
          "></div>
        </div>
        <div style="color: ${progressColor}; font-weight: bold;">
          ÂÆåÊàêÂ∫¶Ôºö${percentage}%
        </div>
      `;
      
      // Êõ¥Êñ∞Ê®£Âºè
      categoryStats.style.background = bgColor;
      categoryStats.style.borderColor = borderColor;
      categoryStats.style.color = progressColor;
      categoryStats.style.display = "block";
      
      // Ê∑ªÂä†ÂãïÁï´ÊïàÊûú
      categoryStats.style.animation = "none";
      setTimeout(() => {
        categoryStats.style.animation = "fadeInScale 0.3s ease";
      }, 10);
    }

    // -------- 4. Ê∏≤ÊüìÂç°ÁâáÂÄâÂ∫´(ÊêúÂ∞ã+ÁØ©ÈÅ∏+Ëß£ÈéñÁãÄÊÖã) --------
    function renderCards() {
      // ÈáçÊñ∞Êãø localStorageÔºåÁ¢∫‰øùËàáÊäΩÂç°È†ÅÂêåÊ≠•
      try {
        ownedCards = LinkageSystem.cards.getOwnedCards();
        recentlyObtainedCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
        
        // Ê∑ªÂä†Ë™øË©¶Ë≥áË®ä
        console.log('üîç renderCards Ë™øË©¶Ë≥áË®ä:');
        console.log('- ownedCards Êï∏Èáè:', Object.keys(ownedCards).length);
        console.log('- recentlyObtainedCards Êï∏Èáè:', recentlyObtainedCards.length);
        console.log('- window.allCards Êï∏Èáè:', window.allCards ? window.allCards.length : 'undefined');
      } catch (error) {
        console.error('Áç≤ÂèñÂç°ÁâáË≥áÊñôÊôÇÁôºÁîüÈåØË™§:', error);
        ownedCards = {};
        recentlyObtainedCards = [];
      }

      const search = document.getElementById("searchInput").value.trim().toLowerCase();
      const filterRarity = document.getElementById("rarityFilter").value;
      const filterCategory = document.getElementById("categoryFilter").value;
      const ownedFilter = document.querySelector('.tab-btn.active').dataset.filter;
      const showOwnedOnly = (ownedFilter === 'owned');
      const grid = document.getElementById("cardGrid");
      grid.innerHTML = "";

      // Á∞°ÂåñÂæåÁöÑÊéíÂ∫èÈÇèËºØ
      const sortedCards = [...window.allCards].sort((a, b) => {
        const aIsUnlocked = LinkageSystem.cards.isCardOwned(a.word);
        const bIsUnlocked = LinkageSystem.cards.isCardOwned(b.word);

        // 1. Â∑≤Ëß£ÈéñÁöÑÂç°ÁâáÂÑ™ÂÖà
        if (aIsUnlocked !== bIsUnlocked) {
          return aIsUnlocked ? -1 : 1;
        }

        // 2. Á®ÄÊúâÂ∫¶È´òÁöÑÂÑ™ÂÖà
        const rarityOrder = { 'Ë∂ÖÁ®ÄÊúâ': 3, 'Á®ÄÊúâ': 2, 'ÊôÆÈÄö': 1 };
        const aRarity = rarityOrder[a.rarity] || 0;
        const bRarity = rarityOrder[b.rarity] || 0;
        if (aRarity !== bRarity) {
          return bRarity - aRarity;
        }
        
        // 3. ÊúÄÂæå‰æùÁÖß ID ÊéíÂ∫è
        return (a.id || 0) - (b.id || 0);
      });

      let unlockedCount = 0;
      sortedCards.forEach(card => {
        // ÊêúÂ∞ãÂñÆÂ≠óÊàñ‰∏≠Êñá
        const combinedText = (card.word + card.zh).toLowerCase();
        const matchSearch = combinedText.includes(search);
        // ÁØ©Á®ÄÊúâÂ∫¶
        const matchRarity = (filterRarity === 'all' || card.rarity === filterRarity);
        // ÁØ©È°ûÂà•
        const matchCategory = (filterCategory === 'all' || card.category === filterCategory);

        const isUnlocked = LinkageSystem.cards.isCardOwned(card.word);
        const isNewCardFlag = recentlyObtainedCards.includes(card.word);

        let shardDisplayHtml = '';
        if (isUnlocked) {
          shardDisplayHtml = `<div class="shard-count shard-unlocked">‚úî</div>`;
        } else {
          shardDisplayHtml = `<div class="shard-count">Êú™Ëß£Èéñ</div>`;
        }

        // ÁØ©ÈÅ∏Â∑≤ÊúâÂç°Áâá (Ê≠§ÂäüËÉΩÂ∑≤ÁßªÈô§ÔºåÊîπÁÇ∫Ê®ôË®ò)
        const matchOwned = !showOwnedOnly || isUnlocked;

        if (!(matchSearch && matchRarity && matchCategory && matchOwned)) return;

        // CSS class
        const rarityClass = card.rarity === 'ÊôÆÈÄö' ? 'common'
                             : card.rarity === 'Á®ÄÊúâ' ? 'rare' : 'epic';

        const div = document.createElement("div");
        div.className = `card ${rarityClass}${isUnlocked ? ' unlocked' : ' locked'}`;
        div.setAttribute('data-word', card.word); // Ê∑ªÂä†data-wordÂ±¨ÊÄßÁî®ÊñºÂÆö‰Ωç
        
        // Ê†πÊìöÁ®ÄÊúâÂ∫¶Ê±∫ÂÆöÈÇäÊ°ÜÂ∫ïÂúñ
        if (card.rarity === 'ÊôÆÈÄö') {
          div.style.backgroundImage = "url('img/border/common.jpg')";
        } else if (card.rarity === 'Á®ÄÊúâ') {
          div.style.backgroundImage = "url('img/border/rare.png')";
        } else if (card.rarity === 'Ë∂ÖÁ®ÄÊúâ') {
          div.style.backgroundImage = "url('img/border/epic.png')";
        }

        // ÊòüÊòüÂúñÁ§∫
        let starIcons = '';
        if (card.rarity === 'ÊôÆÈÄö') starIcons = '‚òÖ';
        else if (card.rarity === 'Á®ÄÊúâ') starIcons = '‚òÖ‚òÖ';
        else if (card.rarity === 'Ë∂ÖÁ®ÄÊúâ') starIcons = '‚òÖ‚òÖ‚òÖ';

        // Ê∫ñÂÇôÂç°ÁâáÂÖßÂÆπ
        let mediaContent = '';
        // Âà§Êñ∑ÂúñÁâáÂûãÊÖãÔºåÁî¢ÁîüÊ≠£ÊñπÂΩ¢Á∏ÆÂúñÔºàmp4 Êì∑ÂèñÁ¨¨‰∏ÄÂπÄÔºâ
        let imgSrc = card.image;
        if (imgSrc && imgSrc.endsWith('.mp4')) {
          // mp4 Ê™îÊ°àÔºöÁî® video Ê®ôÁ±§Êì∑ÂèñÁ¨¨‰∏ÄÂπÄ‰ΩúÁÇ∫Á∏ÆÂúñ
          mediaContent = `
            <video class="card-media" preload="metadata" muted playsinline>
              <source src="${imgSrc}" type="video/mp4">
            </video>
          `;
        } else {
          // ‰∏ÄËà¨ÂúñÁâá
          mediaContent = `
            <img class="card-media" src="${imgSrc}" alt="${card.word}" onerror="this.onerror=null;this.src='img/cards/placeholder.jpg'">
          `;
        }
        let cardContent = `
          ${mediaContent}
        `;
        
        // Â¶ÇÊûúÊòØÊñ∞Âç°Áâá‰∏îÂ∑≤Ëß£ÈéñÔºåÊ∑ªÂä†NEWÊ®ôÁ±§
        if (recentlyObtainedCards.includes(card.word) && isUnlocked) {
          cardContent = `
            <div class="new-card-badge">NEW!</div>
            ${cardContent}
          `;
        }
        
        // Ê∑ªÂä†Âç°ÁâáÂêçÁ®±È°ØÁ§∫
        cardContent += `
          <div class="card-name">
            <div class="card-name-chinese">${card.zh}</div>
            <div class="card-name-english">${card.word}</div>
          </div>
        `;

        div.innerHTML = cardContent;

        // Âè™ÊúâÂ∑≤Ëß£ÈéñÂç°ÁâáÊâçÁ∂ÅÂÆöÈªûÊìä‰∫ã‰ª∂
        if (isUnlocked) {
          div.onclick = (event) => {
            // Ê™¢Êü•ÊòØÂê¶ÈªûÊìäÁöÑÊòØÂΩ±ÁâáÊåâÈàïÔºåÂ¶ÇÊûúÊòØÂâá‰∏çËôïÁêÜÔºàËÆìÂΩ±ÁâáÊåâÈàïËá™Â∑±ËôïÁêÜÔºâ
            if (event.target.closest('.video-button')) {
              return;
            }
            
            // ÊâìÈñã Modal
            openModal(card);
          };
          
          // Âè™ÊúâÂ∑≤Ëß£ÈéñÂç°ÁâáÁöÑÂΩ±ÁâáÊâçÊ∑ªÂä†ÈªûÊìä‰∫ã‰ª∂ÂíåÊá∏ÂÅú‰∫ã‰ª∂
          const videoElement = div.querySelector('video');
          if (videoElement) {
            // ÈªûÊìäÊí≠Êîæ/Êö´ÂÅú
            videoElement.addEventListener('click', (e) => {
              e.stopPropagation();
              if (videoElement.paused) {
                videoElement.play();
              } else {
                videoElement.pause();
              }
            });
            
            // ÊªëÈº†Êá∏ÂÅúÊôÇÊí≠ÊîæÔºåÈõ¢ÈñãÊôÇÊö´ÂÅú
            div.addEventListener('mouseenter', () => {
              if (videoElement.paused) {
                videoElement.play().catch(err => {
                  console.log('ÂΩ±ÁâáÊí≠ÊîæÂ§±Êïó:', err);
                });
              }
            });
            
            div.addEventListener('mouseleave', () => {
              if (!videoElement.paused) {
                videoElement.pause();
              }
            });
          }
          
          unlockedCount++;
        } else {
          // Êú™Ëß£ÈéñÂç°ÁâáÔºöÁ¶ÅÁî®ÊâÄÊúâÈªûÊìä‰∫ã‰ª∂
          div.style.pointerEvents = 'none';
          div.style.cursor = 'not-allowed';
          
          // Á¶ÅÁî®Êú™Ëß£ÈéñÂç°ÁâáÁöÑÂΩ±ÁâáÊí≠Êîæ
          const videoElements = div.querySelectorAll('video');
          videoElements.forEach(video => {
            video.style.pointerEvents = 'none';
            video.controls = false;
            video.autoplay = false;
            video.muted = true;
            video.pause();
          });
          
          // ÁÇ∫Êú™Ëß£ÈéñÂç°ÁâáÊ∑ªÂä†ÈéñÂÆöÈÅÆÁΩ©
          const lockOverlay = document.createElement('div');
          lockOverlay.className = 'lock-overlay';
          lockOverlay.innerHTML = `
            <div class="lock-icon">üîí</div>
            <div class="lock-text">Êú™Ëß£Èéñ</div>
          `;
          div.appendChild(lockOverlay);
        }

        grid.appendChild(div);
      });

      document.getElementById("progress").textContent = `Â∑≤Ëß£ÈéñÔºö${unlockedCount} / ${window.allCards.length}`;
      
      // Êõ¥Êñ∞Âç°ÁâáÁµ±Ë®àÔºàÁßªÈô§ÈáçË§áÂëºÂè´ÔºåÈÅøÂÖçÊïàËÉΩÂïèÈ°åÔºâ
      // updateCardStats();

      // ÁÇ∫ÊØèÂºµÂç°ÁâáÊ∑ªÂä†Âè≥ÈçµÈÅ∏ÂñÆ
      document.querySelectorAll('.card').forEach(cardElement => {
        cardElement.addEventListener('contextmenu', function(e) {
          e.preventDefault();
          
          const cardWord = this.getAttribute('data-word');
          const card = window.allCards.find(c => c.word === cardWord);
          
          if (!card) return;
          
          // Â¶ÇÊûúÊòØÁîüÊó•ËõãÁ≥ïÂç°Áâá‰∏îÊú™Ë®≠ÂÆöÁîüÊó•ÔºåÈ°ØÁ§∫ÁîüÊó•Ë®≠ÂÆöÈÅ∏È†Ö
          if (card.word === 'Birthday Cake' && !BirthdaySystem.hasBirthdaySet()) {
            showBirthdayContextMenu(e, card);
          }
        });
      });
    }

    // -------- 4.5. ÂàáÊèõÂ∑≤ÊúâÂç°ÁâáÁØ©ÈÅ∏ --------
    function toggleOwnedFilter() {
      const button = document.getElementById("ownedFilter");
      button.classList.toggle("active");
      renderCards();
    }

    // -------- 5. Modal ÁöÑÈñãÂïü/ÈóúÈñâ ÈÇèËºØ --------
    
    // YouTube URL ËΩâÊèõÂáΩÊï∏
    function getYouTubeEmbedUrl(url) {
      if (!url) return null;
      
      // ÊîØÊè¥Â§öÁ®ÆYouTube URLÊ†ºÂºè
      const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
        /youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/
      ];
      
      for (let pattern of patterns) {
        const match = url.match(pattern);
        if (match) {
          return `https://www.youtube.com/embed/${match[1]}?rel=0&modestbranding=1`;
        }
      }
      
      return null;
    }
    
    // Ê†πÊìöÂç°ÁâáÂÖßÂÆπËá™ÂãïÁîüÊàêYouTubeÊêúÂ∞ãURL
    function getYouTubeSearchUrl(card) {
      // ‰ΩøÁî®Âç°ÁâáÁöÑ‰∏≠Ëã±ÊñáÂêçÁ®±‰ΩúÁÇ∫ÊêúÂ∞ãÈóúÈçµÂ≠ó
      const searchTerm = encodeURIComponent(`${card.word} ${card.zh}`);
      // ‰ΩøÁî®YouTubeÊêúÂ∞ãÈ†ÅÈù¢ÔºåËÆìÁî®Êà∂ÂèØ‰ª•ÊâãÂãïÊêúÂ∞ãÁõ∏ÈóúÂΩ±Áâá
      return `https://www.youtube.com/results?search_query=${searchTerm}`;
    }
    
    // Ê™¢Ê∏¨ÊòØÂê¶ÊáâË©≤È°ØÁ§∫YouTubeÂΩ±Áâá
    function shouldShowYouTube(card) {
      // Â¶ÇÊûúÂç°ÁâáÊ≤íÊúâÂΩ±Áâá‰ΩÜÊúâÂúñÁâáÔºåÂâáÈ°ØÁ§∫YouTube
      return card.image && !card.image.endsWith('.mp4') && 
             !card.image.includes('youtube.com') && 
             !card.image.includes('youtu.be');
    }
    
    function openModal(card) {
      // ÁßªÈô§Ë©≤Âç°ÁâáÁöÑ NEW Ê®ôË®ò
      removeNewCardMarker(card.word);

      // Ê∫ñÂÇôÁ®ÄÊúâÂ∫¶ÊòüÊòü
      let starIcons = '';
      if (card.rarity === 'ÊôÆÈÄö') starIcons = '‚òÖ';
      else if (card.rarity === 'Á®ÄÊúâ') starIcons = '‚òÖ‚òÖ';
      else if (card.rarity === 'Ë∂ÖÁ®ÄÊúâ') starIcons = '‚òÖ‚òÖ‚òÖ';
      
      // Ê∫ñÂÇôÁ®ÄÊúâÂ∫¶Ê®ôÁ±§
      let rarityLabel = '';
      if (card.rarity === 'ÊôÆÈÄö') rarityLabel = 'A';
      else if (card.rarity === 'Á®ÄÊúâ') rarityLabel = 'R';
      else if (card.rarity === 'Ë∂ÖÁ®ÄÊúâ') rarityLabel = 'SSR';
      
      console.log('Á®ÄÊúâÂ∫¶Ê®ôÁ±§:', rarityLabel, 'ÊòüÊòü:', starIcons);
      
      let rarityIconHtml = `
        <div class="rarity-stars">${starIcons}</div>
        <div class="rarity-label">${rarityLabel}</div>
      `;

      // Ê∫ñÂÇôÁ®ÄÊúâÂ∫¶CSSÈ°ûÂà•
      let rarityClass = '';
      if (card.rarity === 'ÊôÆÈÄö') rarityClass = 'common';
      else if (card.rarity === 'Á®ÄÊúâ') rarityClass = 'rare';
      else if (card.rarity === 'Ë∂ÖÁ®ÄÊúâ') rarityClass = 'epic';

      // Ê∫ñÂÇôÂ™íÈ´îÂÖßÂÆπ
      let mediaContent = '';
      if (card.image) {
        if (card.image.endsWith('.mp4')) {
          // MP4 ÂΩ±Áâá
          mediaContent = `<video class="modal-video" controls>
            <source src="${card.image}" type="video/mp4">
          </video>`;
        } else if (card.image.includes('youtube.com') || card.image.includes('youtu.be')) {
          // YouTube ÂΩ±Áâá
          const embedUrl = getYouTubeEmbedUrl(card.image);
          if (embedUrl) {
            mediaContent = `<iframe class="modal-youtube" 
              src="${embedUrl}" 
              frameborder="0" 
              allowfullscreen>
            </iframe>`;
          } else {
            // Â¶ÇÊûúÁÑ°Ê≥ïËß£ÊûêYouTube URLÔºåÈ°ØÁ§∫È†êË®≠ÂúñÁâá
            mediaContent = `<img class="modal-image" src="${card.image}" alt="${card.word}">`;
          }
        } else {
          // ‰∏ÄËà¨ÂúñÁâá - Êèê‰æõYouTubeÊêúÂ∞ãÈÅ∏È†Ö
          const youtubeUrl = getYouTubeSearchUrl(card);
          mediaContent = `
            <div class="modal-image-container">
              <img class="modal-image" src="${card.image}" alt="${card.word}">
              <div class="youtube-overlay">
                <button class="youtube-search-btn" onclick="window.open('${youtubeUrl}', '_blank')">
                  <span class="material-icons">play_circle</span>
                  <span>ÊêúÂ∞ãYouTubeÂΩ±Áâá</span>
                </button>
              </div>
            </div>
          `;
        }
      } else {
        // Ê≤íÊúâÂúñÁâáÊôÇÁöÑÈ†êË®≠ÂÖßÂÆπ
        mediaContent = `<div class="modal-no-media">
          <span class="material-icons">image</span>
          <p>ÁÑ°Â™íÈ´îÂÖßÂÆπ</p>
        </div>`;
      }

      // Ê∫ñÂÇôÂÆåÊï¥Âç°ÁâáÂÖßÂÆπ
      let modalContent = `
        <div class="modal-card ${rarityClass}">
          ${rarityIconHtml}
          <div class="modal-title">
            <div class="chinese-text">${card.zh}</div>
            <div class="english-text">${card.word}</div>
          </div>
          <div class="modal-media">
            ${mediaContent}
          </div>
          <div class="modal-info">
            <div class="modal-category">È°ûÂà•Ôºö${card.category}</div>
            <div class="modal-description">${card.description}</div>
          </div>
        </div>
      `;

      // Ê∏ÖÁ©∫ modalCardContainerÔºåÊîæÂÖ•ÂÆåÊï¥ÂÖßÂÆπ
      const container = document.getElementById('modalCardContainer');
      container.innerHTML = modalContent;

      document.getElementById("overlay").style.display = "block";
      document.getElementById("modal").classList.add("show");
    }



    function closeModal() {
      // ÂÅúÊ≠¢Modal‰∏≠ÁöÑÂΩ±ÁâáÊí≠Êîæ
      const modalVideo = document.querySelector('#modal video');
      if (modalVideo) {
        modalVideo.pause();
        modalVideo.currentTime = 0;
      }
      
      // ÁßªÈô§YouTube iframe‰ª•ÂÅúÊ≠¢Êí≠Êîæ
      const modalYouTube = document.querySelector('#modal iframe');
      if (modalYouTube) {
        modalYouTube.remove();
      }
      
      document.getElementById("modal").classList.remove("show");
      document.getElementById("overlay").style.display = "none";
      // ‰ΩøÁî®Êñ∞ÁöÑÁôºÈü≥Á≥ªÁµ±ÂÅúÊ≠¢ÁôºÈü≥
      if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
      }
    }

    function playModalAudio() {
      const audioElem = document.getElementById("modalAudio");
      if (audioElem && audioElem.src) {
        audioElem.play();
      }
    }

    // -------- 6. È†ÅÈù¢ËºâÂÖ•ÊôÇÂÖàÂàùÂßãÂåñ „ÄåÈ°ûÂà•ÈÅ∏ÂñÆ„Äç ‰∏¶ renderCards() --------
    // ÁßªÈô§ÈáçË§áÁöÑ window.addEventListener("load")ÔºåÁµ±‰∏ÄÂú®‰∏ãÊñπËôïÁêÜ

    // Ë®≠ÁΩÆ Modal ‰∫ã‰ª∂
    function setupModalEvents() {
      const overlay = document.getElementById('overlay');
      const modal = document.getElementById('modal');
      
      if (overlay) {
        // ÈªûÊìäËÉåÊôØÈÅÆÁΩ©ÈóúÈñâ Modal
        overlay.addEventListener('click', function(e) {
          if (e.target === overlay) {
            closeModal();
          }
        });
      }
      
      if (modal) {
        // ÈªûÊìä Modal ÂÖßÂÆπÂçÄÂüü‰∏çÈóúÈñâ
        modal.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      }
      
      // ESC ÈçµÈóúÈñâ Modal
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeModal();
        }
      });
    }

    // -------- 7. Á¢éÁâáÁ≥ªÁµ±Áõ∏ÈóúÂáΩÊï∏ --------
    // Â∑≤Âà™Èô§ toggleShardInfo ÂáΩÊï∏ÔºåÂõ†ÁÇ∫‰∏çÂÜçÈúÄË¶ÅÂàáÊèõË™™ÊòéÈ°ØÁ§∫

    // -------- 8. Êñ∞Âç°ÁâáÁ≥ªÁµ±Áõ∏ÈóúÂáΩÊï∏ --------
    function clearNewCardMarkers() {
      // Ê∏ÖÈô§ÊúÄËøëÁç≤ÂæóÁöÑÂç°ÁâáÊ®ôË®ò
      localStorage.removeItem('recentlyObtainedCards');
      localStorage.removeItem('newCardTimestamps');
      recentlyObtainedCards = [];
      renderCards();
    }

    function addNewCard(cardWord) {
      // Ê∑ªÂä†Êñ∞Âç°ÁâáÂà∞ÊúÄËøëÁç≤ÂæóÂàóË°®
      let recentCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
      let cardTimestamps = JSON.parse(localStorage.getItem('newCardTimestamps') || '{}');
      
      if (!recentCards.includes(cardWord)) {
        recentCards.push(cardWord);
        // Ë®òÈåÑÁç≤ÂæóÊôÇÈñìÊà≥
        cardTimestamps[cardWord] = Date.now();
        
        // Âè™‰øùÁïôÊúÄËøë20ÂºµÊñ∞Âç°Áâá
        if (recentCards.length > 20) {
          const oldestCard = recentCards.shift();
          delete cardTimestamps[oldestCard];
        }
        
        localStorage.setItem('recentlyObtainedCards', JSON.stringify(recentCards));
        localStorage.setItem('newCardTimestamps', JSON.stringify(cardTimestamps));
      }
    }

    // ÁßªÈô§ÂñÆÂºµÂç°ÁâáÁöÑ NEW Ê®ôË®ò
    function removeNewCardMarker(cardWord) {
      let recentCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
      let cardTimestamps = JSON.parse(localStorage.getItem('newCardTimestamps') || '{}');
      
      // Â¶ÇÊûúÂç°ÁâáÂú®Êñ∞Âç°ÁâáÂàóË°®‰∏≠ÔºåÂâáÁßªÈô§ÂÆÉ
      if (recentCards.includes(cardWord)) {
        recentCards = recentCards.filter(card => card !== cardWord);
        delete cardTimestamps[cardWord];
        
        localStorage.setItem('recentlyObtainedCards', JSON.stringify(recentCards));
        localStorage.setItem('newCardTimestamps', JSON.stringify(cardTimestamps));
        
        // Êõ¥Êñ∞È†ÅÈù¢ËÆäÊï∏
        recentlyObtainedCards = recentCards;
        
        // ÈáçÊñ∞Ê∏≤ÊüìÂç°Áâá‰ª•ÁßªÈô§ NEW Ê®ôË®ò
        renderCards();
        
        console.log(`‚úÖ Â∑≤ÁßªÈô§„Äå${cardWord}„ÄçÁöÑ NEW Ê®ôË®ò`);
      }
    }

    // Ëá™ÂãïÊ∏ÖÈô§Êñ∞Âç°ÁâáÊ®ôË®òÔºà10ÁßíÂæåÔºâ
    function autoClearNewCards() {
      const cardTimestamps = JSON.parse(localStorage.getItem('newCardTimestamps') || '{}');
      const now = Date.now();
      const tenSeconds = 10 * 1000; // 10Áßí
      
      let hasExpiredCards = false;
      const expiredCards = [];
      
      // Ê™¢Êü•ÊòØÂê¶ÊúâÈÅéÊúüÁöÑÂç°Áâá
      Object.keys(cardTimestamps).forEach(cardWord => {
        const timestamp = cardTimestamps[cardWord];
        if (now - timestamp > tenSeconds) {
          expiredCards.push(cardWord);
          delete cardTimestamps[cardWord];
          hasExpiredCards = true;
        }
      });
      
      // Â¶ÇÊûúÊúâÈÅéÊúüÂç°ÁâáÔºåÊõ¥Êñ∞ localStorage
      if (hasExpiredCards) {
        let recentCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
        recentCards = recentCards.filter(card => !expiredCards.includes(card));
        
        localStorage.setItem('recentlyObtainedCards', JSON.stringify(recentCards));
        localStorage.setItem('newCardTimestamps', JSON.stringify(cardTimestamps));
        
        // Êõ¥Êñ∞È†ÅÈù¢ËÆäÊï∏
        recentlyObtainedCards = recentCards;
        
        // Âè™Âú®ÊúâÈÅéÊúüÂç°ÁâáÊôÇÊâçÈáçÊñ∞Ê∏≤ÊüìÔºåÈÅøÂÖç‰∏çÂøÖË¶ÅÁöÑÈáçË§áÊ∏≤Êüì
        if (expiredCards.length > 0) {
          renderCards();
          console.log(`‚è∞ Â∑≤ÁßªÈô§ ${expiredCards.length} ÂºµÈÅéÊúüÁöÑÊñ∞Âç°ÁâáÊ®ôË®òÔºö`, expiredCards);
        }
      }
      
      // ÁßªÈô§È†ªÁπÅÁöÑ console.logÔºåÈÅøÂÖçÊïàËÉΩÂïèÈ°å
      // console.log('‚è∞ Ê™¢Êü•Êñ∞Âç°ÁâáÊ®ôË®òÂÆåÊàê');
    }

    // Ê™¢Êü•Âç°ÁâáÊòØÂê¶ÁÇ∫Êñ∞Âç°ÁâáÔºà10ÁßíÂÖßÔºâ
    function isNewCard(cardWord) {
      const cardTimestamps = JSON.parse(localStorage.getItem('newCardTimestamps') || '{}');
      const timestamp = cardTimestamps[cardWord];
      
      if (!timestamp) return false;
      
      const now = Date.now();
      const tenSeconds = 10 * 1000; // 10Áßí
      
      return (now - timestamp) <= tenSeconds;
    }

    // Áç≤ÂèñÊïàÊûúÈ°ûÂûãÁöÑ‰∏≠ÊñáÂêçÁ®±
    function getEffectTypeName(effectType) {
      const typeNames = {
        'time_extend': 'ÊôÇÈñìÂª∂Èï∑',
        'time_freeze': 'ÊôÇÈñìÊö´ÂÅú',
        'hint': 'ÊèêÁ§∫ËºîÂä©',
        'shield': 'Ë≠∑Áõæ‰øùË≠∑',
        'energy_restore': 'ËÉΩÈáèÊÅ¢Âæ©',
        'combo_protect': 'ÈÄ£Êìä‰øùË≠∑',
        'score_multiply': 'ÂàÜÊï∏Âä†ÂÄç',
        'skip_level': 'Ë∑≥ÈÅéÈóúÂç°'
      };
      return typeNames[effectType] || 'Êú™Áü•ÊïàÊûú';
    }

    // Ë™øË©¶‰ø°ÊÅØ
    function debugNewCardInfo() {
      console.log('üîç Ë™øË©¶‰ø°ÊÅØÔºö');
      console.log('recentlyObtainedCards:', recentlyObtainedCards);
      console.log('ownedCards keys:', Object.keys(ownedCards));
      console.log('localStorage recentlyObtainedCards:', localStorage.getItem('recentlyObtainedCards'));
      console.log('ownedCards ÂÆåÊï¥ÂÖßÂÆπ:', ownedCards);
      
      // Ê∏¨Ë©¶Âç°ÁâáÊ™¢Êü•Â∑≤ÁßªÈô§
      
      // È°ØÁ§∫ÊôÇÈñìÊà≥‰ø°ÊÅØ
      const cardTimestamps = JSON.parse(localStorage.getItem('newCardTimestamps') || '{}');
      console.log('newCardTimestamps:', cardTimestamps);
      
      // È°ØÁ§∫ÊØèÂºµÊñ∞Âç°ÁâáÁöÑÂâ©È§òÊôÇÈñì
      const now = Date.now();
      const tenSeconds = 10 * 1000;
      Object.keys(cardTimestamps).forEach(cardWord => {
        const timestamp = cardTimestamps[cardWord];
        const elapsed = now - timestamp;
        const remaining = tenSeconds - elapsed;
        const remainingSeconds = Math.max(0, Math.floor(remaining / 1000));
        console.log(`‚è∞ ${cardWord}: Ââ©È§ò ${remainingSeconds}Áßí`);
      });
    }

    // Êõ¥Êñ∞Âç°ÁâáÁµ±Ë®à
    function updateCardStats() {
      const totalCards = window.allCards.length;
      const ownedCards = LinkageSystem.cards.getOwnedCards();
      const unlockedCards = Object.keys(ownedCards).length;
      
      // Êõ¥Êñ∞È†ÅÈù¢È†ÇÈÉ®ÁöÑÊòüÊòüÈ°ØÁ§∫
      const totalStars = parseInt(localStorage.getItem('totalStars') || '0');
      const starsDisplay = document.getElementById('totalStarsCount');
      if (starsDisplay) {
        starsDisplay.textContent = `‚≠ê ${totalStars}`;
      }
      
      // Êõ¥Êñ∞ÈÄ≤Â∫¶È°ØÁ§∫
      const progressText = `Â∑≤Ëß£ÈéñÔºö${unlockedCards} / ${totalCards}`;
      document.getElementById("progress").textContent = progressText;
    }

    // -------- 9. YouTube ÂΩ±ÁâáÁõ∏ÈóúÂáΩÊï∏ --------
    
    // Êí≠ÊîæÂΩ±ÁâáÂáΩÊï∏
    function playVideo(videoUrl, cardWord) {
      if (!videoUrl) {
        alert('Ê≤íÊúâÂΩ±ÁâáÈÄ£Áµê');
        return;
      }
      
      // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ YouTube ÈÄ£Áµê
      if (/youtu(be\.com|\.be)/.test(videoUrl)) {
        const youtubeId = extractYouTubeId(videoUrl);
        if (youtubeId) {
          // ÈñãÂïü YouTube ÂΩ±Áâá Modal
          openVideoModal(youtubeId, cardWord, 'youtube');
        } else {
          alert('YouTube ÈÄ£ÁµêÊ†ºÂºèÈåØË™§');
        }
      } else {
        // Êú¨Âú∞ MP4 ÂΩ±Áâá
        openVideoModal(videoUrl, cardWord, 'mp4');
      }
    }
    
    // ÈñãÂïüÂΩ±Áâá Modal
    function openVideoModal(videoSource, cardWord, type) {
      // ÂâµÂª∫ÂΩ±Áâá Modal
      const modal = document.createElement('div');
      modal.className = 'video-modal';
      modal.innerHTML = `
        <div class="video-modal-content">
          <div class="video-modal-header">
            <h3>${cardWord}</h3>
            <button class="video-modal-close" onclick="closeVideoModal()">√ó</button>
          </div>
          <div class="video-modal-body">
            ${type === 'youtube' 
              ? `<iframe src="https://www.youtube.com/embed/${videoSource}?controls=1&showinfo=1&rel=0&modestbranding=1" 
                   frameborder="0" allow="encrypted-media" allowfullscreen></iframe>`
              : `<video controls>
                   <source src="${videoSource}" type="video/mp4">
                   ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÂΩ±ÁâáÊí≠Êîæ
                 </video>`
            }
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // ÈªûÊìäËÉåÊôØÈóúÈñâ Modal
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeVideoModal();
        }
      });
      
      // ESC ÈçµÈóúÈñâ Modal
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeVideoModal();
        }
      });
    }
    
    // ÈóúÈñâÂΩ±Áâá Modal
    function closeVideoModal() {
      const modal = document.querySelector('.video-modal');
      if (modal) {
        modal.remove();
      }
    }
    
    // Êñ∞Â¢ûÔºöÂàáÊèõÂΩ±ÁâáÊí≠Êîæ/Êö´ÂÅú
    function toggleVideoPlayback(controlElement) {
      const video = controlElement.parentElement.querySelector('video');
      if (!video) return;
      
      if (video.paused) {
        video.play();
        controlElement.textContent = '‚è∏Ô∏è Êö´ÂÅú';
      } else {
        video.pause();
        controlElement.textContent = '‚ñ∂Ô∏è Êí≠Êîæ';
      }
    }
    
    function extractYouTubeId(url) {
      const patterns = [
        /(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([\w-]{11})/,
        /youtube\.com\/embed\/([\w-]{11})/,
        /youtu\.be\/([\w-]{11})/
      ];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
          return match[1];
        }
      }
      return null;
    }



    // =================== Ê∏¨Ë©¶ËÄÖÊï¥ÂêàÁ®ãÂºèÁ¢º ===================
    // Â¶ÇÊûúË¶ÅÁî®Ê∏¨Ë©¶ËÄÖÊåá‰ª§Ôºà‰æãÂ¶ÇÔºöÂä†Êòü„ÄÅËß£ÈéñÊâÄÊúâÔºâÔºåÂèØ‰ª•Âú® localStorage Ë£°Êîæ testerInstructions
    // { "addStars": true, "unlockAllCards": true, "testerMode": true }
    let stars = parseInt(localStorage.getItem("totalStars") || "0");

    function updateStars() {
      // Â¶ÇÊûúÊúâ #stars Êàñ #totalStarsCount ÂÖÉÁ¥†ÔºåÂ∞±Êõ¥Êñ∞ÂÆÉ
      const el = document.getElementById("stars") || document.getElementById("totalStarsCount");
      if (el) {
        // ÁÇ∫ totalStarsCount ÂÖÉÁ¥†Âä†‰∏äÊòüÊòüÁ¨¶Ëôü
        if (el.id === 'totalStarsCount') {
          el.textContent = `‚≠ê ${stars}`;
        } else {
          el.textContent = stars;
        }
      }
      localStorage.setItem("totalStars", stars);
    }

    window.addEventListener("load", () => {
      updateStars();
      
      // ÁßªÈô§ÈáçË§áÁöÑÂàùÂßãÂåñÈÇèËºØÔºåËÆì waitForAllCards() Áµ±‰∏ÄËôïÁêÜ
      // if (!window.allCards || window.allCards.length === 0) {
      //   console.error('Ë≠¶ÂëäÔºöallCards ÁÇ∫Á©∫Èô£ÂàóÔºåÂèØËÉΩÊòØ cards.js ËºâÂÖ•Â§±Êïó');
      //   waitForAllCards();
      // } else {
      //   initializePage();
      // }
    });



    console.log('allCards Èï∑Â∫¶:', window.allCards.length);

    // ÁßªÈô§ÈáçË§áÁöÑÂàùÂßãÂåñÈÇèËºØÔºåÈÅøÂÖçÂ§öÊ¨°ÂëºÂè´ initializePage()
    // if (!window.allCards || window.allCards.length === 0) {
    //   console.error('Ë≠¶ÂëäÔºöallCards ÁÇ∫Á©∫Èô£ÂàóÔºåÂèØËÉΩÊòØ cards.js ËºâÂÖ•Â§±Êïó');
    //   waitForAllCards();
    // } else {
    //   initializePage();
    // }

    function initializePage() {
      // ÂàùÂßãÂåñÈü≥ÊïàÁ≥ªÁµ±
      if (typeof SoundSystem !== 'undefined') {
        SoundSystem.speech.init();
      }
      
      // ÂàùÂßãÂåñÈü≥Ê®ÇÁ≥ªÁµ±
      setTimeout(() => {
        initBackgroundMusic();
        
        // Á∂ÅÂÆöÈü≥Ê®ÇÊéßÂà∂ÊåâÈàï‰∫ã‰ª∂
        const musicBtn = document.getElementById('toggleMusic');
        if (musicBtn) {
          musicBtn.addEventListener('click', toggleBackgroundMusic);
          console.log('üéµ Èü≥Ê®ÇÊéßÂà∂ÊåâÈàï‰∫ã‰ª∂Â∑≤Á∂ÅÂÆö');
        }
        
        // Ê∑ªÂä†Áî®Êà∂‰∫íÂãïËß∏ÁôºÈü≥Ê®ÇÊí≠Êîæ
        let hasUserInteracted = false;
        
        function handleUserInteraction() {
          if (!hasUserInteracted) {
            hasUserInteracted = true;
            console.log('üëÜ Áî®Êà∂‰∫íÂãïËß∏ÁôºÔºåÈü≥Ê®ÇÁ≥ªÁµ±Â∑≤ÂïüÁî®');
            
            // Â¶ÇÊûúÊáâË©≤Êí≠Êîæ‰ΩÜÈÇÑÊ≤íÊí≠ÊîæÔºåÂòóË©¶Êí≠Êîæ
            if (isMusicPlaying && backgroundMusic && backgroundMusic.paused) {
              playBackgroundMusic();
            }
          }
        }
        
        // Áõ£ËÅΩÂêÑÁ®ÆÁî®Êà∂‰∫íÂãï‰∫ã‰ª∂
        ['click', 'touchstart', 'keydown'].forEach(eventType => {
          document.addEventListener(eventType, handleUserInteraction, { once: true });
        });
      }, 500);
      
      // Áõ£ËÅΩÈ†ÅÈù¢ÂèØË¶ãÊÄßËÆäÂåñÔºåËôïÁêÜÈü≥Ê®ÇÊö´ÂÅú/ÊÅ¢Âæ©
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          // È†ÅÈù¢Èö±ËóèÊôÇÊö´ÂÅúÈü≥Ê®Ç
          if (isMusicPlaying && backgroundMusic) {
            backgroundMusic.pause();
          }
        } else {
          // È†ÅÈù¢È°ØÁ§∫ÊôÇÊÅ¢Âæ©Èü≥Ê®Ç
          if (isMusicPlaying && backgroundMusic && backgroundMusic.paused) {
            backgroundMusic.play().catch(err => {
              console.log('È†ÅÈù¢ÊÅ¢Âæ©ÊôÇÈü≥Ê®ÇÊí≠ÊîæÂ§±Êïó:', err);
            });
          }
        }
      });
      
      // ÂàùÂßãÂåñÈ†ÅÁ±§ÊåâÈàï
      document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const clickedButton = e.currentTarget;
          if (clickedButton.classList.contains('active')) {
            return; // Â¶ÇÊûúÈªûÊìäÁöÑÂ∑≤Á∂ìÊòØÂïüÁî®ÁãÄÊÖãÔºåÂâá‰∏çÈáçË§áÂü∑Ë°å
          }
          document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
          clickedButton.classList.add('active');
          renderCards();
          updateCategoryStats();
        });
      });
      
      // ÂàùÂßãÂåñÊñ∞Âç°ÁâáÁ≥ªÁµ±
      autoClearNewCards();
      
      // Ë®≠ÁΩÆÂÆöÊôÇÂô®ÔºåÊØèÁßíÊ™¢Êü•‰∏ÄÊ¨°ÈÅéÊúüÁöÑÊñ∞Âç°ÁâáÊ®ôË®ò
      setInterval(autoClearNewCards, 1000); // ÊØèÁßíÊ™¢Êü•‰∏ÄÊ¨°
      
      // ÂàùÂßãÂåñÈ†ÅÈù¢
      initCategoryOptions();
      renderCards();
      updateCardStats(); // Á¢∫‰øùÊòüÊòüÊï∏ÂêåÊ≠•
      updateCategoryStats(); // ÂàùÂßãÂåñÂàÜÈ°ûÁµ±Ë®à
      // updateShardStats(); // Â∑≤ÁßªÈô§Á¢éÁâáÁ≥ªÁµ±
      
      // Ë®≠ÁΩÆ Modal ‰∫ã‰ª∂
      setupModalEvents();
      
      // Ë®≠ÁΩÆËß∏ÊéßË®≠ÂÇôÂÑ™Âåñ
      setupTouchOptimization();
      
      // Ê™¢Êü•‰∏¶Á™ÅÂá∫È°ØÁ§∫Êñ∞Ëß£ÈéñÁöÑÂç°Áâá
      setTimeout(() => {
        highlightNewCards();
      }, 500); // Âª∂ÈÅ≤500msÁ¢∫‰øùÂç°ÁâáÂ∑≤Ê∏≤ÊüìÂÆåÊàê
      
      // Ë®≠ÁΩÆÂΩ±ÁâáÊïàËÉΩÂÑ™ÂåñÂÆöÊôÇÂô®
      setInterval(optimizeVideoPerformance, 2000); // ÊØè2ÁßíÊ™¢Êü•‰∏ÄÊ¨°ÂΩ±ÁâáÊïàËÉΩ
      
      // Ë™øË©¶‰ø°ÊÅØ
      debugNewCardInfo();
      
      // Â¶ÇÊûúÊúâÊñ∞Âç°ÁâáÔºåÈ°ØÁ§∫ÊèêÁ§∫
      if (recentlyObtainedCards.length > 0) {
        console.log(`üéâ ÁôºÁèæ ${recentlyObtainedCards.length} ÂºµÊñ∞Âç°ÁâáÔºÅ`);
      } else {
        console.log('üìù ÁõÆÂâçÊ≤íÊúâÊñ∞Âç°ÁâáÊ®ôË®ò');
      }
      
      // Ê∑ªÂä†ÈçµÁõ§Âø´Êç∑Èçµ
      document.addEventListener('keydown', (e) => {
        // Èü≥Ê®ÇÊéßÂà∂Âø´Êç∑Èçµ
        if (e.key === 'm' || e.key === 'M') {
          toggleBackgroundMusic();
        }
      });
      
      setupVirtualScroll();
      renderCardsVirtual();
    }

    // -------- 9. YouTube ÂΩ±ÁâáÁõ∏ÈóúÂáΩÊï∏ --------
    
    // Êñ∞Â¢ûÔºöËß∏ÊéßË®≠ÂÇôÂÑ™Âåñ
    function setupTouchOptimization() {
      // Ê™¢Ê∏¨ÊòØÂê¶ÁÇ∫Ëß∏ÊéßË®≠ÂÇô
      const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      
      if (isTouchDevice) {
        console.log('üì± Ê™¢Ê∏¨Âà∞Ëß∏ÊéßË®≠ÂÇôÔºåÂïüÁî®Ëß∏ÊéßÂÑ™Âåñ');
        
        // ÁÇ∫Ëß∏ÊéßË®≠ÂÇôÊ∑ªÂä†ÁâπÊÆäÁöÑÂΩ±ÁâáÊéßÂà∂
        document.addEventListener('click', (e) => {
          const video = e.target.closest('.card')?.querySelector('video.card-media');
          if (video) {
            e.preventDefault();
            e.stopPropagation();
            
            if (video.paused) {
              video.play().catch(err => {
                console.log('Ëß∏ÊéßË®≠ÂÇôÂΩ±ÁâáÊí≠ÊîæÂ§±Êïó:', err);
              });
            } else {
              video.pause();
            }
          }
        });
      }
    }
    
    // Êñ∞Â¢ûÔºöÊñ∞Âç°ÁâáÈ´ò‰∫ÆÂãïÁï´
    const style = document.createElement('style');
    style.textContent = `
      @keyframes newCardHighlight {
        0%, 100% { 
          transform: scale(1);
          box-shadow: 0 0 16px #00ffff55, 0 0 32px #a259ff33;
        }
        50% { 
          transform: scale(1.1);
          box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc, 0 0 20px #ffd700;
        }
      }
    `;
    document.head.appendChild(style);

    // ËºîÂä©ÂáΩÊï∏ÔºöÂà§Êñ∑ÊòØÂê¶ÁÇ∫SSR
    function isSSR(card) {
      return card.rarity === 'Ë∂ÖÁ®ÄÊúâ' || card.rarity === 'ÁØÄÊó•ÈôêÂÆö';
    }

    // Á¢éÁâáËΩâÊèõÊòüÊòüÂäüËÉΩÂ∑≤ÁßªÈô§ÔºàÁ¢éÁâáÁ≥ªÁµ±Â∑≤ÁßªÈô§Ôºâ



    // È°ØÁ§∫ÁîüÊó•Ë®≠ÂÆöÂè≥ÈçµÈÅ∏ÂñÆ
    function showBirthdayContextMenu(e, card) {
      // ÁßªÈô§ÁèæÊúâÁöÑÂè≥ÈçµÈÅ∏ÂñÆ
      const existingMenu = document.querySelector('.context-menu');
      if (existingMenu) {
        existingMenu.remove();
      }
      
      const menu = document.createElement('div');
      menu.className = 'context-menu';
      menu.style.cssText = `
        position: fixed;
        top: ${e.clientY}px;
        left: ${e.clientX}px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        padding: 8px 0;
        min-width: 200px;
      `;
      
      menu.innerHTML = `
        <div style="padding: 8px 16px; border-bottom: 1px solid #eee; font-weight: bold; color: #333;">
          üéÇ ÁîüÊó•ËõãÁ≥ïÂç°Áâá
        </div>
        <div style="padding: 8px 16px; cursor: pointer; transition: background 0.2s;" 
             onmouseover="this.style.background='#f5f5f5'" 
             onmouseout="this.style.background='transparent'"
             onclick="BirthdaySystem.showBirthdaySetupDialog(); this.parentElement.remove();">
          üìÖ Ë®≠ÂÆöÁîüÊó•Êó•Êúü
        </div>
        <div style="padding: 8px 16px; color: #666; font-size: 12px;">
          Ë®≠ÂÆöÂæåÂú®ÁîüÊó•Áï∂Â§©ÊúÉËá™ÂãïÁç≤ÂæóÊ≠§Âç°Áâá
        </div>
      `;
      
      document.body.appendChild(menu);
      
      // ÈªûÊìäÂÖ∂‰ªñÂú∞ÊñπÈóúÈñâÈÅ∏ÂñÆ
      setTimeout(() => {
        document.addEventListener('click', function closeMenu() {
          menu.remove();
          document.removeEventListener('click', closeMenu);
        });
      }, 100);
    }

    // Âú®È†ÅÈù¢ËºâÂÖ•ÊôÇÂàùÂßãÂåñÁîüÊó•Á≥ªÁµ±
    document.addEventListener('DOMContentLoaded', function() {
      // Ê™¢Êü•‰∏¶È°ØÁ§∫ÁîüÊó•Á•ùÁ¶è
      if (typeof BirthdaySystem !== 'undefined') {
        BirthdaySystem.checkAndGiveBirthdayCard();
      }
    });

    console.log('allCards Èï∑Â∫¶:', window.allCards.length);

    // ÁßªÈô§ÈáçË§áÁöÑÂàùÂßãÂåñÈÇèËºØ
    // if (!window.allCards || window.allCards.length === 0) {
    //   console.error('Ë≠¶ÂëäÔºöallCards ÁÇ∫Á©∫Èô£ÂàóÔºåÂèØËÉΩÊòØ cards.js ËºâÂÖ•Â§±Êïó');
    //   waitForAllCards();
    // } else {
    //   initializePage();
    // }

    // Ê∏ÖÁêÜÁÑ°ÊïàÁöÑ ownedCards Ë≥áÊñô
    function cleanOwnedCards() {
        const ownedCards = JSON.parse(localStorage.getItem('ownedCards') || '{}');
        const allCardWords = window.allCards.map(card => card.word);
        
        // Âè™‰øùÁïôÂú® allCards ‰∏≠Â≠òÂú®ÁöÑÂç°Áâá
        const cleanedOwnedCards = {};
        Object.keys(ownedCards).forEach(word => {
            if (allCardWords.includes(word)) {
                cleanedOwnedCards[word] = ownedCards[word];
            } else {
                console.log('ÁßªÈô§ÁÑ°ÊïàÂç°Áâá:', word);
            }
        });
        
        localStorage.setItem('ownedCards', JSON.stringify(cleanedOwnedCards));
        console.log('Ê∏ÖÁêÜÂÆåÊàêÔºåÊúâÊïàÂç°ÁâáÊï∏Èáè:', Object.keys(cleanedOwnedCards).length);
        
        // ÈáçÊñ∞Ê∏≤ÊüìÈ†ÅÈù¢
        if (typeof renderCards === 'function') {
            renderCards();
        }
    }

    // ÁßªÈô§Ëá™ÂãïÂü∑Ë°åÊ∏ÖÁêÜÔºåÈÅøÂÖçÂú®È†ÅÈù¢ËºâÂÖ•ÊôÇÂ∞±Ê∏ÖÁ©∫Âç°ÁâáË≥áÊñô
    // cleanOwnedCards();

    // Ê∏¨Ë©¶Âç°ÁâáÂ∑≤Ê∏ÖÁêÜÂÆåÊàê

    // ====== ÈÄ≤ÈöéËôõÊì¨Êç≤ÂãïÂÑ™Âåñ ======
    const CARD_HEIGHT = 160;
    const BUFFER_ROWS = 1;
    let cardsPerRow = 0;
    let visibleRows = 0;
    let lastStartIdx = -1;
    let cardDomPool = [];
    let cardDomInUse = [];
    let debounceTimers = {};

    function getCardsPerRow() {
      const grid = document.getElementById('cardGrid');
      const gridWidth = grid.offsetWidth;
      const cardWidth = 120 + 20;
      return Math.max(1, Math.floor(gridWidth / cardWidth));
    }

    function getVisibleRows() {
      const grid = document.getElementById('cardGrid');
      const gridHeight = grid.offsetHeight;
      return Math.ceil(gridHeight / CARD_HEIGHT);
    }

    function preloadImage(src) {
      if (!src) return;
      const img = new window.Image();
      img.src = src;
    }

    // ====== ÈÄ≤ÈöéËôõÊì¨Êç≤ÂãïÂÑ™ÂåñÔºàË°åÂãïË£ùÁΩÆÂ∞àÂ±¨Ôºâ ======
    function isTouchDevice() {
      return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    }

    function renderCardsVirtual() {
      window.requestAnimationFrame(() => {
        try {
          ownedCards = LinkageSystem.cards.getOwnedCards();
          recentlyObtainedCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
        } catch (error) {
          ownedCards = {};
          recentlyObtainedCards = [];
        }
        const search = document.getElementById("searchInput").value.trim().toLowerCase();
        const filterRarity = document.getElementById("rarityFilter").value;
        const filterCategory = document.getElementById("categoryFilter").value;
        const ownedFilter = document.querySelector('.tab-btn.active').dataset.filter;
        const showOwnedOnly = (ownedFilter === 'owned');
        const grid = document.getElementById("cardGrid");

        // ÊéíÂ∫èËàáÁØ©ÈÅ∏
        const sortedCards = [...window.allCards].sort((a, b) => {
          const aIsUnlocked = LinkageSystem.cards.isCardOwned(a.word);
          const bIsUnlocked = LinkageSystem.cards.isCardOwned(b.word);
          if (aIsUnlocked !== bIsUnlocked) return aIsUnlocked ? -1 : 1;
          const rarityOrder = { 'Ë∂ÖÁ®ÄÊúâ': 3, 'Á®ÄÊúâ': 2, 'ÊôÆÈÄö': 1 };
          const aRarity = rarityOrder[a.rarity] || 0;
          const bRarity = rarityOrder[b.rarity] || 0;
          if (aRarity !== bRarity) return bRarity - aRarity;
          return (a.id || 0) - (b.id || 0);
        });
        const filteredCards = sortedCards.filter(card => {
          const combinedText = (card.word + card.zh).toLowerCase();
          const matchSearch = combinedText.includes(search);
          const matchRarity = (filterRarity === 'all' || card.rarity === filterRarity);
          const matchCategory = (filterCategory === 'all' || card.category === filterCategory);
          const isUnlocked = LinkageSystem.cards.isCardOwned(card.word);
          const matchOwned = !showOwnedOnly || isUnlocked;
          return matchSearch && matchRarity && matchCategory && matchOwned;
        });

        // ËôõÊì¨Êç≤ÂãïË®àÁÆó
        cardsPerRow = getCardsPerRow();
        visibleRows = getVisibleRows();
        const totalRows = Math.ceil(filteredCards.length / cardsPerRow);
        const scrollTop = grid.scrollTop;
        const startRow = Math.max(0, Math.floor(scrollTop / CARD_HEIGHT) - BUFFER_ROWS);
        const endRow = Math.min(totalRows, Math.ceil((scrollTop + grid.offsetHeight) / CARD_HEIGHT) + BUFFER_ROWS);
        const startIdx = startRow * cardsPerRow;
        const endIdx = Math.min(filteredCards.length, endRow * cardsPerRow);

        if (lastStartIdx === startIdx && grid.childElementCount > 0) return;
        lastStartIdx = startIdx;

        // È†êËºâÂúñÁâáÔºàÂèØË¶ãÂçÄÂüüÂâçÂæå 2 Ë°åÔºâ
        for (let i = Math.max(0, startIdx - 2 * cardsPerRow); i < Math.min(filteredCards.length, endIdx + 2 * cardsPerRow); i++) {
          const card = filteredCards[i];
          if (card.image && !card.image.endsWith('.mp4')) preloadImage(card.image);
        }

        // DOM Ê±†ÈáçÁî®
        if (!cardDomPool.length || cardDomPool.length < (endIdx - startIdx)) {
          for (let i = cardDomPool.length; i < (endIdx - startIdx); i++) {
            const div = document.createElement('div');
            cardDomPool.push(div);
          }
        }
        cardDomInUse = [];

        // Áî¢Áîü‰Ωî‰ΩçÈ´òÂ∫¶
        const topSpace = document.createElement('div');
        topSpace.style.height = `${startRow * CARD_HEIGHT}px`;
        const bottomSpace = document.createElement('div');
        bottomSpace.style.height = `${(totalRows - endRow) * CARD_HEIGHT}px`;

        // Ê∏≤ÊüìÂèØË¶ãÂç°Áâá
        for (let i = startIdx, poolIdx = 0; i < endIdx; i++, poolIdx++) {
          const card = filteredCards[i];
          const isUnlocked = LinkageSystem.cards.isCardOwned(card.word);
          const rarityClass = card.rarity === 'ÊôÆÈÄö' ? 'common' : card.rarity === 'Á®ÄÊúâ' ? 'rare' : 'epic';
          const div = cardDomPool[poolIdx];
          div.className = `card ${rarityClass}${isUnlocked ? ' unlocked' : ' locked'}`;
          div.setAttribute('data-word', card.word);
          let imgSrc = card.image;
          // Ë°åÂãïË£ùÁΩÆÂè™È°ØÁ§∫ÂúñÁâáÔºåÊ°åÊ©üÊâçÊîØÊè¥ hover ËºâÂÖ•ÂΩ±Áâá
          let cardContent = `<img class="card-media" src="${imgSrc}" alt="${card.word}" onerror="this.onerror=null;this.src='img/cards/placeholder.jpg'">`;
          if (recentlyObtainedCards.includes(card.word) && isUnlocked) {
            cardContent = `<div class="new-card-badge">NEW!</div>` + cardContent;
          }
          div.innerHTML = cardContent;
          if (isUnlocked) {
            div.onclick = (event) => {
              if (event.target.closest('.video-button')) return;
              openModal(card);
            };
            // Ê°åÊ©üÊâçÊîØÊè¥ hover ËºâÂÖ•ÂΩ±Áâá
            if (!isTouchDevice() && imgSrc && imgSrc.endsWith('.mp4')) {
              div.onmouseenter = function() {
                clearTimeout(debounceTimers[card.word]);
                debounceTimers[card.word] = setTimeout(() => {
                  if (!div.querySelector('video')) {
                    const video = document.createElement('video');
                    video.className = 'card-media';
                    video.preload = 'none';
                    video.muted = true;
                    video.playsInline = true;
                    video.loop = true;
                    video.style.width = '100%';
                    video.style.height = '100%';
                    const source = document.createElement('source');
                    source.src = imgSrc;
                    source.type = 'video/mp4';
                    video.appendChild(source);
                    video.addEventListener('canplay', () => video.play());
                    video.addEventListener('click', (e) => {
                      e.stopPropagation();
                      if (video.paused) video.play();
                      else video.pause();
                    });
                    const img = div.querySelector('img');
                    if (img) img.remove();
                    div.appendChild(video);
                  }
                }, 100);
              };
              div.onmouseleave = function() {
                clearTimeout(debounceTimers[card.word]);
                debounceTimers[card.word] = setTimeout(() => {
                  const video = div.querySelector('video');
                  if (video) video.remove();
                  if (!div.querySelector('img')) {
                    const img = document.createElement('img');
                    img.className = 'card-media';
                    img.src = imgSrc;
                    img.alt = card.word;
                    img.onerror = function() { this.onerror=null; this.src='img/cards/placeholder.jpg'; };
                    div.appendChild(img);
                  }
                }, 100);
              };
            } else {
              div.onmouseenter = null;
              div.onmouseleave = null;
            }
          } else {
            div.style.pointerEvents = 'none';
            div.style.cursor = 'not-allowed';
            const lockOverlay = document.createElement('div');
            lockOverlay.className = 'lock-overlay';
            lockOverlay.innerHTML = `<div class="lock-icon">üîí</div><div class="lock-text">Êú™Ëß£Èéñ</div>`;
            div.appendChild(lockOverlay);
          }
          cardDomInUse.push(div);
        }
        grid.innerHTML = '';
        grid.appendChild(topSpace);
        cardDomInUse.forEach(div => grid.appendChild(div));
        grid.appendChild(bottomSpace);
        document.getElementById("progress").textContent = `Â∑≤Ëß£ÈéñÔºö${Object.keys(ownedCards).length} / ${window.allCards.length}`;
      });
    }

    function setupVirtualScroll() {
      const grid = document.getElementById('cardGrid');
      grid.addEventListener('scroll', () => {
        renderCardsVirtual();
      });
      window.addEventListener('resize', () => {
        lastStartIdx = -1;
        renderCardsVirtual();
      });
    }

    // ====== ÂàÜÈ°ûÂàÜÈ†ÅÂäüËÉΩ ======
    function renderCategoryTabs() {
      if (!Array.isArray(allCards)) return;
      const categories = Array.from(new Set(allCards.map(card => card.category))).filter(Boolean);
      const tabDiv = document.getElementById('categoryTabs');
      tabDiv.innerHTML = '';
      // "ÂÖ®ÈÉ®"ÂàÜÈ†Å
      const allBtn = document.createElement('button');
      allBtn.textContent = 'ÂÖ®ÈÉ®';
      allBtn.className = 'filter-btn active';
      allBtn.onclick = () => filterCardsByCategory('ÂÖ®ÈÉ®');
      tabDiv.appendChild(allBtn);
      // ÂÖ∂‰ªñÂàÜÈ°û
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.textContent = cat;
        btn.className = 'filter-btn';
        btn.onclick = () => filterCardsByCategory(cat);
        tabDiv.appendChild(btn);
      });
    }
    function filterCardsByCategory(category) {
      // ÂàáÊèõÊåâÈàïÈ´ò‰∫Æ
      document.querySelectorAll('#categoryTabs .filter-btn').forEach(btn => {
        if (btn.textContent === category || (category === 'ÂÖ®ÈÉ®' && btn.textContent === 'ÂÖ®ÈÉ®')) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      // ÈÅéÊøæÂç°ÁâáÈ°ØÁ§∫
      const grid = document.getElementById('cardGrid');
      if (!Array.isArray(allCards)) return;
      let showCards = (category === 'ÂÖ®ÈÉ®') ? allCards : allCards.filter(card => card.category === category);
      // ÈÄôË£°Áõ¥Êé•Ë§áÁî®ÁèæÊúâÁöÑÂç°ÁâáÊ∏≤ÊüìÈÇèËºØ
      grid.innerHTML = '';
      showCards.forEach(card => {
        // ‰Ω†ÂèØ‰ª•Ê†πÊìöÁèæÊúâÁöÑÂç°ÁâáÊ∏≤ÊüìÊñπÂºèÁîüÊàêÂç°Áâá
        // ÈÄôË£°Á∞°ÂåñÁÇ∫Âè™È°ØÁ§∫Âç°ÁâáÊ®ôÈ°å
        // ÂØ¶ÈöõÊáâÁî®ÊôÇË´ãË§áÁî®ÂéüÊú¨ÁöÑÂç°Áâá HTML ÁµêÊßã
        // ...
      });
      // ‰Ω†ÂèØ‰ª•Âú®ÈÄôË£°ÂëºÂè´ÂéüÊú¨ÁöÑÂç°ÁâáÊ∏≤ÊüìÂáΩÊï∏ÔºåÊàñÁõ¥Êé•Ë§áË£ΩÂéüÊú¨ÁöÑÊ∏≤ÊüìÈÇèËºØ
    }
    // È†ÅÈù¢ËºâÂÖ•ÊôÇËá™ÂãïÊ∏≤ÊüìÂàÜÈ†Å
    window.addEventListener('load', () => {
      renderCategoryTabs();
      filterCardsByCategory('ÂÖ®ÈÉ®');
    });
  </script>
</body>
</html>
