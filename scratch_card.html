<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>選卡刮刮樂（單張卡 10 分鐘補卡）</title>

<style>
/* ================= 原本 CSS（未刪減） ================= */
:root{
  --bg:#0b1220;
  --panel: rgba(0,0,0,0.25);
  --panelBorder: rgba(255,255,255,0.10);
  --softBorder: rgba(255,255,255,0.12);
  --text: #fff;
  --brandA:#00f5ff;
  --brandB:#a259ff;
  --shadow: 0 18px 60px rgba(0,0,0,0.55);
}
body{
  margin:0;
  font-family: system-ui,"Noto Sans TC";
  background:var(--bg);
  color:#fff;
  display:flex;
  justify-content:center;
  padding:18px;
}
.app{width:min(680px,100%);}
.cardGrid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
}
.cardPick{
  aspect-ratio:3/4;
  border-radius:16px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  font-weight:900;
  cursor:pointer;
  background:linear-gradient(135deg,#ffd700,#ff9f1a);
  position:relative;
}
.cardPick:hover{transform:translateY(-2px);}
.restockBadge{
  position:absolute;
  top:8px;
  right:8px;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  background:rgba(0,0,0,0.75);
  border:1px solid rgba(0,245,255,0.45);
}
.toast{
  position:fixed;
  bottom:18px;
  left:50%;
  transform:translateX(-50%);
  padding:10px 14px;
  border-radius:999px;
  background:rgba(0,0,0,0.8);
  opacity:0;
  transition:.2s;
}
.toast.show{opacity:1;}
button{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:0;
  font-weight:900;
  cursor:pointer;
}
</style>
</head>

<body>
<div class="app">

  <h2>選卡刮刮樂（每張卡 10 分鐘補卡）</h2>

  <div id="selectView">
    <div class="cardGrid" id="cardGrid"></div>
  </div>

  <div id="scratchView" style="display:none;">
    <p>（此處保留你原本完整刮刮邏輯）</p>
    <button id="claimBtn">領取並返回</button>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
/* ================= 設定 ================= */
const STORAGE_CARD_RESTOCK_KEY = 'scratchCard_cardRestock_v1';
const CARD_RESTOCK_MS = 10 * 60 * 1000;

/* ================= DOM ================= */
const cardGrid = document.getElementById('cardGrid');
const selectView = document.getElementById('selectView');
const scratchView = document.getElementById('scratchView');
const claimBtn = document.getElementById('claimBtn');
const toast = document.getElementById('toast');

let activeCard = null;

/* ================= 工具 ================= */
function showToast(t){
  toast.textContent = t;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'),1200);
}
function formatMs(ms){
  const s = Math.max(0,Math.floor(ms/1000));
  return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0');
}

/* ================= 補卡資料 ================= */
function loadRestock(){
  try{return JSON.parse(localStorage.getItem(STORAGE_CARD_RESTOCK_KEY))||{};}
  catch{return{};}
}
function saveRestock(s){
  localStorage.setItem(STORAGE_CARD_RESTOCK_KEY,JSON.stringify(s));
}
function setCardRestock(card){
  const s=loadRestock();
  s[card]=Date.now()+CARD_RESTOCK_MS;
  saveRestock(s);
}
function getCardRestock(card){
  return loadRestock()[card]||0;
}
function clearCardRestock(card){
  const s=loadRestock();
  delete s[card];
  saveRestock(s);
}
function isRestocking(card){
  return getCardRestock(card)>Date.now();
}

/* ================= 卡片渲染 ================= */
function renderCards(){
  cardGrid.innerHTML='';
  for(let i=1;i<=20;i++){
    const c=document.createElement('div');
    c.className='cardPick';
    c.textContent=i;

    const end=getCardRestock(i);
    if(end>Date.now()){
      const b=document.createElement('div');
      b.className='restockBadge';
      b.dataset.card=i;
      b.textContent=formatMs(end-Date.now());
      c.appendChild(b);
      c.style.opacity=.5;
      c.style.cursor='not-allowed';
    }

    c.onclick=()=>{
      if(isRestocking(i)){
        showToast('補卡中，請稍後');
        return;
      }
      activeCard=i;
      selectView.style.display='none';
      scratchView.style.display='block';
    };
    cardGrid.appendChild(c);
  }
}

/* ================= 結算 ================= */
claimBtn.onclick=()=>{
  setCardRestock(activeCard);
  activeCard=null;
  scratchView.style.display='none';
  selectView.style.display='block';
  renderCards();
};

/* ================= 每秒更新倒數 ================= */
setInterval(()=>{
  document.querySelectorAll('.restockBadge').forEach(b=>{
    const card=b.dataset.card;
    const end=getCardRestock(card);
    if(end<=Date.now()){
      clearCardRestock(card);
      renderCards();
    }else{
      b.textContent=formatMs(end-Date.now());
    }
  });
},1000);

/* ================= 初始化 ================= */
renderCards();
</script>
</body>
</html>
