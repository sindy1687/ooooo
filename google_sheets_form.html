<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“¬ ç©å®¶ä¿¡ç®±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .content {
      padding: 30px;
    }

    .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    input {
      flex: 1;
      min-width: 200px;
      padding: 15px 20px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
      padding: 15px 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 120px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    .mail {
      border: 2px solid #e1e5e9;
      padding: 20px;
      margin: 15px 0;
      border-radius: 15px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .mail:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .mail:active {
      transform: translateY(0);
    }

    .mail.clicked {
      animation: clickEffect 0.3s ease;
    }

    @keyframes clickEffect {
      0% { transform: scale(1); }
      50% { transform: scale(0.98); }
      100% { transform: scale(1); }
    }

    .mail::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .unread {
      background: linear-gradient(135deg, #fff9e6 0%, #fff5d6 100%);
      border-color: #ffd700;
      box-shadow: 0 5px 15px rgba(255, 215, 0, 0.2);
    }

    .unread::before {
      background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
    }

    .read {
      background: #f8f9fa;
      border-color: #e1e5e9;
      opacity: 0.8;
    }

    .mail.read::before {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }

    .mail h3 {
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 1.3em;
    }

    .mail p {
      color: #555;
      line-height: 1.6;
      margin-bottom: 15px;
    }

    .mail small {
      color: #888;
      font-size: 0.9em;
    }

    .claim-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      padding: 10px 20px;
      font-size: 14px;
      margin-top: 10px;
    }

    .claim-btn:hover {
      box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
    }

    .empty-message {
      text-align: center;
      padding: 60px 20px;
      color: #888;
      font-size: 1.2em;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      border: 1px solid #f5c6cb;
    }

    .success {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      border: 1px solid #c3e6cb;
    }

    .demo-mode {
      background: #fff3cd;
      color: #856404;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      border: 1px solid #ffeaa7;
    }

    .name-generator {
      margin-bottom: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 15px;
      border: 2px solid #e1e5e9;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .name-generator h3 {
      margin-bottom: 15px;
      color: #2c3e50;
      font-size: 1.3em;
      display: flex;
      align-items: center;
    }

    .name-generator h3::before {
      content: 'ğŸ²';
      margin-right: 10px;
      font-size: 1.2em;
    }

    .name-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .name-btn {
      padding: 8px 15px;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      color: white;
    }

    .name-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .name-btn.chinese {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }

    .name-btn.english {
      background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
    }

    .name-btn.gaming {
      background: linear-gradient(135deg, #a8e6cf 0%, #7fcdcd 100%);
    }

    .name-btn.mixed {
      background: linear-gradient(135deg, #ffd93d 0%, #ff6b6b 100%);
    }

    .generated-names {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
    }

    .name-card {
      background: white;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      color: #2c3e50;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .name-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      border-color: #667eea;
    }

    @media (max-width: 600px) {
      .container {
        margin: 10px;
        border-radius: 15px;
      }
      
      .header {
        padding: 20px;
      }
      
      .header h1 {
        font-size: 2em;
      }
      
      .content {
        padding: 20px;
      }
      
      .input-group {
        flex-direction: column;
      }
      
      input, button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“¬ ç©å®¶ä¿¡ç®±</h1>
      <p>æŸ¥çœ‹æ‚¨çš„éŠæˆ²é€šçŸ¥å’Œçå‹µ</p>
    </div>
    
    <div class="content">
      <div class="input-group">
        <input id="playerName" placeholder="è«‹è¼¸å…¥æ‚¨çš„ç©å®¶åç¨±" type="text">
        <button onclick="loadInbox()">ğŸ“¥ æŸ¥çœ‹ä¿¡ç®±</button>
        <button onclick="generateRandomName()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">ğŸ² éš¨æ©Ÿåç¨±</button>
        <button onclick="addNewPlayer()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">â• æ–°å¢ç©å®¶</button>
      </div>
      
      <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 10px; padding: 15px; margin-bottom: 20px; color: #0c5460;">
        <strong>ğŸ’¡ ä½¿ç”¨æç¤ºï¼š</strong>
        <ul style="margin: 10px 0 0 20px;">
          <li>è¼¸å…¥æ‚¨çš„ç©å®¶åç¨±å¾Œé»æ“Šã€ŒğŸ“¥ æŸ¥çœ‹ä¿¡ç®±ã€å³å¯è‡ªå‹•æ–°å¢åˆ°ç³»çµ±</li>
          <li>ä½¿ç”¨ã€ŒğŸ² éš¨æ©Ÿåç¨±ã€å¯ä»¥å¿«é€Ÿç”Ÿæˆä¸€å€‹éš¨æ©Ÿåç¨±</li>
          <li>ä½¿ç”¨ã€Œâ• æ–°å¢ç©å®¶ã€å¯ä»¥æ‰‹å‹•æ–°å¢ç©å®¶åˆ°ç³»çµ±</li>
          <li>é¦–æ¬¡ä½¿ç”¨æ™‚ç³»çµ±æœƒè‡ªå‹•ç‚ºæ‚¨å»ºç«‹æ­¡è¿è¨Šæ¯</li>
          <li><strong>ğŸ’¡ æ–°åŠŸèƒ½ï¼š</strong>é»æ“Šä»»ä½•è¨Šæ¯å³å¯æ¨™è¨˜ç‚ºå·²è®€</li>
        </ul>
      </div>
      
      <div class="name-generator" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 2px solid #e1e5e9;">
        <h3 style="margin-bottom: 15px; color: #2c3e50;">ğŸ² å¿«é€Ÿåç¨±ç”Ÿæˆå™¨</h3>
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
          <button onclick="generateName('chinese')" style="padding: 8px 15px; font-size: 14px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">ğŸ‡¨ğŸ‡³ ä¸­æ–‡åç¨±</button>
          <button onclick="generateName('english')" style="padding: 8px 15px; font-size: 14px; background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);">ğŸ‡ºğŸ‡¸ è‹±æ–‡åç¨±</button>
          <button onclick="generateName('gaming')" style="padding: 8px 15px; font-size: 14px; background: linear-gradient(135deg, #a8e6cf 0%, #7fcdcd 100%);">ğŸ® éŠæˆ²åç¨±</button>
          <button onclick="generateName('mixed')" style="padding: 8px 15px; font-size: 14px; background: linear-gradient(135deg, #ffd93d 0%, #ff6b6b 100%);">ğŸŒˆ æ··åˆåç¨±</button>
        </div>
        <div id="generatedNames" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;"></div>
      </div>

      <div id="status"></div>
      <div id="mailbox"></div>
    </div>
  </div>

  <script>
    // æª¢æŸ¥æ˜¯å¦ç‚ºæ¸¬è©¦æ¨¡å¼
    const urlParams = new URLSearchParams(window.location.search);
    const isTestMode = urlParams.get('test') === '1';
    
    // æ¸¬è©¦æ¨¡å¼çš„ API URLï¼ˆä½¿ç”¨æ¨¡æ“¬è³‡æ–™ï¼‰
    const TEST_API = "https://script.google.com/macros/s/AKfycbxhXiQ8G7QnT5k3W-nFgAIBqsmCEnV4_wlqOSPwL-cyetKlq6T6CVmjXYkOZ5Y2jzHP/exec";
    
    // å¯¦éš›çš„ API URLï¼ˆæ‚¨çš„æ–°éƒ¨ç½²ï¼‰
    const PROD_API = "https://script.google.com/macros/s/AKfycbxvJg2sgkye1vu_uRk2MhqwT4kl9GC7GneTarpkKSNyrWCaDWHQWpxNRtKA95OU0P_E/exec";
    
    // æ ¹æ“šæ¨¡å¼é¸æ“‡ API
    const API = isTestMode ? TEST_API : PROD_API;

    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.innerHTML = `<div class="${type}">${message}</div>`;
      setTimeout(() => {
        status.innerHTML = '';
      }, 5000);
    }

    function showLoading() {
      const mailbox = document.getElementById('mailbox');
      mailbox.innerHTML = '<div class="loading">â³ è¼‰å…¥ä¸­...</div>';
    }

    function loadInbox() {
      const user = document.getElementById("playerName").value.trim();
      if (!user) {
        showStatus("è«‹è¼¸å…¥ç©å®¶åç¨±", "error");
        return;
      }

      showLoading();

      // å¦‚æœæ˜¯æ¸¬è©¦æ¨¡å¼ï¼Œä½¿ç”¨æ¨¡æ“¬è³‡æ–™
      if (isTestMode) {
        setTimeout(() => {
          const mockData = [
            {
              title: "æ­¡è¿è¨Šæ¯",
              content: "æ­¡è¿ä¾†åˆ°éŠæˆ²ï¼é€™æ˜¯æ‚¨çš„ç¬¬ä¸€å°è¨Šæ¯ã€‚",
              read: "å¦",
              time: "2024-01-01 12:00:00",
              cardId: "TEST_CARD_001",
              index: 1
            },
            {
              title: "ç³»çµ±é€šçŸ¥",
              content: "ç³»çµ±ç¶­è­·é€šçŸ¥ï¼šä»Šæ™šå°‡é€²è¡Œç³»çµ±ç¶­è­·ã€‚",
              read: "æ˜¯",
              time: "2024-01-01 10:00:00",
              index: 2
            },
            {
              title: "çå‹µé€šçŸ¥",
              content: "æ­å–œæ‚¨å®Œæˆä»»å‹™ï¼ç²å¾—çå‹µå¡ç‰‡ä¸€å¼µã€‚",
              read: "å¦",
              time: "2024-01-01 09:30:00",
              cardId: "REWARD_CARD_002",
              index: 3
            }
          ];
          
          displayMessages(mockData);
          showStatus("æ¸¬è©¦æ¨¡å¼ï¼šä½¿ç”¨æ¨¡æ“¬è³‡æ–™", "demo-mode");
        }, 1000);
        return;
      }

      // å¯¦éš›æ¨¡å¼ï¼šä½¿ç”¨ JSONP é¿å… CORS å•é¡Œ
      const script = document.createElement('script');
      const callbackName = 'callback_' + Date.now();
      
      // å»ºç«‹å…¨åŸŸå›èª¿å‡½æ•¸
      window[callbackName] = function(data) {
        // å¦‚æœä¿¡ç®±æ˜¯ç©ºçš„ï¼Œè‡ªå‹•æ–°å¢ç©å®¶
        if (!Array.isArray(data) || data.length === 0) {
          showStatus("ğŸ“ é¦–æ¬¡ä½¿ç”¨ï¼æ­£åœ¨ç‚ºæ‚¨å»ºç«‹ç©å®¶å¸³è™Ÿ...", "info");
          addNewPlayer();
          return;
        }
        
        displayMessages(data);
        // æ¸…ç†å…¨åŸŸå›èª¿å‡½æ•¸
        delete window[callbackName];
        document.head.removeChild(script);
      };
      
      // è¨­å®šéŒ¯èª¤è™•ç†
      script.onerror = function() {
        showStatus("è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
        document.getElementById('mailbox').innerHTML = `
          <div class="error">
            <h3>âŒ è¼‰å…¥å¤±æ•—</h3>
            <p>ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦</p>
          </div>`;
        delete window[callbackName];
        if (document.head.contains(script)) {
          document.head.removeChild(script);
        }
      };
      
      script.src = `${API}?action=getInbox&user=${encodeURIComponent(user)}&callback=${callbackName}`;
      document.head.appendChild(script);
    }

    function displayMessages(data) {
      const mailbox = document.getElementById("mailbox");
      
      if (!Array.isArray(data) || data.length === 0) {
        mailbox.innerHTML = `
          <div class="empty-message">
            <h3>ğŸ“­ ä¿¡ç®±æ˜¯ç©ºçš„</h3>
            <p>ç›®å‰æ²’æœ‰æ–°çš„è¨Šæ¯</p>
          </div>`;
        return;
      }

      // å°è¨Šæ¯é€²è¡Œæ’åºï¼šæœªè®€çš„è¨Šæ¯æ’åœ¨å‰é¢ï¼Œç„¶å¾ŒæŒ‰æ™‚é–“æ’åº
      const sortedData = data.sort((a, b) => {
        // é¦–å…ˆæŒ‰è®€å–ç‹€æ…‹æ’åºï¼šæœªè®€çš„åœ¨å‰
        if (a.read === 'å¦' && b.read === 'æ˜¯') return -1;
        if (a.read === 'æ˜¯' && b.read === 'å¦') return 1;
        
        // å¦‚æœè®€å–ç‹€æ…‹ç›¸åŒï¼ŒæŒ‰æ™‚é–“æ’åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
        const timeA = new Date(a.time || '1970-01-01');
        const timeB = new Date(b.time || '1970-01-01');
        return timeB - timeA;
      });

      mailbox.innerHTML = sortedData.map((msg, index) => `
        <div class="mail ${msg.read === 'æ˜¯' ? 'read' : 'unread'}" 
             onclick="markAsRead(${msg.index || index}, '${msg.cardId || ''}', this)">
          <h3>${msg.title || 'ç³»çµ±é€šçŸ¥'}</h3>
          <p>${msg.content || msg.message || 'ç„¡å…§å®¹'}</p>
          ${msg.cardId && msg.read === "å¦" ? 
            `<button class="claim-btn" onclick="claimReward('${msg.cardId}', ${msg.index || index}, event)">
              ğŸ é ˜å–å¡ç‰‡
            </button>` : ""}
          ${msg.read === "æ˜¯" ? "<small>âœ… å·²è®€</small>" : "<small>ğŸ†• æœªè®€</small>"}
          <br><small>ğŸ•“ ${msg.time || 'æœªçŸ¥æ™‚é–“'}</small>
        </div>
      `).join("");
    }

    function markAsRead(rowIndex, cardId, element) {
      // å¦‚æœå·²ç¶“å·²è®€ï¼Œä¸éœ€è¦é‡è¤‡æ¨™è¨˜
      if (element.classList.contains('read')) {
        return;
      }

      // é˜²æ­¢äº‹ä»¶å†’æ³¡ï¼ˆç•¶é»æ“ŠæŒ‰éˆ•æ™‚ï¼‰
      if (event && event.target.tagName === 'BUTTON') {
        return;
      }

      // åŠ å…¥é»æ“Šå‹•ç•«
      element.classList.add('clicked');
      setTimeout(() => {
        element.classList.remove('clicked');
      }, 300);

      showStatus("æ­£åœ¨æ¨™è¨˜ç‚ºå·²è®€...", "info");

      if (isTestMode) {
        // æ¸¬è©¦æ¨¡å¼ï¼šæ¨¡æ“¬æ¨™è¨˜å·²è®€
        setTimeout(() => {
          element.classList.remove('unread');
          element.classList.add('read');
          element.querySelector('small').innerHTML = "âœ… å·²è®€";
          showStatus("âœ… å·²æ¨™è¨˜ç‚ºå·²è®€", "success");
        }, 500);
        return;
      }

      // å¯¦éš›æ¨¡å¼ï¼šä½¿ç”¨ JSONP
      const script = document.createElement('script');
      const callbackName = 'markReadCallback_' + Date.now();
      
      window[callbackName] = function(data) {
        if (data.success) {
          // æ›´æ–° UI
          element.classList.remove('unread');
          element.classList.add('read');
          element.querySelector('small').innerHTML = "âœ… å·²è®€";
          showStatus("âœ… å·²æ¨™è¨˜ç‚ºå·²è®€", "success");
        } else {
          showStatus("æ¨™è¨˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
        }
        delete window[callbackName];
        document.head.removeChild(script);
      };
      
      script.onerror = function() {
        showStatus("æ¨™è¨˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
        delete window[callbackName];
        if (document.head.contains(script)) {
          document.head.removeChild(script);
        }
      };
      
      script.src = `${API}?action=markAsRead&index=${rowIndex}&callback=${callbackName}`;
      document.head.appendChild(script);
    }

    function claimReward(cardId, rowIndex, event) {
      // é˜²æ­¢äº‹ä»¶å†’æ³¡
      if (event) {
        event.stopPropagation();
      }

      showStatus("æ­£åœ¨é ˜å–çå‹µ...", "info");
      
      if (isTestMode) {
        // æ¸¬è©¦æ¨¡å¼ï¼šæ¨¡æ“¬é ˜å–
        setTimeout(() => {
          showStatus(`ğŸ´ æˆåŠŸé ˜å–å¡ç‰‡ï¼š${cardId}ï¼`, "success");
          setTimeout(() => {
            loadInbox();
          }, 2000);
        }, 1000);
        return;
      }
      
      // å¯¦éš›æ¨¡å¼ï¼šä½¿ç”¨ JSONP
      const script = document.createElement('script');
      const callbackName = 'claimCallback_' + Date.now();
      
      window[callbackName] = function(data) {
        if (data.success) {
          showStatus(`ğŸ´ æˆåŠŸé ˜å–å¡ç‰‡ï¼š${cardId}ï¼`, "success");
          setTimeout(() => {
            loadInbox();
          }, 2000);
        } else {
          showStatus("é ˜å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
        }
        delete window[callbackName];
        document.head.removeChild(script);
      };
      
      script.onerror = function() {
        showStatus("é ˜å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
        delete window[callbackName];
        if (document.head.contains(script)) {
          document.head.removeChild(script);
        }
      };
      
      script.src = `${API}?action=markAsRead&index=${rowIndex}&callback=${callbackName}`;
      document.head.appendChild(script);
    }

    // åç¨±ç”Ÿæˆå™¨è³‡æ–™
    const chineseNames = [
      'å°æ˜', 'å°è¯', 'å°ç¾', 'å°å¼·', 'å°èŠ³', 'å°å‰', 'å°ç²', 'å°å‚‘', 'å°å©·', 'å°è±ª',
      'å°é›…', 'å°å®‡', 'å°æ…§', 'å°å‡±', 'å°æ½”', 'å°æ–‡', 'å°å›', 'å°å¿—', 'å°éº—', 'å°å³°',
      'å°è', 'å°å»º', 'å°ç‡•', 'å°è¼', 'å°èŠ¬', 'å°é¾', 'å°æ¢…', 'å°è»', 'å°è˜­', 'å°æ–Œ',
      'å°ç´…', 'å°å‰›', 'å°è‹±', 'å°å‰', 'å°è¯', 'å°éº—', 'å°å¼·', 'å°ç¾', 'å°å‚‘', 'å°èŠ³'
    ];

    const englishNames = [
      'Alex', 'Emma', 'John', 'Sarah', 'Mike', 'Lisa', 'David', 'Anna', 'Tom', 'Mary',
      'Chris', 'Kate', 'Ryan', 'Emma', 'Jack', 'Sophie', 'Nick', 'Grace', 'Sam', 'Lucy',
      'Dan', 'Mia', 'Ben', 'Eva', 'Tim', 'Zoe', 'Rob', 'Lily', 'Matt', 'Rose',
      'Joe', 'Nina', 'Mark', 'Ella', 'Paul', 'Maya', 'Tony', 'Ruby', 'Steve', 'Diana'
    ];

    const gamingNames = [
      'DragonSlayer', 'ShadowHunter', 'FireMage', 'IceQueen', 'ThunderLord', 'MoonWalker',
      'StarGazer', 'NightRider', 'SunWarrior', 'StormBreaker', 'LightBringer', 'DarkKnight',
      'CrystalMage', 'IronFist', 'SwiftWind', 'GoldenEagle', 'SilverWolf', 'BronzeTiger',
      'EmeraldDragon', 'RubyPhoenix', 'SapphireKnight', 'DiamondQueen', 'PlatinumKing',
      'CosmicRider', 'GalaxyHunter', 'NebulaWalker', 'VoidMaster', 'EchoStriker'
    ];

    function generatePlayerName(type) {
      switch(type) {
        case 'chinese':
          return chineseNames[Math.floor(Math.random() * chineseNames.length)];
        case 'english':
          return englishNames[Math.floor(Math.random() * englishNames.length)];
        case 'gaming':
          return gamingNames[Math.floor(Math.random() * gamingNames.length)];
        case 'mixed':
          const isChinese = Math.random() > 0.5;
          return isChinese ? 
            chineseNames[Math.floor(Math.random() * chineseNames.length)] :
            englishNames[Math.floor(Math.random() * englishNames.length)];
        default:
          return chineseNames[Math.floor(Math.random() * chineseNames.length)];
      }
    }

    function generateName(type) {
      const names = [];
      for (let i = 0; i < 6; i++) {
        names.push(generatePlayerName(type));
      }
      
      const generatedNamesDiv = document.getElementById('generatedNames');
      generatedNamesDiv.innerHTML = names.map(name => `
        <div style="
          background: white; 
          border: 2px solid #e1e5e9; 
          border-radius: 8px; 
          padding: 10px; 
          text-align: center; 
          cursor: pointer;
          transition: all 0.3s ease;
          font-weight: bold;
          color: #2c3e50;
        " 
        onclick="selectName('${name}')"
        onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'"
        onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
          ${name}
        </div>
      `).join('');
      
      showStatus(`å·²ç”Ÿæˆ ${names.length} å€‹${getTypeDisplayName(type)}åç¨±`, "success");
    }

    function getTypeDisplayName(type) {
      switch(type) {
        case 'chinese': return 'ä¸­æ–‡';
        case 'english': return 'è‹±æ–‡';
        case 'gaming': return 'éŠæˆ²';
        case 'mixed': return 'æ··åˆ';
        default: return 'éš¨æ©Ÿ';
      }
    }

    function selectName(name) {
      document.getElementById('playerName').value = name;
      showStatus(`å·²é¸æ“‡åç¨±ï¼š${name}ï¼Œæ­£åœ¨æ–°å¢åˆ°ç³»çµ±...`, "success");
      
      // è‡ªå‹•æ–°å¢ç©å®¶ä¸¦è¼‰å…¥ä¿¡ç®±
      setTimeout(() => {
        addNewPlayer();
      }, 1000);
    }

    function generateRandomName() {
      const types = ['chinese', 'english', 'gaming', 'mixed'];
      const randomType = types[Math.floor(Math.random() * types.length)];
      const name = generatePlayerName(randomType);
      
      document.getElementById('playerName').value = name;
      showStatus(`å·²ç”Ÿæˆéš¨æ©Ÿåç¨±ï¼š${name}ï¼Œæ­£åœ¨æ–°å¢åˆ°ç³»çµ±...`, "success");
      
      // è‡ªå‹•æ–°å¢ç©å®¶
      setTimeout(() => {
        addNewPlayer();
      }, 1000);
    }

    function addNewPlayer() {
      const playerName = document.getElementById('playerName').value.trim();
      
      if (!playerName) {
        showStatus("è«‹å…ˆè¼¸å…¥ç©å®¶åç¨±", "error");
        return;
      }

      showStatus("æ­£åœ¨æ–°å¢ç©å®¶åˆ°ç³»çµ±...", "info");

      if (isTestMode) {
        // æ¸¬è©¦æ¨¡å¼ï¼šæ¨¡æ“¬æ–°å¢
        setTimeout(() => {
          showStatus(`âœ… æ¸¬è©¦æ¨¡å¼ï¼šç©å®¶ ${playerName} å·²æ–°å¢åˆ°ç³»çµ±`, "success");
          setTimeout(() => {
            loadInbox();
          }, 2000);
        }, 1000);
        return;
      }

      // å¯¦éš›æ¨¡å¼ï¼šä½¿ç”¨ JSONP æ–°å¢ç©å®¶
      const script = document.createElement('script');
      const callbackName = 'addPlayerCallback_' + Date.now();
      
      window[callbackName] = function(data) {
        if (data.success) {
          showStatus(`âœ… ç©å®¶ ${playerName} å·²æˆåŠŸæ–°å¢åˆ°ç³»çµ±ï¼`, "success");
          setTimeout(() => {
            loadInbox();
          }, 2000);
        } else {
          showStatus(`âŒ æ–°å¢å¤±æ•—ï¼š${data.error || 'æœªçŸ¥éŒ¯èª¤'}`, "error");
        }
        delete window[callbackName];
        document.head.removeChild(script);
      };
      
      script.onerror = function() {
        showStatus("æ–°å¢ç©å®¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
        delete window[callbackName];
        if (document.head.contains(script)) {
          document.head.removeChild(script);
        }
      };
      
      // ç™¼é€æ­¡è¿è¨Šæ¯ä¾†æ–°å¢ç©å®¶
      script.src = `${API}?action=sendMessage&to=${encodeURIComponent(playerName)}&title=æ­¡è¿ä¾†åˆ°éŠæˆ²ï¼&content=è¦ªæ„›çš„ ${playerName}ï¼Œæ­¡è¿ä¾†åˆ°æˆ‘å€‘çš„éŠæˆ²ä¸–ç•Œï¼é€™è£¡æ˜¯æ‚¨çš„å€‹äººä¿¡ç®±ï¼Œæ‚¨å¯ä»¥åœ¨é€™è£¡æ”¶åˆ°ç³»çµ±é€šçŸ¥ã€ä»»å‹™çå‹µã€æ´»å‹•è¨Šæ¯å’Œå¡ç‰‡çå‹µã€‚ç¥æ‚¨éŠæˆ²æ„‰å¿«ï¼&cardId=WELCOME_CARD_001&callback=${callbackName}`;
      document.head.appendChild(script);
    }

    // æŒ‰ Enter éµè¼‰å…¥ä¿¡ç®±
    document.getElementById('playerName').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        loadInbox();
      }
    });

    // é é¢è¼‰å…¥æ™‚çš„æ­¡è¿è¨Šæ¯
    window.addEventListener('load', function() {
      if (isTestMode) {
        showStatus("æ¸¬è©¦æ¨¡å¼å·²å•Ÿç”¨ï¼Œä½¿ç”¨æ¨¡æ“¬è³‡æ–™", "demo-mode");
      } else {
        showStatus("æ­¡è¿ä½¿ç”¨ç©å®¶ä¿¡ç®±ï¼è«‹è¼¸å…¥æ‚¨çš„ç©å®¶åç¨±æˆ–ä½¿ç”¨åç¨±ç”Ÿæˆå™¨", "success");
      }
      
      // è‡ªå‹•ç”Ÿæˆä¸€äº›åç¨±ä¾›é¸æ“‡
      generateName('chinese');
    });
  </script>
</body>
</html>
