<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å¡«ç©ºæŒ‘æˆ° - è‹±æ‰“å°è‹±é›„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="responsive_enhanced.css">
  <style>
    /* ===== åŸºç¤æ¨£å¼ ===== */
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif, 'Orbitron', sans-serif;
      background: linear-gradient(135deg, #232526 0%, #414345 100%);
      color: #fff;
      text-align: center;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    h1 {
      color: #ffd700;
      text-shadow: 0 0 8px #ffd700;
      margin-bottom: 20px;
      letter-spacing: 2px;
      font-family: 'Orbitron', Arial, sans-serif;
      font-size: 2.2rem;
    }

    /* ===== èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶æŒ‰éˆ•æ¨£å¼ ===== */
    #bgMusicControl {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(255, 215, 0, 0.9);
      color: #000;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 12;
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.4);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #bgMusicControl:hover {
      background: rgba(255, 215, 0, 1);
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
    }

    #bgMusicControl.paused {
      background: rgba(255, 255, 255, 0.3);
      color: #fff;
    }

    #bgMusicControl.paused:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* ===== æŒ‰éˆ•æ¨£å¼ ===== */
    .top-btns {
      position: fixed;
      top: 20px;
      right: 20px;
      left: auto;
      display: flex;
      gap: 8px;
      z-index: 11;
    }

    .top-btns button {
      padding: 6px 12px;
      font-size: 1rem;
      background: #ffd700;
      color: #000;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 0 6px rgba(255, 215, 0, 0.2);
      font-family: 'Orbitron', Arial, sans-serif;
      transition: background 0.2s;
    }

    .top-btns button:hover {
      background: #ffe54f;
    }

    button {
      font-size: 1rem;
      padding: 10px 26px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 2px 8px #0003;
      font-family: 'Orbitron', Arial, sans-serif;
    }

    #submit-btn {
      background: #ffd700;
      color: #111;
    }

    #submit-btn:disabled {
      background: #ccc;
      color: #888;
      cursor: not-allowed;
    }

    #skip-btn {
      background: #bbb;
      color: #222;
    }

    #skip-btn:hover {
      background: #ccc;
    }

    #speak-btn {
      background: #0ff;
      color: #111;
      margin-top: 10px;
    }

    #speak-btn:disabled {
      background: #555;
      color: #888;
    }

    #speak-btn:hover {
      background: #7ff;
    }

    #next-btn {
      background: #4caf50;
      color: #fff;
      margin-top: 10px;
    }

    #next-btn:hover {
      background: #6fdc7f;
    }

    /* ===== é¡¯ç¤ºå€å¡Šæ¨£å¼ ===== */
    #star-counter {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 18px;
      background: rgba(30, 30, 40, 0.92);
      border-radius: 18px;
      box-shadow: 0 4px 18px 0 rgba(31, 38, 135, 0.18);
      padding: 14px 32px;
      margin-bottom: 18px;
      border: 1.5px solid #ffd70044;
      font-size: 1.18rem;
      color: #ffd700;
      min-width: 260px;
      font-family: 'Orbitron', Arial, sans-serif;
    }

    #starsDisplay {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(10, 20, 40, 0.85);
      padding: 8px 14px;
      border-radius: 10px;
      color: #ffd700;
      font-weight: bold;
      box-shadow: 0 0 12px #ffd700, 0 0 32px #00ffff;
      border: 2px solid #00ffff;
      font-size: 1.2rem;
      z-index: 10;
    }

    #timer {
      font-size: 1.1rem;
      margin-bottom: 16px;
    }

    #timer.hidden {
      display: none;
    }

    /* ===== å•é¡Œå®¹å™¨æ¨£å¼ ===== */
    #question-container {
      background: rgba(30, 30, 40, 0.97);
      border-radius: 22px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      padding: 38px 30px 30px;
      max-width: 440px;
      width: 100%;
      margin: auto;
      border: 1.5px solid #ffd70044;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 18px;
    }

    .question-title {
      font-size: 1.1rem;
      margin-bottom: 8px;
      letter-spacing: 1px;
    }

    .question-sentence {
      font-size: 1.7rem;
      font-weight: bold;
      margin: 10px 0 20px 0;
      line-height: 1.5;
      word-break: break-word;
    }

    .question-sentence .blank {
      color: #0ff;
      background: #fff2;
      border-radius: 8px;
      padding: 2px 16px;
      box-shadow: 0 1px 4px #0ff2;
    }

    .question-zh {
      color: #ffd700;
      margin-bottom: 16px;
      font-size: 1.08rem;
    }

    /* ===== è¼¸å…¥æ¡†æ¨£å¼ ===== */
    input {
      width: 92%;
      padding: 15px;
      font-size: 1.15rem;
      border: 2px solid #ffd700;
      border-radius: 14px;
      background: #222;
      color: #fff;
      margin-bottom: 22px;
      box-shadow: 0 2px 8px #0003;
      outline: none;
      transition: border 0.2s;
    }

    input:focus {
      border-color: #0ff;
    }

    /* ===== æŒ‰éˆ•åˆ—æ¨£å¼ ===== */
    .btn-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 14px;
      width: 100%;
    }

    /* ===== åé¥‹æ¨£å¼ ===== */
    #feedback {
      margin-top: 12px;
      font-size: 1.13rem;
      min-height: 28px;
    }

    .feedback-box {
      display: inline-block;
      padding: 10px 22px;
      border-radius: 16px;
      font-size: 1.18rem;
      font-weight: bold;
      box-shadow: 0 2px 16px #0004;
      margin-top: 8px;
      transition: background 0.3s, color 0.3s, transform 0.2s;
      animation: popfade 0.7s cubic-bezier(.68, -0.55, .27, 1.55);
    }

    .feedback-correct {
      background: linear-gradient(90deg, #2ecc40, #bfff00);
      color: #222;
    }

    .feedback-wrong {
      background: linear-gradient(90deg, #ff4f4f, #ffbaba);
      color: #fff;
    }

    .feedback-bonus {
      color: #ffd700;
      animation: bonusflash 1s infinite alternate;
      font-size: 1.25em;
    }

    /* ===== å‹•ç•«æ•ˆæœ ===== */
    .complete-anim {
      animation: pop 0.7s cubic-bezier(.68, -0.55, .27, 1.55) both;
    }

    @keyframes pop {
      0% { transform: scale(0.7); opacity: 0; }
      60% { transform: scale(1.15); opacity: 1; }
      100% { transform: scale(1); }
    }

    @keyframes popfade {
      0% { transform: scale(0.7); opacity: 0; }
      60% { transform: scale(1.15); opacity: 1; }
      100% { transform: scale(1); }
    }

    @keyframes bonusflash {
      0% { text-shadow: 0 0 8px #ffd700; }
      100% { text-shadow: 0 0 24px #fff700; }
    }

    /* ===== éŸ¿æ‡‰å¼è¨­è¨ˆå„ªåŒ– ===== */
    @media (max-width: 768px) {
      .top-btns { position: fixed; top: 10px; right: 10px; left: auto; display: flex; gap: 6px; z-index: 11; flex-wrap: wrap; justify-content: flex-end; }
      .top-btns button { padding: 4px 8px; font-size: 0.9rem; }
      #starsDisplay { top: 10px; left: 10px; padding: 6px 10px; font-size: 1rem; }
      h1 { font-size: 1.8rem; margin-top: 60px; }
      #question-container { max-width: 95vw; padding: 20px 15px; margin: 10px auto; }
      .question-sentence { font-size: 1.3rem; }
      .modal-content { padding: 20px; margin: 10px; max-width: 95vw; }
      .end-buttons { flex-direction: column; gap: 10px; }
      .end-buttons button { width: 100%; padding: 10px; }
    }

    @media (max-width: 480px) {
      body { padding: 10px; }
      .top-btns { position: relative; top: auto; right: auto; left: auto; justify-content: center; margin-bottom: 15px; }
      #starsDisplay { position: relative; top: auto; left: auto; display: inline-block; margin-bottom: 10px; }
      h1 { font-size: 1.5rem; margin-top: 10px; }
      #sessionStarsDisplay { font-size: 1rem; margin-bottom: 8px; }
      #star-counter { font-size: 1rem; padding: 10px 20px; min-width: 200px; }
      .question-sentence { font-size: 1.1rem; }
      input { font-size: 1rem; padding: 12px; }
      .btn-row { flex-direction: column; gap: 10px; }
      .btn-row button { width: 100%; padding: 12px; }
    }

    /* ===== éŠæˆ²çµæŸç•«é¢æ¨£å¼ ===== */
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex; justify-content: center; align-items: center;
      z-index: 1000; backdrop-filter: blur(4px);
    }

    .modal-content {
      background: rgba(30, 30, 40, 0.95);
      border: 2px solid #ffd700; border-radius: 20px; padding: 40px;
      text-align: center; max-width: 500px; width: 90%;
      box-shadow: 0 0 32px #ffd70044, 0 0 80px #00ffff22 inset;
      animation: modalPop 0.5s cubic-bezier(.68, -0.55, .27, 1.55);
    }

    .end-icon { font-size: 4rem; margin-bottom: 20px; animation: tada 1.2s infinite; }

    .modal-content h2 {
      color: #ffd700; font-size: 2rem; margin-bottom: 25px;
      text-shadow: 0 0 12px #ffd700; font-family: 'Orbitron', Arial, sans-serif;
    }

    .end-stats { margin-bottom: 30px; }
    .end-stats p { font-size: 1.2rem; margin: 10px 0; color: #fff; }
    .end-stats span { color: #ffd700; font-weight: bold; }

    .end-buttons { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
    .end-buttons button {
      background: linear-gradient(90deg, #ffd700, #ffed4e); color: #000;
      border: none; border-radius: 12px; padding: 12px 24px; font-size: 1.1rem; font-weight: bold;
      cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; font-family: 'Orbitron', Arial, sans-serif;
    }
    .end-buttons button:hover { transform: scale(1.05); box-shadow: 0 0 16px #ffd700; }

    @keyframes modalPop {
      0% { transform: scale(0.7); opacity: 0; }
      60% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); }
    }

    @keyframes tada {
      0% { transform: scale(1); }
      10%, 20% { transform: scale(0.9) rotate(-3deg); }
      30%, 50%, 70%, 90% { transform: scale(1.1) rotate(3deg); }
      40%, 60%, 80% { transform: scale(1.1) rotate(-3deg); }
      100% { transform: scale(1) rotate(0); }
    }
  </style>
</head>
<body>
  <!-- èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶æŒ‰éˆ• -->
  <button id="bgMusicControl" onclick="toggleBackgroundMusic()" title="èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶">ğŸµ</button>

  <!-- æ˜Ÿæ˜Ÿæ•¸é¡¯ç¤ºå€å¡Š -->
  <div id="starsDisplay">
    â­<span id="totalStarsCount">0</span>
  </div>

  <!-- é ‚éƒ¨æŒ‰éˆ• -->
  <div class="top-btns">
    <button onclick="location.href='atlas.html?tab=greek'" aria-label="å›é¦–é ">ğŸ  å›é¦–é </button>
    <button onclick="resetProgress()" aria-label="é‡æ–°é–‹å§‹">ğŸ”„ é‡æ–°é–‹å§‹</button>
    <button onclick="showReviewModal()" aria-label="è¤‡ç¿’å–®å­—">ğŸ“š è¤‡ç¿’å–®å­—</button>
  </div>

  <h1> nike - å¡«ç©ºæŒ‘æˆ°</h1>

  <!-- æœ¬æ¬¡æ˜Ÿæ˜Ÿé¡¯ç¤º -->
  <div id="sessionStarsDisplay" style="margin-bottom:10px;color:#ffd700;font-weight:bold;font-size:1.08rem;">
    æœ¬æ¬¡å·²ç²å¾— 0 é¡†æ˜Ÿæ˜Ÿ
  </div>

  <!-- é€²åº¦é¡¯ç¤º -->
  <div id="star-counter">
    ç¬¬ <span id="current-index">0</span> / <span id="total-questions">0</span> é¡Œ
  </div>

  <!-- è¨ˆæ™‚å™¨ -->
  <div id="timer" class="hidden">
    â³ å€’æ•¸ï¼š<span id="time-left">0</span> ç§’
  </div>

  <!-- å•é¡Œå®¹å™¨ -->
  <div id="question-container"></div>

  <!-- éŠæˆ²çµæŸç•«é¢ -->
  <div id="gameEndModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="end-icon">ğŸ‰</div>
      <h2>éŠæˆ²å®Œæˆï¼</h2>
      <div class="end-stats">
        <p>â­ æœ¬æ¬¡ç²å¾—æ˜Ÿæ˜Ÿï¼š<span id="endSessionStars">0</span></p>
        <p>âœ… ç­”å°é¡Œæ•¸ï¼š<span id="endCorrectCount">0</span></p>
        <p>âŒ ç­”éŒ¯é¡Œæ•¸ï¼š<span id="endWrongCount">0</span></p>
        <p>â­ ç´¯ç©ç¸½æ˜Ÿæ˜Ÿï¼š<span id="endTotalStars">0</span></p>
      </div>
      <div class="end-buttons">
        <button onclick="restartGame()">ğŸ”„ é‡æ–°é–‹å§‹</button>
        <button onclick="location.href='atlas.html?tab=greek'">ğŸ  è¿”å›é¦–é </button>
      </div>
    </div>
  </div>

  <!-- è¤‡ç¿’å–®å­—å½ˆçª— -->
  <div id="reviewModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="end-icon">ğŸ“š</div>
      <h2>å–®å­—è¤‡ç¿’</h2>

      <!-- åˆ†é¡é¸æ“‡å™¨ -->
      <div style="margin-bottom: 20px;">
        <label for="categoryFilter" style="color: #ffd700; font-weight: bold; margin-right: 10px;">é¸æ“‡åˆ†é¡ï¼š</label>
        <select id="categoryFilter" style="
          background: #222; color: #fff; border: 2px solid #ffd700; border-radius: 8px;
          padding: 8px 12px; font-size: 1rem; cursor: pointer;
        ">
          <option value="all">å…¨éƒ¨å–®å­—</option>
          <option value="å‹•ä½œå‹•è©">å‹•ä½œå‹•è©</option>
          <option value="å­¸è¡“æ•™è‚²">å­¸è¡“æ•™è‚²</option>
          <option value="æ™‚é–“æ—¥æœŸ">æ™‚é–“æ—¥æœŸ</option>
          <option value="ç¯€æ—¥æ…¶ç¥">ç¯€æ—¥æ…¶ç¥</option>
          <option value="æ•¸é‡åˆ†æ•¸">æ•¸é‡åˆ†æ•¸</option>
          <option value="è²éŸ³è¡¨æ¼”">è²éŸ³è¡¨æ¼”</option>
          <option value="ç¨±è¬‚äººéš›">ç¨±è¬‚äººéš›</option>
          <option value="äº¤é€šå·¥å…·">äº¤é€šå·¥å…·</option>
          <option value="é‹å‹•å¨›æ¨‚">é‹å‹•å¨›æ¨‚</option>
          <option value="èº«é«”å¥åº·">èº«é«”å¥åº·</option>
          <option value="å½¢å®¹è©">å½¢å®¹è©</option>
          <option value="æŠ½è±¡æ¦‚å¿µ">æŠ½è±¡æ¦‚å¿µ</option>
          <option value="å ´æ‰€ä½ç½®">å ´æ‰€ä½ç½®</option>
        </select>
      </div>

      <!-- çµ±è¨ˆè³‡è¨Š -->
      <div id="vocabStats" style="
        background: rgba(255, 215, 0, 0.1); border: 1px solid #ffd700; border-radius: 8px;
        padding: 10px; margin-bottom: 15px; color: #ffd700; font-size: 0.9rem;
      ">
        ç¸½å…± <span id="totalVocabCount">0</span> å€‹å–®å­—
        <button onclick="showVocabStats()" style="
          background: #0ff; color: #000; border: none; border-radius: 6px; padding: 4px 8px;
          font-size: 0.8rem; margin-left: 10px; cursor: pointer;
        ">ğŸ“Š è©³ç´°çµ±è¨ˆ</button>
        <button onclick="exportVocabData()" style="
          background: #4caf50; color: #fff; border: none; border-radius: 6px; padding: 4px 8px;
          font-size: 0.8rem; margin-left: 5px; cursor: pointer;
        ">ğŸ“¥ åŒ¯å‡ºå­—åº«</button>
      </div>

      <div id="reviewWordsContainer" style="max-height: 400px; overflow-y: auto; margin: 20px 0;">
        <!-- å–®å­—åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
      </div>
      <div class="end-buttons">
        <button onclick="closeReviewModal()">é—œé–‰</button>
      </div>
    </div>
  </div>

  <audio id="backgroundMusic" loop autoplay>
    <source src="sound/åˆå¾Œæ”¾é¬†æ™‚å…‰ï¼ˆç´”éŸ³æ¨‚ï¼‰.mp3" type="audio/mpeg">
  </audio>

  <script src="js/gameDialogue.js"></script>
  <script>
    // ===== éŠæˆ²é…ç½® =====
    const GAME_CONFIG = { QUESTIONS_COUNT: 20, TIME_LIMIT: 30, MAX_ATTEMPTS: 3 };

    // ===== é¡Œåº«è³‡æ–™ (P169 + åˆ†é¡) =====
   // ===== é¡Œåº«è³‡æ–™ (å·²æ›´æ–°ç‚ºæ–°çš„å–®å­—åˆ—è¡¨ P193 ä¸¦å¢åŠ åˆ†é¡) =====
const VOCAB_DATA = [
Â  Â  {
Â  Â  Â  Â  "word": "airport",
Â  Â  Â  Â  "zh": "æ©Ÿå ´",
Â  Â  Â  Â  "en_sentence": "We arrived at the airport two hours before the flight.",
Â  Â  Â  Â  "zh_sentence": "æˆ‘å€‘åœ¨é£›æ©Ÿèµ·é£›å‰å…©å°æ™‚åˆ°é”æ©Ÿå ´ã€‚",
Â  Â  Â  Â  "category": "åœ°é»/äº¤é€š"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "postcard",
Â  Â  Â  Â  "zh": "æ˜ä¿¡ç‰‡",
Â  Â  Â  Â  "en_sentence": "I sent a postcard to my friend from Paris.",
Â  Â  Â  Â  "zh_sentence": "æˆ‘å¾å·´é»å¯„äº†ä¸€å¼µæ˜ä¿¡ç‰‡çµ¦æˆ‘çš„æœ‹å‹ã€‚",
Â  Â  Â  Â  "category": "ç‰©å“/åè©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "stair",
Â  Â  Â  Â  "zh": "æ¨“æ¢¯ï¼›è‡ºéš (é€šå¸¸ç”¨è¤‡æ•¸ stairs)",
Â  Â  Â  Â  "en_sentence": "Be careful when climbing the stair.",
Â  Â  Â  Â  "zh_sentence": "çˆ¬æ¨“æ¢¯æ™‚è¦å°å¿ƒã€‚",
Â  Â  Â  Â  "category": "å»ºç¯‰/åè©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "hard-working",
Â  Â  Â  Â  "zh": "å‹¤å¥®çš„ï¼›åŠªåŠ›å·¥ä½œçš„",
Â  Â  Â  Â  "en_sentence": "She is a hard-working student who always gets good grades.",
Â  Â  Â  Â  "zh_sentence": "å¥¹æ˜¯å€‹å‹¤å¥®çš„å­¸ç”Ÿï¼Œç¸½æ˜¯æ‹¿åˆ°å¥½æˆç¸¾ã€‚",
Â  Â  Â  Â  "category": "å½¢å®¹è©/ç‰¹è³ª"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "clap",
Â  Â  Â  Â  "zh": "æ‹æ‰‹ï¼›é¼“æŒ",
Â  Â  Â  Â  "en_sentence": "The audience began to clap loudly after the show.",
Â  Â  Â  Â  "zh_sentence": "è¡¨æ¼”çµæŸå¾Œï¼Œè§€çœ¾é–‹å§‹å¤§è²é¼“æŒã€‚",
Â  Â  Â  Â  "category": "å‹•è©/å‹•ä½œ"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "serious",
Â  Â  Â  Â  "zh": "åš´è‚…çš„ï¼›åš´é‡çš„",
Â  Â  Â  Â  "en_sentence": "This is a serious problem that needs immediate attention.",
Â  Â  Â  Â  "zh_sentence": "é€™æ˜¯ä¸€å€‹éœ€è¦ç«‹å³é—œæ³¨çš„åš´é‡å•é¡Œã€‚",
Â  Â  Â  Â  "category": "å½¢å®¹è©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "simple",
Â  Â  Â  Â  "zh": "ç°¡å–®çš„",
Â  Â  Â  Â  "en_sentence": "The answer to the question is quite simple.",
Â  Â  Â  Â  "zh_sentence": "é€™å€‹å•é¡Œçš„ç­”æ¡ˆç›¸ç•¶ç°¡å–®ã€‚",
Â  Â  Â  Â  "category": "å½¢å®¹è©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "cross",
Â  Â  Â  Â  "zh": "ç©¿è¶Šï¼›åå­—æ¶",
Â  Â  Â  Â  "en_sentence": "Be careful when you cross the road.",
Â  Â  Â  Â  "zh_sentence": "éé¦¬è·¯æ™‚è¦å°å¿ƒã€‚",
Â  Â  Â  Â  "category": "å‹•è©/åè©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "enter",
Â  Â  Â  Â  "zh": "é€²å…¥",
Â  Â  Â  Â  "en_sentence": "Please do not enter the room without permission.",
Â  Â  Â  Â  "zh_sentence": "æœªç¶“è¨±å¯è«‹å‹¿é€²å…¥æˆ¿é–“ã€‚",
Â  Â  Â  Â  "category": "å‹•è©/å‹•ä½œ"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "appear",
Â  Â  Â  Â  "zh": "å‡ºç¾",
Â  Â  Â  Â  "en_sentence": "The singer will appear on stage soon.",
Â  Â  Â  Â  "zh_sentence": "é€™ä½æ­Œæ‰‹å¾ˆå¿«å°±æœƒå‡ºç¾åœ¨èˆå°ä¸Šã€‚",
Â  Â  Â  Â  "category": "å‹•è©/å‹•ä½œ"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "space",
Â  Â  Â  Â  "zh": "ç©ºé–“ï¼›å¤ªç©º",
Â  Â  Â  Â  "en_sentence": "There is enough space for everyone to sit down.",
Â  Â  Â  Â  "zh_sentence": "æœ‰è¶³å¤ çš„ç©ºé–“è®“æ¯å€‹äººåä¸‹ã€‚",
Â  Â  Â  Â  "category": "åè©/åœ°é»"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "lie",
Â  Â  Â  Â  "zh": "èººï¼›èªªè¬Š",
Â  Â  Â  Â  "en_sentence": "I like to lie on the beach and read a book.",
Â  Â  Â  Â  "zh_sentence": "æˆ‘å–œæ­¡èººåœ¨æ²™ç˜ä¸Šçœ‹æ›¸ã€‚",
Â  Â  Â  Â  "category": "å‹•è©/å‹•ä½œ"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "shine",
Â  Â  Â  Â  "zh": "ç…§è€€ï¼›ç™¼å…‰",
Â  Â  Â  Â  "en_sentence": "The stars shine brightly in the night sky.",
Â  Â  Â  Â  "zh_sentence": "æ˜Ÿæ˜Ÿåœ¨å¤œç©ºä¸­æ˜äº®åœ°ç…§è€€ã€‚",
Â  Â  Â  Â  "category": "å‹•è©/ç‹€æ…‹"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "pray",
Â  Â  Â  Â  "zh": "ç¥ˆç¦±",
Â  Â  Â  Â  "en_sentence": "She went to church to pray for her family.",
Â  Â  Â  Â  "zh_sentence": "å¥¹å»æ•™å ‚ç‚ºå¥¹çš„å®¶äººç¥ˆç¦±ã€‚",
Â  Â  Â  Â  "category": "å‹•è©/å‹•ä½œ"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "belong",
Â  Â  Â  Â  "zh": "å±¬æ–¼",
Â  Â  Â  Â  "en_sentence": "This coat belongs to my sister.",
Â  Â  Â  Â  "zh_sentence": "é€™ä»¶å¤–å¥—å±¬æ–¼æˆ‘å§å§ã€‚",
Â  Â  Â  Â  "category": "å‹•è©/ç‹€æ…‹"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "build",
Â  Â  Â  Â  "zh": "å»ºé€ ",
Â  Â  Â  Â  "en_sentence": "They are planning to build a new house next year.",
Â  Â  Â  Â  "zh_sentence": "ä»–å€‘è¨ˆç•«æ˜å¹´å»ºé€ ä¸€æ£Ÿæ–°æˆ¿å­ã€‚",
Â  Â  Â  Â  "category": "å‹•è©/å‹•ä½œ"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "ever",
Â  Â  Â  Â  "zh": "æ›¾ç¶“ï¼›ç©¶ç«Ÿ",
Â  Â  Â  Â  "en_sentence": "Have you ever traveled to Japan?",
Â  Â  Â  Â  "zh_sentence": "ä½ æ›¾ç¶“å»éæ—¥æœ¬æ—…è¡Œå—ï¼Ÿ",
Â  Â  Â  Â  "category": "å‰¯è©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "however",
Â  Â  Â  Â  "zh": "ç„¶è€Œï¼›ç„¡è«–å¦‚ä½•",
Â  Â  Â  Â  "en_sentence": "He was late; however, he managed to catch the train.",
Â  Â  Â  Â  "zh_sentence": "ä»–é²åˆ°äº†ï¼›ç„¶è€Œï¼Œä»–é‚„æ˜¯è¨­æ³•è¶•ä¸Šäº†ç«è»Šã€‚",
Â  Â  Â  Â  "category": "é€£æ¥è©/å‰¯è©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "almost",
Â  Â  Â  Â  "zh": "å¹¾ä¹",
Â  Â  Â  Â  "en_sentence": "I am almost finished with my homework.",
Â  Â  Â  Â  "zh_sentence": "æˆ‘çš„ä½œæ¥­å¹¾ä¹å®Œæˆäº†ã€‚",
Â  Â  Â  Â  "category": "å‰¯è©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "finally",
Â  Â  Â  Â  "zh": "çµ‚æ–¼ï¼›æœ€çµ‚",
Â  Â  Â  Â  "en_sentence": "The rain finally stopped after three hours.",
Â  Â  Â  Â  "zh_sentence": "å¤§é›¨åœ¨ä¸‰å€‹å°æ™‚å¾Œçµ‚æ–¼åœäº†ã€‚",
Â  Â  Â  Â  "category": "å‰¯è©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "quite",
Â  Â  Â  Â  "zh": "ç›¸ç•¶ï¼›éå¸¸",
Â  Â  Â  Â  "en_sentence": "The movie was quite good, but not excellent.",
Â  Â  Â  Â  "zh_sentence": "é€™éƒ¨é›»å½±ç›¸ç•¶ä¸éŒ¯ï¼Œä½†é‚„ç¨±ä¸ä¸Šå„ªç§€ã€‚",
Â  Â  Â  Â  "category": "å‰¯è©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "whether",
Â  Â  Â  Â  "zh": "æ˜¯å¦",
Â  Â  Â  Â  "en_sentence": "I don't know whether he will come or not.",
Â  Â  Â  Â  "zh_sentence": "æˆ‘ä¸çŸ¥é“ä»–æ˜¯å¦æœƒä¾†ã€‚",
Â  Â  Â  Â  "category": "é€£æ¥è©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "stand",
Â  Â  Â  Â  "zh": "ç«™ç«‹ï¼›å¿å—",
Â  Â  Â  Â  "en_sentence": "Please stand up when the teacher enters.",
Â  Â  Â  Â  "zh_sentence": "è€å¸«é€²ä¾†æ™‚è«‹ç«™èµ·ä¾†ã€‚",
Â  Â  Â  Â  "category": "å‹•è©/å‹•ä½œ"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "except",
Â  Â  Â  Â  "zh": "é™¤äº†...ä¹‹å¤–",
Â  Â  Â  Â  "en_sentence": "Everyone except John came to the meeting.",
Â  Â  Â  Â  "zh_sentence": "é™¤äº†ç´„ç¿°ä¹‹å¤–ï¼Œæ‰€æœ‰äººéƒ½ä¾†åƒåŠ äº†æœƒè­°ã€‚",
Â  Â  Â  Â  "category": "ä»‹ç³»è©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "club",
Â  Â  Â  Â  "zh": "ä¿±æ¨‚éƒ¨ï¼›ç¤¾åœ˜",
Â  Â  Â  Â  "en_sentence": "I joined the basketball club after school.",
Â  Â  Â  Â  "zh_sentence": "æˆ‘æ”¾å­¸å¾ŒåŠ å…¥äº†ç±ƒçƒç¤¾åœ˜ã€‚",
Â  Â  Â  Â  "category": "åè©/åœ˜é«”"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "chess",
Â  Â  Â  Â  "zh": "è¥¿æ´‹æ£‹",
Â  Â  Â  Â  "en_sentence": "Playing chess requires careful planning.",
Â  Â  Â  Â  "zh_sentence": "ä¸‹è¥¿æ´‹æ£‹éœ€è¦ä»”ç´°çš„è¨ˆç•«ã€‚",
Â  Â  Â  Â  "category": "ä¼‘é–’/éŠæˆ²"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "chalk",
Â  Â  Â  Â  "zh": "ç²‰ç­†",
Â  Â  Â  Â  "en_sentence": "The teacher wrote on the board with a piece of chalk.",
Â  Â  Â  Â  "zh_sentence": "è€å¸«ç”¨ä¸€æ”¯ç²‰ç­†åœ¨é»‘æ¿ä¸Šå¯«å­—ã€‚",
Â  Â  Â  Â  "category": "ç‰©å“/åè©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "newspaper",
Â  Â  Â  Â  "zh": "å ±ç´™",
Â  Â  Â  Â  "en_sentence": "I read the newspaper every morning to catch up on the news.",
Â  Â  Â  Â  "zh_sentence": "æˆ‘æ¯å¤©æ—©ä¸Šçœ‹å ±ç´™ä»¥äº†è§£æ–°èã€‚",
Â  Â  Â  Â  "category": "ç‰©å“/åè©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "glue",
Â  Â  Â  Â  "zh": "è† æ°´ï¼›é»åˆ",
Â  Â  Â  Â  "en_sentence": "We used strong glue to fix the broken vase.",
Â  Â  Â  Â  "zh_sentence": "æˆ‘å€‘ç”¨å¼·åŠ›çš„è† æ°´ä¾†ä¿®å¾©ç ´ç¢çš„èŠ±ç“¶ã€‚",
Â  Â  Â  Â  "category": "ç‰©å“/åè©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "hurry",
Â  Â  Â  Â  "zh": "åŒ†å¿™",
Â  Â  Â  Â  "en_sentence": "We must hurry or we will miss the train.",
Â  Â  Â  Â  "zh_sentence": "æˆ‘å€‘å¿…é ˆè¶•å¿«ï¼Œå¦å‰‡æˆ‘å€‘æœƒéŒ¯éç«è»Šã€‚",
Â  Â  Â  Â  "category": "å‹•è©/å‹•ä½œ"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "hobby",
Â  Â  Â  Â  "zh": "å—œå¥½ï¼›æ¥­é¤˜æ„›å¥½",
Â  Â  Â  Â  "en_sentence": "My hobby is collecting old coins.",
Â  Â  Â  Â  "zh_sentence": "æˆ‘çš„å—œå¥½æ˜¯æ”¶é›†èˆŠç¡¬å¹£ã€‚",
Â  Â  Â  Â  "category": "æŠ½è±¡åè©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "across",
Â  Â  Â  Â  "zh": "æ©«è¶Šï¼›ç©¿é",
Â  Â  Â  Â  "en_sentence": "The dog ran quickly across the field.",
Â  Â  Â  Â  "zh_sentence": "é‚£éš»ç‹—å¿«é€Ÿè·‘éç”°é‡ã€‚",
Â  Â  Â  Â  "category": "ä»‹ç³»è©/å‰¯è©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "vest",
Â  Â  Â  Â  "zh": "èƒŒå¿ƒ",
Â  Â  Â  Â  "en_sentence": "He wore a bright orange vest for safety.",
Â  Â  Â  Â  "zh_sentence": "ä»–ç©¿äº†ä¸€ä»¶é®®è±”çš„æ©˜è‰²èƒŒå¿ƒä»¥ä¿å®‰å…¨ã€‚",
Â  Â  Â  Â  "category": "è¡£ç‰©/åè©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "interest",
Â  Â  Â  Â  "zh": "èˆˆè¶£ï¼›ä½¿æ„Ÿèˆˆè¶£",
Â  Â  Â  Â  "en_sentence": "History is a subject of great interest to me.",
Â  Â  Â  Â  "zh_sentence": "æ­·å²æ˜¯æˆ‘éå¸¸æ„Ÿèˆˆè¶£çš„ç§‘ç›®ã€‚",
Â  Â  Â  Â  "category": "æŠ½è±¡åè©/å‹•è©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "interested",
Â  Â  Â  Â  "zh": "æ„Ÿèˆˆè¶£çš„",
Â  Â  Â  Â  "en_sentence": "Are you interested in joining our team?",
Â  Â  Â  Â  "zh_sentence": "ä½ å°åŠ å…¥æˆ‘å€‘çš„åœ˜éšŠæ„Ÿèˆˆè¶£å—ï¼Ÿ",
Â  Â  Â  Â  "category": "å½¢å®¹è©/æƒ…ç·’"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "pleasure",
Â  Â  Â  Â  "zh": "æ¨‚è¶£ï¼›æ„‰å¿«",
Â  Â  Â  Â  "en_sentence": "It was a pleasure meeting you today.",
Â  Â  Â  Â  "zh_sentence": "ä»Šå¤©å¾ˆé«˜èˆˆè¦‹åˆ°ä½ ã€‚",
Â  Â  Â  Â  "category": "æŠ½è±¡åè©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "business",
Â  Â  Â  Â  "zh": "ç”Ÿæ„ï¼›äº‹å‹™",
Â  Â  Â  Â  "en_sentence": "He travels frequently for his international business.",
Â  Â  Â  Â  "zh_sentence": "ä»–ç¶“å¸¸å‡ºå·®è™•ç†ä»–çš„åœ‹éš›æ¥­å‹™ã€‚",
Â  Â  Â  Â  "category": "æŠ½è±¡åè©/è·æ¥­"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "salt",
Â  Â  Â  Â  "zh": "é¹½",
Â  Â  Â  Â  "en_sentence": "Please pass me the salt for the soup.",
Â  Â  Â  Â  "zh_sentence": "è«‹æŠŠé¹½éçµ¦æˆ‘ï¼Œæˆ‘è¦åŠ åˆ°æ¹¯è£¡ã€‚",
Â  Â  Â  Â  "category": "é£Ÿç‰©/åè©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "popcorn",
Â  Â  Â  Â  "zh": "çˆ†ç±³èŠ±",
Â  Â  Â  Â  "en_sentence": "We bought a huge bucket of popcorn at the movie theater.",
Â  Â  Â  Â  "zh_sentence": "æˆ‘å€‘åœ¨é›»å½±é™¢è²·äº†ä¸€å¤§æ¡¶çˆ†ç±³èŠ±ã€‚",
Â  Â  Â  Â  "category": "é£Ÿç‰©/åè©"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  "word": "bakery",
Â  Â  Â  Â  "zh": "éºµåŒ…åº—",
Â  Â  Â  Â  "en_sentence": "The smell of fresh bread came from the bakery.",
Â  Â  Â  Â  "zh_sentence": "æ–°é®®éºµåŒ…çš„é¦™å‘³å¾éºµåŒ…åº—å‚³ä¾†ã€‚",
Â  Â  Â  Â  "category": "åœ°é»/å ´æ‰€"
Â  Â  }
];

    // ===== éŠæˆ²ç‹€æ…‹è®Šæ•¸ =====
    let gameState = {
      data: [],
      currentIndex: 0,
      attemptCount: 0,
      answered: false,
      timerInterval: null,
      preferredVoice: null,
      answerLog: [],
      sessionStars: 0
    };

    // ===== éŸ³æ•ˆè³‡æº =====
    const SOUNDS = {
      correct: new Audio('sound/correct.mp3'),
      wrong: new Audio('sound/wrong.mp3'),
      type: new Audio('sound/type.mp3')
    };

    // ===== èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶ =====
    let bgMusic = null;
    let isMusicPlaying = false;

    function initBackgroundMusic() {
      bgMusic = new Audio('sound/åˆå¾Œæ”¾é¬†æ™‚å…‰ï¼ˆç´”éŸ³æ¨‚ï¼‰.mp3');
      bgMusic.loop = true;
      bgMusic.volume = 0.3;
      const musicState = localStorage.getItem('bgMusicState');
      if (musicState === 'playing') playBackgroundMusic();
    }

    function toggleBackgroundMusic() {
      if (isMusicPlaying) pauseBackgroundMusic();
      else playBackgroundMusic();
    }

    function playBackgroundMusic() {
      if (!bgMusic) return;
      bgMusic.play().then(() => {
        isMusicPlaying = true;
        document.getElementById('bgMusicControl').textContent = 'ğŸ”Š';
        document.getElementById('bgMusicControl').classList.remove('paused');
        localStorage.setItem('bgMusicState', 'playing');
      }).catch(err => console.log('èƒŒæ™¯éŸ³æ¨‚æ’­æ”¾å¤±æ•—:', err));
    }

    function pauseBackgroundMusic() {
      if (!bgMusic) return;
      bgMusic.pause();
      isMusicPlaying = false;
      document.getElementById('bgMusicControl').textContent = 'ğŸ”‡';
      document.getElementById('bgMusicControl').classList.add('paused');
      localStorage.setItem('bgMusicState', 'paused');
    }

    // ===== å·¥å…·å‡½æ•¸ =====
    // âœ… ä¿®æ­£å¾Œçš„ escapeRegExp
    function escapeRegExp(s) {
      return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // ä¿éšªï¼šæ­£å‰‡å¤±æ•—ä¹Ÿèƒ½é †åˆ©æŒ–ç©º
    function safeBlank(sentence, answer) {
      try {
        const re = new RegExp(escapeRegExp(answer), 'i');
        return sentence.replace(re, '___');
      } catch {
        const lower = sentence.toLowerCase();
        const target = answer.toLowerCase();
        const idx = lower.indexOf(target);
        if (idx >= 0) {
          return sentence.slice(0, idx) + '___' + sentence.slice(idx + answer.length);
        }
        return sentence;
      }
    }

    function getRandomQuestions(arr, n) {
      const count = Math.min(n, arr.length);
      return arr.slice().sort(() => Math.random() - 0.5).slice(0, count);
    }

    // ===== è³‡æ–™åˆå§‹åŒ– =====
    function initData() {
      const selected = getRandomQuestions(VOCAB_DATA, GAME_CONFIG.QUESTIONS_COUNT);
      gameState.data = selected.map(item => ({
        answer: item.word,
        zh: item.zh,
        sentence: safeBlank(item.en_sentence, item.word),
        original: item.en_sentence,
        zh_sentence: item.zh_sentence,
        category: item.category
      }));
      document.getElementById('total-questions').textContent = gameState.data.length;
    }

    // ===== é€²åº¦ç®¡ç† =====
    function saveProgress() { localStorage.setItem('fillIndex', gameState.currentIndex); }

    function loadProgress() {
      gameState.currentIndex = parseInt(localStorage.getItem('fillIndex')) || 0;
      if (Array.isArray(gameState.data) && gameState.currentIndex >= gameState.data.length) {
        gameState.currentIndex = 0;
        localStorage.removeItem('fillIndex');
      }
    }

    function resetProgress() {
      localStorage.removeItem('fillIndex');
      location.reload();
    }

    function updateCounter() {
      document.getElementById('current-index').textContent = gameState.currentIndex + 1;
    }

    // ===== è¨ˆæ™‚å™¨åŠŸèƒ½ =====
    function startTimer() {
      clearInterval(gameState.timerInterval);
      let timeLeft = GAME_CONFIG.TIME_LIMIT;
      document.getElementById('time-left').textContent = timeLeft;
      document.getElementById('timer').classList.remove('hidden');

      gameState.timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('time-left').textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(gameState.timerInterval);
          revealAnswer(true);
        }
      }, 1000);
    }

    function stopTimer() { clearInterval(gameState.timerInterval); }

    // ===== èªéŸ³åŠŸèƒ½ =====
    function pickVoice() {
      const voices = window.speechSynthesis.getVoices();
      const prefer = ['Google US English','Microsoft Aria Online','Microsoft Jenny Online','Samantha','Jenny','Aria','en-US'];
      gameState.preferredVoice =
        voices.find(v => prefer.some(p => v.name.includes(p))) ||
        voices.find(v => v.lang === 'en-US') || voices[0];
    }

    function speak(text, rate = 1.0, callback) {
      if (!window.speechSynthesis) return;
      const utter = new window.SpeechSynthesisUtterance(text);
      utter.lang = 'en-US';
      utter.rate = rate;
      utter.pitch = 1.12;
      if (gameState.preferredVoice) utter.voice = gameState.preferredVoice;
      if (callback) utter.onend = callback;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    function speakQuestionAndWord(question) {
      window.speechSynthesis.cancel();
      speak(question.original, 0.97, function() {
        setTimeout(() => {
          const masked = safeBlank(question.original, question.answer).replace('___','...');
          speak(masked, 1.02, function() { setTimeout(() => speak(question.answer, 1.08), 350); });
        }, 350);
      });
    }

    // ===== ç­”æ¡ˆè™•ç† =====
    function revealAnswer(autoNext = false) {
      gameState.attemptCount = Infinity;
      document.getElementById('feedback').innerHTML =
        '<span style="color:#f66;">â° æ™‚é–“åˆ°ï¼æ­£ç¢ºç­”æ¡ˆï¼š<b>' + gameState.data[gameState.currentIndex].answer + '</b></span>';
      document.getElementById('submit-btn').disabled = true;
      document.getElementById('user-input').disabled = true;

      logAnswer(false);

      if (autoNext) {
        setTimeout(() => { gameState.currentIndex++; showQuestion(); }, 500);
      }
    }

    function logAnswer(correct, userAnswer = '') {
      const currentQuestion = gameState.data[gameState.currentIndex];
      gameState.answerLog[gameState.currentIndex] = {
        word: currentQuestion.answer,
        zh: currentQuestion.zh_sentence || currentQuestion.zh,
        en: currentQuestion.original,
        user: userAnswer,
        correct: correct,
        stars: 0,
        category: currentQuestion.category
      };
    }

    // ===== å•é¡Œé¡¯ç¤º =====
    function showQuestion() {
      if (!gameState.data || !Array.isArray(gameState.data) || gameState.data.length === 0) {
        document.getElementById('question-container').innerHTML =
          '<div style="color:#f66;font-size:1.2rem;">âš ï¸ é¡Œåº«æ²’æœ‰é¡Œç›®ï¼Œè«‹æª¢æŸ¥è³‡æ–™ï¼</div>';
        return;
      }

      if (gameState.currentIndex < 0 || gameState.currentIndex >= gameState.data.length) {
        showGameEndScreen();
        return;
      }

      gameState.answered = false;
      gameState.attemptCount = 0;
      const question = gameState.data[gameState.currentIndex];

      document.getElementById('question-container').innerHTML =
        '<div class="question-title">è‹±æ–‡å¥å­ï¼š</div>' +
        '<div class="question-sentence">' + question.sentence.replace('___', '<span class="blank">___</span>') + '</div>' +
        '<div class="question-zh">ä¸­æ–‡æç¤ºï¼š' + (question.zh_sentence || question.zh) + '</div>' +
        '<input id="user-input" placeholder="è¼¸å…¥ç­”æ¡ˆâ€¦" autocomplete="off" />' +
        '<div class="btn-row">' +
          '<button id="submit-btn" onclick="checkAnswer()">é€å‡º</button>' +
          '<button id="skip-btn" onclick="skipQuestion()">è·³é</button>' +
          '<button id="next-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>' +
        '</div>' +
        '<div id="feedback"></div>' +
        '<button id="speak-btn" onclick="speakQuestionAndWord(question)">ğŸ”Š æœ—è®€</button>';

      const inputEl = document.getElementById('user-input');
      inputEl.focus();
      inputEl.onkeydown = function(e) {
        if (e.key === 'Enter') {
          checkAnswer();
        } else if (e.key.length === 1) {
          try { SOUNDS.type.currentTime = 0; SOUNDS.type.play(); } catch (e) {}
        }
      };

      updateCounter();
      startTimer();

      setTimeout(() => { speak(question.original, 0.97); }, 400);

      document.getElementById('speak-btn').onclick = () => speakQuestionAndWord(question);
      window.answerStartTime = Date.now();

      // é–å®šè¤‡ç¿’æŒ‰éˆ•
      lockReviewButton();
    }

    // ===== éŠæˆ²çµæŸç•«é¢ =====
    function showGameEndScreen() {
      const correctCount = gameState.answerLog.filter(log => log && log.correct === true).length;
      const wrongCount = gameState.answerLog.filter(log => log && log.correct === false).length;
      const totalStars = loadTotalStars();

      document.getElementById('endSessionStars').textContent = gameState.sessionStars;
      document.getElementById('endCorrectCount').textContent = correctCount;
      document.getElementById('endWrongCount').textContent = wrongCount;
      document.getElementById('endTotalStars').textContent = totalStars;

      document.getElementById('gameEndModal').style.display = 'flex';

      stopTimer();
      unlockReviewButton();

      try { SOUNDS.correct.currentTime = 0; SOUNDS.correct.play(); } catch (e) {}
    }

    function restartGame() {
      document.getElementById('gameEndModal').style.display = 'none';
      gameState.currentIndex = 0;
      gameState.sessionStars = 0;
      gameState.answerLog = [];
      initData();
      updateCounter();
      showQuestion();
      document.getElementById('sessionStarsDisplay').textContent = 'æœ¬æ¬¡å·²ç²å¾— 0 é¡†æ˜Ÿæ˜Ÿ';
    }

    // ===== å•é¡Œæ“ä½œ =====
    function skipQuestion() {
      stopTimer();
      logAnswer(null, '');
      const feedback = document.getElementById('feedback');
      if (feedback) feedback.innerHTML = '<span style="color:#bbb;">å·²è·³éæœ¬é¡Œ</span>';
      setTimeout(() => { gameState.currentIndex++; showQuestion(); }, 400);
    }

    function nextQuestion() {
      stopTimer();
      if (!gameState.answerLog[gameState.currentIndex]) {
        logAnswer(false, document.getElementById('user-input')?.value || '');
        const feedback = document.getElementById('feedback');
        if (feedback) feedback.innerHTML = '<span style="color:#bbb;">æœªä½œç­”</span>';
      }
      setTimeout(() => { gameState.currentIndex++; showQuestion(); }, 400);
    }

    function checkAnswer() {
      if (gameState.answered) return;

      gameState.attemptCount++;
      const inputEl = document.getElementById('user-input');
      const feedback = document.getElementById('feedback');
      const answer = gameState.data[gameState.currentIndex].answer.toLowerCase();
      const userAnswer = inputEl.value.trim().toLowerCase();

      if (userAnswer === answer) {
        gameState.answered = true;
        stopTimer();

        const usedSeconds = (Date.now() - (window.answerStartTime || Date.now())) / 1000;
        let bonus = 0;
        let feedbackMsg = '<div class="feedback-box feedback-correct">âœ… ç­”å°äº†ï¼å¤ªæ£’äº†ï¼';

        if (usedSeconds < 10) {
          bonus = 2;
          feedbackMsg += ' <span class="feedback-bonus">BONUS! â±ï¸ +2</span>';
        }
        feedbackMsg += '</div>';

        feedback.innerHTML = feedbackMsg;
        inputEl.disabled = true;
        document.getElementById('submit-btn').disabled = true;

        speak(answer, 1.1);
        saveProgress();
        updateCounter();

        logAnswer(true, inputEl.value.trim());

        const addStars = 1 + bonus;
        addStarsToTotal(addStars);
        gameState.sessionStars += addStars;
        document.getElementById('sessionStarsDisplay').textContent = 'æœ¬æ¬¡å·²ç²å¾— ' + gameState.sessionStars + ' é¡†æ˜Ÿæ˜Ÿ';

        try { SOUNDS.correct.currentTime = 0; SOUNDS.correct.play(); } catch (e) {}

        setTimeout(() => { gameState.currentIndex++; showQuestion(); }, 1300);
      } else {
        if (gameState.attemptCount < GAME_CONFIG.MAX_ATTEMPTS) {
          feedback.innerHTML = '<div class="feedback-box feedback-wrong">âŒ å†è©¦ä¸€æ¬¡ï¼ä½ å¯ä»¥çš„ï¼</div>';
          try { SOUNDS.wrong.currentTime = 0; SOUNDS.wrong.play(); } catch (e) {}
        } else {
          feedback.innerHTML = '<div class="feedback-box feedback-wrong">âŒ æ­£ç¢ºç­”æ¡ˆï¼š<b>' + gameState.data[gameState.currentIndex].answer + '</b><br>åˆ¥æ°£é¤’ï¼Œå†æ¥å†å²ï¼</div>';
          inputEl.disabled = true;
          document.getElementById('submit-btn').disabled = true;

          logAnswer(false, inputEl.value.trim());

          try { SOUNDS.wrong.currentTime = 0; SOUNDS.wrong.play(); } catch (e) {}

          setTimeout(() => { gameState.currentIndex++; showQuestion(); }, 1300);
        }
      }
    }

    // ===== æ˜Ÿæ˜Ÿç³»çµ± =====
    function loadTotalStars() {
      const stars = localStorage.getItem('totalStars');
      return stars !== null ? parseInt(stars, 10) : 0;
    }

    function addStarsToTotal(stars) {
      const currentStars = loadTotalStars();
      const newTotal = currentStars + stars;
      localStorage.setItem('totalStars', newTotal);
      updateStarsDisplay();
    }

    function updateStarsDisplay() {
      document.getElementById('totalStarsCount').textContent = loadTotalStars();
    }

    // ===== è¤‡ç¿’å–®å­—åŠŸèƒ½ =====
    function showReviewModal() {
      stopTimer();
      const totalVocabCount = document.getElementById('totalVocabCount');
      totalVocabCount.textContent = VOCAB_DATA.length;
      displayVocabByCategory('all');
      const categoryFilter = document.getElementById('categoryFilter');
      categoryFilter.onchange = function() { displayVocabByCategory(this.value); };
      document.getElementById('reviewModal').style.display = 'flex';
    }

    function displayVocabByCategory(category) {
      const container = document.getElementById('reviewWordsContainer');
      const totalVocabCount = document.getElementById('totalVocabCount');
      container.innerHTML = '';

      let filteredVocab = VOCAB_DATA;
      if (category !== 'all') filteredVocab = VOCAB_DATA.filter(item => item.category === category);
      totalVocabCount.textContent = filteredVocab.length;

      if (category !== 'all') {
        const categoryTitle = document.createElement('div');
        categoryTitle.style.cssText = `
          color: #0ff; font-size: 1.3rem; font-weight: bold; margin: 15px 0 10px 0;
          padding: 10px; background: rgba(0, 255, 255, 0.1); border-radius: 8px; text-align: center;
        `;
        categoryTitle.textContent = `ğŸ“‚ ${category} (${filteredVocab.length}å€‹å–®å­—)`;
        container.appendChild(categoryTitle);
      }

      filteredVocab.forEach((item, index) => {
        const wordDiv = document.createElement('div');
        wordDiv.style.cssText = `
          background: rgba(255, 255, 255, 0.1); border: 1px solid #ffd700; border-radius: 10px;
          padding: 15px; margin: 10px 0; text-align: left; cursor: pointer; transition: all 0.3s;
        `;
        const categoryLabel = category === 'all'
          ? `<span style="color: #0ff; font-size: 0.8rem; background: rgba(0,255,255,0.2); padding: 2px 6px; border-radius: 4px; margin-left: 8px;">${item.category}</span>`
          : '';

        wordDiv.innerHTML = `
          <div style="display: flex; align-items: flex-start; gap: 15px;">
            <div style="flex: 1; min-width: 0;">
              <div style="color: #ffd700; font-size: 1.2rem; font-weight: bold; margin-bottom: 8px; word-break: break-word;">
                ${index+1}. ${item.word}${categoryLabel}
              </div>
              <div style="color: #fff; font-size: 1rem; margin-bottom: 8px; word-break: break-word;">
                ${item.zh}
              </div>
              <div style="color: #0ff; font-size: 0.9rem; font-style: italic; word-break: break-word;">
                ${item.en_sentence}
              </div>
            </div>
            <button onclick="event.stopPropagation(); speakWord('${item.word}')" style="
              background: #0ff; color: #000; border: none; border-radius: 50%; width: 45px; height: 45px;
              font-size: 1.3rem; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
              transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,255,255,0.3);">ğŸ”Š</button>
          </div>
        `;

        wordDiv.addEventListener('mouseenter', () => { wordDiv.style.background = 'rgba(255, 215, 0, 0.2)'; wordDiv.style.transform = 'scale(1.02)'; });
        wordDiv.addEventListener('mouseleave', () => { wordDiv.style.background = 'rgba(255, 255, 255, 0.1)'; wordDiv.style.transform = 'scale(1)'; });
        wordDiv.addEventListener('click', () => { speakWord(item.word); });

        container.appendChild(wordDiv);
      });

      if (filteredVocab.length === 0) {
        const noWordsDiv = document.createElement('div');
        noWordsDiv.style.cssText = `
          text-align: center; color: #888; font-size: 1.1rem; padding: 40px; font-style: italic;
        `;
        noWordsDiv.textContent = 'æ­¤åˆ†é¡æš«ç„¡å–®å­—';
        container.appendChild(noWordsDiv);
      }
    }

    function closeReviewModal() {
      document.getElementById('reviewModal').style.display = 'none';
      if (gameState.currentIndex < gameState.data.length && !gameState.answered) startTimer();
    }

    function speakWord(word) {
      if (!window.speechSynthesis) return;
      const utter = new window.SpeechSynthesisUtterance(word);
      utter.lang = 'en-US';
      utter.rate = 0.9;
      utter.pitch = 1.1;
      if (gameState.preferredVoice) utter.voice = gameState.preferredVoice;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    // ===== è¤‡ç¿’æŒ‰éˆ•é–å®šåŠŸèƒ½ =====
    function lockReviewButton() {
      const reviewBtn = document.querySelector('.top-btns button[onclick*="showReviewModal"]');
      if (reviewBtn) {
        reviewBtn.disabled = true;
        reviewBtn.style.background = '#555';
        reviewBtn.style.color = '#888';
        reviewBtn.style.cursor = 'not-allowed';
        reviewBtn.title = 'éŠæˆ²é€²è¡Œä¸­ï¼Œç„¡æ³•è¤‡ç¿’å–®å­—';
      }
    }

    function unlockReviewButton() {
      const reviewBtn = document.querySelector('.top-btns button[onclick*="showReviewModal"]');
      if (reviewBtn) {
        reviewBtn.disabled = false;
        reviewBtn.style.background = '#ffd700';
        reviewBtn.style.color = '#000';
        reviewBtn.style.cursor = 'pointer';
        reviewBtn.title = 'è¤‡ç¿’å–®å­—';
      }
    }

    // ===== å­—åº«çµ±è¨ˆåŠŸèƒ½ =====
    function showVocabStats() {
      const categoryStats = {};
      VOCAB_DATA.forEach(item => { categoryStats[item.category] = (categoryStats[item.category] || 0) + 1; });

      const statsModal = document.createElement('div');
      statsModal.className = 'modal';
      statsModal.style.display = 'flex';
      statsModal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="end-icon">ğŸ“Š</div>
          <h2>å­—åº«çµ±è¨ˆ</h2>
          <div style="text-align: left; margin: 20px 0;">
            <h3 style="color: #ffd700; margin-bottom: 15px;">ğŸ“ˆ åˆ†é¡çµ±è¨ˆ</h3>
            ${Object.entries(categoryStats).map(([category, count]) => `
              <div style="
                display: flex; justify-content: space-between; align-items: center;
                padding: 8px 0; border-bottom: 1px solid rgba(255, 215, 0, 0.3);
              ">
                <span style="color: #fff;">${category}</span>
                <span style="color: #0ff; font-weight: bold;">${count} å€‹å–®å­—</span>
              </div>
            `).join('')}
            <div style="
              display: flex; justify-content: space-between; align-items: center;
              padding: 12px 0; border-top: 2px solid #ffd700; margin-top: 10px; font-weight: bold;
            ">
              <span style="color: #ffd700;">ç¸½è¨ˆ</span>
              <span style="color: #ffd700;">${VOCAB_DATA.length} å€‹å–®å­—</span>
            </div>
          </div>
          <div class="end-buttons">
            <button onclick="this.closest('.modal').remove()">é—œé–‰</button>
          </div>
        </div>
      `;
      statsModal.addEventListener('click', function(e) { if (e.target === statsModal) statsModal.remove(); });
      document.body.appendChild(statsModal);
    }

    // ===== å­—åº«åŒ¯å‡ºåŠŸèƒ½ =====
    function exportVocabData() {
      const csvContent = [
        ['å–®å­—','ä¸­æ–‡','è‹±æ–‡ä¾‹å¥','ä¸­æ–‡ä¾‹å¥','åˆ†é¡'],
        ...VOCAB_DATA.map(item => [item.word,item.zh,item.en_sentence,item.zh_sentence,item.category])
      ].map(row => row.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.href = url;
      link.download = `zeus_vocabulary_${new Date().toISOString().split('T')[0]}.csv`;
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showNotification('âœ… å­—åº«å·²æˆåŠŸåŒ¯å‡ºï¼', 'success');
    }

    // ===== é€šçŸ¥åŠŸèƒ½ =====
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        background: ${type === 'success' ? '#4caf50' : '#2196f3'};
        color: white; padding: 12px 24px; border-radius: 8px; font-weight: bold;
        z-index: 10000; animation: slideDown 0.3s ease-out;
      `;
      notification.textContent = message;

      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideDown {
          from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
          to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);

      document.body.appendChild(notification);
      setTimeout(() => { notification.remove(); style.remove(); }, 3000);
    }

    // ===== è§’è‰²äº’å‹•ç³»çµ±æ•´åˆ =====
    let currentCharacter = localStorage.getItem('characterName') || 'zeus';
    if (window.GameDialogue) window.GameDialogue.currentCharacter = currentCharacter;
    function showGameStartDialogue(){ if (window.GameDialogue) window.GameDialogue.showGameStartDialogue(); }
    function showCorrectAnswerDialogue(){ if (window.GameDialogue) window.GameDialogue.showCorrectAnswerDialogue(); }
    function showWrongAnswerDialogue(){ if (window.GameDialogue) window.GameDialogue.showWrongAnswerDialogue(); }
    function showGameVictoryDialogue(){ if (window.GameDialogue) window.GameDialogue.showGameVictoryDialogue(); }
    function showGameDefeatDialogue(){ if (window.GameDialogue) window.GameDialogue.showGameDefeatDialogue(); }

    // ===== åˆå§‹åŒ– =====
    if (typeof speechSynthesis !== 'undefined') {
      speechSynthesis.onvoiceschanged = pickVoice;
      pickVoice();
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateStarsDisplay();
      document.getElementById('sessionStarsDisplay').textContent = 'æœ¬æ¬¡å·²ç²å¾— 0 é¡†æ˜Ÿæ˜Ÿ';
      initData();
      gameState.currentIndex = 0;
      updateCounter();
      showQuestion();
      localStorage.removeItem('fillIndex');

      // åˆå§‹åŒ–èƒŒæ™¯éŸ³æ¨‚
      initBackgroundMusic();

      // åˆå§‹åŒ–æ™‚è§£é–è¤‡ç¿’æŒ‰éˆ•
      unlockReviewButton();

      // é–‹å§‹å°è©±ï¼ˆè‹¥å¤–æ›å­˜åœ¨ï¼‰
      if (window.GameDialogue) { window.GameDialogue.init(); showGameStartDialogue(); }
    });

    // é»æ“Šå½ˆçª—å¤–ä¹Ÿèƒ½é—œé–‰
    document.addEventListener('DOMContentLoaded', function() {
      const reviewModal = document.getElementById('reviewModal');
      const gameEndModal = document.getElementById('gameEndModal');

      if (reviewModal) {
        reviewModal.addEventListener('click', function(e){ if (e.target === reviewModal) closeReviewModal(); });
      }
      if (gameEndModal) {
        gameEndModal.addEventListener('click', function(e){ if (e.target === gameEndModal) document.getElementById('gameEndModal').style.display = 'none'; });
      }
    });
  </script>
</body>
</html>
