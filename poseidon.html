<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>填空挑戰 - 英打小英雄</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="responsive_enhanced.css" />
  <style>
    /* —— 精簡樣式，保留原視覺 —— */
    :root{--gold:#ffd700;--cyan:#0ff;--bg1:#232526;--bg2:#414345}
    *{box-sizing:border-box;max-width:100%}
    html,body{margin:0;padding:0}
    body{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;text-align:center;font-family:'Segoe UI',Arial,sans-serif,'Orbitron',sans-serif;background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);color:#fff;overflow-x:hidden}
    h1{color:var(--gold);text-shadow:0 0 8px var(--gold);letter-spacing:2px;font-family:'Orbitron',Arial,sans-serif;font-size:2.2rem;margin:60px 0 20px}
    #bgMusicControl{position:fixed;bottom:20px;right:20px;background:rgba(255,215,0,.9);color:#000;border:none;border-radius:50%;width:50px;height:50px;font-size:1.5rem;cursor:pointer;z-index:12;box-shadow:0 0 12px rgba(255,215,0,.4);transition:.3s;display:flex;align-items:center;justify-content:center}
    #bgMusicControl:hover{background:rgba(255,215,0,1);transform:scale(1.1);box-shadow:0 0 20px rgba(255,215,0,.6)}
    #bgMusicControl.paused{background:rgba(255,255,255,.3);color:#fff}
    .top-btns{position:fixed;top:20px;right:20px;display:flex;gap:8px;z-index:11}
    .top-btns button,button{padding:10px 22px;font-size:1rem;background:var(--gold);color:#000;border:none;border-radius:12px;cursor:pointer;box-shadow:0 2px 8px #0003;font-family:'Orbitron',Arial,sans-serif}
    .top-btns button:hover{background:#ffe54f}
    #submit-btn{background:var(--gold);color:#111}
    #submit-btn:disabled{background:#ccc;color:#888;cursor:not-allowed}
    #skip-btn{background:#bbb;color:#222}
    #skip-btn:hover{background:#ccc}
    #speak-btn{background:var(--cyan);color:#111;margin-top:10px}
    #speak-btn:disabled{background:#555;color:#888}
    #next-btn{background:#4caf50;color:#fff;margin-top:10px}
    #next-btn:hover{background:#6fdc7f}
    #starsDisplay{position:fixed;top:20px;left:20px;background:rgba(10,20,40,.85);padding:8px 14px;border-radius:10px;color:var(--gold);font-weight:700;box-shadow:0 0 12px var(--gold),0 0 32px var(--cyan);border:2px solid var(--cyan);font-size:1.2rem;z-index:10}
    #star-counter{display:flex;align-items:center;justify-content:center;gap:18px;background:rgba(30,30,40,.92);border-radius:18px;box-shadow:0 4px 18px rgba(31,38,135,.18);padding:14px 32px;margin-bottom:18px;border:1.5px solid #ffd70044;font-size:1.18rem;color:var(--gold);min-width:260px}
    #timer{font-size:1.1rem;margin-bottom:16px}
    #timer.hidden{display:none}
    #question-container{background:rgba(30,30,40,.97);border-radius:22px;box-shadow:0 8px 32px rgba(31,38,135,.37);padding:34px 26px 26px;max-width:440px;width:100%;margin:auto 0 18px;border:1.5px solid #ffd70044;display:flex;flex-direction:column;align-items:center}
    .question-title{font-size:1.05rem;margin-bottom:8px;letter-spacing:1px}
    .question-sentence{font-size:1.6rem;font-weight:700;margin:8px 0 16px;line-height:1.5;word-break:break-word}
    .question-sentence .blank{color:var(--cyan);background:#fff2;border-radius:8px;padding:2px 12px;box-shadow:0 1px 4px #0ff2}
    .question-zh{color:var(--gold);margin-bottom:12px;font-size:1.02rem}
    input{width:92%;padding:14px;font-size:1.1rem;border:2px solid var(--gold);border-radius:14px;background:#222;color:#fff;margin-bottom:18px;box-shadow:0 2px 8px #0003;outline:none}
    input:focus{border-color:var(--cyan)}
    .btn-row{display:flex;justify-content:center;gap:14px;margin-bottom:10px;width:100%}
    #feedback{margin-top:10px;font-size:1.08rem;min-height:28px}
    .feedback-box{display:inline-block;padding:10px 18px;border-radius:14px;font-size:1.08rem;font-weight:700;box-shadow:0 2px 16px #0004;margin-top:6px;transition:.3s;animation:popfade .7s cubic-bezier(.68,-.55,.27,1.55)}
    .feedback-correct{background:linear-gradient(90deg,#2ecc40,#bfff00);color:#222}
    .feedback-wrong{background:linear-gradient(90deg,#ff4f4f,#ffbaba);color:#fff}
    .feedback-bonus{color:var(--gold);animation:bonusflash 1s infinite alternate;font-size:1.15em}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;justify-content:center;align-items:center;z-index:1000;backdrop-filter:blur(4px)}
    .modal-content{background:rgba(30,30,40,.95);border:2px solid var(--gold);border-radius:20px;padding:32px;text-align:center;max-width:520px;width:90%;box-shadow:0 0 32px #ffd70044,0 0 80px #00ffff22 inset;animation:modalPop .5s cubic-bezier(.68,-.55,.27,1.55)}
    .end-buttons{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    .end-buttons button{background:linear-gradient(90deg,#ffd700,#ffed4e);color:#000;padding:12px 20px;font-size:1.05rem;font-weight:700}
    .end-icon{font-size:3.5rem;margin-bottom:12px;animation:tada 1.2s infinite}
    @keyframes popfade{0%{transform:scale(.7);opacity:0}60%{transform:scale(1.15);opacity:1}100%{transform:scale(1)}}
    @keyframes bonusflash{0%{text-shadow:0 0 8px var(--gold)}100%{text-shadow:0 0 24px #fff700}}
    @keyframes modalPop{0%{transform:scale(.7);opacity:0}60%{transform:scale(1.1);opacity:1}100%{transform:scale(1)}}
    @keyframes tada{0%{transform:scale(1)}10%,20%{transform:scale(.9) rotate(-3deg)}30%,50%,70%,90%{transform:scale(1.1) rotate(3deg)}40%,60%,80%{transform:scale(1.1) rotate(-3deg)}100%{transform:scale(1) rotate(0)}}
    @media (max-width:768px){.top-btns{top:10px;right:10px;gap:6px;flex-wrap:wrap;justify-content:flex-end}.top-btns button{padding:4px 8px;font-size:.9rem}#starsDisplay{top:10px;left:10px;padding:6px 10px;font-size:1rem}h1{font-size:1.8rem;margin-top:60px}#question-container{max-width:95vw;padding:20px 15px;margin:10px auto}.question-sentence{font-size:1.3rem}.modal-content{padding:20px;margin:10px;max-width:95vw}.end-buttons{flex-direction:column;gap:10px}.end-buttons button{width:100%;padding:10px}}
    @media (max-width:480px){body{padding:10px}.top-btns{position:relative;justify-content:center;margin-bottom:15px}#starsDisplay{position:relative;display:inline-block;margin-bottom:10px}h1{font-size:1.5rem;margin-top:10px}#star-counter{font-size:1rem;padding:10px 20px;min-width:200px}.question-sentence{font-size:1.1rem}input{font-size:1rem;padding:12px}.btn-row{flex-direction:column;gap:10px}.btn-row button{width:100%}}
  </style>
</head>
<body>
  <button id="bgMusicControl" title="背景音樂控制">🎵</button>
  <div id="starsDisplay">⭐<span id="totalStarsCount">0</span></div>
  <div class="top-btns">
    <button onclick="location.href='atlas.html?tab=greek'">🏠 回首頁</button>
    <button id="resetBtn">🔄 重新開始</button>
    <button id="reviewBtn">📚 複習單字</button>
  </div>

  <h1>波塞頓 Poseidon - 填空挑戰</h1>
  <div id="sessionStarsDisplay" style="margin-bottom:10px;color:var(--gold);font-weight:bold;font-size:1.08rem;">本次已獲得 0 顆星星</div>
  <div id="star-counter">第 <span id="current-index">0</span> / <span id="total-questions">0</span> 題</div>
  <div id="timer" class="hidden">⏳ 倒數：<span id="time-left">0</span> 秒</div>
  <div id="question-container"></div>

  <!-- 遊戲結束 -->
  <div id="gameEndModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="end-icon">🎉</div>
      <h2 style="color:var(--gold);text-shadow:0 0 12px var(--gold);font-family:'Orbitron',Arial,sans-serif">遊戲完成！</h2>
      <div class="end-stats">
        <p>⭐ 本次獲得星星：<span id="endSessionStars">0</span></p>
        <p>✅ 答對題數：<span id="endCorrectCount">0</span></p>
        <p>❌ 答錯題數：<span id="endWrongCount">0</span></p>
        <p>⭐ 累積總星星：<span id="endTotalStars">0</span></p>
      </div>
      <div class="end-buttons">
        <button id="restartBtn">🔄 重新開始</button>
        <button onclick="location.href='atlas.html?tab=greek'">🏠 返回首頁</button>
      </div>
    </div>
  </div>

  <!-- 單字複習 -->
  <div id="reviewModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="end-icon">📚</div>
      <h2>單字複習</h2>
      <div style="margin-bottom:20px;">
        <label for="categoryFilter" style="color:var(--gold);font-weight:700;margin-right:10px;">選擇分類：</label>
        <select id="categoryFilter" style="background:#222;color:#fff;border:2px solid var(--gold);border-radius:8px;padding:8px 12px;font-size:1rem;cursor:pointer"></select>
      </div>
      <div id="vocabStats" style="background:rgba(255,215,0,.1);border:1px solid var(--gold);border-radius:8px;padding:10px;margin-bottom:15px;color:var(--gold);font-size:.9rem;">
        總共 <span id="totalVocabCount">0</span> 個單字
        <button id="statsBtn" style="background:var(--cyan);color:#000;border:none;border-radius:6px;padding:4px 8px;font-size:.8rem;margin-left:10px;cursor:pointer">📊 詳細統計</button>
        <button id="exportBtn" style="background:#4caf50;color:#fff;border:none;border-radius:6px;padding:4px 8px;font-size:.8rem;margin-left:5px;cursor:pointer">📥 匯出字庫</button>
      </div>
      <div id="reviewWordsContainer" style="max-height:400px;overflow-y:auto;margin:20px 0;"></div>
      <div class="end-buttons"><button id="closeReviewBtn">關閉</button></div>
    </div>
  </div>

  <audio id="backgroundMusic" loop>
    <source src="sound/午後放鬆時光（純音樂）.mp3" type="audio/mpeg" />
  </audio>

  <script>
  (()=>{
    // ===== 狀態 =====
    const GAME_CONFIG={QUESTIONS_COUNT:20,TIME_LIMIT:30,MAX_ATTEMPTS:3};
    const qs=(s,p=document)=>p.querySelector(s);const qsa=(s,p=document)=>[...p.querySelectorAll(s)];
    const el={
      bgBtn:qs('#bgMusicControl'),bg:qs('#backgroundMusic'),
      totalStars:qs('#totalStarsCount'),sessionStars:qs('#sessionStarsDisplay'),
      qBox:qs('#question-container'),cur:qs('#current-index'),tot:qs('#total-questions'),
      timerWrap:qs('#timer'),timeLeft:qs('#time-left'),
      reviewBtn:qs('#reviewBtn'),resetBtn:qs('#resetBtn'),
      endModal:qs('#gameEndModal'),endSession:qs('#endSessionStars'),endCorrect:qs('#endCorrectCount'),endWrong:qs('#endWrongCount'),endTotal:qs('#endTotalStars'),restartBtn:qs('#restartBtn'),
      reviewModal:qs('#reviewModal'),reviewList:qs('#reviewWordsContainer'),category:qs('#categoryFilter'),vocabCount:qs('#totalVocabCount'),statsBtn:qs('#statsBtn'),exportBtn:qs('#exportBtn'),closeReviewBtn:qs('#closeReviewBtn')
    };

    let gameState={currentIndex:0,data:[],answered:false,attemptCount:0,timer:null,answerLog:[],sessionStars:0,preferredVoice:null,isMusicPlaying:false,lastTypeAt:0};

    // ===== 題庫 =====
    const VOCAB_DATA=[
      {word:"balcony",zh:"陽台",en_sentence:"We drink tea on the balcony in the evening.",zh_sentence:"我們晚上在陽台喝茶。",category:"場所位置"},
      {word:"koala",zh:"無尾熊",en_sentence:"A koala sleeps in the eucalyptus tree.",zh_sentence:"無尾熊睡在尤加利樹上。",category:"動物"},
      {word:"hippo",zh:"河馬",en_sentence:"The hippo swims across the river.",zh_sentence:"河馬游過河面。",category:"動物"},
      {word:"zebra",zh:"斑馬",en_sentence:"The zebra has black and white stripes.",zh_sentence:"斑馬有黑白相間的條紋。",category:"動物"},
      {word:"kangaroo",zh:"袋鼠",en_sentence:"A kangaroo can jump very far.",zh_sentence:"袋鼠可以跳得很遠。",category:"動物"},
      {word:"person",zh:"人(單數)",en_sentence:"One person is waiting at the door.",zh_sentence:"一個人在門口等候。",category:"稱謂人際"},
      {word:"people",zh:"人們(複數)",en_sentence:"Many people visit the museum on weekends.",zh_sentence:"很多人週末參觀博物館。",category:"稱謂人際"},
      {word:"man",zh:"男人",en_sentence:"The man reads a newspaper.",zh_sentence:"那位男人在看報紙。",category:"稱謂人際"},
      {word:"woman",zh:"女人",en_sentence:"The woman works at a bank.",zh_sentence:"那位女人在銀行工作。",category:"稱謂人際"},
      {word:"center",zh:"中心；中央",en_sentence:"Please stand in the center of the circle.",zh_sentence:"請站在圓的中央。",category:"場所位置"},
      {word:"future",zh:"未來",en_sentence:"We should plan for the future.",zh_sentence:"我們應該為未來做打算。",category:"抽象概念"},
      {word:"age",zh:"年齡",en_sentence:"What is your age?",zh_sentence:"你的年齡是多少？",category:"抽象概念"},
      {word:"minute",zh:"分鐘",en_sentence:"Please wait one minute.",zh_sentence:"請等一分鐘。",category:"時間日期"},
      {word:"Christmas",zh:"聖誕節",en_sentence:"We open gifts on Christmas morning.",zh_sentence:"我們在聖誕節早上打開禮物。",category:"節日慶祝"},
      {word:"bell",zh:"鈴；鐘",en_sentence:"The school bell rings at eight.",zh_sentence:"學校的鐘在八點響起。",category:"聲音表演"},
      {word:"turkey",zh:"火雞",en_sentence:"We eat turkey for dinner.",zh_sentence:"我們晚餐吃火雞。",category:"動物"},
      {word:"thing",zh:"事物；東西",en_sentence:"This thing is very useful.",zh_sentence:"這個東西很有用。",category:"抽象概念"},
      {word:"glasses",zh:"眼鏡",en_sentence:"She wears glasses to read.",zh_sentence:"她戴眼鏡閱讀。",category:"日常生活用品"},
      {word:"belt",zh:"皮帶",en_sentence:"He wears a belt with his jeans.",zh_sentence:"他牛仔褲配了一條皮帶。",category:"日常生活用品"},
      {word:"think",zh:"思考；認為",en_sentence:"I think this answer is correct.",zh_sentence:"我認為這個答案是正確的。",category:"動作動詞"},
      {word:"quiet",zh:"安靜的",en_sentence:"Please be quiet in the library.",zh_sentence:"請在圖書館保持安靜。",category:"形容詞"},
      {word:"interesting",zh:"有趣的",en_sentence:"This book is very interesting.",zh_sentence:"這本書非常有趣。",category:"形容詞"},
      {word:"favorite",zh:"最喜愛的",en_sentence:"Ice cream is my favorite dessert.",zh_sentence:"冰淇淋是我最喜愛的甜點。",category:"形容詞"},
      {word:"any",zh:"任何的",en_sentence:"Do you have any questions?",zh_sentence:"你有任何問題嗎？",category:"形容詞"},
      {word:"wait",zh:"等待",en_sentence:"Please wait for your turn.",zh_sentence:"請等待輪到你。",category:"動作動詞"},
      {word:"worry",zh:"擔心",en_sentence:"Don't worry about the test.",zh_sentence:"別擔心考試。",category:"情感表達"},
      {word:"get",zh:"得到；取得",en_sentence:"I will get a new bike.",zh_sentence:"我要得到一台新腳踏車。",category:"動作動詞"},
      {word:"share",zh:"分享",en_sentence:"We share our snacks with friends.",zh_sentence:"我們和朋友分享零食。",category:"動作動詞"},
      {word:"kick",zh:"踢",en_sentence:"He can kick the ball very hard.",zh_sentence:"他能很用力地踢球。",category:"動作動詞"},
      {word:"remember",zh:"記得",en_sentence:"Please remember to lock the door.",zh_sentence:"請記得把門鎖上。",category:"動作動詞"},
      {word:"fight",zh:"打架；對抗",en_sentence:"They fight over the toy.",zh_sentence:"他們為了玩具打架。",category:"動作動詞"},
      {word:"shout",zh:"大喊",en_sentence:"Don't shout in the classroom.",zh_sentence:"不要在教室裡大喊。",category:"動作動詞"},
      {word:"behind",zh:"在…後面",en_sentence:"The cat is behind the chair.",zh_sentence:"貓在椅子後面。",category:"場所位置"},
      {word:"front",zh:"在…前面；前面",en_sentence:"Stand in front of the line.",zh_sentence:"請站在隊伍前面。",category:"場所位置"},
      {word:"between",zh:"在…之間",en_sentence:"The ball is between the boxes.",zh_sentence:"球在兩個箱子之間。",category:"場所位置"},
      {word:"down",zh:"向下；在下方",en_sentence:"The bird flies down to the tree.",zh_sentence:"那隻鳥向下飛到樹上。",category:"場所位置"},
      {word:"then",zh:"然後；接著",en_sentence:"Finish your homework, then play.",zh_sentence:"先完成作業，然後再玩。",category:"邏輯關係"},
      {word:"even",zh:"甚至",en_sentence:"He can swim even in cold water.",zh_sentence:"他甚至可以在冷水中游泳。",category:"附加表達"},
      {word:"wrong",zh:"錯誤的",en_sentence:"Your answer is wrong.",zh_sentence:"你的答案是錯的。",category:"形容詞"},
      {word:"many",zh:"許多",en_sentence:"There are many books on the shelf.",zh_sentence:"書架上有許多書。",category:"數量分數"}
    ];

    // ===== 音效 =====
    const SOUNDS={correct:new Audio('sound/correct.mp3'),wrong:new Audio('sound/wrong.mp3'),type:new Audio('sound/type.mp3')};

    // ===== 小工具 =====
    const rnd=(arr,n)=>arr.slice().sort(()=>Math.random()-.5).slice(0,Math.min(n,arr.length));
    const esc=s=>s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    const setHTML=(node,html)=>node&&(node.innerHTML=html);

    // ===== 音樂控制（修正首次播放） =====
    const playMusic=()=>el.bg.play().then(()=>{gameState.isMusicPlaying=true;el.bgBtn.textContent='🔊';el.bgBtn.classList.remove('paused');localStorage.setItem('bgMusicState','playing')}).catch(()=>{});
    const pauseMusic=()=>{el.bg.pause();gameState.isMusicPlaying=false;el.bgBtn.textContent='🔇';el.bgBtn.classList.add('paused');localStorage.setItem('bgMusicState','paused')};

    // ===== 星星 =====
    const loadStars=()=>parseInt(localStorage.getItem('totalStars')||'0',10);
    const addStars=n=>{localStorage.setItem('totalStars',loadStars()+n);el.totalStars.textContent=loadStars()};

    // ===== 初始化題目 =====
    function initData(){
      gameState.data=rnd(VOCAB_DATA,GAME_CONFIG.QUESTIONS_COUNT).map(item=>({
        answer:item.word,zh:item.zh,sentence:item.en_sentence.replace(new RegExp(esc(item.word),'i'),'___'),original:item.en_sentence,zh_sentence:item.zh_sentence,category:item.category
      }));
      el.tot.textContent=gameState.data.length;
    }

    // ===== 計時器 =====
    function startTimer(){
      stopTimer();let t=GAME_CONFIG.TIME_LIMIT;el.timeLeft.textContent=t;el.timerWrap.classList.remove('hidden');
      gameState.timer=setInterval(()=>{t--;el.timeLeft.textContent=t;if(t<=0){stopTimer();revealAnswer(true)}},1000);
    }
    function stopTimer(){clearInterval(gameState.timer)}

    // ===== 發音 =====
    function pickVoice(){
      const prefer=['Google US English','Microsoft Aria Online','Microsoft Jenny Online','Samantha','Jenny','Aria','en-US'];
      const vs=speechSynthesis.getVoices();
      gameState.preferredVoice=vs.find(v=>prefer.some(p=>v.name.includes(p)))||vs.find(v=>v.lang==='en-US')||vs[0];
    }
    function speak(text,rate=1,cb){ if(!window.speechSynthesis) return; const u=new SpeechSynthesisUtterance(text); u.lang='en-US';u.rate=rate;u.pitch=1.1; if(gameState.preferredVoice) u.voice=gameState.preferredVoice; if(cb) u.onend=cb; speechSynthesis.cancel(); speechSynthesis.speak(u); }
    function speakSeq(q){ speechSynthesis.cancel(); speak(q.original,.97,()=>setTimeout(()=>speak(q.original.replace(new RegExp(esc(q.answer),'i'),'...'),1.02,()=>setTimeout(()=>speak(q.answer,1.08),300)),300)); }

    // ===== 題目流轉 =====
    function updateCounter(){el.cur.textContent=gameState.currentIndex+1}
    function showQuestion(){
      const i=gameState.currentIndex; if(!gameState.data.length){setHTML(el.qBox,'<div style="color:#f66;font-size:1.2rem;">⚠️ 題庫沒有題目，請檢查資料！</div>');return}
      if(i<0||i>=gameState.data.length){return showEnd()}
      gameState.answered=false; gameState.attemptCount=0; const q=gameState.data[i];
      setHTML(el.qBox,
        `<div class="question-title">英文句子：</div>
         <div class="question-sentence">${q.sentence.replace('___','<span class="blank">___</span>')}</div>
         <div class="question-zh">中文提示：${q.zh_sentence||q.zh}</div>
         <input id="user-input" placeholder="輸入答案…" autocomplete="off" />
         <div class="btn-row">
           <button id="submit-btn">送出</button>
           <button id="skip-btn">跳過</button>
           <button id="next-btn">下一題</button>
         </div>
         <div id="feedback"></div>
         <button id="speak-btn">🔊 朗讀</button>`);

      const input=qs('#user-input'); const feedback=qs('#feedback');
      const onCorrect=(bonus)=>{
        setHTML(feedback,`<div class="feedback-box feedback-correct">✅ 答對了！太棒了！ ${bonus?'<span class="feedback-bonus">BONUS! ⏱️ +'+bonus+'</span>':''}</div>`);
        input.disabled=true; qs('#submit-btn').disabled=true; speak(q.answer,1.08); logAnswer(true,input.value.trim()); const add=1+bonus; addStars(add); gameState.sessionStars+=add; el.sessionStars.textContent=`本次已獲得 ${gameState.sessionStars} 顆星星`; try{SOUNDS.correct.currentTime=0;SOUNDS.correct.play()}catch{} setTimeout(()=>{gameState.currentIndex++; showQuestion()},1100);
      };

      input.focus(); input.onkeydown=e=>{ if(e.key==='Enter'){ checkAnswer() } else if(e.key.length===1){ const now=Date.now(); if(now-gameState.lastTypeAt>50){ try{SOUNDS.type.currentTime=0;SOUNDS.type.play()}catch{} gameState.lastTypeAt=now } } };
      qs('#submit-btn').onclick=checkAnswer; qs('#skip-btn').onclick=()=>{stopTimer(); logAnswer(null,''); setHTML(feedback,'<span style="color:#bbb;">已跳過本題</span>'); setTimeout(()=>{gameState.currentIndex++; showQuestion()},350)};
      qs('#next-btn').onclick=()=>{stopTimer(); if(!gameState.answerLog[i]){logAnswer(false,input?.value||''); setHTML(feedback,'<span style="color:#bbb;">未作答</span>')} setTimeout(()=>{gameState.currentIndex++; showQuestion()},350)};
      qs('#speak-btn').onclick=()=>speakSeq(q);

      updateCounter(); startTimer(); setTimeout(()=>speak(q.original,.97),300);
      lockReview(true);

      function checkAnswer(){ if(gameState.answered) return; gameState.attemptCount++; const ans=q.answer.toLowerCase(); const user=(input.value||'').trim().toLowerCase(); if(user===ans){ gameState.answered=true; stopTimer(); const used=((Date.now()-(window.answerStartTime||Date.now()))/1000); const bonus=used<10?2:0; onCorrect(bonus) } else { if(gameState.attemptCount<GAME_CONFIG.MAX_ATTEMPTS){ setHTML(feedback,'<div class="feedback-box feedback-wrong">❌ 再試一次！你可以的！</div>'); try{SOUNDS.wrong.currentTime=0;SOUNDS.wrong.play()}catch{} } else { setHTML(feedback,`<div class="feedback-box feedback-wrong">❌ 正確答案：<b>${q.answer}</b><br>別氣餒，再接再厲！</div>`); input.disabled=true; qs('#submit-btn').disabled=true; logAnswer(false,input.value.trim()); try{SOUNDS.wrong.currentTime=0;SOUNDS.wrong.play()}catch{} setTimeout(()=>{gameState.currentIndex++; showQuestion()},1100) } } }
      window.answerStartTime=Date.now();
    }

    // ===== 記錄 =====
    const logAnswer=(correct,user='')=>{const q=gameState.data[gameState.currentIndex]; gameState.answerLog[gameState.currentIndex]={word:q.answer,zh:q.zh_sentence||q.zh,en:q.original,user,correct,stars:0,category:q.category}};

    // ===== 結束畫面 =====
    function showEnd(){ const correct=gameState.answerLog.filter(x=>x&&x.correct===true).length; const wrong=gameState.answerLog.filter(x=>x&&x.correct===false).length; const total=loadStars(); el.endSession.textContent=gameState.sessionStars; el.endCorrect.textContent=correct; el.endWrong.textContent=wrong; el.endTotal.textContent=total; el.endModal.style.display='flex'; stopTimer(); lockReview(false); try{SOUNDS.correct.currentTime=0;SOUNDS.correct.play()}catch{} }
    function restart(){ el.endModal.style.display='none'; gameState.currentIndex=0; gameState.sessionStars=0; gameState.answerLog=[]; initData(); updateCounter(); showQuestion(); el.sessionStars.textContent='本次已獲得 0 顆星星' }

    // ===== 複習清單 =====
    const lockReview=(locked)=>{ el.reviewBtn.disabled=locked; el.reviewBtn.style.background=locked?'#555':'var(--gold)'; el.reviewBtn.style.color=locked?'#888':'#000'; el.reviewBtn.style.cursor=locked?'not-allowed':'pointer'; el.reviewBtn.title=locked?'遊戲進行中，無法複習單字':'複習單字' };
    function openReview(){ stopTimer(); el.reviewModal.style.display='flex'; buildCategory(); drawList('all') }
    function closeReview(){ el.reviewModal.style.display='none'; if(gameState.currentIndex<gameState.data.length && !gameState.answered) startTimer() }
    function buildCategory(){ const cats=['all',...new Set(VOCAB_DATA.map(v=>v.category))]; el.category.innerHTML=cats.map(c=>`<option value="${c}">${c==='all'?'全部單字':c}</option>`).join(''); el.category.onchange=e=>drawList(e.target.value) }
    function drawList(cat){ const list=cat==='all'?VOCAB_DATA:VOCAB_DATA.filter(v=>v.category===cat); el.vocabCount.textContent=list.length; el.reviewList.innerHTML=''; if(cat!=='all'){ const h=document.createElement('div'); h.style.cssText='color:#0ff;font-size:1.2rem;font-weight:700;margin:10px 0;padding:8px;background:rgba(0,255,255,.1);border-radius:8px;text-align:center'; h.textContent=`📂 ${cat} (${list.length}個單字)`; el.reviewList.appendChild(h) }
      list.forEach((item,i)=>{ const d=document.createElement('div'); d.style.cssText='background:rgba(255,255,255,.1);border:1px solid var(--gold);border-radius:10px;padding:14px;margin:10px 0;text-align:left;cursor:pointer;transition:.2s'; d.innerHTML=`<div style="display:flex;align-items:flex-start;gap:15px;"> <div style="flex:1;min-width:0;"> <div style="color:var(--gold);font-size:1.1rem;font-weight:700;margin-bottom:6px;word-break:break-word;">${i+1}. ${item.word}${cat==='all'?` <span style="color:#0ff;font-size:.8rem;background:rgba(0,255,255,.2);padding:2px 6px;border-radius:4px;margin-left:8px;">${item.category}</span>`:''}</div> <div style="color:#fff;font-size:1rem;margin-bottom:6px;word-break:break-word;">${item.zh}</div> <div style="color:#0ff;font-size:.9rem;font-style:italic;word-break:break-word;">${item.en_sentence}</div> </div> <button class="speakWord" data-w="${item.word}" style="background:var(--cyan);color:#000;border:none;border-radius:50%;width:45px;height:45px;font-size:1.2rem;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,255,255,.3)">🔊</button> </div>`; d.addEventListener('mouseenter',()=>{d.style.background='rgba(255,215,0,.2)';d.style.transform='scale(1.02)'}); d.addEventListener('mouseleave',()=>{d.style.background='rgba(255,255,255,.1)';d.style.transform='scale(1)'}); d.addEventListener('click',()=>speakWord(item.word)); el.reviewList.appendChild(d) });
      qsa('.speakWord',el.reviewList).forEach(b=>b.onclick=e=>{ e.stopPropagation(); speakWord(e.currentTarget.dataset.w) })
      if(!list.length){ el.reviewList.innerHTML='<div style="text-align:center;color:#888;font-size:1.05rem;padding:32px;font-style:italic;">此分類暫無單字</div>' }
    }
    function speakWord(w){ if(!window.speechSynthesis) return; const u=new SpeechSynthesisUtterance(w); u.lang='en-US';u.rate=.9;u.pitch=1.1; if(gameState.preferredVoice) u.voice=gameState.preferredVoice; speechSynthesis.cancel(); speechSynthesis.speak(u) }

    // ===== 統計與匯出 =====
    function showStats(){ const stats={}; VOCAB_DATA.forEach(v=>stats[v.category]=(stats[v.category]||0)+1); const modal=document.createElement('div'); modal.className='modal'; modal.innerHTML=`<div class='modal-content' style='max-width:600px;'><div class='end-icon'>📊</div><h2>字庫統計</h2><div style='text-align:left;margin:16px 0;'>${Object.entries(stats).map(([k,c])=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,215,0,.3)"><span style='color:#fff'>${k}</span><span style='color:#0ff;font-weight:700'>${c} 個單字</span></div>`).join('')}<div style='display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-top:2px solid var(--gold);margin-top:10px;font-weight:700'><span style='color:var(--gold)'>總計</span><span style='color:var(--gold)'>${VOCAB_DATA.length} 個單字</span></div></div><div class='end-buttons'><button id='statsClose'>關閉</button></div></div>`; modal.onclick=e=>{ if(e.target===modal) modal.remove() }; modal.querySelector('#statsClose').onclick=()=>modal.remove(); document.body.appendChild(modal) }
    function exportCSV(){ const csv=[['單字','中文','英文例句','中文例句','分類'],...VOCAB_DATA.map(v=>[v.word,v.zh,v.en_sentence,v.zh_sentence,v.category])].map(r=>r.map(c=>`"${c}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`poseidon_vocabulary_${new Date().toISOString().split('T')[0]}.csv`; a.style.visibility='hidden'; document.body.appendChild(a); a.click(); a.remove(); notify('✅ 字庫已成功匯出！','success') }
    function notify(msg,type='info'){ const n=document.createElement('div'); n.style.cssText=`position:fixed;top:20px;left:50%;transform:translateX(-50%);background:${type==='success'?'#4caf50':'#2196f3'};color:#fff;padding:10px 18px;border-radius:8px;font-weight:700;z-index:10000;animation:slideDown .3s ease-out`; n.textContent=msg; const st=document.createElement('style'); st.textContent='@keyframes slideDown{from{transform:translateX(-50%) translateY(-100%);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}'; document.head.appendChild(st); document.body.appendChild(n); setTimeout(()=>{n.remove();st.remove()},2500) }

    // ===== 綁定事件 =====
    el.bgBtn.onclick=()=>gameState.isMusicPlaying?pauseMusic():playMusic();
    el.resetBtn.onclick=()=>location.reload();
    el.reviewBtn.onclick=openReview; el.closeReviewBtn.onclick=closeReview; el.statsBtn.onclick=showStats; el.exportBtn.onclick=exportCSV; el.restartBtn.onclick=restart;
    [el.reviewModal,el.endModal].forEach(m=>m&&m.addEventListener('click',e=>{ if(e.target===m) m.style.display='none' }));

    // ===== 啟動 =====
    if('speechSynthesis' in window){ speechSynthesis.onvoiceschanged=pickVoice; pickVoice() }
    el.totalStars.textContent=loadStars(); el.sessionStars.textContent='本次已獲得 0 顆星星';
    initData(); gameState.currentIndex=0; updateCounter(); showQuestion();
    const remembered=localStorage.getItem('bgMusicState'); if(remembered==='playing') playMusic(); else { el.bgBtn.textContent='🔇'; el.bgBtn.classList.add('paused') }
    lockReview(true);
  })();
  </script>
</body>
</html>
