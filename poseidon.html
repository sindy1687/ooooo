<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>å¡«ç©ºæŒ‘æˆ° - è‹±æ‰“å°è‹±é›„</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="responsive_enhanced.css" />
  <style>
    /* â€”â€” ç²¾ç°¡æ¨£å¼ï¼Œä¿ç•™åŸè¦–è¦º â€”â€” */
    :root{--gold:#ffd700;--cyan:#0ff;--bg1:#232526;--bg2:#414345}
    *{box-sizing:border-box;max-width:100%}
    html,body{margin:0;padding:0}
    body{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;text-align:center;font-family:'Segoe UI',Arial,sans-serif,'Orbitron',sans-serif;background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);color:#fff;overflow-x:hidden}
    h1{color:var(--gold);text-shadow:0 0 8px var(--gold);letter-spacing:2px;font-family:'Orbitron',Arial,sans-serif;font-size:2.2rem;margin:60px 0 20px}
    #bgMusicControl{position:fixed;bottom:20px;right:20px;background:rgba(255,215,0,.9);color:#000;border:none;border-radius:50%;width:50px;height:50px;font-size:1.5rem;cursor:pointer;z-index:12;box-shadow:0 0 12px rgba(255,215,0,.4);transition:.3s;display:flex;align-items:center;justify-content:center}
    #bgMusicControl:hover{background:rgba(255,215,0,1);transform:scale(1.1);box-shadow:0 0 20px rgba(255,215,0,.6)}
    #bgMusicControl.paused{background:rgba(255,255,255,.3);color:#fff}
    .top-btns{position:fixed;top:20px;right:20px;display:flex;gap:8px;z-index:11}
    .top-btns button,button{padding:10px 22px;font-size:1rem;background:var(--gold);color:#000;border:none;border-radius:12px;cursor:pointer;box-shadow:0 2px 8px #0003;font-family:'Orbitron',Arial,sans-serif}
    .top-btns button:hover{background:#ffe54f}
    #submit-btn{background:var(--gold);color:#111}
    #submit-btn:disabled{background:#ccc;color:#888;cursor:not-allowed}
    #skip-btn{background:#bbb;color:#222}
    #skip-btn:hover{background:#ccc}
    #speak-btn{background:var(--cyan);color:#111;margin-top:10px}
    #speak-btn:disabled{background:#555;color:#888}
    #next-btn{background:#4caf50;color:#fff;margin-top:10px}
    #next-btn:hover{background:#6fdc7f}
    #starsDisplay{position:fixed;top:20px;left:20px;background:rgba(10,20,40,.85);padding:8px 14px;border-radius:10px;color:var(--gold);font-weight:700;box-shadow:0 0 12px var(--gold),0 0 32px var(--cyan);border:2px solid var(--cyan);font-size:1.2rem;z-index:10}
    #lives{position:fixed;top:76px;right:20px;padding:8px 14px;border-radius:10px;box-shadow:0 0 12px var(--gold),0 0 32px var(--cyan);border:2px solid var(--cyan);color:var(--gold);font-size:1.2rem;font-weight:700;z-index:10;background:rgba(10,20,40,.85);font-family:'Orbitron',Arial,sans-serif}
    #star-counter{display:flex;align-items:center;justify-content:center;gap:18px;background:rgba(30,30,40,.92);border-radius:18px;box-shadow:0 4px 18px rgba(31,38,135,.18);padding:14px 32px;margin-bottom:18px;border:1.5px solid #ffd70044;font-size:1.18rem;color:var(--gold);min-width:260px}
    #timer{font-size:1.1rem;margin-bottom:16px}
    #timer.hidden{display:none}
    #question-container{background:rgba(30,30,40,.97);border-radius:22px;box-shadow:0 8px 32px rgba(31,38,135,.37);padding:34px 26px 26px;max-width:440px;width:100%;margin:auto 0 18px;border:1.5px solid #ffd70044;display:flex;flex-direction:column;align-items:center}
    .question-title{font-size:1.05rem;margin-bottom:8px;letter-spacing:1px}
    .question-sentence{font-size:1.6rem;font-weight:700;margin:8px 0 16px;line-height:1.5;word-break:break-word}
    .question-sentence .blank{color:var(--cyan);background:#fff2;border-radius:8px;padding:2px 12px;box-shadow:0 1px 4px #0ff2}
    .question-zh{color:var(--gold);margin-bottom:12px;font-size:1.02rem}
    input{width:92%;padding:14px;font-size:1.1rem;border:2px solid var(--gold);border-radius:14px;background:#222;color:#fff;margin-bottom:18px;box-shadow:0 2px 8px #0003;outline:none}
    input:focus{border-color:var(--cyan)}
    .btn-row{display:flex;justify-content:center;gap:14px;margin-bottom:10px;width:100%}
    #feedback{margin-top:10px;font-size:1.08rem;min-height:28px}
    .feedback-box{display:inline-block;padding:10px 18px;border-radius:14px;font-size:1.08rem;font-weight:700;box-shadow:0 2px 16px #0004;margin-top:6px;transition:.3s;animation:popfade .7s cubic-bezier(.68,-.55,.27,1.55)}
    .feedback-correct{background:linear-gradient(90deg,#2ecc40,#bfff00);color:#222}
    .feedback-wrong{background:linear-gradient(90deg,#ff4f4f,#ffbaba);color:#fff}
    .feedback-bonus{color:var(--gold);animation:bonusflash 1s infinite alternate;font-size:1.15em}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;justify-content:center;align-items:center;z-index:1000;backdrop-filter:blur(4px)}
    .modal-content{background:rgba(30,30,40,.95);border:2px solid var(--gold);border-radius:20px;padding:32px;text-align:center;max-width:520px;width:90%;box-shadow:0 0 32px #ffd70044,0 0 80px #00ffff22 inset;animation:modalPop .5s cubic-bezier(.68,-.55,.27,1.55)}
    .end-buttons{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    .end-buttons button{background:linear-gradient(90deg,#ffd700,#ffed4e);color:#000;padding:12px 20px;font-size:1.05rem;font-weight:700}
    .end-icon{font-size:3.5rem;margin-bottom:12px;animation:tada 1.2s infinite}
    @keyframes popfade{0%{transform:scale(.7);opacity:0}60%{transform:scale(1.15);opacity:1}100%{transform:scale(1)}}
    @keyframes bonusflash{0%{text-shadow:0 0 8px var(--gold)}100%{text-shadow:0 0 24px #fff700}}
    @keyframes modalPop{0%{transform:scale(.7);opacity:0}60%{transform:scale(1.1);opacity:1}100%{transform:scale(1)}}
    @keyframes tada{0%{transform:scale(1)}10%,20%{transform:scale(.9) rotate(-3deg)}30%,50%,70%,90%{transform:scale(1.1) rotate(3deg)}40%,60%,80%{transform:scale(1.1) rotate(-3deg)}100%{transform:scale(1) rotate(0)}}
    @media (max-width:768px){.top-btns{top:10px;right:10px;gap:6px;flex-wrap:wrap;justify-content:flex-end}.top-btns button{padding:4px 8px;font-size:.9rem}#starsDisplay{top:10px;left:10px;padding:6px 10px;font-size:1rem}#lives{top:62px;right:10px;padding:6px 10px;font-size:1rem}h1{font-size:1.8rem;margin-top:60px}#question-container{max-width:95vw;padding:20px 15px;margin:10px auto}.question-sentence{font-size:1.3rem}.modal-content{padding:20px;margin:10px;max-width:95vw}.end-buttons{flex-direction:column;gap:10px}.end-buttons button{width:100%;padding:10px}}
    @media (max-width:480px){body{padding:10px}.top-btns{position:relative;justify-content:center;margin-bottom:15px}#starsDisplay{position:relative;display:inline-block;margin-bottom:10px}h1{font-size:1.5rem;margin-top:10px}#star-counter{font-size:1rem;padding:10px 20px;min-width:200px}.question-sentence{font-size:1.1rem}input{font-size:1rem;padding:12px}.btn-row{flex-direction:column;gap:10px}.btn-row button{width:100%}}
  </style>
</head>
<body>
  <button id="bgMusicControl" onclick="toggleBackgroundMusic()" title="èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶">ğŸµ</button>

  <div id="starsDisplay">â­<span id="totalStarsCount">0</span></div>
  <div id="lives">â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</div>

  <div class="top-btns">
    <button onclick="location.href='atlas.html?tab=greek'">ğŸ  å›é¦–é </button>
    <button onclick="resetProgress()">ğŸ”„ é‡æ–°é–‹å§‹</button>
    <button onclick="showReviewModal()">ğŸ“š è¤‡ç¿’å–®å­—</button>
  </div>

  <h1>æ³¢å¡é “ Poseidon - å¡«ç©ºæŒ‘æˆ°</h1>
  <div id="sessionStarsDisplay" style="margin-bottom:10px;color:var(--gold);font-weight:bold;font-size:1.08rem;">æœ¬æ¬¡å·²ç²å¾— 0 é¡†æ˜Ÿæ˜Ÿ</div>
  <div id="star-counter">ç¬¬ <span id="current-index">0</span> / <span id="total-questions">0</span> é¡Œ</div>
  <div id="timer" class="hidden">â³ å€’æ•¸ï¼š<span id="time-left">0</span> ç§’</div>
  <div id="question-container"></div>

  <!-- éŠæˆ²çµæŸ -->
  <div id="gameEndModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="end-icon">ğŸ‰</div>
      <h2 style="color:var(--gold);text-shadow:0 0 12px var(--gold);font-family:'Orbitron',Arial,sans-serif">éŠæˆ²å®Œæˆï¼</h2>
      <div class="end-stats">
        <p>â­ æœ¬æ¬¡ç²å¾—æ˜Ÿæ˜Ÿï¼š<span id="endSessionStars">0</span></p>
        <p>âœ… ç­”å°é¡Œæ•¸ï¼š<span id="endCorrectCount">0</span></p>
        <p>âŒ ç­”éŒ¯é¡Œæ•¸ï¼š<span id="endWrongCount">0</span></p>
        <p>â­ ç´¯ç©ç¸½æ˜Ÿæ˜Ÿï¼š<span id="endTotalStars">0</span></p>
      </div>
      <div class="end-buttons">
        <button onclick="restartGame()">ğŸ”„ é‡æ–°é–‹å§‹</button>
        <button onclick="location.href='atlas.html?tab=greek'">ğŸ  è¿”å›é¦–é </button>
      </div>
    </div>
  </div>

  <!-- å–®å­—è¤‡ç¿’ -->
  <div id="reviewModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="end-icon">ğŸ“š</div>
      <h2>å–®å­—è¤‡ç¿’</h2>
      <div style="margin-bottom:20px;">
        <label for="categoryFilter" style="color:var(--gold);font-weight:700;margin-right:10px;">é¸æ“‡åˆ†é¡ï¼š</label>
        <select id="categoryFilter" style="background:#222;color:#fff;border:2px solid var(--gold);border-radius:8px;padding:8px 12px;font-size:1rem;cursor:pointer">
          <option value="all">å…¨éƒ¨å–®å­—</option>
          <option value="å‹•ä½œå‹•è©">å‹•ä½œå‹•è©</option>
          <option value="å­¸è¡“æ•™è‚²">å­¸è¡“æ•™è‚²</option>
          <option value="æ™‚é–“æ—¥æœŸ">æ™‚é–“æ—¥æœŸ</option>
          <option value="ç¯€æ—¥æ…¶ç¥">ç¯€æ—¥æ…¶ç¥</option>
          <option value="æ•¸é‡åˆ†æ•¸">æ•¸é‡åˆ†æ•¸</option>
          <option value="è²éŸ³è¡¨æ¼”">è²éŸ³è¡¨æ¼”</option>
          <option value="ç¨±è¬‚äººéš›">ç¨±è¬‚äººéš›</option>
          <option value="äº¤é€šå·¥å…·">äº¤é€šå·¥å…·</option>
          <option value="é‹å‹•å¨›æ¨‚">é‹å‹•å¨›æ¨‚</option>
          <option value="èº«é«”å¥åº·">èº«é«”å¥åº·</option>
          <option value="å½¢å®¹è©">å½¢å®¹è©</option>
          <option value="æŠ½è±¡æ¦‚å¿µ">æŠ½è±¡æ¦‚å¿µ</option>
          <option value="å ´æ‰€ä½ç½®">å ´æ‰€ä½ç½®</option>
        </select>
      </div>
      <div id="vocabStats" style="background:rgba(255,215,0,.1);border:1px solid var(--gold);border-radius:8px;padding:10px;margin-bottom:15px;color:var(--gold);font-size:.9rem;">
        ç¸½å…± <span id="totalVocabCount">0</span> å€‹å–®å­—
        <button onclick="showVocabStats()" style="background:var(--cyan);color:#000;border:none;border-radius:6px;padding:4px 8px;font-size:.8rem;margin-left:10px;cursor:pointer">ğŸ“Š è©³ç´°çµ±è¨ˆ</button>
        <button onclick="exportVocabData()" style="background:#4caf50;color:#fff;border:none;border-radius:6px;padding:4px 8px;font-size:.8rem;margin-left:5px;cursor:pointer">ğŸ“¥ åŒ¯å‡ºå­—åº«</button>
      </div>
      <div id="reviewWordsContainer" style="max-height:400px;overflow-y:auto;margin:20px 0;"></div>
      <div class="end-buttons"><button onclick="closeReviewModal()">é—œé–‰</button></div>
    </div>
  </div>

  <div id="achievementNotifyModal" style="display:none;position:fixed;z-index:2000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;">
    <div style="background:linear-gradient(135deg,#232526 0%,#414345 100%);border-radius:18px;padding:36px 28px;box-shadow:0 0 32px #ffd700,0 0 80px #00ffff22 inset;max-width:90vw;width:350px;text-align:center;position:relative;">
      <div style="font-size:2.5rem;margin-bottom:12px;">ğŸ‰</div>
      <div id="achievementNotifyTitle" style="font-size:1.3rem;font-weight:bold;color:#ffd700;margin-bottom:8px;"></div>
      <div id="achievementNotifyDesc" style="font-size:1rem;color:#fff;margin-bottom:18px;"></div>
      <button onclick="window.location.href='achievement.html'" style="background:linear-gradient(90deg,#00ffff,#ffd700);color:#000;font-weight:bold;padding:10px 28px;border:none;border-radius:10px;font-size:1.1rem;box-shadow:0 0 12px #ffd700;cursor:pointer;margin-bottom:10px;">å‰å¾€æˆå°±é </button><br>
      <button onclick="document.getElementById('achievementNotifyModal').style.display='none'" style="background:#bbb;color:#222;padding:6px 18px;border:none;border-radius:8px;font-size:1rem;cursor:pointer;">é—œé–‰</button>
    </div>
  </div>

  <script src="js/utils.js"></script>
  <script src="js/bgmController.js"></script>
  <script src="js/userData.js"></script>
  <script src="js/characterDialogue.js"></script>
  <script src="js/gameDialogue.js"></script>
  <script src="js/greekScoreUpload.js"></script>

  <script>
    const GAME_CONFIG = { QUESTIONS_COUNT: 20, TIME_LIMIT: 30, MAX_ATTEMPTS: 3 };

    const VOCAB_DATA = [
      {
        "word": "something",
        "zh": "æŸäº‹ï¼›æŸç‰©",
        "en_sentence": "I want to tell you something important.",
        "zh_sentence": "æˆ‘æƒ³å‘Šè¨´ä½ ä¸€äº›é‡è¦çš„äº‹ã€‚",
        "category": "ä»£åè©"
      },
      {
        "word": "everything",
        "zh": "æ¯ä»¶äº‹",
        "en_sentence": "Everything in this room belongs to me.",
        "zh_sentence": "é€™å€‹æˆ¿é–“è£¡çš„æ¯æ¨£æ±è¥¿éƒ½å±¬æ–¼æˆ‘ã€‚",
        "category": "ä»£åè©"
      },
      {
        "word": "anything",
        "zh": "ä»»ä½•äº‹æƒ…",
        "en_sentence": "You can ask me anything you want.",
        "zh_sentence": "ä½ å¯ä»¥å•æˆ‘ä»»ä½•ä½ æƒ³å•çš„äº‹ã€‚",
        "category": "ä»£åè©"
      },
      {
        "word": "dodge ball",
        "zh": "èº²é¿çƒ",
        "en_sentence": "We play dodge ball during PE class.",
        "zh_sentence": "æˆ‘å€‘åœ¨é«”è‚²èª²æ™‚ç©èº²é¿çƒã€‚",
        "category": "é‹å‹•å¨›æ¨‚"
      },
      {
        "word": "tennis",
        "zh": "ç¶²çƒ",
        "en_sentence": "She plays tennis every weekend.",
        "zh_sentence": "å¥¹æ¯å€‹é€±æœ«éƒ½æ‰“ç¶²çƒã€‚",
        "category": "é‹å‹•å¨›æ¨‚"
      },
      {
        "word": "badminton",
        "zh": "ç¾½çƒ",
        "en_sentence": "We play badminton in the gym.",
        "zh_sentence": "æˆ‘å€‘åœ¨é«”è‚²é¤¨æ‰“ç¾½çƒã€‚",
        "category": "é‹å‹•å¨›æ¨‚"
      },
      {
        "word": "sport",
        "zh": "é‹å‹•",
        "en_sentence": "Basketball is my favorite sport.",
        "zh_sentence": "ç±ƒçƒæ˜¯æˆ‘æœ€å–œæ­¡çš„é‹å‹•ã€‚",
        "category": "é‹å‹•å¨›æ¨‚"
      },
      {
        "word": "player",
        "zh": "é¸æ‰‹ï¼›çƒå“¡",
        "en_sentence": "He is a good basketball player.",
        "zh_sentence": "ä»–æ˜¯ä¸€å€‹å¾ˆå¥½çš„ç±ƒçƒé¸æ‰‹ã€‚",
        "category": "é‹å‹•å¨›æ¨‚"
      },
      {
        "word": "skate",
        "zh": "æºœå†°",
        "en_sentence": "I learned to skate when I was young.",
        "zh_sentence": "æˆ‘å°æ™‚å€™å­¸æœƒäº†æºœå†°ã€‚",
        "category": "é‹å‹•å¨›æ¨‚"
      },
      {
        "word": "past",
        "zh": "éå»(çš„)",
        "en_sentence": "In the past, people didn't have smartphones.",
        "zh_sentence": "åœ¨éå»ï¼Œäººå€‘æ²’æœ‰æ™ºæ…§å‹æ‰‹æ©Ÿã€‚",
        "category": "æ™‚é–“æ—¥æœŸ"
      },
      {
        "word": "gym",
        "zh": "é«”è‚²é¤¨ï¼›å¥èº«æˆ¿",
        "en_sentence": "We have PE class in the gym.",
        "zh_sentence": "æˆ‘å€‘åœ¨é«”è‚²é¤¨ä¸Šé«”è‚²èª²ã€‚",
        "category": "å ´æ‰€ä½ç½®"
      },
      {
        "word": "rat",
        "zh": "è€é¼ ",
        "en_sentence": "A rat ran across the street.",
        "zh_sentence": "ä¸€éš»è€é¼ è·‘éè¡—é“ã€‚",
        "category": "å‹•ç‰©"
      },
      {
        "word": "hour",
        "zh": "å°æ™‚",
        "en_sentence": "It takes one hour to drive to the city.",
        "zh_sentence": "é–‹è»Šåˆ°åŸå¸‚éœ€è¦ä¸€å°æ™‚ã€‚",
        "category": "æ™‚é–“æ—¥æœŸ"
      },
      {
        "word": "story",
        "zh": "æ•…äº‹",
        "en_sentence": "My grandmother tells me bedtime stories.",
        "zh_sentence": "æˆ‘å¥¶å¥¶çµ¦æˆ‘è¬›ç¡å‰æ•…äº‹ã€‚",
        "category": "æŠ½è±¡æ¦‚å¿µ"
      },
      {
        "word": "centimeter",
        "zh": "å…¬åˆ†",
        "en_sentence": "The pencil is 15 centimeters long.",
        "zh_sentence": "é€™æ”¯é‰›ç­†é•·15å…¬åˆ†ã€‚",
        "category": "æ•¸é‡åˆ†æ•¸"
      },
      {
        "word": "sure",
        "zh": "ç¢ºå®šçš„(åœ°)",
        "en_sentence": "Are you sure you want to go?",
        "zh_sentence": "ä½ ç¢ºå®šè¦å»å—ï¼Ÿ",
        "category": "å½¢å®¹è©"
      },
      {
        "word": "only",
        "zh": "å”¯ä¸€çš„(åœ°)",
        "en_sentence": "She is the only child in her family.",
        "zh_sentence": "å¥¹æ˜¯å®¶è£¡å”¯ä¸€çš„å­©å­ã€‚",
        "category": "å½¢å®¹è©"
      },
      {
        "word": "wonderful",
        "zh": "ç¾å¥½çš„",
        "en_sentence": "We had a wonderful time at the party.",
        "zh_sentence": "æˆ‘å€‘åœ¨æ´¾å°ä¸Šåº¦éäº†ç¾å¥½çš„æ™‚å…‰ã€‚",
        "category": "å½¢å®¹è©"
      },
      {
        "word": "well",
        "zh": "å¥½åœ°",
        "en_sentence": "She sings very well.",
        "zh_sentence": "å¥¹å”±æ­Œå”±å¾—å¾ˆå¥½ã€‚",
        "category": "å‰¯è©"
      },
      {
        "word": "hey",
        "zh": "å˜¿ï¼›å–‚",
        "en_sentence": "Hey, what are you doing?",
        "zh_sentence": "å˜¿ï¼Œä½ åœ¨åšä»€éº¼ï¼Ÿ",
        "category": "ç¨±è¬‚äººéš›"
      },
      {
        "word": "catch",
        "zh": "è¶•ä¸Šï¼›æ¥",
        "en_sentence": "I need to catch the bus to school.",
        "zh_sentence": "æˆ‘éœ€è¦è¶•ä¸Šå…¬è»Šå»å­¸æ ¡ã€‚",
        "category": "å‹•ä½œå‹•è©"
      },
      {
        "word": "count",
        "zh": "è¨ˆç®—",
        "en_sentence": "Please count the number of students.",
        "zh_sentence": "è«‹è¨ˆç®—å­¸ç”Ÿäººæ•¸ã€‚",
        "category": "å‹•ä½œå‹•è©"
      },
      {
        "word": "hold",
        "zh": "æ‹¿è‘—ï¼›æŠ±ä½",
        "en_sentence": "Hold my hand when we cross the street.",
        "zh_sentence": "éé¦¬è·¯æ™‚ç‰½è‘—æˆ‘çš„æ‰‹ã€‚",
        "category": "å‹•ä½œå‹•è©"
      },
      {
        "word": "carry",
        "zh": "æ¬é‹ï¼›æ”œå¸¶",
        "en_sentence": "I carry my backpack to school every day.",
        "zh_sentence": "æˆ‘æ¯å¤©èƒŒæ›¸åŒ…å»å­¸æ ¡ã€‚",
        "category": "å‹•ä½œå‹•è©"
      },
      {
        "word": "love",
        "zh": "å–œæ„›",
        "en_sentence": "I love playing basketball.",
        "zh_sentence": "æˆ‘å–œæ­¡æ‰“ç±ƒçƒã€‚",
        "category": "å‹•ä½œå‹•è©"
      },
      {
        "word": "kiss",
        "zh": "è¦ªå»",
        "en_sentence": "She gave her baby a kiss goodnight.",
        "zh_sentence": "å¥¹çµ¦å¯¶å¯¶ä¸€å€‹æ™šå®‰å»ã€‚",
        "category": "å‹•ä½œå‹•è©"
      },
      {
        "word": "else",
        "zh": "å…¶ä»–",
        "en_sentence": "Is there anything else you want to say?",
        "zh_sentence": "é‚„æœ‰å…¶ä»–ä½ æƒ³èªªçš„å—ï¼Ÿ",
        "category": "å‰¯è©"
      },
      {
        "word": "may",
        "zh": "å¯ä»¥ï¼›å¯èƒ½",
        "en_sentence": "May I borrow your pen?",
        "zh_sentence": "æˆ‘å¯ä»¥å€Ÿä½ çš„ç­†å—ï¼Ÿ",
        "category": "åŠ©å‹•è©"
      },
      {
        "word": "before",
        "zh": "åœ¨â€¦ä¹‹å‰",
        "en_sentence": "Please finish your homework before dinner.",
        "zh_sentence": "è«‹åœ¨æ™šé¤å‰å®Œæˆä½œæ¥­ã€‚",
        "category": "ä»‹ç³»è©"
      },
      {
        "word": "after",
        "zh": "åœ¨â€¦ä¹‹å¾Œ",
        "en_sentence": "We will go to the park after school.",
        "zh_sentence": "æ”¾å­¸å¾Œæˆ‘å€‘æœƒå»å…¬åœ’ã€‚",
        "category": "ä»‹ç³»è©"
      },
      {
        "word": "about",
        "zh": "å¤§ç´„ï¼›é—œæ–¼",
        "en_sentence": "Tell me about your new school.",
        "zh_sentence": "å‘Šè¨´æˆ‘é—œæ–¼ä½ çš„æ–°å­¸æ ¡ã€‚",
        "category": "ä»‹ç³»è©"
      },
      {
        "word": "or",
        "zh": "æˆ–è€…ï¼›å¦å‰‡",
        "en_sentence": "Do you want tea or coffee?",
        "zh_sentence": "ä½ æƒ³è¦èŒ¶é‚„æ˜¯å’–å•¡ï¼Ÿ",
        "category": "é€£æ¥è©"
      },
      {
        "word": "off",
        "zh": "è„«ä¸‹ï¼›é›¢å»",
        "en_sentence": "Please take off your shoes before entering.",
        "zh_sentence": "è«‹åœ¨é€²å…¥å‰è„«ä¸‹é‹å­ã€‚",
        "category": "å‰¯è©"
      },
      {
        "word": "noodle",
        "zh": "éºµæ¢",
        "en_sentence": "I like to eat noodle soup.",
        "zh_sentence": "æˆ‘å–œæ­¡åƒéºµæ¢æ¹¯ã€‚",
        "category": "é£Ÿç‰©"
      },
      {
        "word": "chocolate",
        "zh": "å·§å…‹åŠ›",
        "en_sentence": "She loves dark chocolate.",
        "zh_sentence": "å¥¹å–œæ­¡é»‘å·§å…‹åŠ›ã€‚",
        "category": "é£Ÿç‰©"
      },
      {
        "word": "shake",
        "zh": "æ–å‹•",
        "en_sentence": "Shake the bottle before drinking.",
        "zh_sentence": "å–ä¹‹å‰æ–å‹•ç“¶å­ã€‚",
        "category": "å‹•ä½œå‹•è©"
      },
      {
        "word": "sugar",
        "zh": "ç³–",
        "en_sentence": "Add some sugar to your coffee.",
        "zh_sentence": "åœ¨ä½ çš„å’–å•¡è£¡åŠ ä¸€äº›ç³–ã€‚",
        "category": "é£Ÿç‰©"
      },
      {
        "word": "meal",
        "zh": "é¤",
        "en_sentence": "Breakfast is the most important meal of the day.",
        "zh_sentence": "æ—©é¤æ˜¯ä¸€å¤©ä¸­æœ€é‡è¦çš„ä¸€é¤ã€‚",
        "category": "é£Ÿç‰©"
      },
      {
        "word": "bottle",
        "zh": "ç“¶å­",
        "en_sentence": "I drink water from a bottle.",
        "zh_sentence": "æˆ‘å¾ç“¶å­è£¡å–æ°´ã€‚",
        "category": "é£Ÿç‰©"
      },
      {
        "word": "plate",
        "zh": "ç›¤å­",
        "en_sentence": "Put the food on the plate.",
        "zh_sentence": "æŠŠé£Ÿç‰©æ”¾åœ¨ç›¤å­ä¸Šã€‚",
        "category": "é£Ÿç‰©"
      }
    ];


    let gameState = {
      data: [],
      currentIndex: 0,
      attemptCount: 0,
      answered: false,
      timerInterval: null,
      preferredVoice: null,
      answerLog: [],
      sessionStars: 0,
      totalTimeUsed: 0,
      questionStartTs: null
    };

    window.gameState = gameState;

    let lives = 5;

    function updateLives() {
      const el = document.getElementById('lives');
      if (!el) return;
      el.innerHTML = 'â¤ï¸'.repeat(Math.max(0, lives)) + 'ğŸ¤'.repeat(Math.max(0, 5 - lives));
    }

    const SOUNDS = {
      correct: new Audio('sound/correct.mp3'),
      wrong: new Audio('sound/wrong.mp3'),
      type: new Audio('sound/type.mp3')
    };

    let bgMusic = null;
    let isMusicPlaying = false;

    function initBackgroundMusic() {
      bgMusic = new Audio('sound/åˆå¾Œæ”¾é¬†æ™‚å…‰ï¼ˆç´”éŸ³æ¨‚ï¼‰.mp3');
      bgMusic.loop = true;
      bgMusic.volume = 0.3;

      const musicState = localStorage.getItem('bgMusicState');
      if (musicState === 'playing') {
        playBackgroundMusic();
      }
    }

    function toggleBackgroundMusic() {
      if (isMusicPlaying) pauseBackgroundMusic();
      else playBackgroundMusic();
    }

    function playBackgroundMusic() {
      if (!bgMusic) return;
      bgMusic.play().then(() => {
        isMusicPlaying = true;
        const btn = document.getElementById('bgMusicControl');
        if (btn) {
          btn.textContent = 'ğŸ”Š';
          btn.classList.remove('paused');
        }
        localStorage.setItem('bgMusicState', 'playing');
      }).catch(() => {});
    }

    function pauseBackgroundMusic() {
      if (!bgMusic) return;
      bgMusic.pause();
      isMusicPlaying = false;
      const btn = document.getElementById('bgMusicControl');
      if (btn) {
        btn.textContent = 'ğŸ”‡';
        btn.classList.add('paused');
      }
      localStorage.setItem('bgMusicState', 'paused');
    }

    function escapeRegExp(s) {
      return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function getRandomQuestions(arr, n) {
      const count = Math.min(n, arr.length);
      return arr.slice().sort(() => Math.random() - 0.5).slice(0, count);
    }

    function initData() {
      const selected = getRandomQuestions(VOCAB_DATA, GAME_CONFIG.QUESTIONS_COUNT);
      gameState.data = selected.map(item => ({
        answer: item.word,
        zh: item.zh,
        sentence: item.en_sentence.replace(new RegExp(escapeRegExp(item.word), 'i'), '___'),
        original: item.en_sentence,
        zh_sentence: item.zh_sentence,
        category: item.category
      }));
      document.getElementById('total-questions').textContent = gameState.data.length;
    }

    function saveProgress() {
      localStorage.setItem('fillIndex', gameState.currentIndex);
    }

    function loadProgress() {
      gameState.currentIndex = parseInt(localStorage.getItem('fillIndex')) || 0;
      if (Array.isArray(gameState.data) && gameState.currentIndex >= gameState.data.length) {
        gameState.currentIndex = 0;
        localStorage.removeItem('fillIndex');
      }
    }

    function resetProgress() {
      localStorage.removeItem('fillIndex');
      location.reload();
    }

    function updateCounter() {
      document.getElementById('current-index').textContent = gameState.currentIndex + 1;
    }

    function startTimer() {
      clearInterval(gameState.timerInterval);
      let timeLeft = GAME_CONFIG.TIME_LIMIT;
      document.getElementById('time-left').textContent = timeLeft;
      document.getElementById('timer').classList.remove('hidden');
      gameState.questionStartTs = Date.now();
      gameState.timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('time-left').textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(gameState.timerInterval);
          revealAnswer(true);
        }
      }, 1000);
    }

    function stopTimer() {
      clearInterval(gameState.timerInterval);
      if (gameState.questionStartTs) {
        const deltaSec = Math.max(0, Math.round((Date.now() - gameState.questionStartTs) / 1000));
        gameState.totalTimeUsed = (Number(gameState.totalTimeUsed) || 0) + deltaSec;
        gameState.questionStartTs = null;
      }
    }

    function pickVoice() {
      const voices = window.speechSynthesis.getVoices();
      const prefer = ['Google US English', 'Microsoft Aria Online', 'Microsoft Jenny Online', 'Samantha', 'Jenny', 'Aria', 'en-US'];
      gameState.preferredVoice = voices.find(v => prefer.some(p => v.name.includes(p))) || voices.find(v => v.lang === 'en-US') || voices[0];
    }

    function speak(text, rate = 1.0, callback) {
      if (!window.speechSynthesis) return;
      const utter = new window.SpeechSynthesisUtterance(text);
      utter.lang = 'en-US';
      utter.rate = rate;
      utter.pitch = 1.12;
      if (gameState.preferredVoice) utter.voice = gameState.preferredVoice;
      if (callback) utter.onend = callback;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    function speakQuestionAndWord(question) {
      window.speechSynthesis.cancel();
      speak(question.original, 0.97, function() {
        setTimeout(() => {
          speak(question.original.replace(new RegExp(escapeRegExp(question.answer), 'i'), '...'), 1.02, function() {
            setTimeout(() => speak(question.answer, 1.08), 350);
          });
        }, 350);
      });
    }

    function revealAnswer(autoNext = false) {
      stopTimer();
      gameState.attemptCount = Infinity;
      document.getElementById('feedback').innerHTML = '<span style="color:#f66;">â° æ™‚é–“åˆ°ï¼æ­£ç¢ºç­”æ¡ˆï¼š<b>' + gameState.data[gameState.currentIndex].answer + '</b></span>';
      document.getElementById('submit-btn').disabled = true;
      document.getElementById('user-input').disabled = true;
      logAnswer(false);
      if (autoNext) {
        setTimeout(() => {
          lives--;
          updateLives();
          if (lives <= 0) {
            showGameEndScreen();
            return;
          }
          gameState.currentIndex++;
          showQuestion();
        }, 500);
      }
    }

    function logAnswer(correct, userAnswer = '') {
      const currentQuestion = gameState.data[gameState.currentIndex];
      gameState.answerLog[gameState.currentIndex] = {
        word: currentQuestion.answer,
        zh: currentQuestion.zh_sentence || currentQuestion.zh,
        en: currentQuestion.original,
        user: userAnswer,
        correct: correct,
        stars: 0,
        category: currentQuestion.category
      };
    }

    function showQuestion() {
      if (!gameState.data || !Array.isArray(gameState.data) || gameState.data.length === 0) {
        document.getElementById('question-container').innerHTML = '<div style="color:#f66;font-size:1.2rem;">âš ï¸ é¡Œåº«æ²’æœ‰é¡Œç›®ï¼Œè«‹æª¢æŸ¥è³‡æ–™ï¼</div>';
        return;
      }
      if (gameState.currentIndex < 0 || gameState.currentIndex >= gameState.data.length) {
        showGameEndScreen();
        return;
      }
      gameState.answered = false;
      gameState.attemptCount = 0;
      const question = gameState.data[gameState.currentIndex];

      document.getElementById('question-container').innerHTML =
        '<div class="question-title">è‹±æ–‡å¥å­ï¼š</div>' +
        '<div class="question-sentence">' + question.sentence.replace('___', '<span class="blank">___</span>') + '</div>' +
        '<div class="question-zh">ä¸­æ–‡æç¤ºï¼š' + (question.zh_sentence || question.zh) + '</div>' +
        '<input id="user-input" placeholder="è¼¸å…¥ç­”æ¡ˆâ€¦" autocomplete="off" />' +
        '<div class="btn-row">' +
          '<button id="submit-btn" onclick="checkAnswer()">é€å‡º</button>' +
          '<button id="skip-btn" onclick="skipQuestion()">è·³é</button>' +
          '<button id="next-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>' +
        '</div>' +
        '<div id="feedback"></div>' +
        '<button id="speak-btn" onclick="speakQuestionAndWord(question)">ğŸ”Š æœ—è®€</button>';

      const inputEl = document.getElementById('user-input');
      inputEl.focus();
      inputEl.onkeydown = function(e) {
        if (e.key === 'Enter') {
          checkAnswer();
        } else if (e.key.length === 1) {
          try {
            SOUNDS.type.currentTime = 0;
            SOUNDS.type.play();
          } catch (e) {}
        }
      };

      updateCounter();
      startTimer();
      setTimeout(() => speak(question.original, 0.97), 400);

      window.answerStartTime = Date.now();
      lockReviewButton();
    }

    function showGameEndScreen() {
      const correctCount = gameState.answerLog.filter(log => log && log.correct === true).length;
      const wrongCount = gameState.answerLog.filter(log => log && log.correct === false).length;
      const totalStars = loadTotalStars();

      document.getElementById('endSessionStars').textContent = gameState.sessionStars;
      document.getElementById('endCorrectCount').textContent = correctCount;
      document.getElementById('endWrongCount').textContent = wrongCount;
      document.getElementById('endTotalStars').textContent = totalStars;

      document.getElementById('gameEndModal').style.display = 'flex';
      stopTimer();
      unlockReviewButton();
      try {
        SOUNDS.correct.currentTime = 0;
        SOUNDS.correct.play();
      } catch (e) {}

      if (window.GameDialogue) {
        setTimeout(() => {
          if (correctCount > wrongCount) {
            window.GameDialogue.showGameVictoryDialogue();
          } else {
            window.GameDialogue.showGameDefeatDialogue();
          }
        }, 2000);
      }
    }

    function restartGame() {
      document.getElementById('gameEndModal').style.display = 'none';

      gameState.currentIndex = 0;
      gameState.sessionStars = 0;
      gameState.answerLog = [];
      gameState.totalTimeUsed = 0;
      gameState.questionStartTs = null;
      window.gameState = gameState;

      lives = 5;
      updateLives();

      initData();
      updateCounter();
      showQuestion();

      document.getElementById('sessionStarsDisplay').textContent = 'æœ¬æ¬¡å·²ç²å¾— 0 é¡†æ˜Ÿæ˜Ÿ';
    }

    function skipQuestion() {
      stopTimer();
      if (!gameState.answerLog[gameState.currentIndex]) {
        logAnswer(false, '');
      }
      const feedback = document.getElementById('feedback');
      if (feedback) feedback.innerHTML = '<span style="color:#bbb;">å·²è·³éæœ¬é¡Œ</span>';
      setTimeout(() => {
        lives--;
        updateLives();
        if (lives <= 0) {
          showGameEndScreen();
          return;
        }
        gameState.currentIndex++;
        showQuestion();
      }, 400);
    }

    function nextQuestion() {
      stopTimer();
      if (!gameState.answerLog[gameState.currentIndex]) {
        logAnswer(false, document.getElementById('user-input')?.value || '');
        const feedback = document.getElementById('feedback');
        if (feedback) feedback.innerHTML = '<span style="color:#bbb;">æœªä½œç­”</span>';
      }
      setTimeout(() => {
        lives--;
        updateLives();
        if (lives <= 0) {
          showGameEndScreen();
          return;
        }
        gameState.currentIndex++;
        showQuestion();
      }, 400);
    }

    function checkAnswer() {
      if (gameState.answered) return;
      gameState.attemptCount++;

      const inputEl = document.getElementById('user-input');
      const feedback = document.getElementById('feedback');
      const answer = gameState.data[gameState.currentIndex].answer.toLowerCase();
      const userAnswer = inputEl.value.trim().toLowerCase();

      if (userAnswer === answer) {
        gameState.answered = true;
        stopTimer();

        const usedSeconds = (Date.now() - (window.answerStartTime || Date.now())) / 1000;
        let bonus = 0;
        let feedbackMsg = '<div class="feedback-box feedback-correct">âœ… ç­”å°äº†ï¼å¤ªæ£’äº†ï¼';
        if (usedSeconds < 10) {
          bonus = 2;
          feedbackMsg += ' <span class="feedback-bonus">BONUS! â±ï¸ +2</span>';
        }
        feedbackMsg += '</div>';

        feedback.innerHTML = feedbackMsg;
        inputEl.disabled = true;
        document.getElementById('submit-btn').disabled = true;

        speak(answer, 1.1);
        logAnswer(true, inputEl.value.trim());

        saveProgress();
        updateCounter();

        const addStars = 1 + bonus;
        addStarsToTotal(addStars);
        gameState.sessionStars += addStars;
        document.getElementById('sessionStarsDisplay').textContent = 'æœ¬æ¬¡å·²ç²å¾— ' + gameState.sessionStars + ' é¡†æ˜Ÿæ˜Ÿ';

        try {
          SOUNDS.correct.currentTime = 0;
          SOUNDS.correct.play();
        } catch (e) {}

        if (window.GameDialogue) {
          window.GameDialogue.showCorrectAnswerDialogue();
        }

        setTimeout(() => {
          gameState.currentIndex++;
          showQuestion();
        }, 1300);
      } else {
        if (gameState.attemptCount < GAME_CONFIG.MAX_ATTEMPTS) {
          feedback.innerHTML = '<div class="feedback-box feedback-wrong">âŒ å†è©¦ä¸€æ¬¡ï¼ä½ å¯ä»¥çš„ï¼</div>';
          try {
            SOUNDS.wrong.currentTime = 0;
            SOUNDS.wrong.play();
          } catch (e) {}
        } else {
          feedback.innerHTML = '<div class="feedback-box feedback-wrong">âŒ æ­£ç¢ºç­”æ¡ˆï¼š<b>' + gameState.data[gameState.currentIndex].answer + '</b><br>åˆ¥æ°£é¤’ï¼Œå†æ¥å†å²ï¼</div>';
          inputEl.disabled = true;
          document.getElementById('submit-btn').disabled = true;
          logAnswer(false, inputEl.value.trim());
          try {
            SOUNDS.wrong.currentTime = 0;
            SOUNDS.wrong.play();
          } catch (e) {}

          if (window.GameDialogue) {
            window.GameDialogue.showWrongAnswerDialogue();
          }
          setTimeout(() => {
            lives--;
            updateLives();
            if (lives <= 0) {
              showGameEndScreen();
              return;
            }
            gameState.currentIndex++;
            showQuestion();
          }, 1300);
        }
      }
    }

    function loadTotalStars() {
      if (typeof LinkageSystem !== 'undefined' && LinkageSystem?.stars?.get) {
        return Number(LinkageSystem.stars.get()) || 0;
      }
      if (typeof StarRewardSystem !== 'undefined' && typeof StarRewardSystem.getTotalStars === 'function') {
        return Number(StarRewardSystem.getTotalStars()) || 0;
      }
      const stars = localStorage.getItem('totalStars');
      return stars !== null ? parseInt(stars, 10) : 0;
    }

    function addStarsToTotal(stars) {
      if (typeof StarRewardSystem !== 'undefined' && typeof StarRewardSystem.addStars === 'function') {
        StarRewardSystem.addStars(stars);
        updateStarsDisplay();
        return;
      }
      if (typeof LinkageSystem !== 'undefined' && LinkageSystem?.stars?.add) {
        LinkageSystem.stars.add(stars);
        updateStarsDisplay();
        return;
      }
      const currentStars = loadTotalStars();
      const newTotal = currentStars + stars;
      localStorage.setItem('totalStars', newTotal);
      updateStarsDisplay();
    }

    function updateStarsDisplay() {
      document.getElementById('totalStarsCount').textContent = loadTotalStars();
    }

    function showReviewModal() {
      stopTimer();
      const totalVocabCount = document.getElementById('totalVocabCount');
      totalVocabCount.textContent = VOCAB_DATA.length;
      buildCategoryFilter();
      displayVocabByCategory('all');
      document.getElementById('reviewModal').style.display = 'flex';
    }

    function buildCategoryFilter() {
      const categoryFilter = document.getElementById('categoryFilter');
      categoryFilter.onchange = function() {
        displayVocabByCategory(this.value);
      };
    }

    function displayVocabByCategory(category) {
      const container = document.getElementById('reviewWordsContainer');
      const totalVocabCount = document.getElementById('totalVocabCount');
      container.innerHTML = '';

      let filteredVocab = VOCAB_DATA;
      if (category !== 'all') filteredVocab = VOCAB_DATA.filter(item => item.category === category);
      totalVocabCount.textContent = filteredVocab.length;

      if (category !== 'all') {
        const categoryTitle = document.createElement('div');
        categoryTitle.style.cssText = 'color:#0ff;font-size:1.3rem;font-weight:bold;margin:15px 0 10px 0;padding:10px;background:rgba(0,255,255,0.1);border-radius:8px;text-align:center';
        categoryTitle.textContent = `ğŸ“‚ ${category} (${filteredVocab.length}å€‹å–®å­—)`;
        container.appendChild(categoryTitle);
      }

      filteredVocab.forEach((item, index) => {
        const wordDiv = document.createElement('div');
        wordDiv.style.cssText = 'background:rgba(255,255,255,0.1);border:1px solid #ffd700;border-radius:10px;padding:15px;margin:10px 0;text-align:left;cursor:pointer;transition:all 0.3s';
        const categoryLabel = category === 'all' ? `<span style="color:#0ff;font-size:0.8rem;background:rgba(0,255,255,0.2);padding:2px 6px;border-radius:4px;margin-left:8px;">${item.category}</span>` : '';
        wordDiv.innerHTML = `
          <div style="display:flex;align-items:flex-start;gap:15px;">
            <div style="flex:1;min-width:0;">
              <div style="color:#ffd700;font-size:1.2rem;font-weight:bold;margin-bottom:8px;word-break:break-word;">${index + 1}. ${item.word}${categoryLabel}</div>
              <div style="color:#fff;font-size:1rem;margin-bottom:8px;word-break:break-word;">${item.zh}</div>
              <div style="color:#0ff;font-size:0.9rem;font-style:italic;word-break:break-word;">${item.en_sentence}</div>
            </div>
            <button onclick="event.stopPropagation(); speakWord('${item.word}')" style="background:#0ff;color:#000;border:none;border-radius:50%;width:45px;height:45px;font-size:1.3rem;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all 0.2s;box-shadow:0 2px 8px rgba(0,255,255,0.3);">ğŸ”Š</button>
          </div>
        `;

        wordDiv.addEventListener('mouseenter', () => {
          wordDiv.style.background = 'rgba(255, 215, 0, 0.2)';
          wordDiv.style.transform = 'scale(1.02)';
        });
        wordDiv.addEventListener('mouseleave', () => {
          wordDiv.style.background = 'rgba(255, 255, 255, 0.1)';
          wordDiv.style.transform = 'scale(1)';
        });
        wordDiv.addEventListener('click', () => speakWord(item.word));
        container.appendChild(wordDiv);
      });

      if (filteredVocab.length === 0) {
        const noWordsDiv = document.createElement('div');
        noWordsDiv.style.cssText = 'text-align:center;color:#888;font-size:1.1rem;padding:40px;font-style:italic';
        noWordsDiv.textContent = 'æ­¤åˆ†é¡æš«ç„¡å–®å­—';
        container.appendChild(noWordsDiv);
      }
    }

    function closeReviewModal() {
      document.getElementById('reviewModal').style.display = 'none';
      if (gameState.currentIndex < gameState.data.length && !gameState.answered) startTimer();
    }

    function speakWord(word) {
      if (!window.speechSynthesis) return;
      const utter = new window.SpeechSynthesisUtterance(word);
      utter.lang = 'en-US';
      utter.rate = 0.9;
      utter.pitch = 1.1;
      if (gameState.preferredVoice) utter.voice = gameState.preferredVoice;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    function lockReviewButton() {
      const reviewBtn = document.querySelector('.top-btns button[onclick*="showReviewModal"]');
      if (!reviewBtn) return;
      reviewBtn.disabled = true;
      reviewBtn.style.background = '#555';
      reviewBtn.style.color = '#888';
      reviewBtn.style.cursor = 'not-allowed';
      reviewBtn.title = 'éŠæˆ²é€²è¡Œä¸­ï¼Œç„¡æ³•è¤‡ç¿’å–®å­—';
    }

    function unlockReviewButton() {
      const reviewBtn = document.querySelector('.top-btns button[onclick*="showReviewModal"]');
      if (!reviewBtn) return;
      reviewBtn.disabled = false;
      reviewBtn.style.background = '#ffd700';
      reviewBtn.style.color = '#000';
      reviewBtn.style.cursor = 'pointer';
      reviewBtn.title = 'è¤‡ç¿’å–®å­—';
    }

    function showVocabStats() {
      const categoryStats = {};
      VOCAB_DATA.forEach(item => {
        categoryStats[item.category] = (categoryStats[item.category] || 0) + 1;
      });

      const statsModal = document.createElement('div');
      statsModal.className = 'modal';
      statsModal.style.display = 'flex';
      statsModal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="end-icon">ğŸ“Š</div>
          <h2>å­—åº«çµ±è¨ˆ</h2>
          <div style="text-align:left;margin:20px 0;">
            ${Object.entries(categoryStats).map(([category, count]) => `
              <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,215,0,0.3);">
                <span style="color:#fff;">${category}</span>
                <span style="color:#0ff;font-weight:bold;">${count} å€‹å–®å­—</span>
              </div>
            `).join('')}
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-top:2px solid #ffd700;margin-top:10px;font-weight:bold;">
              <span style="color:#ffd700;">ç¸½è¨ˆ</span>
              <span style="color:#ffd700;">${VOCAB_DATA.length} å€‹å–®å­—</span>
            </div>
          </div>
          <div class="end-buttons">
            <button onclick="this.closest('.modal').remove()">é—œé–‰</button>
          </div>
        </div>
      `;

      statsModal.addEventListener('click', function(e) {
        if (e.target === statsModal) statsModal.remove();
      });
      document.body.appendChild(statsModal);
    }

    function exportVocabData() {
      const csvContent = [
        ['å–®å­—', 'ä¸­æ–‡', 'è‹±æ–‡ä¾‹å¥', 'ä¸­æ–‡ä¾‹å¥', 'åˆ†é¡'],
        ...VOCAB_DATA.map(item => [item.word, item.zh, item.en_sentence, item.zh_sentence, item.category])
      ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `poseidon_vocabulary_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showNotification('âœ… å­—åº«å·²æˆåŠŸåŒ¯å‡ºï¼', 'success');
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `position:fixed;top:20px;left:50%;transform:translateX(-50%);background:${type === 'success' ? '#4caf50' : '#2196f3'};color:white;padding:12px 24px;border-radius:8px;font-weight:bold;z-index:10000;animation:slideDown 0.3s ease-out;`;
      notification.textContent = message;
      const style = document.createElement('style');
      style.textContent = '@keyframes slideDown { from { transform: translateX(-50%) translateY(-100%); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }';
      document.head.appendChild(style);
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.remove();
        style.remove();
      }, 3000);
    }

    function showAchievementNotify(title, desc) {
      document.getElementById('achievementNotifyTitle').textContent = title;
    }

    if (typeof speechSynthesis !== 'undefined') {
      speechSynthesis.onvoiceschanged = pickVoice;
      pickVoice();
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateStarsDisplay();
      document.getElementById('sessionStarsDisplay').textContent = 'æœ¬æ¬¡å·²ç²å¾— 0 é¡†æ˜Ÿæ˜Ÿ';
      updateLives();
      initData();
      loadProgress();
      updateCounter();
      showQuestion();
      initBackgroundMusic();
      unlockReviewButton();

      if (window.GameDialogue) {
        window.GameDialogue.init();
        setTimeout(() => {
          window.GameDialogue.showGameStartDialogue();
        }, 2000);
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      const reviewModal = document.getElementById('reviewModal');
      const gameEndModal = document.getElementById('gameEndModal');
      if (reviewModal) {
        reviewModal.addEventListener('click', function(e) {
          if (e.target === reviewModal) closeReviewModal();
        });
      }
      if (gameEndModal) {
        gameEndModal.addEventListener('click', function(e) {
          if (e.target === gameEndModal) document.getElementById('gameEndModal').style.display = 'none';
        });
      }
    });
  </script>
</body>
</html>
